(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))o(i);new MutationObserver(i=>{for(const r of i)if(r.type==="childList")for(const a of r.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&o(a)}).observe(document,{childList:!0,subtree:!0});function n(i){const r={};return i.integrity&&(r.integrity=i.integrity),i.referrerPolicy&&(r.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?r.credentials="include":i.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function o(i){if(i.ep)return;i.ep=!0;const r=n(i);fetch(i.href,r)}})();const Kf="modulepreload",Yf=function(e){return"/"+e},il={},_o=function(t,n,o){let i=Promise.resolve();if(n&&n.length>0){let m=function(y){return Promise.all(y.map(p=>Promise.resolve(p).then(N=>({status:"fulfilled",value:N}),N=>({status:"rejected",reason:N}))))};document.getElementsByTagName("link");const a=document.querySelector("meta[property=csp-nonce]"),u=a?.nonce||a?.getAttribute("nonce");i=m(n.map(y=>{if(y=Yf(y),y in il)return;il[y]=!0;const p=y.endsWith(".css"),N=p?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${y}"]${N}`))return;const I=document.createElement("link");if(I.rel=p?"stylesheet":Kf,p||(I.as="script"),I.crossOrigin="",I.href=y,u&&I.setAttribute("nonce",u),document.head.appendChild(I),p)return new Promise((k,A)=>{I.addEventListener("load",k),I.addEventListener("error",()=>A(new Error(`Unable to preload CSS for ${y}`)))})}))}function r(a){const u=new Event("vite:preloadError",{cancelable:!0});if(u.payload=a,window.dispatchEvent(u),!u.defaultPrevented)throw a}return i.then(a=>{for(const u of a||[])u.status==="rejected"&&r(u.reason);return t().catch(r)})};const Jf=e=>{const t=new Map;t.set("web",{name:"web"});const n=e.CapacitorPlatforms||{currentPlatform:{name:"web"},platforms:t},o=(r,a)=>{n.platforms.set(r,a)},i=r=>{n.platforms.has(r)&&(n.currentPlatform=n.platforms.get(r))};return n.addPlatform=o,n.setPlatform=i,n},Xf=e=>e.CapacitorPlatforms=Jf(e),uu=Xf(typeof globalThis<"u"?globalThis:typeof self<"u"?self:typeof window<"u"?window:typeof globalThis<"u"?globalThis:{});uu.addPlatform;uu.setPlatform;var Uo;(function(e){e.Unimplemented="UNIMPLEMENTED",e.Unavailable="UNAVAILABLE"})(Uo||(Uo={}));let ys=class extends Error{constructor(t,n,o){super(t),this.message=t,this.code=n,this.data=o}};const Qf=e=>{var t,n;return e?.androidBridge?"android":!((n=(t=e?.webkit)===null||t===void 0?void 0:t.messageHandlers)===null||n===void 0)&&n.bridge?"ios":"web"},Zf=e=>{var t,n,o,i,r;const a=e.CapacitorCustomPlatform||null,u=e.Capacitor||{},m=u.Plugins=u.Plugins||{},y=e.CapacitorPlatforms,p=()=>a!==null?a.name:Qf(e),N=((t=y?.currentPlatform)===null||t===void 0?void 0:t.getPlatform)||p,I=()=>N()!=="web",k=((n=y?.currentPlatform)===null||n===void 0?void 0:n.isNativePlatform)||I,A=oe=>{const X=G.get(oe);return!!(X?.platforms.has(N())||Y(oe))},U=((o=y?.currentPlatform)===null||o===void 0?void 0:o.isPluginAvailable)||A,W=oe=>{var X;return(X=u.PluginHeaders)===null||X===void 0?void 0:X.find(ye=>ye.name===oe)},Y=((i=y?.currentPlatform)===null||i===void 0?void 0:i.getPluginHeader)||W,ae=oe=>e.console.error(oe),Ce=(oe,X,ye)=>Promise.reject(`${ye} does not have an implementation of "${X}".`),G=new Map,ve=(oe,X={})=>{const ye=G.get(oe);if(ye)return console.warn(`Capacitor plugin "${oe}" already registered. Cannot register plugins twice.`),ye.proxy;const Z=N(),Fe=Y(oe);let Ae;const Et=async()=>(!Ae&&Z in X?Ae=typeof X[Z]=="function"?Ae=await X[Z]():Ae=X[Z]:a!==null&&!Ae&&"web"in X&&(Ae=typeof X.web=="function"?Ae=await X.web():Ae=X.web),Ae),It=(ge,Te)=>{var _e,qe;if(Fe){const Ie=Fe?.methods.find(we=>Te===we.name);if(Ie)return Ie.rtype==="promise"?we=>u.nativePromise(oe,Te.toString(),we):(we,st)=>u.nativeCallback(oe,Te.toString(),we,st);if(ge)return(_e=ge[Te])===null||_e===void 0?void 0:_e.bind(ge)}else{if(ge)return(qe=ge[Te])===null||qe===void 0?void 0:qe.bind(ge);throw new ys(`"${oe}" plugin is not implemented on ${Z}`,Uo.Unimplemented)}},rt=ge=>{let Te;const _e=(...qe)=>{const Ie=Et().then(we=>{const st=It(we,ge);if(st){const ht=st(...qe);return Te=ht?.remove,ht}else throw new ys(`"${oe}.${ge}()" is not implemented on ${Z}`,Uo.Unimplemented)});return ge==="addListener"&&(Ie.remove=async()=>Te()),Ie};return _e.toString=()=>`${ge.toString()}() { [capacitor code] }`,Object.defineProperty(_e,"name",{value:ge,writable:!1,configurable:!1}),_e},ft=rt("addListener"),gt=rt("removeListener"),$e=(ge,Te)=>{const _e=ft({eventName:ge},Te),qe=async()=>{const we=await _e;gt({eventName:ge,callbackId:we},Te)},Ie=new Promise(we=>_e.then(()=>we({remove:qe})));return Ie.remove=async()=>{console.warn("Using addListener() without 'await' is deprecated."),await qe()},Ie},kt=new Proxy({},{get(ge,Te){switch(Te){case"$$typeof":return;case"toJSON":return()=>({});case"addListener":return Fe?$e:ft;case"removeListener":return gt;default:return rt(Te)}}});return m[oe]=kt,G.set(oe,{name:oe,proxy:kt,platforms:new Set([...Object.keys(X),...Fe?[Z]:[]])}),kt},Se=((r=y?.currentPlatform)===null||r===void 0?void 0:r.registerPlugin)||ve;return u.convertFileSrc||(u.convertFileSrc=oe=>oe),u.getPlatform=N,u.handleError=ae,u.isNativePlatform=k,u.isPluginAvailable=U,u.pluginMethodNoop=Ce,u.registerPlugin=Se,u.Exception=ys,u.DEBUG=!!u.DEBUG,u.isLoggingEnabled=!!u.isLoggingEnabled,u.platform=u.getPlatform(),u.isNative=u.isNativePlatform(),u},Gf=e=>e.Capacitor=Zf(e),Vn=Gf(typeof globalThis<"u"?globalThis:typeof self<"u"?self:typeof window<"u"?window:typeof globalThis<"u"?globalThis:{}),jo=Vn.registerPlugin;Vn.Plugins;let fu=class{constructor(t){this.listeners={},this.retainedEventArguments={},this.windowListeners={},t&&(console.warn(`Capacitor WebPlugin "${t.name}" config object was deprecated in v3 and will be removed in v4.`),this.config=t)}addListener(t,n){let o=!1;this.listeners[t]||(this.listeners[t]=[],o=!0),this.listeners[t].push(n);const r=this.windowListeners[t];r&&!r.registered&&this.addWindowListener(r),o&&this.sendRetainedArgumentsForEvent(t);const a=async()=>this.removeListener(t,n);return Promise.resolve({remove:a})}async removeAllListeners(){this.listeners={};for(const t in this.windowListeners)this.removeWindowListener(this.windowListeners[t]);this.windowListeners={}}notifyListeners(t,n,o){const i=this.listeners[t];if(!i){if(o){let r=this.retainedEventArguments[t];r||(r=[]),r.push(n),this.retainedEventArguments[t]=r}return}i.forEach(r=>r(n))}hasListeners(t){return!!this.listeners[t].length}registerWindowListener(t,n){this.windowListeners[n]={registered:!1,windowEventName:t,pluginEventName:n,handler:o=>{this.notifyListeners(n,o)}}}unimplemented(t="not implemented"){return new Vn.Exception(t,Uo.Unimplemented)}unavailable(t="not available"){return new Vn.Exception(t,Uo.Unavailable)}async removeListener(t,n){const o=this.listeners[t];if(!o)return;const i=o.indexOf(n);this.listeners[t].splice(i,1),this.listeners[t].length||this.removeWindowListener(this.windowListeners[t])}addWindowListener(t){window.addEventListener(t.windowEventName,t.handler),t.registered=!0}removeWindowListener(t){t&&(window.removeEventListener(t.windowEventName,t.handler),t.registered=!1)}sendRetainedArgumentsForEvent(t){const n=this.retainedEventArguments[t];n&&(delete this.retainedEventArguments[t],n.forEach(o=>{this.notifyListeners(t,o)}))}};const rl=e=>encodeURIComponent(e).replace(/%(2[346B]|5E|60|7C)/g,decodeURIComponent).replace(/[()]/g,escape),sl=e=>e.replace(/(%[\dA-F]{2})+/gi,decodeURIComponent);class em extends fu{async getCookies(){const t=document.cookie,n={};return t.split(";").forEach(o=>{if(o.length<=0)return;let[i,r]=o.replace(/=/,"CAP_COOKIE").split("CAP_COOKIE");i=sl(i).trim(),r=sl(r).trim(),n[i]=r}),n}async setCookie(t){try{const n=rl(t.key),o=rl(t.value),i=`; expires=${(t.expires||"").replace("expires=","")}`,r=(t.path||"/").replace("path=",""),a=t.url!=null&&t.url.length>0?`domain=${t.url}`:"";document.cookie=`${n}=${o||""}${i}; path=${r}; ${a};`}catch(n){return Promise.reject(n)}}async deleteCookie(t){try{document.cookie=`${t.key}=; Max-Age=0`}catch(n){return Promise.reject(n)}}async clearCookies(){try{const t=document.cookie.split(";")||[];for(const n of t)document.cookie=n.replace(/^ +/,"").replace(/=.*/,`=;expires=${new Date().toUTCString()};path=/`)}catch(t){return Promise.reject(t)}}async clearAllCookies(){try{await this.clearCookies()}catch(t){return Promise.reject(t)}}}jo("CapacitorCookies",{web:()=>new em});const tm=async e=>new Promise((t,n)=>{const o=new FileReader;o.onload=()=>{const i=o.result;t(i.indexOf(",")>=0?i.split(",")[1]:i)},o.onerror=i=>n(i),o.readAsDataURL(e)}),nm=(e={})=>{const t=Object.keys(e);return Object.keys(e).map(i=>i.toLocaleLowerCase()).reduce((i,r,a)=>(i[r]=e[t[a]],i),{})},om=(e,t=!0)=>e?Object.entries(e).reduce((o,i)=>{const[r,a]=i;let u,m;return Array.isArray(a)?(m="",a.forEach(y=>{u=t?encodeURIComponent(y):y,m+=`${r}=${u}&`}),m.slice(0,-1)):(u=t?encodeURIComponent(a):a,m=`${r}=${u}`),`${o}&${m}`},"").substr(1):null,im=(e,t={})=>{const n=Object.assign({method:e.method||"GET",headers:e.headers},t),i=nm(e.headers)["content-type"]||"";if(typeof e.data=="string")n.body=e.data;else if(i.includes("application/x-www-form-urlencoded")){const r=new URLSearchParams;for(const[a,u]of Object.entries(e.data||{}))r.set(a,u);n.body=r.toString()}else if(i.includes("multipart/form-data")||e.data instanceof FormData){const r=new FormData;if(e.data instanceof FormData)e.data.forEach((u,m)=>{r.append(m,u)});else for(const u of Object.keys(e.data))r.append(u,e.data[u]);n.body=r;const a=new Headers(n.headers);a.delete("content-type"),n.headers=a}else(i.includes("application/json")||typeof e.data=="object")&&(n.body=JSON.stringify(e.data));return n};class rm extends fu{async request(t){const n=im(t,t.webFetchExtra),o=om(t.params,t.shouldEncodeUrlParams),i=o?`${t.url}?${o}`:t.url,r=await fetch(i,n),a=r.headers.get("content-type")||"";let{responseType:u="text"}=r.ok?t:{};a.includes("application/json")&&(u="json");let m,y;switch(u){case"arraybuffer":case"blob":y=await r.blob(),m=await tm(y);break;case"json":m=await r.json();break;case"document":case"text":default:m=await r.text()}const p={};return r.headers.forEach((N,I)=>{p[I]=N}),{data:m,headers:p,status:r.status,url:r.url}}async get(t){return this.request(Object.assign(Object.assign({},t),{method:"GET"}))}async post(t){return this.request(Object.assign(Object.assign({},t),{method:"POST"}))}async put(t){return this.request(Object.assign(Object.assign({},t),{method:"PUT"}))}async patch(t){return this.request(Object.assign(Object.assign({},t),{method:"PATCH"}))}async delete(t){return this.request(Object.assign(Object.assign({},t),{method:"DELETE"}))}}const al=jo("CapacitorHttp",{web:()=>new rm}),gs=jo("Preferences",{web:()=>_o(()=>import("./web-BpZet86R.js"),[]).then(e=>new e.PreferencesWeb)});class so{static async get(t){const{value:n}=await gs.get({key:t});return n}static async set(t,n){await gs.set({key:t,value:n})}static async remove(t){await gs.remove({key:t})}static async getObject(t){const n=await this.get(t);if(!n)return null;try{return JSON.parse(n)}catch(o){return console.error(`Error parsing key ${t}:`,o),null}}static async setObject(t,n){await this.set(t,JSON.stringify(n))}}class cl{static async get(t,n={}){const i={...{"User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36",Accept:"text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8","Accept-Language":"en-US,en;q=0.5"},...n};console.log(`[HttpService] GET ${t}`);try{const r=await al.get({url:t,headers:i});if(r.status>=200&&r.status<300)return r.data;throw new Error(`Request failed with status ${r.status}: ${r.data}`)}catch(r){throw console.error(`[HttpService] Error fetching ${t}:`,r),r}}static async post(t,n,o={}){const r={...{"Content-Type":"application/json","User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36"},...o};try{const a=await al.post({url:t,headers:r,data:n});if(a.status>=200&&a.status<300)return a.data;throw new Error(`Request failed with status ${a.status}: ${a.data}`)}catch(a){throw console.error(`[HttpService] Error POST ${t}:`,a),a}}}const Ei=class Ei{static getTrackersString(){return this.TRACKERS.map(t=>`&tr=${encodeURIComponent(t)}`).join("")}static parseStreamInfo(t){const n=t.match(/ðŸ‘¤\s*(\d+)/),o=t.match(/ðŸ’¾\s*([\d.]+\s*[A-Z]+)/);return{seeders:n?parseInt(n[1]):0,size:o?o[1]:"Unknown"}}static constructMagnetLink(t,n){const o=encodeURIComponent(n);return`magnet:?xt=urn:btih:${t}&dn=${o}${this.getTrackersString()}`}static async getMovieStreams(t){if(!t.match(/^tt\d+$/))throw new Error("Invalid IMDb ID format. Must be in format: tt1234567");const n=`${this.BASE_URL_MOVIE}/${t}.json`;try{const o=await cl.get(n);return!o||!o.streams||o.streams.length===0?[]:o.streams.map(i=>{const r=this.parseStreamInfo(i.title),a=i.behaviorHints?.filename||"movie.mkv",u=this.constructMagnetLink(i.infoHash,a);return{name:i.name,title:i.title,magnetLink:u,infoHash:i.infoHash,seeders:r.seeders,size:r.size,filename:a,fileIdx:i.fileIdx}})}catch(o){return console.error("[TorrentioService] Error fetching movie streams:",o),[]}}static async getSeriesStreams(t,n,o){if(!t.match(/^tt\d+$/))throw new Error("Invalid IMDb ID format. Must be in format: tt1234567");const i=`${this.BASE_URL_SERIES}/${t}:${n}:${o}.json`;try{const r=await cl.get(i);return!r||!r.streams||r.streams.length===0?[]:r.streams.map(a=>{const u=this.parseStreamInfo(a.title),m=a.behaviorHints?.filename||`episode_S${n}E${o}.mkv`,y=this.constructMagnetLink(a.infoHash,m);return{name:a.name,title:a.title,magnetLink:y,infoHash:a.infoHash,seeders:u.seeders,size:u.size,filename:m,fileIdx:a.fileIdx}})}catch(r){return console.error("[TorrentioService] Error fetching series streams:",r),[]}}};Ei.BASE_URL_MOVIE="https://torrentio.strem.fun/providers=yts,eztv,rarbg,1337x,thepiratebay,kickasstorrents,torrentgalaxy,magnetdl,horriblesubs,nyaasi,tokyotosho,anidex/stream/movie",Ei.BASE_URL_SERIES="https://torrentio.strem.fun/providers=yts,eztv,rarbg,1337x,thepiratebay,kickasstorrents,torrentgalaxy,magnetdl,horriblesubs,nyaasi,tokyotosho,anidex/stream/series",Ei.TRACKERS=["udp://tracker.opentrackr.org:1337/announce","udp://tracker.openbittorrent.com:6969/announce","udp://open.stealth.si:80/announce","udp://tracker.torrent.eu.org:451/announce","udp://tracker.bittor.pw:1337/announce","udp://public.popcorn-tracker.org:6969/announce","udp://tracker.dler.org:6969/announce","udp://exodus.desync.com:6969","udp://open.demonii.com:1337/announce"];let lr=Ei;const hs=jo("CapacitorVideoPlayer",{web:()=>_o(()=>import("./web-BMZClILc.js"),[]).then(e=>new e.CapacitorVideoPlayerWeb)}),ll=jo("AppLauncher",{web:()=>_o(()=>import("./web-JpDIsrN4.js"),[]).then(e=>new e.AppLauncherWeb)});class Dr{static async play(t,n,o){if(Vn.getPlatform()==="web"){console.warn("[PlayerService] Web platform detected. Native player may not work fully. Using HTML5 fallback logic if implemented.");return}try{console.log(`[PlayerService] Opening native player for: ${t}`),await hs.initPlayer({mode:"fullscreen",url:t,playerId:"fullscreen-player",componentTag:"div",subtitle:o?{url:o,language:"en"}:void 0}),(await hs.isPlaying({playerId:"fullscreen-player"})).result||await hs.play({playerId:"fullscreen-player"})}catch(i){throw console.error("[PlayerService] Error playing video:",i),i}}static async playInVlc(t){if(Vn.getPlatform()!=="android")return console.warn("External player intents are Android-only"),!1;try{const n=t.replace(/^https?:\/\//,"vlc://");return console.log(`[PlayerService] Launching VLC: ${n}`),await ll.openUrl({url:n}),!0}catch(n){throw console.error("[PlayerService] Failed to open VLC:",n),n}}static async openInBrowser(t){if(console.log(`[PlayerService] Opening in external browser: ${t}`),Vn.getPlatform()==="android")try{await ll.openUrl({url:t})}catch(n){console.error("[PlayerService] AppLauncher failed, using window.open fallback:",n),window.open(t,"_system")}else window.open(t,"_blank")}static isMobile(){const t=Vn.getPlatform();return t==="android"||t==="ios"}}var no;(function(e){e.Documents="DOCUMENTS",e.Data="DATA",e.Library="LIBRARY",e.Cache="CACHE",e.External="EXTERNAL",e.ExternalStorage="EXTERNAL_STORAGE"})(no||(no={}));var dl;(function(e){e.UTF8="utf8",e.ASCII="ascii",e.UTF16="utf16"})(dl||(dl={}));const Yi=jo("Filesystem",{web:()=>_o(()=>import("./web-DulDFcEB.js"),[]).then(e=>new e.FilesystemWeb)});const sm=e=>{const t=new Map;t.set("web",{name:"web"});const n=e.CapacitorPlatforms||{currentPlatform:{name:"web"},platforms:t},o=(r,a)=>{n.platforms.set(r,a)},i=r=>{n.platforms.has(r)&&(n.currentPlatform=n.platforms.get(r))};return n.addPlatform=o,n.setPlatform=i,n},am=e=>e.CapacitorPlatforms=sm(e),mu=am(typeof globalThis<"u"?globalThis:typeof self<"u"?self:typeof window<"u"?window:typeof globalThis<"u"?globalThis:{});mu.addPlatform;mu.setPlatform;var Oo;(function(e){e.Unimplemented="UNIMPLEMENTED",e.Unavailable="UNAVAILABLE"})(Oo||(Oo={}));class vs extends Error{constructor(t,n){super(t),this.message=t,this.code=n}}const cm=e=>{var t,n;return e?.androidBridge?"android":!((n=(t=e?.webkit)===null||t===void 0?void 0:t.messageHandlers)===null||n===void 0)&&n.bridge?"ios":"web"},lm=e=>{var t,n,o,i,r;const a=e.CapacitorCustomPlatform||null,u=e.Capacitor||{},m=u.Plugins=u.Plugins||{},y=e.CapacitorPlatforms,p=()=>a!==null?a.name:cm(e),N=((t=y?.currentPlatform)===null||t===void 0?void 0:t.getPlatform)||p,I=()=>N()!=="web",k=((n=y?.currentPlatform)===null||n===void 0?void 0:n.isNativePlatform)||I,A=oe=>{const X=G.get(oe);return!!(X?.platforms.has(N())||Y(oe))},U=((o=y?.currentPlatform)===null||o===void 0?void 0:o.isPluginAvailable)||A,W=oe=>{var X;return(X=u.PluginHeaders)===null||X===void 0?void 0:X.find(ye=>ye.name===oe)},Y=((i=y?.currentPlatform)===null||i===void 0?void 0:i.getPluginHeader)||W,ae=oe=>e.console.error(oe),Ce=(oe,X,ye)=>Promise.reject(`${ye} does not have an implementation of "${X}".`),G=new Map,ve=(oe,X={})=>{const ye=G.get(oe);if(ye)return console.warn(`Capacitor plugin "${oe}" already registered. Cannot register plugins twice.`),ye.proxy;const Z=N(),Fe=Y(oe);let Ae;const Et=async()=>(!Ae&&Z in X?Ae=typeof X[Z]=="function"?Ae=await X[Z]():Ae=X[Z]:a!==null&&!Ae&&"web"in X&&(Ae=typeof X.web=="function"?Ae=await X.web():Ae=X.web),Ae),It=(ge,Te)=>{var _e,qe;if(Fe){const Ie=Fe?.methods.find(we=>Te===we.name);if(Ie)return Ie.rtype==="promise"?we=>u.nativePromise(oe,Te.toString(),we):(we,st)=>u.nativeCallback(oe,Te.toString(),we,st);if(ge)return(_e=ge[Te])===null||_e===void 0?void 0:_e.bind(ge)}else{if(ge)return(qe=ge[Te])===null||qe===void 0?void 0:qe.bind(ge);throw new vs(`"${oe}" plugin is not implemented on ${Z}`,Oo.Unimplemented)}},rt=ge=>{let Te;const _e=(...qe)=>{const Ie=Et().then(we=>{const st=It(we,ge);if(st){const ht=st(...qe);return Te=ht?.remove,ht}else throw new vs(`"${oe}.${ge}()" is not implemented on ${Z}`,Oo.Unimplemented)});return ge==="addListener"&&(Ie.remove=async()=>Te()),Ie};return _e.toString=()=>`${ge.toString()}() { [capacitor code] }`,Object.defineProperty(_e,"name",{value:ge,writable:!1,configurable:!1}),_e},ft=rt("addListener"),gt=rt("removeListener"),$e=(ge,Te)=>{const _e=ft({eventName:ge},Te),qe=async()=>{const we=await _e;gt({eventName:ge,callbackId:we},Te)},Ie=new Promise(we=>_e.then(()=>we({remove:qe})));return Ie.remove=async()=>{console.warn("Using addListener() without 'await' is deprecated."),await qe()},Ie},kt=new Proxy({},{get(ge,Te){switch(Te){case"$$typeof":return;case"toJSON":return()=>({});case"addListener":return Fe?$e:ft;case"removeListener":return gt;default:return rt(Te)}}});return m[oe]=kt,G.set(oe,{name:oe,proxy:kt,platforms:new Set([...Object.keys(X),...Fe?[Z]:[]])}),kt},Se=((r=y?.currentPlatform)===null||r===void 0?void 0:r.registerPlugin)||ve;return u.convertFileSrc||(u.convertFileSrc=oe=>oe),u.getPlatform=N,u.handleError=ae,u.isNativePlatform=k,u.isPluginAvailable=U,u.pluginMethodNoop=Ce,u.registerPlugin=Se,u.Exception=vs,u.DEBUG=!!u.DEBUG,u.isLoggingEnabled=!!u.isLoggingEnabled,u.platform=u.getPlatform(),u.isNative=u.isNativePlatform(),u},dm=e=>e.Capacitor=lm(e),dr=dm(typeof globalThis<"u"?globalThis:typeof self<"u"?self:typeof window<"u"?window:typeof globalThis<"u"?globalThis:{}),um=dr.registerPlugin;dr.Plugins;class Vv{constructor(t){this.listeners={},this.windowListeners={},t&&(console.warn(`Capacitor WebPlugin "${t.name}" config object was deprecated in v3 and will be removed in v4.`),this.config=t)}addListener(t,n){this.listeners[t]||(this.listeners[t]=[]),this.listeners[t].push(n);const i=this.windowListeners[t];i&&!i.registered&&this.addWindowListener(i);const r=async()=>this.removeListener(t,n),a=Promise.resolve({remove:r});return Object.defineProperty(a,"remove",{value:async()=>{console.warn("Using addListener() without 'await' is deprecated."),await r()}}),a}async removeAllListeners(){this.listeners={};for(const t in this.windowListeners)this.removeWindowListener(this.windowListeners[t]);this.windowListeners={}}notifyListeners(t,n){const o=this.listeners[t];o&&o.forEach(i=>i(n))}hasListeners(t){return!!this.listeners[t].length}registerWindowListener(t,n){this.windowListeners[n]={registered:!1,windowEventName:t,pluginEventName:n,handler:o=>{this.notifyListeners(n,o)}}}unimplemented(t="not implemented"){return new dr.Exception(t,Oo.Unimplemented)}unavailable(t="not available"){return new dr.Exception(t,Oo.Unavailable)}async removeListener(t,n){const o=this.listeners[t];if(!o)return;const i=o.indexOf(n);this.listeners[t].splice(i,1),this.listeners[t].length||this.removeWindowListener(this.windowListeners[t])}addWindowListener(t){window.addEventListener(t.windowEventName,t.handler),t.registered=!0}removeWindowListener(t){t&&(window.removeEventListener(t.windowEventName,t.handler),t.registered=!1)}}const ul=um("Http",{web:()=>_o(()=>import("./web-D39WRD1K.js"),[]).then(e=>new e.HttpWeb),electron:()=>_o(()=>import("./web-D39WRD1K.js"),[]).then(e=>new e.HttpWeb)});var Oe;(function(e){e.Root="root",e.Text="text",e.Directive="directive",e.Comment="comment",e.Script="script",e.Style="style",e.Tag="tag",e.CDATA="cdata",e.Doctype="doctype"})(Oe||(Oe={}));function fm(e){return e.type===Oe.Tag||e.type===Oe.Script||e.type===Oe.Style}const pu=Oe.Root,mm=Oe.Text,pm=Oe.Directive,ym=Oe.Comment,gm=Oe.Script,hm=Oe.Style,Xs=Oe.Tag,vm=Oe.CDATA,wm=Oe.Doctype;class yu{constructor(){this.parent=null,this.prev=null,this.next=null,this.startIndex=null,this.endIndex=null}get parentNode(){return this.parent}set parentNode(t){this.parent=t}get previousSibling(){return this.prev}set previousSibling(t){this.prev=t}get nextSibling(){return this.next}set nextSibling(t){this.next=t}cloneNode(t=!1){return bi(this,t)}}class Ia extends yu{constructor(t){super(),this.data=t}get nodeValue(){return this.data}set nodeValue(t){this.data=t}}class gu extends Ia{constructor(){super(...arguments),this.type=Oe.Text}get nodeType(){return 3}}class Em extends Ia{constructor(){super(...arguments),this.type=Oe.Comment}get nodeType(){return 8}}class bm extends Ia{constructor(t,n){super(n),this.name=t,this.type=Oe.Directive}get nodeType(){return 1}}class ka extends yu{constructor(t){super(),this.children=t}get firstChild(){var t;return(t=this.children[0])!==null&&t!==void 0?t:null}get lastChild(){return this.children.length>0?this.children[this.children.length-1]:null}get childNodes(){return this.children}set childNodes(t){this.children=t}}class Im extends ka{constructor(){super(...arguments),this.type=Oe.CDATA}get nodeType(){return 4}}class hu extends ka{constructor(){super(...arguments),this.type=Oe.Root}get nodeType(){return 9}}class km extends ka{constructor(t,n,o=[],i=t==="script"?Oe.Script:t==="style"?Oe.Style:Oe.Tag){super(o),this.name=t,this.attribs=n,this.type=i}get nodeType(){return 1}get tagName(){return this.name}set tagName(t){this.name=t}get attributes(){return Object.keys(this.attribs).map(t=>{var n,o;return{name:t,value:this.attribs[t],namespace:(n=this["x-attribsNamespace"])===null||n===void 0?void 0:n[t],prefix:(o=this["x-attribsPrefix"])===null||o===void 0?void 0:o[t]}})}}function me(e){return fm(e)}function Fr(e){return e.type===Oe.CDATA}function uo(e){return e.type===Oe.Text}function Sa(e){return e.type===Oe.Comment}function Sm(e){return e.type===Oe.Directive}function qo(e){return e.type===Oe.Root}function nt(e){return Object.prototype.hasOwnProperty.call(e,"children")}function bi(e,t=!1){let n;if(uo(e))n=new gu(e.data);else if(Sa(e))n=new Em(e.data);else if(me(e)){const o=t?ws(e.children):[],i=new km(e.name,{...e.attribs},o);o.forEach(r=>r.parent=i),e.namespace!=null&&(i.namespace=e.namespace),e["x-attribsNamespace"]&&(i["x-attribsNamespace"]={...e["x-attribsNamespace"]}),e["x-attribsPrefix"]&&(i["x-attribsPrefix"]={...e["x-attribsPrefix"]}),n=i}else if(Fr(e)){const o=t?ws(e.children):[],i=new Im(o);o.forEach(r=>r.parent=i),n=i}else if(qo(e)){const o=t?ws(e.children):[],i=new hu(o);o.forEach(r=>r.parent=i),e["x-mode"]&&(i["x-mode"]=e["x-mode"]),n=i}else if(Sm(e)){const o=new bm(e.name,e.data);e["x-name"]!=null&&(o["x-name"]=e["x-name"],o["x-publicId"]=e["x-publicId"],o["x-systemId"]=e["x-systemId"]),n=o}else throw new Error(`Not implemented yet: ${e.type}`);return n.startIndex=e.startIndex,n.endIndex=e.endIndex,e.sourceCodeLocation!=null&&(n.sourceCodeLocation=e.sourceCodeLocation),n}function ws(e){const t=e.map(n=>bi(n,!0));for(let n=1;n<t.length;n++)t[n].prev=t[n-1],t[n-1].next=t[n];return t}const fl=/["&'<>$\x80-\uFFFF]/g,Tm=new Map([[34,"&quot;"],[38,"&amp;"],[39,"&apos;"],[60,"&lt;"],[62,"&gt;"]]),Lm=String.prototype.codePointAt!=null?(e,t)=>e.codePointAt(t):(e,t)=>(e.charCodeAt(t)&64512)===55296?(e.charCodeAt(t)-55296)*1024+e.charCodeAt(t+1)-56320+65536:e.charCodeAt(t);function vu(e){let t="",n=0,o;for(;(o=fl.exec(e))!==null;){const i=o.index,r=e.charCodeAt(i),a=Tm.get(r);a!==void 0?(t+=e.substring(n,i)+a,n=i+1):(t+=`${e.substring(n,i)}&#x${Lm(e,i).toString(16)};`,n=fl.lastIndex+=+((r&64512)===55296))}return t+e.substr(n)}function wu(e,t){return function(o){let i,r=0,a="";for(;i=e.exec(o);)r!==i.index&&(a+=o.substring(r,i.index)),a+=t.get(i[0].charCodeAt(0)),r=i.index+1;return a+o.substring(r)}}const Cm=wu(/["&\u00A0]/g,new Map([[34,"&quot;"],[38,"&amp;"],[160,"&nbsp;"]])),Bm=wu(/[&<>\u00A0]/g,new Map([[38,"&amp;"],[60,"&lt;"],[62,"&gt;"],[160,"&nbsp;"]])),Am=new Map(["altGlyph","altGlyphDef","altGlyphItem","animateColor","animateMotion","animateTransform","clipPath","feBlend","feColorMatrix","feComponentTransfer","feComposite","feConvolveMatrix","feDiffuseLighting","feDisplacementMap","feDistantLight","feDropShadow","feFlood","feFuncA","feFuncB","feFuncG","feFuncR","feGaussianBlur","feImage","feMerge","feMergeNode","feMorphology","feOffset","fePointLight","feSpecularLighting","feSpotLight","feTile","feTurbulence","foreignObject","glyphRef","linearGradient","radialGradient","textPath"].map(e=>[e.toLowerCase(),e])),Pm=new Map(["definitionURL","attributeName","attributeType","baseFrequency","baseProfile","calcMode","clipPathUnits","diffuseConstant","edgeMode","filterUnits","glyphRef","gradientTransform","gradientUnits","kernelMatrix","kernelUnitLength","keyPoints","keySplines","keyTimes","lengthAdjust","limitingConeAngle","markerHeight","markerUnits","markerWidth","maskContentUnits","maskUnits","numOctaves","pathLength","patternContentUnits","patternTransform","patternUnits","pointsAtX","pointsAtY","pointsAtZ","preserveAlpha","preserveAspectRatio","primitiveUnits","refX","refY","repeatCount","repeatDur","requiredExtensions","requiredFeatures","specularConstant","specularExponent","spreadMethod","startOffset","stdDeviation","stitchTiles","surfaceScale","systemLanguage","tableValues","targetX","targetY","textLength","viewBox","viewTarget","xChannelSelector","yChannelSelector","zoomAndPan"].map(e=>[e.toLowerCase(),e])),xm=new Set(["style","script","xmp","iframe","noembed","noframes","plaintext","noscript"]);function $m(e){return e.replace(/"/g,"&quot;")}function Nm(e,t){var n;if(!e)return;const o=((n=t.encodeEntities)!==null&&n!==void 0?n:t.decodeEntities)===!1?$m:t.xmlMode||t.encodeEntities!=="utf8"?vu:Cm;return Object.keys(e).map(i=>{var r,a;const u=(r=e[i])!==null&&r!==void 0?r:"";return t.xmlMode==="foreign"&&(i=(a=Pm.get(i))!==null&&a!==void 0?a:i),!t.emptyAttrs&&!t.xmlMode&&u===""?i:`${i}="${o(u)}"`}).join(" ")}const ml=new Set(["area","base","basefont","br","col","command","embed","frame","hr","img","input","isindex","keygen","link","meta","param","source","track","wbr"]);function Ta(e,t={}){const n="length"in e?e:[e];let o="";for(let i=0;i<n.length;i++)o+=Mm(n[i],t);return o}function Mm(e,t){switch(e.type){case pu:return Ta(e.children,t);case wm:case pm:return Om(e);case ym:return Hm(e);case vm:return Fm(e);case gm:case hm:case Xs:return Um(e,t);case mm:return Dm(e,t)}}const Rm=new Set(["mi","mo","mn","ms","mtext","annotation-xml","foreignObject","desc","title"]),_m=new Set(["svg","math"]);function Um(e,t){var n;t.xmlMode==="foreign"&&(e.name=(n=Am.get(e.name))!==null&&n!==void 0?n:e.name,e.parent&&Rm.has(e.parent.name)&&(t={...t,xmlMode:!1})),!t.xmlMode&&_m.has(e.name)&&(t={...t,xmlMode:"foreign"});let o=`<${e.name}`;const i=Nm(e.attribs,t);return i&&(o+=` ${i}`),e.children.length===0&&(t.xmlMode?t.selfClosingTags!==!1:t.selfClosingTags&&ml.has(e.name))?(t.xmlMode||(o+=" "),o+="/>"):(o+=">",e.children.length>0&&(o+=Ta(e.children,t)),(t.xmlMode||!ml.has(e.name))&&(o+=`</${e.name}>`)),o}function Om(e){return`<${e.data}>`}function Dm(e,t){var n;let o=e.data||"";return((n=t.encodeEntities)!==null&&n!==void 0?n:t.decodeEntities)!==!1&&!(!t.xmlMode&&e.parent&&xm.has(e.parent.name))&&(o=t.xmlMode||t.encodeEntities!=="utf8"?vu(o):Bm(o)),o}function Fm(e){return`<![CDATA[${e.children[0].data}]]>`}function Hm(e){return`<!--${e.data}-->`}function Eu(e,t){return Ta(e,t)}function Vm(e,t){return nt(e)?e.children.map(n=>Eu(n,t)).join(""):""}function nr(e){return Array.isArray(e)?e.map(nr).join(""):me(e)?e.name==="br"?`
`:nr(e.children):Fr(e)?nr(e.children):uo(e)?e.data:""}function Do(e){return Array.isArray(e)?e.map(Do).join(""):nt(e)&&!Sa(e)?Do(e.children):uo(e)?e.data:""}function ur(e){return Array.isArray(e)?e.map(ur).join(""):nt(e)&&(e.type===Oe.Tag||Fr(e))?ur(e.children):uo(e)?e.data:""}function Hr(e){return nt(e)?e.children:[]}function bu(e){return e.parent||null}function Iu(e){const t=bu(e);if(t!=null)return Hr(t);const n=[e];let{prev:o,next:i}=e;for(;o!=null;)n.unshift(o),{prev:o}=o;for(;i!=null;)n.push(i),{next:i}=i;return n}function jm(e,t){var n;return(n=e.attribs)===null||n===void 0?void 0:n[t]}function qm(e,t){return e.attribs!=null&&Object.prototype.hasOwnProperty.call(e.attribs,t)&&e.attribs[t]!=null}function zm(e){return e.name}function La(e){let{next:t}=e;for(;t!==null&&!me(t);)({next:t}=t);return t}function Ca(e){let{prev:t}=e;for(;t!==null&&!me(t);)({prev:t}=t);return t}function go(e){if(e.prev&&(e.prev.next=e.next),e.next&&(e.next.prev=e.prev),e.parent){const t=e.parent.children,n=t.lastIndexOf(e);n>=0&&t.splice(n,1)}e.next=null,e.prev=null,e.parent=null}function Wm(e,t){const n=t.prev=e.prev;n&&(n.next=t);const o=t.next=e.next;o&&(o.prev=t);const i=t.parent=e.parent;if(i){const r=i.children;r[r.lastIndexOf(e)]=t,e.parent=null}}function Km(e,t){if(go(t),t.next=null,t.parent=e,e.children.push(t)>1){const n=e.children[e.children.length-2];n.next=t,t.prev=n}else t.prev=null}function Ym(e,t){go(t);const{parent:n}=e,o=e.next;if(t.next=o,t.prev=e,e.next=t,t.parent=n,o){if(o.prev=t,n){const i=n.children;i.splice(i.lastIndexOf(o),0,t)}}else n&&n.children.push(t)}function Jm(e,t){if(go(t),t.parent=e,t.prev=null,e.children.unshift(t)!==1){const n=e.children[1];n.prev=t,t.next=n}else t.next=null}function Xm(e,t){go(t);const{parent:n}=e;if(n){const o=n.children;o.splice(o.indexOf(e),0,t)}e.prev&&(e.prev.next=t),t.parent=n,t.prev=e.prev,t.next=e,e.prev=t}function Ai(e,t,n=!0,o=1/0){return Ba(e,Array.isArray(t)?t:[t],n,o)}function Ba(e,t,n,o){const i=[],r=[Array.isArray(t)?t:[t]],a=[0];for(;;){if(a[0]>=r[0].length){if(a.length===1)return i;r.shift(),a.shift();continue}const u=r[0][a[0]++];if(e(u)&&(i.push(u),--o<=0))return i;n&&nt(u)&&u.children.length>0&&(a.unshift(0),r.unshift(u.children))}}function Qm(e,t){return t.find(e)}function Aa(e,t,n=!0){const o=Array.isArray(t)?t:[t];for(let i=0;i<o.length;i++){const r=o[i];if(me(r)&&e(r))return r;if(n&&nt(r)&&r.children.length>0){const a=Aa(e,r.children,!0);if(a)return a}}return null}function ku(e,t){return(Array.isArray(t)?t:[t]).some(n=>me(n)&&e(n)||nt(n)&&ku(e,n.children))}function Zm(e,t){const n=[],o=[Array.isArray(t)?t:[t]],i=[0];for(;;){if(i[0]>=o[0].length){if(o.length===1)return n;o.shift(),i.shift();continue}const r=o[0][i[0]++];me(r)&&e(r)&&n.push(r),nt(r)&&r.children.length>0&&(i.unshift(0),o.unshift(r.children))}}const fr={tag_name(e){return typeof e=="function"?t=>me(t)&&e(t.name):e==="*"?me:t=>me(t)&&t.name===e},tag_type(e){return typeof e=="function"?t=>e(t.type):t=>t.type===e},tag_contains(e){return typeof e=="function"?t=>uo(t)&&e(t.data):t=>uo(t)&&t.data===e}};function Pa(e,t){return typeof t=="function"?n=>me(n)&&t(n.attribs[e]):n=>me(n)&&n.attribs[e]===t}function Gm(e,t){return n=>e(n)||t(n)}function Su(e){const t=Object.keys(e).map(n=>{const o=e[n];return Object.prototype.hasOwnProperty.call(fr,n)?fr[n](o):Pa(n,o)});return t.length===0?null:t.reduce(Gm)}function ep(e,t){const n=Su(e);return n?n(t):!0}function tp(e,t,n,o=1/0){const i=Su(e);return i?Ai(i,t,n,o):[]}function np(e,t,n=!0){return Array.isArray(t)||(t=[t]),Aa(Pa("id",e),t,n)}function zo(e,t,n=!0,o=1/0){return Ai(fr.tag_name(e),t,n,o)}function op(e,t,n=!0,o=1/0){return Ai(Pa("class",e),t,n,o)}function ip(e,t,n=!0,o=1/0){return Ai(fr.tag_type(e),t,n,o)}function rp(e){let t=e.length;for(;--t>=0;){const n=e[t];if(t>0&&e.lastIndexOf(n,t-1)>=0){e.splice(t,1);continue}for(let o=n.parent;o;o=o.parent)if(e.includes(o)){e.splice(t,1);break}}return e}var Zt;(function(e){e[e.DISCONNECTED=1]="DISCONNECTED",e[e.PRECEDING=2]="PRECEDING",e[e.FOLLOWING=4]="FOLLOWING",e[e.CONTAINS=8]="CONTAINS",e[e.CONTAINED_BY=16]="CONTAINED_BY"})(Zt||(Zt={}));function Tu(e,t){const n=[],o=[];if(e===t)return 0;let i=nt(e)?e:e.parent;for(;i;)n.unshift(i),i=i.parent;for(i=nt(t)?t:t.parent;i;)o.unshift(i),i=i.parent;const r=Math.min(n.length,o.length);let a=0;for(;a<r&&n[a]===o[a];)a++;if(a===0)return Zt.DISCONNECTED;const u=n[a-1],m=u.children,y=n[a],p=o[a];return m.indexOf(y)>m.indexOf(p)?u===t?Zt.FOLLOWING|Zt.CONTAINED_BY:Zt.FOLLOWING:u===e?Zt.PRECEDING|Zt.CONTAINS:Zt.PRECEDING}function Wo(e){return e=e.filter((t,n,o)=>!o.includes(t,n+1)),e.sort((t,n)=>{const o=Tu(t,n);return o&Zt.PRECEDING?-1:o&Zt.FOLLOWING?1:0}),e}function sp(e){const t=mr(up,e);return t?t.name==="feed"?ap(t):cp(t):null}function ap(e){var t;const n=e.children,o={type:"atom",items:zo("entry",n).map(a=>{var u;const{children:m}=a,y={media:Lu(m)};Rt(y,"id","id",m),Rt(y,"title","title",m);const p=(u=mr("link",m))===null||u===void 0?void 0:u.attribs.href;p&&(y.link=p);const N=jn("summary",m)||jn("content",m);N&&(y.description=N);const I=jn("updated",m);return I&&(y.pubDate=new Date(I)),y})};Rt(o,"id","id",n),Rt(o,"title","title",n);const i=(t=mr("link",n))===null||t===void 0?void 0:t.attribs.href;i&&(o.link=i),Rt(o,"description","subtitle",n);const r=jn("updated",n);return r&&(o.updated=new Date(r)),Rt(o,"author","email",n,!0),o}function cp(e){var t,n;const o=(n=(t=mr("channel",e.children))===null||t===void 0?void 0:t.children)!==null&&n!==void 0?n:[],i={type:e.name.substr(0,3),id:"",items:zo("item",e.children).map(a=>{const{children:u}=a,m={media:Lu(u)};Rt(m,"id","guid",u),Rt(m,"title","title",u),Rt(m,"link","link",u),Rt(m,"description","description",u);const y=jn("pubDate",u)||jn("dc:date",u);return y&&(m.pubDate=new Date(y)),m})};Rt(i,"title","title",o),Rt(i,"link","link",o),Rt(i,"description","description",o);const r=jn("lastBuildDate",o);return r&&(i.updated=new Date(r)),Rt(i,"author","managingEditor",o,!0),i}const lp=["url","type","lang"],dp=["fileSize","bitrate","framerate","samplingrate","channels","duration","height","width"];function Lu(e){return zo("media:content",e).map(t=>{const{attribs:n}=t,o={medium:n.medium,isDefault:!!n.isDefault};for(const i of lp)n[i]&&(o[i]=n[i]);for(const i of dp)n[i]&&(o[i]=parseInt(n[i],10));return n.expression&&(o.expression=n.expression),o})}function mr(e,t){return zo(e,t,!0,1)[0]}function jn(e,t,n=!1){return Do(zo(e,t,n,1)).trim()}function Rt(e,t,n,o,i=!1){const r=jn(n,o,i);r&&(e[t]=r)}function up(e){return e==="rss"||e==="feed"||e==="rdf:RDF"}const Vr=Object.freeze(Object.defineProperty({__proto__:null,get DocumentPosition(){return Zt},append:Ym,appendChild:Km,compareDocumentPosition:Tu,existsOne:ku,filter:Ai,find:Ba,findAll:Zm,findOne:Aa,findOneChild:Qm,getAttributeValue:jm,getChildren:Hr,getElementById:np,getElements:tp,getElementsByClassName:op,getElementsByTagName:zo,getElementsByTagType:ip,getFeed:sp,getInnerHTML:Vm,getName:zm,getOuterHTML:Eu,getParent:bu,getSiblings:Iu,getText:nr,hasAttrib:qm,hasChildren:nt,innerText:ur,isCDATA:Fr,isComment:Sa,isDocument:qo,isTag:me,isText:uo,nextElementSibling:La,prepend:Xm,prependChild:Jm,prevElementSibling:Ca,removeElement:go,removeSubsets:rp,replaceElement:Wm,testElement:ep,textContent:Do,uniqueSort:Wo},Symbol.toStringTag,{value:"Module"}));function pr(e){const t=e??(this?this.root():[]);let n="";for(let o=0;o<t.length;o++)n+=Do(t[o]);return n}function fp(e,t){if(t===e)return!1;let n=t;for(;n&&n!==n.parent;)if(n=n.parent,n===e)return!0;return!1}function Ko(e){return e.cheerio!=null}function mp(e){return e.replace(/[._-](\w|$)/g,(t,n)=>n.toUpperCase())}function pp(e){return e.replace(/[A-Z]/g,"-$&").toLowerCase()}function et(e,t){const n=e.length;for(let o=0;o<n;o++)t(e[o],o);return e}var oo;(function(e){e[e.LowerA=97]="LowerA",e[e.LowerZ=122]="LowerZ",e[e.UpperA=65]="UpperA",e[e.UpperZ=90]="UpperZ",e[e.Exclamation=33]="Exclamation"})(oo||(oo={}));function yp(e){const t=e.indexOf("<");if(t===-1||t>e.length-3)return!1;const n=e.charCodeAt(t+1);return(n>=oo.LowerA&&n<=oo.LowerZ||n>=oo.UpperA&&n<=oo.UpperZ||n===oo.Exclamation)&&e.includes(">",t+2)}var Es;const Ii=(Es=Object.hasOwn)!==null&&Es!==void 0?Es:((e,t)=>Object.prototype.hasOwnProperty.call(e,t)),ki=/\s+/,Qs="data-",xa=/^(?:autofocus|autoplay|async|checked|controls|defer|disabled|hidden|loop|multiple|open|readonly|required|scoped|selected)$/i,gp=/^{[^]*}$|^\[[^]*]$/;function yr(e,t,n){var o;if(!(!e||!me(e))){if((o=e.attribs)!==null&&o!==void 0||(e.attribs={}),!t)return e.attribs;if(Ii(e.attribs,t))return!n&&xa.test(t)?t:e.attribs[t];if(e.name==="option"&&t==="value")return pr(e.children);if(e.name==="input"&&(e.attribs.type==="radio"||e.attribs.type==="checkbox")&&t==="value")return"on"}}function No(e,t,n){n===null?Bu(e,t):e.attribs[t]=`${n}`}function hp(e,t){if(typeof e=="object"||t!==void 0){if(typeof t=="function"){if(typeof e!="string")throw new Error("Bad combination of arguments.");return et(this,(n,o)=>{me(n)&&No(n,e,t.call(n,o,n.attribs[e]))})}return et(this,n=>{if(me(n))if(typeof e=="object")for(const o of Object.keys(e)){const i=e[o];No(n,o,i)}else No(n,e,t)})}return arguments.length>1?this:yr(this[0],e,this.options.xmlMode)}function pl(e,t,n){return t in e?e[t]:!n&&xa.test(t)?yr(e,t,!1)!==void 0:yr(e,t,n)}function bs(e,t,n,o){t in e?e[t]=n:No(e,t,!o&&xa.test(t)?n?"":null:`${n}`)}function vp(e,t){var n;if(typeof e=="string"&&t===void 0){const o=this[0];if(!o)return;switch(e){case"style":{const i=this.css(),r=Object.keys(i);for(let a=0;a<r.length;a++)i[a]=r[a];return i.length=r.length,i}case"tagName":case"nodeName":return me(o)?o.name.toUpperCase():void 0;case"href":case"src":{if(!me(o))return;const i=(n=o.attribs)===null||n===void 0?void 0:n[e];return typeof URL<"u"&&(e==="href"&&(o.tagName==="a"||o.tagName==="link")||e==="src"&&(o.tagName==="img"||o.tagName==="iframe"||o.tagName==="audio"||o.tagName==="video"||o.tagName==="source"))&&i!==void 0&&this.options.baseURI?new URL(i,this.options.baseURI).href:i}case"innerText":return ur(o);case"textContent":return Do(o);case"outerHTML":return o.type===pu?this.html():this.clone().wrap("<container />").parent().html();case"innerHTML":return this.html();default:return me(o)?pl(o,e,this.options.xmlMode):void 0}}if(typeof e=="object"||t!==void 0){if(typeof t=="function"){if(typeof e=="object")throw new TypeError("Bad combination of arguments.");return et(this,(o,i)=>{me(o)&&bs(o,e,t.call(o,i,pl(o,e,this.options.xmlMode)),this.options.xmlMode)})}return et(this,o=>{if(me(o))if(typeof e=="object")for(const i of Object.keys(e)){const r=e[i];bs(o,i,r,this.options.xmlMode)}else bs(o,e,t,this.options.xmlMode)})}}function yl(e,t,n){var o;(o=e.data)!==null&&o!==void 0||(e.data={}),typeof t=="object"?Object.assign(e.data,t):typeof t=="string"&&n!==void 0&&(e.data[t]=n)}function wp(e){for(const t of Object.keys(e.attribs)){if(!t.startsWith(Qs))continue;const n=mp(t.slice(Qs.length));Ii(e.data,n)||(e.data[n]=Cu(e.attribs[t]))}return e.data}function Ep(e,t){const n=Qs+pp(t),o=e.data;if(Ii(o,t))return o[t];if(Ii(e.attribs,n))return o[t]=Cu(e.attribs[n])}function Cu(e){if(e==="null")return null;if(e==="true")return!0;if(e==="false")return!1;const t=Number(e);if(e===String(t))return t;if(gp.test(e))try{return JSON.parse(e)}catch{}return e}function bp(e,t){var n;const o=this[0];if(!o||!me(o))return;const i=o;return(n=i.data)!==null&&n!==void 0||(i.data={}),e==null?wp(i):typeof e=="object"||t!==void 0?(et(this,r=>{me(r)&&(typeof e=="object"?yl(r,e):yl(r,e,t))}),this):Ep(i,e)}function Ip(e){const t=arguments.length===0,n=this[0];if(!n||!me(n))return t?void 0:this;switch(n.name){case"textarea":return this.text(e);case"select":{const o=this.find("option:selected");if(!t){if(this.attr("multiple")==null&&typeof e=="object")return this;this.find("option").removeAttr("selected");const i=typeof e=="object"?e:[e];for(const r of i)this.find(`option[value="${r}"]`).attr("selected","");return this}return this.attr("multiple")?o.toArray().map(i=>pr(i.children)):o.attr("value")}case"input":case"option":return t?this.attr("value"):this.attr("value",e)}}function Bu(e,t){!e.attribs||!Ii(e.attribs,t)||delete e.attribs[t]}function gr(e){return e?e.trim().split(ki):[]}function kp(e){const t=gr(e);for(const n of t)et(this,o=>{me(o)&&Bu(o,n)});return this}function Sp(e){return this.toArray().some(t=>{const n=me(t)&&t.attribs.class;let o=-1;if(n&&e.length>0)for(;(o=n.indexOf(e,o+1))>-1;){const i=o+e.length;if((o===0||ki.test(n[o-1]))&&(i===n.length||ki.test(n[i])))return!0}return!1})}function Au(e){if(typeof e=="function")return et(this,(o,i)=>{if(me(o)){const r=o.attribs.class||"";Au.call([o],e.call(o,i,r))}});if(!e||typeof e!="string")return this;const t=e.split(ki),n=this.length;for(let o=0;o<n;o++){const i=this[o];if(!me(i))continue;const r=yr(i,"class",!1);if(r){let a=` ${r} `;for(const u of t){const m=`${u} `;a.includes(` ${m}`)||(a+=m)}No(i,"class",a.trim())}else No(i,"class",t.join(" ").trim())}return this}function Pu(e){if(typeof e=="function")return et(this,(i,r)=>{me(i)&&Pu.call([i],e.call(i,r,i.attribs.class||""))});const t=gr(e),n=t.length,o=arguments.length===0;return et(this,i=>{if(me(i))if(o)i.attribs.class="";else{const r=gr(i.attribs.class);let a=!1;for(let u=0;u<n;u++){const m=r.indexOf(t[u]);m!==-1&&(r.splice(m,1),a=!0,u--)}a&&(i.attribs.class=r.join(" "))}})}function xu(e,t){if(typeof e=="function")return et(this,(a,u)=>{me(a)&&xu.call([a],e.call(a,u,a.attribs.class||"",t),t)});if(!e||typeof e!="string")return this;const n=e.split(ki),o=n.length,i=typeof t=="boolean"?t?1:-1:0,r=this.length;for(let a=0;a<r;a++){const u=this[a];if(!me(u))continue;const m=gr(u.attribs.class);for(let y=0;y<o;y++){const p=m.indexOf(n[y]);i>=0&&p===-1?m.push(n[y]):i<=0&&p!==-1&&m.splice(p,1)}u.attribs.class=m.join(" ")}return this}const Tp=Object.freeze(Object.defineProperty({__proto__:null,addClass:Au,attr:hp,data:bp,hasClass:Sp,prop:vp,removeAttr:kp,removeClass:Pu,toggleClass:xu,val:Ip},Symbol.toStringTag,{value:"Module"}));var le;(function(e){e.Attribute="attribute",e.Pseudo="pseudo",e.PseudoElement="pseudo-element",e.Tag="tag",e.Universal="universal",e.Adjacent="adjacent",e.Child="child",e.Descendant="descendant",e.Parent="parent",e.Sibling="sibling",e.ColumnCombinator="column-combinator"})(le||(le={}));var ut;(function(e){e.Any="any",e.Element="element",e.End="end",e.Equals="equals",e.Exists="exists",e.Hyphen="hyphen",e.Not="not",e.Start="start"})(ut||(ut={}));const gl=/^[^\\#]?(?:\\(?:[\da-f]{1,6}\s?|.)|[\w\-\u00b0-\uFFFF])+/,Lp=/\\([\da-f]{1,6}\s?|(\s)|.)/gi,Cp=new Map([[126,ut.Element],[94,ut.Start],[36,ut.End],[42,ut.Any],[33,ut.Not],[124,ut.Hyphen]]),Bp=new Set(["has","not","matches","is","where","host","host-context"]);function fi(e){switch(e.type){case le.Adjacent:case le.Child:case le.Descendant:case le.Parent:case le.Sibling:case le.ColumnCombinator:return!0;default:return!1}}const Ap=new Set(["contains","icontains"]);function Pp(e,t,n){const o=parseInt(t,16)-65536;return o!==o||n?t:o<0?String.fromCharCode(o+65536):String.fromCharCode(o>>10|55296,o&1023|56320)}function si(e){return e.replace(Lp,Pp)}function Is(e){return e===39||e===34}function hl(e){return e===32||e===9||e===10||e===12||e===13}function jr(e){const t=[],n=$u(t,`${e}`,0);if(n<e.length)throw new Error(`Unmatched selector: ${e.slice(n)}`);return t}function $u(e,t,n){let o=[];function i(I){const k=t.slice(n+I).match(gl);if(!k)throw new Error(`Expected name, found ${t.slice(n)}`);const[A]=k;return n+=I+A.length,si(A)}function r(I){for(n+=I;n<t.length&&hl(t.charCodeAt(n));)n++}function a(){n+=1;const I=n;let k=1;for(;k>0&&n<t.length;n++)t.charCodeAt(n)===40&&!u(n)?k++:t.charCodeAt(n)===41&&!u(n)&&k--;if(k)throw new Error("Parenthesis not matched");return si(t.slice(I,n-1))}function u(I){let k=0;for(;t.charCodeAt(--I)===92;)k++;return(k&1)===1}function m(){if(o.length>0&&fi(o[o.length-1]))throw new Error("Did not expect successive traversals.")}function y(I){if(o.length>0&&o[o.length-1].type===le.Descendant){o[o.length-1].type=I;return}m(),o.push({type:I})}function p(I,k){o.push({type:le.Attribute,name:I,action:k,value:i(1),namespace:null,ignoreCase:"quirks"})}function N(){if(o.length&&o[o.length-1].type===le.Descendant&&o.pop(),o.length===0)throw new Error("Empty sub-selector");e.push(o)}if(r(0),t.length===n)return n;e:for(;n<t.length;){const I=t.charCodeAt(n);switch(I){case 32:case 9:case 10:case 12:case 13:{(o.length===0||o[0].type!==le.Descendant)&&(m(),o.push({type:le.Descendant})),r(1);break}case 62:{y(le.Child),r(1);break}case 60:{y(le.Parent),r(1);break}case 126:{y(le.Sibling),r(1);break}case 43:{y(le.Adjacent),r(1);break}case 46:{p("class",ut.Element);break}case 35:{p("id",ut.Equals);break}case 91:{r(1);let k,A=null;t.charCodeAt(n)===124?k=i(1):t.startsWith("*|",n)?(A="*",k=i(2)):(k=i(0),t.charCodeAt(n)===124&&t.charCodeAt(n+1)!==61&&(A=k,k=i(1))),r(0);let U=ut.Exists;const W=Cp.get(t.charCodeAt(n));if(W){if(U=W,t.charCodeAt(n+1)!==61)throw new Error("Expected `=`");r(2)}else t.charCodeAt(n)===61&&(U=ut.Equals,r(1));let Y="",ae=null;if(U!=="exists"){if(Is(t.charCodeAt(n))){const ve=t.charCodeAt(n);let Se=n+1;for(;Se<t.length&&(t.charCodeAt(Se)!==ve||u(Se));)Se+=1;if(t.charCodeAt(Se)!==ve)throw new Error("Attribute value didn't end");Y=si(t.slice(n+1,Se)),n=Se+1}else{const ve=n;for(;n<t.length&&(!hl(t.charCodeAt(n))&&t.charCodeAt(n)!==93||u(n));)n+=1;Y=si(t.slice(ve,n))}r(0);const G=t.charCodeAt(n)|32;G===115?(ae=!1,r(1)):G===105&&(ae=!0,r(1))}if(t.charCodeAt(n)!==93)throw new Error("Attribute selector didn't terminate");n+=1;const Ce={type:le.Attribute,name:k,action:U,value:Y,namespace:A,ignoreCase:ae};o.push(Ce);break}case 58:{if(t.charCodeAt(n+1)===58){o.push({type:le.PseudoElement,name:i(2).toLowerCase(),data:t.charCodeAt(n)===40?a():null});continue}const k=i(1).toLowerCase();let A=null;if(t.charCodeAt(n)===40)if(Bp.has(k)){if(Is(t.charCodeAt(n+1)))throw new Error(`Pseudo-selector ${k} cannot be quoted`);if(A=[],n=$u(A,t,n+1),t.charCodeAt(n)!==41)throw new Error(`Missing closing parenthesis in :${k} (${t})`);n+=1}else{if(A=a(),Ap.has(k)){const U=A.charCodeAt(0);U===A.charCodeAt(A.length-1)&&Is(U)&&(A=A.slice(1,-1))}A=si(A)}o.push({type:le.Pseudo,name:k,data:A});break}case 44:{N(),o=[],r(1);break}default:{if(t.startsWith("/*",n)){const U=t.indexOf("*/",n+2);if(U<0)throw new Error("Comment was not terminated");n=U+2,o.length===0&&r(0);break}let k=null,A;if(I===42)n+=1,A="*";else if(I===124){if(A="",t.charCodeAt(n+1)===124){y(le.ColumnCombinator),r(2);break}}else if(gl.test(t.slice(n)))A=i(0);else break e;t.charCodeAt(n)===124&&t.charCodeAt(n+1)!==124&&(k=A,t.charCodeAt(n+1)===42?(A="*",n+=2):A=i(1)),o.push(A==="*"?{type:le.Universal,namespace:k}:{type:le.Tag,name:A,namespace:k})}}}return N(),n}function xp(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var ks,vl;function $p(){return vl||(vl=1,ks={trueFunc:function(){return!0},falseFunc:function(){return!1}}),ks}var hr=$p();const Be=xp(hr),Nu=new Map([[le.Universal,50],[le.Tag,30],[le.Attribute,1],[le.Pseudo,0]]);function $a(e){return!Nu.has(e.type)}const Np=new Map([[ut.Exists,10],[ut.Equals,8],[ut.Not,7],[ut.Start,6],[ut.End,6],[ut.Any,5]]);function Mp(e){const t=e.map(Mu);for(let n=1;n<e.length;n++){const o=t[n];if(!(o<0))for(let i=n-1;i>=0&&o<t[i];i--){const r=e[i+1];e[i+1]=e[i],e[i]=r,t[i+1]=t[i],t[i]=o}}}function Mu(e){var t,n;let o=(t=Nu.get(e.type))!==null&&t!==void 0?t:-1;return e.type===le.Attribute?(o=(n=Np.get(e.action))!==null&&n!==void 0?n:4,e.action===ut.Equals&&e.name==="id"&&(o=9),e.ignoreCase&&(o>>=1)):e.type===le.Pseudo&&(e.data?e.name==="has"||e.name==="contains"?o=0:Array.isArray(e.data)?(o=Math.min(...e.data.map(i=>Math.min(...i.map(Mu)))),o<0&&(o=0)):o=2:o=3),o}const Rp=/[-[\]{}()*+?.,\\^$|#\s]/g;function wl(e){return e.replace(Rp,"\\$&")}const _p=new Set(["accept","accept-charset","align","alink","axis","bgcolor","charset","checked","clear","codetype","color","compact","declare","defer","dir","direction","disabled","enctype","face","frame","hreflang","http-equiv","lang","language","link","media","method","multiple","nohref","noresize","noshade","nowrap","readonly","rel","rev","rules","scope","scrolling","selected","shape","target","text","type","valign","valuetype","vlink"]);function eo(e,t){return typeof e.ignoreCase=="boolean"?e.ignoreCase:e.ignoreCase==="quirks"?!!t.quirksMode:!t.xmlMode&&_p.has(e.name)}const Up={equals(e,t,n){const{adapter:o}=n,{name:i}=t;let{value:r}=t;return eo(t,n)?(r=r.toLowerCase(),a=>{const u=o.getAttributeValue(a,i);return u!=null&&u.length===r.length&&u.toLowerCase()===r&&e(a)}):a=>o.getAttributeValue(a,i)===r&&e(a)},hyphen(e,t,n){const{adapter:o}=n,{name:i}=t;let{value:r}=t;const a=r.length;return eo(t,n)?(r=r.toLowerCase(),function(m){const y=o.getAttributeValue(m,i);return y!=null&&(y.length===a||y.charAt(a)==="-")&&y.substr(0,a).toLowerCase()===r&&e(m)}):function(m){const y=o.getAttributeValue(m,i);return y!=null&&(y.length===a||y.charAt(a)==="-")&&y.substr(0,a)===r&&e(m)}},element(e,t,n){const{adapter:o}=n,{name:i,value:r}=t;if(/\s/.test(r))return Be.falseFunc;const a=new RegExp(`(?:^|\\s)${wl(r)}(?:$|\\s)`,eo(t,n)?"i":"");return function(m){const y=o.getAttributeValue(m,i);return y!=null&&y.length>=r.length&&a.test(y)&&e(m)}},exists(e,{name:t},{adapter:n}){return o=>n.hasAttrib(o,t)&&e(o)},start(e,t,n){const{adapter:o}=n,{name:i}=t;let{value:r}=t;const a=r.length;return a===0?Be.falseFunc:eo(t,n)?(r=r.toLowerCase(),u=>{const m=o.getAttributeValue(u,i);return m!=null&&m.length>=a&&m.substr(0,a).toLowerCase()===r&&e(u)}):u=>{var m;return!!(!((m=o.getAttributeValue(u,i))===null||m===void 0)&&m.startsWith(r))&&e(u)}},end(e,t,n){const{adapter:o}=n,{name:i}=t;let{value:r}=t;const a=-r.length;return a===0?Be.falseFunc:eo(t,n)?(r=r.toLowerCase(),u=>{var m;return((m=o.getAttributeValue(u,i))===null||m===void 0?void 0:m.substr(a).toLowerCase())===r&&e(u)}):u=>{var m;return!!(!((m=o.getAttributeValue(u,i))===null||m===void 0)&&m.endsWith(r))&&e(u)}},any(e,t,n){const{adapter:o}=n,{name:i,value:r}=t;if(r==="")return Be.falseFunc;if(eo(t,n)){const a=new RegExp(wl(r),"i");return function(m){const y=o.getAttributeValue(m,i);return y!=null&&y.length>=r.length&&a.test(y)&&e(m)}}return a=>{var u;return!!(!((u=o.getAttributeValue(a,i))===null||u===void 0)&&u.includes(r))&&e(a)}},not(e,t,n){const{adapter:o}=n,{name:i}=t;let{value:r}=t;return r===""?a=>!!o.getAttributeValue(a,i)&&e(a):eo(t,n)?(r=r.toLowerCase(),a=>{const u=o.getAttributeValue(a,i);return(u==null||u.length!==r.length||u.toLowerCase()!==r)&&e(a)}):a=>o.getAttributeValue(a,i)!==r&&e(a)}},Op=new Set([9,10,12,13,32]),El=48,Dp=57;function Fp(e){if(e=e.trim().toLowerCase(),e==="even")return[2,0];if(e==="odd")return[2,1];let t=0,n=0,o=r(),i=a();if(t<e.length&&e.charAt(t)==="n"&&(t++,n=o*(i??1),u(),t<e.length?(o=r(),u(),i=a()):o=i=0),i===null||t<e.length)throw new Error(`n-th rule couldn't be parsed ('${e}')`);return[n,o*i];function r(){return e.charAt(t)==="-"?(t++,-1):(e.charAt(t)==="+"&&t++,1)}function a(){const m=t;let y=0;for(;t<e.length&&e.charCodeAt(t)>=El&&e.charCodeAt(t)<=Dp;)y=y*10+(e.charCodeAt(t)-El),t++;return t===m?null:y}function u(){for(;t<e.length&&Op.has(e.charCodeAt(t));)t++}}function Hp(e){const t=e[0],n=e[1]-1;if(n<0&&t<=0)return Be.falseFunc;if(t===-1)return r=>r<=n;if(t===0)return r=>r===n;if(t===1)return n<0?Be.trueFunc:r=>r>=n;const o=Math.abs(t),i=(n%o+o)%o;return t>1?r=>r>=n&&r%o===i:r=>r<=n&&r%o===i}function Ji(e){return Hp(Fp(e))}function Xi(e,t){return n=>{const o=t.getParent(n);return o!=null&&t.isTag(o)&&e(n)}}const Zs={contains(e,t,{adapter:n}){return function(i){return e(i)&&n.getText(i).includes(t)}},icontains(e,t,{adapter:n}){const o=t.toLowerCase();return function(r){return e(r)&&n.getText(r).toLowerCase().includes(o)}},"nth-child"(e,t,{adapter:n,equals:o}){const i=Ji(t);return i===Be.falseFunc?Be.falseFunc:i===Be.trueFunc?Xi(e,n):function(a){const u=n.getSiblings(a);let m=0;for(let y=0;y<u.length&&!o(a,u[y]);y++)n.isTag(u[y])&&m++;return i(m)&&e(a)}},"nth-last-child"(e,t,{adapter:n,equals:o}){const i=Ji(t);return i===Be.falseFunc?Be.falseFunc:i===Be.trueFunc?Xi(e,n):function(a){const u=n.getSiblings(a);let m=0;for(let y=u.length-1;y>=0&&!o(a,u[y]);y--)n.isTag(u[y])&&m++;return i(m)&&e(a)}},"nth-of-type"(e,t,{adapter:n,equals:o}){const i=Ji(t);return i===Be.falseFunc?Be.falseFunc:i===Be.trueFunc?Xi(e,n):function(a){const u=n.getSiblings(a);let m=0;for(let y=0;y<u.length;y++){const p=u[y];if(o(a,p))break;n.isTag(p)&&n.getName(p)===n.getName(a)&&m++}return i(m)&&e(a)}},"nth-last-of-type"(e,t,{adapter:n,equals:o}){const i=Ji(t);return i===Be.falseFunc?Be.falseFunc:i===Be.trueFunc?Xi(e,n):function(a){const u=n.getSiblings(a);let m=0;for(let y=u.length-1;y>=0;y--){const p=u[y];if(o(a,p))break;n.isTag(p)&&n.getName(p)===n.getName(a)&&m++}return i(m)&&e(a)}},root(e,t,{adapter:n}){return o=>{const i=n.getParent(o);return(i==null||!n.isTag(i))&&e(o)}},scope(e,t,n,o){const{equals:i}=n;return!o||o.length===0?Zs.root(e,t,n):o.length===1?r=>i(o[0],r)&&e(r):r=>o.includes(r)&&e(r)},hover:Ss("isHovered"),visited:Ss("isVisited"),active:Ss("isActive")};function Ss(e){return function(n,o,{adapter:i}){const r=i[e];return typeof r!="function"?Be.falseFunc:function(u){return r(u)&&n(u)}}}const bl={empty(e,{adapter:t}){return!t.getChildren(e).some(n=>t.isTag(n)||t.getText(n)!=="")},"first-child"(e,{adapter:t,equals:n}){if(t.prevElementSibling)return t.prevElementSibling(e)==null;const o=t.getSiblings(e).find(i=>t.isTag(i));return o!=null&&n(e,o)},"last-child"(e,{adapter:t,equals:n}){const o=t.getSiblings(e);for(let i=o.length-1;i>=0;i--){if(n(e,o[i]))return!0;if(t.isTag(o[i]))break}return!1},"first-of-type"(e,{adapter:t,equals:n}){const o=t.getSiblings(e),i=t.getName(e);for(let r=0;r<o.length;r++){const a=o[r];if(n(e,a))return!0;if(t.isTag(a)&&t.getName(a)===i)break}return!1},"last-of-type"(e,{adapter:t,equals:n}){const o=t.getSiblings(e),i=t.getName(e);for(let r=o.length-1;r>=0;r--){const a=o[r];if(n(e,a))return!0;if(t.isTag(a)&&t.getName(a)===i)break}return!1},"only-of-type"(e,{adapter:t,equals:n}){const o=t.getName(e);return t.getSiblings(e).every(i=>n(e,i)||!t.isTag(i)||t.getName(i)!==o)},"only-child"(e,{adapter:t,equals:n}){return t.getSiblings(e).every(o=>n(e,o)||!t.isTag(o))}};function Il(e,t,n,o){if(n===null){if(e.length>o)throw new Error(`Pseudo-class :${t} requires an argument`)}else if(e.length===o)throw new Error(`Pseudo-class :${t} doesn't have any arguments`)}const Vp={"any-link":":is(a, area, link)[href]",link:":any-link:not(:visited)",disabled:`:is(
        :is(button, input, select, textarea, optgroup, option)[disabled],
        optgroup[disabled] > option,
        fieldset[disabled]:not(fieldset[disabled] legend:first-of-type *)
    )`,enabled:":not(:disabled)",checked:":is(:is(input[type=radio], input[type=checkbox])[checked], option:selected)",required:":is(input, select, textarea)[required]",optional:":is(input, select, textarea):not([required])",selected:"option:is([selected], select:not([multiple]):not(:has(> option[selected])) > :first-of-type)",checkbox:"[type=checkbox]",file:"[type=file]",password:"[type=password]",radio:"[type=radio]",reset:"[type=reset]",image:"[type=image]",submit:"[type=submit]",parent:":not(:empty)",header:":is(h1, h2, h3, h4, h5, h6)",button:":is(button, input[type=button])",input:":is(input, textarea, select, button)",text:"input:is(:not([type!='']), [type=text])"},Ru={};function jp(e,t){return e===Be.falseFunc?Be.falseFunc:n=>t.isTag(n)&&e(n)}function _u(e,t){const n=t.getSiblings(e);if(n.length<=1)return[];const o=n.indexOf(e);return o<0||o===n.length-1?[]:n.slice(o+1).filter(t.isTag)}function Gs(e){return{xmlMode:!!e.xmlMode,lowerCaseAttributeNames:!!e.lowerCaseAttributeNames,lowerCaseTags:!!e.lowerCaseTags,quirksMode:!!e.quirksMode,cacheResults:!!e.cacheResults,pseudos:e.pseudos,adapter:e.adapter,equals:e.equals}}const Ts=(e,t,n,o,i)=>{const r=i(t,Gs(n),o);return r===Be.trueFunc?e:r===Be.falseFunc?Be.falseFunc:a=>r(a)&&e(a)},Ls={is:Ts,matches:Ts,where:Ts,not(e,t,n,o,i){const r=i(t,Gs(n),o);return r===Be.falseFunc?e:r===Be.trueFunc?Be.falseFunc:a=>!r(a)&&e(a)},has(e,t,n,o,i){const{adapter:r}=n,a=Gs(n);a.relativeSelector=!0;const u=t.some(p=>p.some($a))?[Ru]:void 0,m=i(t,a,u);if(m===Be.falseFunc)return Be.falseFunc;const y=jp(m,r);if(u&&m!==Be.trueFunc){const{shouldTestNextSiblings:p=!1}=m;return N=>{if(!e(N))return!1;u[0]=N;const I=r.getChildren(N),k=p?[...I,..._u(N,r)]:I;return r.existsOne(y,k)}}return p=>e(p)&&r.existsOne(y,r.getChildren(p))}};function qp(e,t,n,o,i){var r;const{name:a,data:u}=t;if(Array.isArray(u)){if(!(a in Ls))throw new Error(`Unknown pseudo-class :${a}(${u})`);return Ls[a](e,u,n,o,i)}const m=(r=n.pseudos)===null||r===void 0?void 0:r[a],y=typeof m=="string"?m:Vp[a];if(typeof y=="string"){if(u!=null)throw new Error(`Pseudo ${a} doesn't have any arguments`);const p=jr(y);return Ls.is(e,p,n,o,i)}if(typeof m=="function")return Il(m,a,u,1),p=>m(p,u)&&e(p);if(a in Zs)return Zs[a](e,u,n,o);if(a in bl){const p=bl[a];return Il(p,a,u,2),N=>p(N,n,u)&&e(N)}throw new Error(`Unknown pseudo-class :${a}`)}function Cs(e,t){const n=t.getParent(e);return n&&t.isTag(n)?n:null}function zp(e,t,n,o,i){const{adapter:r,equals:a}=n;switch(t.type){case le.PseudoElement:throw new Error("Pseudo-elements are not supported by css-select");case le.ColumnCombinator:throw new Error("Column combinators are not yet supported by css-select");case le.Attribute:{if(t.namespace!=null)throw new Error("Namespaced attributes are not yet supported by css-select");return(!n.xmlMode||n.lowerCaseAttributeNames)&&(t.name=t.name.toLowerCase()),Up[t.action](e,t,n)}case le.Pseudo:return qp(e,t,n,o,i);case le.Tag:{if(t.namespace!=null)throw new Error("Namespaced tag names are not yet supported by css-select");let{name:u}=t;return(!n.xmlMode||n.lowerCaseTags)&&(u=u.toLowerCase()),function(y){return r.getName(y)===u&&e(y)}}case le.Descendant:{if(n.cacheResults===!1||typeof WeakSet>"u")return function(y){let p=y;for(;p=Cs(p,r);)if(e(p))return!0;return!1};const u=new WeakSet;return function(y){let p=y;for(;p=Cs(p,r);)if(!u.has(p)){if(r.isTag(p)&&e(p))return!0;u.add(p)}return!1}}case"_flexibleDescendant":return function(m){let y=m;do if(e(y))return!0;while(y=Cs(y,r));return!1};case le.Parent:return function(m){return r.getChildren(m).some(y=>r.isTag(y)&&e(y))};case le.Child:return function(m){const y=r.getParent(m);return y!=null&&r.isTag(y)&&e(y)};case le.Sibling:return function(m){const y=r.getSiblings(m);for(let p=0;p<y.length;p++){const N=y[p];if(a(m,N))break;if(r.isTag(N)&&e(N))return!0}return!1};case le.Adjacent:return r.prevElementSibling?function(m){const y=r.prevElementSibling(m);return y!=null&&e(y)}:function(m){const y=r.getSiblings(m);let p;for(let N=0;N<y.length;N++){const I=y[N];if(a(m,I))break;r.isTag(I)&&(p=I)}return!!p&&e(p)};case le.Universal:{if(t.namespace!=null&&t.namespace!=="*")throw new Error("Namespaced universal selectors are not yet supported by css-select");return e}}}function Uu(e){return e.type===le.Pseudo&&(e.name==="scope"||Array.isArray(e.data)&&e.data.some(t=>t.some(Uu)))}const Wp={type:le.Descendant},Kp={type:"_flexibleDescendant"},Yp={type:le.Pseudo,name:"scope",data:null};function Jp(e,{adapter:t},n){const o=!!n?.every(i=>{const r=t.isTag(i)&&t.getParent(i);return i===Ru||r&&t.isTag(r)});for(const i of e){if(!(i.length>0&&$a(i[0])&&i[0].type!==le.Descendant))if(o&&!i.some(Uu))i.unshift(Wp);else continue;i.unshift(Yp)}}function Ou(e,t,n){var o;e.forEach(Mp),n=(o=t.context)!==null&&o!==void 0?o:n;const i=Array.isArray(n),r=n&&(Array.isArray(n)?n:[n]);if(t.relativeSelector!==!1)Jp(e,t,r);else if(e.some(m=>m.length>0&&$a(m[0])))throw new Error("Relative selectors are not allowed when the `relativeSelector` option is disabled");let a=!1;const u=e.map(m=>{if(m.length>=2){const[y,p]=m;y.type!==le.Pseudo||y.name!=="scope"||(i&&p.type===le.Descendant?m[1]=Kp:(p.type===le.Adjacent||p.type===le.Sibling)&&(a=!0))}return Xp(m,t,r)}).reduce(Qp,Be.falseFunc);return u.shouldTestNextSiblings=a,u}function Xp(e,t,n){var o;return e.reduce((i,r)=>i===Be.falseFunc?Be.falseFunc:zp(i,r,t,n,Ou),(o=t.rootFunc)!==null&&o!==void 0?o:Be.trueFunc)}function Qp(e,t){return t===Be.falseFunc||e===Be.trueFunc?e:e===Be.falseFunc||t===Be.trueFunc?t:function(o){return e(o)||t(o)}}const Du=(e,t)=>e===t,Zp={adapter:Vr,equals:Du};function Gp(e){var t,n,o,i;const r=e??Zp;return(t=r.adapter)!==null&&t!==void 0||(r.adapter=Vr),(n=r.equals)!==null&&n!==void 0||(r.equals=(i=(o=r.adapter)===null||o===void 0?void 0:o.equals)!==null&&i!==void 0?i:Du),r}function ey(e){return function(n,o,i){const r=Gp(o);return e(n,r,i)}}const Na=ey(Ou);function Fu(e,t,n=!1){return n&&(e=ty(e,t)),Array.isArray(e)?t.removeSubsets(e):t.getChildren(e)}function ty(e,t){const n=Array.isArray(e)?e.slice(0):[e],o=n.length;for(let i=0;i<o;i++){const r=_u(n[i],t);n.push(...r)}return n}const ny=new Set(["first","last","eq","gt","nth","lt","even","odd"]);function vr(e){return e.type!=="pseudo"?!1:ny.has(e.name)?!0:e.name==="not"&&Array.isArray(e.data)?e.data.some(t=>t.some(vr)):!1}function oy(e,t,n){const o=t!=null?parseInt(t,10):NaN;switch(e){case"first":return 1;case"nth":case"eq":return isFinite(o)?o>=0?o+1:1/0:0;case"lt":return isFinite(o)?o>=0?Math.min(o,n):1/0:0;case"gt":return isFinite(o)?1/0:0;case"odd":return 2*n;case"even":return 2*n-1;case"last":case"not":return 1/0}}function iy(e){for(;e.parent;)e=e.parent;return e}function Ma(e){const t=[],n=[];for(const o of e)o.some(vr)?t.push(o):n.push(o);return[n,t]}const ry={type:le.Universal,namespace:null},sy={type:le.Pseudo,name:"scope",data:null};function Hu(e,t,n={}){return Vu([e],t,n)}function Vu(e,t,n={}){if(typeof t=="function")return e.some(t);const[o,i]=Ma(jr(t));return o.length>0&&e.some(Na(o,n))||i.some(r=>zu(r,e,n).length>0)}function ay(e,t,n,o){const i=typeof n=="string"?parseInt(n,10):NaN;switch(e){case"first":case"lt":return t;case"last":return t.length>0?[t[t.length-1]]:t;case"nth":case"eq":return isFinite(i)&&Math.abs(i)<t.length?[i<0?t[t.length+i]:t[i]]:[];case"gt":return isFinite(i)?t.slice(i+1):[];case"even":return t.filter((r,a)=>a%2===0);case"odd":return t.filter((r,a)=>a%2===1);case"not":{const r=new Set(qu(n,t,o));return t.filter(a=>!r.has(a))}}}function ju(e,t,n={}){return qu(jr(e),t,n)}function qu(e,t,n){if(t.length===0)return[];const[o,i]=Ma(e);let r;if(o.length){const a=ta(t,o,n);if(i.length===0)return a;a.length&&(r=new Set(a))}for(let a=0;a<i.length&&r?.size!==t.length;a++){const u=i[a];if((r?t.filter(p=>me(p)&&!r.has(p)):t).length===0)break;const y=zu(u,t,n);if(y.length)if(r)y.forEach(p=>r.add(p));else{if(a===i.length-1)return y;r=new Set(y)}}return typeof r<"u"?r.size===t.length?t:t.filter(a=>r.has(a)):[]}function zu(e,t,n){var o;if(e.some(fi)){const i=(o=n.root)!==null&&o!==void 0?o:iy(t[0]),r={...n,context:t,relativeSelector:!1};return e.push(sy),wr(i,e,r,!0,t.length)}return wr(t,e,n,!1,t.length)}function cy(e,t,n={},o=1/0){if(typeof e=="function")return Wu(t,e);const[i,r]=Ma(jr(e)),a=r.map(u=>wr(t,u,n,!0,o));return i.length&&a.push(ea(t,i,n,o)),a.length===0?[]:a.length===1?a[0]:Wo(a.reduce((u,m)=>[...u,...m]))}function wr(e,t,n,o,i){const r=t.findIndex(vr),a=t.slice(0,r),u=t[r],m=t.length-1===r?i:1/0,y=oy(u.name,u.data,m);if(y===0)return[];const N=(a.length===0&&!Array.isArray(e)?Hr(e).filter(me):a.length===0?(Array.isArray(e)?e:[e]).filter(me):o||a.some(fi)?ea(e,[a],n,y):ta(e,[a],n)).slice(0,y);let I=ay(u.name,N,u.data,n);if(I.length===0||t.length===r+1)return I;const k=t.slice(r+1),A=k.some(fi);if(A){if(fi(k[0])){const{type:U}=k[0];(U===le.Sibling||U===le.Adjacent)&&(I=Fu(I,Vr,!0)),k.unshift(ry)}n={...n,relativeSelector:!1,rootFunc:U=>I.includes(U)}}else n.rootFunc&&n.rootFunc!==hr.trueFunc&&(n={...n,rootFunc:hr.trueFunc});return k.some(vr)?wr(I,k,n,!1,i):A?ea(I,[k],n,i):ta(I,[k],n)}function ea(e,t,n,o){const i=Na(t,n,e);return Wu(e,i,o)}function Wu(e,t,n=1/0){const o=Fu(e,Vr,t.shouldTestNextSiblings);return Ba(i=>me(i)&&t(i),o,!0,n)}function ta(e,t,n){const o=(Array.isArray(e)?e:[e]).filter(me);if(o.length===0)return o;const i=Na(t,n);return i===hr.trueFunc?o:o.filter(i)}const ly=/^\s*[+~]/;function dy(e){if(!e)return this._make([]);if(typeof e!="string"){const t=Ko(e)?e.toArray():[e],n=this.toArray();return this._make(t.filter(o=>n.some(i=>fp(i,o))))}return this._findBySelector(e,Number.POSITIVE_INFINITY)}function uy(e,t){var n;const o=this.toArray(),i=ly.test(e)?o:this.children().toArray(),r={context:o,root:(n=this._root)===null||n===void 0?void 0:n[0],xmlMode:this.options.xmlMode,lowerCaseTags:this.options.lowerCaseTags,lowerCaseAttributeNames:this.options.lowerCaseAttributeNames,pseudos:this.options.pseudos,quirksMode:this.options.quirksMode};return this._make(cy(e,i,r,t))}function Ra(e){return function(t,...n){return function(o){var i;let r=e(t,this);return o&&(r=Oa(r,o,this.options.xmlMode,(i=this._root)===null||i===void 0?void 0:i[0])),this._make(this.length>1&&r.length>1?n.reduce((a,u)=>u(a),r):r)}}}const Pi=Ra((e,t)=>{let n=[];for(let o=0;o<t.length;o++){const i=e(t[o]);i.length>0&&(n=n.concat(i))}return n}),_a=Ra((e,t)=>{const n=[];for(let o=0;o<t.length;o++){const i=e(t[o]);i!==null&&n.push(i)}return n});function Ua(e,...t){let n=null;const o=Ra((i,r)=>{const a=[];return et(r,u=>{for(let m;(m=i(u))&&!n?.(m,a.length);u=m)a.push(m)}),a})(e,...t);return function(i,r){n=typeof i=="string"?u=>Hu(u,i,this.options):i?xi(i):null;const a=o.call(this,r);return n=null,a}}function Yo(e){return e.length>1?Array.from(new Set(e)):e}const fy=_a(({parent:e})=>e&&!qo(e)?e:null,Yo),my=Pi(e=>{const t=[];for(;e.parent&&!qo(e.parent);)t.push(e.parent),e=e.parent;return t},Wo,e=>e.reverse()),py=Ua(({parent:e})=>e&&!qo(e)?e:null,Wo,e=>e.reverse());function yy(e){var t;const n=[];if(!e)return this._make(n);const o={xmlMode:this.options.xmlMode,root:(t=this._root)===null||t===void 0?void 0:t[0]},i=typeof e=="string"?r=>Hu(r,e,o):xi(e);return et(this,r=>{for(r&&!qo(r)&&!me(r)&&(r=r.parent);r&&me(r);){if(i(r,0)){n.includes(r)||n.push(r);break}r=r.parent}}),this._make(n)}const gy=_a(e=>La(e)),hy=Pi(e=>{const t=[];for(;e.next;)e=e.next,me(e)&&t.push(e);return t},Yo),vy=Ua(e=>La(e),Yo),wy=_a(e=>Ca(e)),Ey=Pi(e=>{const t=[];for(;e.prev;)e=e.prev,me(e)&&t.push(e);return t},Yo),by=Ua(e=>Ca(e),Yo),Iy=Pi(e=>Iu(e).filter(t=>me(t)&&t!==e),Wo),ky=Pi(e=>Hr(e).filter(me),Yo);function Sy(){const e=this.toArray().reduce((t,n)=>nt(n)?t.concat(n.children):t,[]);return this._make(e)}function Ty(e){let t=0;const n=this.length;for(;t<n&&e.call(this[t],t,this[t])!==!1;)++t;return this}function Ly(e){let t=[];for(let n=0;n<this.length;n++){const o=this[n],i=e.call(o,n,o);i!=null&&(t=t.concat(i))}return this._make(t)}function xi(e){return typeof e=="function"?(t,n)=>e.call(t,n,t):Ko(e)?t=>Array.prototype.includes.call(e,t):function(t){return e===t}}function Cy(e){var t;return this._make(Oa(this.toArray(),e,this.options.xmlMode,(t=this._root)===null||t===void 0?void 0:t[0]))}function Oa(e,t,n,o){return typeof t=="string"?ju(t,e,{xmlMode:n,root:o}):e.filter(xi(t))}function By(e){const t=this.toArray();return typeof e=="string"?Vu(t.filter(me),e,this.options):e?t.some(xi(e)):!1}function Ay(e){let t=this.toArray();if(typeof e=="string"){const n=new Set(ju(e,t,this.options));t=t.filter(o=>!n.has(o))}else{const n=xi(e);t=t.filter((o,i)=>!n(o,i))}return this._make(t)}function Py(e){return this.filter(typeof e=="string"?`:has(${e})`:(t,n)=>this._make(n).find(e).length>0)}function xy(){return this.length>1?this._make(this[0]):this}function $y(){return this.length>0?this._make(this[this.length-1]):this}function Ny(e){var t;return e=+e,e===0&&this.length<=1?this:(e<0&&(e=this.length+e),this._make((t=this[e])!==null&&t!==void 0?t:[]))}function My(e){return e==null?this.toArray():this[e<0?this.length+e:e]}function Ry(){return Array.prototype.slice.call(this)}function _y(e){let t,n;return e==null?(t=this.parent().children(),n=this[0]):typeof e=="string"?(t=this._make(e),n=this[0]):(t=this,n=Ko(e)?e[0]:e),Array.prototype.indexOf.call(t,n)}function Uy(e,t){return this._make(Array.prototype.slice.call(this,e,t))}function Oy(){var e;return(e=this.prevObject)!==null&&e!==void 0?e:this._make([])}function Dy(e,t){const n=this._make(e,t),o=Wo([...this.get(),...n.get()]);return this._make(o)}function Fy(e){return this.prevObject?this.add(e?this.prevObject.filter(e):this.prevObject):this}const Hy=Object.freeze(Object.defineProperty({__proto__:null,_findBySelector:uy,add:Dy,addBack:Fy,children:ky,closest:yy,contents:Sy,each:Ty,end:Oy,eq:Ny,filter:Cy,filterArray:Oa,find:dy,first:xy,get:My,has:Py,index:_y,is:By,last:$y,map:Ly,next:gy,nextAll:hy,nextUntil:vy,not:Ay,parent:fy,parents:my,parentsUntil:py,prev:wy,prevAll:Ey,prevUntil:by,siblings:Iy,slice:Uy,toArray:Ry},Symbol.toStringTag,{value:"Module"}));var Vy={},qr={};qr.byteLength=zy;qr.toByteArray=Ky;qr.fromByteArray=Xy;var dn=[],Qt=[],jy=typeof Uint8Array<"u"?Uint8Array:Array,Bs="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";for(var Co=0,qy=Bs.length;Co<qy;++Co)dn[Co]=Bs[Co],Qt[Bs.charCodeAt(Co)]=Co;Qt[45]=62;Qt[95]=63;function Ku(e){var t=e.length;if(t%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var n=e.indexOf("=");n===-1&&(n=t);var o=n===t?0:4-n%4;return[n,o]}function zy(e){var t=Ku(e),n=t[0],o=t[1];return(n+o)*3/4-o}function Wy(e,t,n){return(t+n)*3/4-n}function Ky(e){var t,n=Ku(e),o=n[0],i=n[1],r=new jy(Wy(e,o,i)),a=0,u=i>0?o-4:o,m;for(m=0;m<u;m+=4)t=Qt[e.charCodeAt(m)]<<18|Qt[e.charCodeAt(m+1)]<<12|Qt[e.charCodeAt(m+2)]<<6|Qt[e.charCodeAt(m+3)],r[a++]=t>>16&255,r[a++]=t>>8&255,r[a++]=t&255;return i===2&&(t=Qt[e.charCodeAt(m)]<<2|Qt[e.charCodeAt(m+1)]>>4,r[a++]=t&255),i===1&&(t=Qt[e.charCodeAt(m)]<<10|Qt[e.charCodeAt(m+1)]<<4|Qt[e.charCodeAt(m+2)]>>2,r[a++]=t>>8&255,r[a++]=t&255),r}function Yy(e){return dn[e>>18&63]+dn[e>>12&63]+dn[e>>6&63]+dn[e&63]}function Jy(e,t,n){for(var o,i=[],r=t;r<n;r+=3)o=(e[r]<<16&16711680)+(e[r+1]<<8&65280)+(e[r+2]&255),i.push(Yy(o));return i.join("")}function Xy(e){for(var t,n=e.length,o=n%3,i=[],r=16383,a=0,u=n-o;a<u;a+=r)i.push(Jy(e,a,a+r>u?u:a+r));return o===1?(t=e[n-1],i.push(dn[t>>2]+dn[t<<4&63]+"==")):o===2&&(t=(e[n-2]<<8)+e[n-1],i.push(dn[t>>10]+dn[t>>4&63]+dn[t<<2&63]+"=")),i.join("")}var Da={};Da.read=function(e,t,n,o,i){var r,a,u=i*8-o-1,m=(1<<u)-1,y=m>>1,p=-7,N=n?i-1:0,I=n?-1:1,k=e[t+N];for(N+=I,r=k&(1<<-p)-1,k>>=-p,p+=u;p>0;r=r*256+e[t+N],N+=I,p-=8);for(a=r&(1<<-p)-1,r>>=-p,p+=o;p>0;a=a*256+e[t+N],N+=I,p-=8);if(r===0)r=1-y;else{if(r===m)return a?NaN:(k?-1:1)*(1/0);a=a+Math.pow(2,o),r=r-y}return(k?-1:1)*a*Math.pow(2,r-o)};Da.write=function(e,t,n,o,i,r){var a,u,m,y=r*8-i-1,p=(1<<y)-1,N=p>>1,I=i===23?Math.pow(2,-24)-Math.pow(2,-77):0,k=o?0:r-1,A=o?1:-1,U=t<0||t===0&&1/t<0?1:0;for(t=Math.abs(t),isNaN(t)||t===1/0?(u=isNaN(t)?1:0,a=p):(a=Math.floor(Math.log(t)/Math.LN2),t*(m=Math.pow(2,-a))<1&&(a--,m*=2),a+N>=1?t+=I/m:t+=I*Math.pow(2,1-N),t*m>=2&&(a++,m/=2),a+N>=p?(u=0,a=p):a+N>=1?(u=(t*m-1)*Math.pow(2,i),a=a+N):(u=t*Math.pow(2,N-1)*Math.pow(2,i),a=0));i>=8;e[n+k]=u&255,k+=A,u/=256,i-=8);for(a=a<<i|u,y+=i;y>0;e[n+k]=a&255,k+=A,a/=256,y-=8);e[n+k-A]|=U*128};(function(e){const t=qr,n=Da,o=typeof Symbol=="function"&&typeof Symbol.for=="function"?Symbol.for("nodejs.util.inspect.custom"):null;e.Buffer=p,e.SlowBuffer=ve,e.INSPECT_MAX_BYTES=50;const i=2147483647;e.kMaxLength=i;const{Uint8Array:r,ArrayBuffer:a,SharedArrayBuffer:u}=globalThis;p.TYPED_ARRAY_SUPPORT=m(),!p.TYPED_ARRAY_SUPPORT&&typeof console<"u"&&typeof console.error=="function"&&console.error("This browser lacks typed array (Uint8Array) support which is required by `buffer` v5.x. Use `buffer` v4.x if you require old browser support.");function m(){try{const g=new r(1),c={foo:function(){return 42}};return Object.setPrototypeOf(c,r.prototype),Object.setPrototypeOf(g,c),g.foo()===42}catch{return!1}}Object.defineProperty(p.prototype,"parent",{enumerable:!0,get:function(){if(p.isBuffer(this))return this.buffer}}),Object.defineProperty(p.prototype,"offset",{enumerable:!0,get:function(){if(p.isBuffer(this))return this.byteOffset}});function y(g){if(g>i)throw new RangeError('The value "'+g+'" is invalid for option "size"');const c=new r(g);return Object.setPrototypeOf(c,p.prototype),c}function p(g,c,d){if(typeof g=="number"){if(typeof c=="string")throw new TypeError('The "string" argument must be of type string. Received type number');return A(g)}return N(g,c,d)}p.poolSize=8192;function N(g,c,d){if(typeof g=="string")return U(g,c);if(a.isView(g))return Y(g);if(g==null)throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof g);if(yt(g,a)||g&&yt(g.buffer,a)||typeof u<"u"&&(yt(g,u)||g&&yt(g.buffer,u)))return ae(g,c,d);if(typeof g=="number")throw new TypeError('The "value" argument must not be of type number. Received type number');const b=g.valueOf&&g.valueOf();if(b!=null&&b!==g)return p.from(b,c,d);const B=Ce(g);if(B)return B;if(typeof Symbol<"u"&&Symbol.toPrimitive!=null&&typeof g[Symbol.toPrimitive]=="function")return p.from(g[Symbol.toPrimitive]("string"),c,d);throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof g)}p.from=function(g,c,d){return N(g,c,d)},Object.setPrototypeOf(p.prototype,r.prototype),Object.setPrototypeOf(p,r);function I(g){if(typeof g!="number")throw new TypeError('"size" argument must be of type number');if(g<0)throw new RangeError('The value "'+g+'" is invalid for option "size"')}function k(g,c,d){return I(g),g<=0?y(g):c!==void 0?typeof d=="string"?y(g).fill(c,d):y(g).fill(c):y(g)}p.alloc=function(g,c,d){return k(g,c,d)};function A(g){return I(g),y(g<0?0:G(g)|0)}p.allocUnsafe=function(g){return A(g)},p.allocUnsafeSlow=function(g){return A(g)};function U(g,c){if((typeof c!="string"||c==="")&&(c="utf8"),!p.isEncoding(c))throw new TypeError("Unknown encoding: "+c);const d=Se(g,c)|0;let b=y(d);const B=b.write(g,c);return B!==d&&(b=b.slice(0,B)),b}function W(g){const c=g.length<0?0:G(g.length)|0,d=y(c);for(let b=0;b<c;b+=1)d[b]=g[b]&255;return d}function Y(g){if(yt(g,r)){const c=new r(g);return ae(c.buffer,c.byteOffset,c.byteLength)}return W(g)}function ae(g,c,d){if(c<0||g.byteLength<c)throw new RangeError('"offset" is outside of buffer bounds');if(g.byteLength<c+(d||0))throw new RangeError('"length" is outside of buffer bounds');let b;return c===void 0&&d===void 0?b=new r(g):d===void 0?b=new r(g,c):b=new r(g,c,d),Object.setPrototypeOf(b,p.prototype),b}function Ce(g){if(p.isBuffer(g)){const c=G(g.length)|0,d=y(c);return d.length===0||g.copy(d,0,0,c),d}if(g.length!==void 0)return typeof g.length!="number"||Ln(g.length)?y(0):W(g);if(g.type==="Buffer"&&Array.isArray(g.data))return W(g.data)}function G(g){if(g>=i)throw new RangeError("Attempt to allocate Buffer larger than maximum size: 0x"+i.toString(16)+" bytes");return g|0}function ve(g){return+g!=g&&(g=0),p.alloc(+g)}p.isBuffer=function(c){return c!=null&&c._isBuffer===!0&&c!==p.prototype},p.compare=function(c,d){if(yt(c,r)&&(c=p.from(c,c.offset,c.byteLength)),yt(d,r)&&(d=p.from(d,d.offset,d.byteLength)),!p.isBuffer(c)||!p.isBuffer(d))throw new TypeError('The "buf1", "buf2" arguments must be one of type Buffer or Uint8Array');if(c===d)return 0;let b=c.length,B=d.length;for(let R=0,D=Math.min(b,B);R<D;++R)if(c[R]!==d[R]){b=c[R],B=d[R];break}return b<B?-1:B<b?1:0},p.isEncoding=function(c){switch(String(c).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"latin1":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}},p.concat=function(c,d){if(!Array.isArray(c))throw new TypeError('"list" argument must be an Array of Buffers');if(c.length===0)return p.alloc(0);let b;if(d===void 0)for(d=0,b=0;b<c.length;++b)d+=c[b].length;const B=p.allocUnsafe(d);let R=0;for(b=0;b<c.length;++b){let D=c[b];if(yt(D,r))R+D.length>B.length?(p.isBuffer(D)||(D=p.from(D)),D.copy(B,R)):r.prototype.set.call(B,D,R);else if(p.isBuffer(D))D.copy(B,R);else throw new TypeError('"list" argument must be an Array of Buffers');R+=D.length}return B};function Se(g,c){if(p.isBuffer(g))return g.length;if(a.isView(g)||yt(g,a))return g.byteLength;if(typeof g!="string")throw new TypeError('The "string" argument must be one of type string, Buffer, or ArrayBuffer. Received type '+typeof g);const d=g.length,b=arguments.length>2&&arguments[2]===!0;if(!b&&d===0)return 0;let B=!1;for(;;)switch(c){case"ascii":case"latin1":case"binary":return d;case"utf8":case"utf-8":return zn(g).length;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return d*2;case"hex":return d>>>1;case"base64":return ho(g).length;default:if(B)return b?-1:zn(g).length;c=(""+c).toLowerCase(),B=!0}}p.byteLength=Se;function oe(g,c,d){let b=!1;if((c===void 0||c<0)&&(c=0),c>this.length||((d===void 0||d>this.length)&&(d=this.length),d<=0)||(d>>>=0,c>>>=0,d<=c))return"";for(g||(g="utf8");;)switch(g){case"hex":return _e(this,c,d);case"utf8":case"utf-8":return gt(this,c,d);case"ascii":return ge(this,c,d);case"latin1":case"binary":return Te(this,c,d);case"base64":return ft(this,c,d);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return qe(this,c,d);default:if(b)throw new TypeError("Unknown encoding: "+g);g=(g+"").toLowerCase(),b=!0}}p.prototype._isBuffer=!0;function X(g,c,d){const b=g[c];g[c]=g[d],g[d]=b}p.prototype.swap16=function(){const c=this.length;if(c%2!==0)throw new RangeError("Buffer size must be a multiple of 16-bits");for(let d=0;d<c;d+=2)X(this,d,d+1);return this},p.prototype.swap32=function(){const c=this.length;if(c%4!==0)throw new RangeError("Buffer size must be a multiple of 32-bits");for(let d=0;d<c;d+=4)X(this,d,d+3),X(this,d+1,d+2);return this},p.prototype.swap64=function(){const c=this.length;if(c%8!==0)throw new RangeError("Buffer size must be a multiple of 64-bits");for(let d=0;d<c;d+=8)X(this,d,d+7),X(this,d+1,d+6),X(this,d+2,d+5),X(this,d+3,d+4);return this},p.prototype.toString=function(){const c=this.length;return c===0?"":arguments.length===0?gt(this,0,c):oe.apply(this,arguments)},p.prototype.toLocaleString=p.prototype.toString,p.prototype.equals=function(c){if(!p.isBuffer(c))throw new TypeError("Argument must be a Buffer");return this===c?!0:p.compare(this,c)===0},p.prototype.inspect=function(){let c="";const d=e.INSPECT_MAX_BYTES;return c=this.toString("hex",0,d).replace(/(.{2})/g,"$1 ").trim(),this.length>d&&(c+=" ... "),"<Buffer "+c+">"},o&&(p.prototype[o]=p.prototype.inspect),p.prototype.compare=function(c,d,b,B,R){if(yt(c,r)&&(c=p.from(c,c.offset,c.byteLength)),!p.isBuffer(c))throw new TypeError('The "target" argument must be one of type Buffer or Uint8Array. Received type '+typeof c);if(d===void 0&&(d=0),b===void 0&&(b=c?c.length:0),B===void 0&&(B=0),R===void 0&&(R=this.length),d<0||b>c.length||B<0||R>this.length)throw new RangeError("out of range index");if(B>=R&&d>=b)return 0;if(B>=R)return-1;if(d>=b)return 1;if(d>>>=0,b>>>=0,B>>>=0,R>>>=0,this===c)return 0;let D=R-B,ke=b-d;const S=Math.min(D,ke),P=this.slice(B,R),$=c.slice(d,b);for(let C=0;C<S;++C)if(P[C]!==$[C]){D=P[C],ke=$[C];break}return D<ke?-1:ke<D?1:0};function ye(g,c,d,b,B){if(g.length===0)return-1;if(typeof d=="string"?(b=d,d=0):d>2147483647?d=2147483647:d<-2147483648&&(d=-2147483648),d=+d,Ln(d)&&(d=B?0:g.length-1),d<0&&(d=g.length+d),d>=g.length){if(B)return-1;d=g.length-1}else if(d<0)if(B)d=0;else return-1;if(typeof c=="string"&&(c=p.from(c,b)),p.isBuffer(c))return c.length===0?-1:Z(g,c,d,b,B);if(typeof c=="number")return c=c&255,typeof r.prototype.indexOf=="function"?B?r.prototype.indexOf.call(g,c,d):r.prototype.lastIndexOf.call(g,c,d):Z(g,[c],d,b,B);throw new TypeError("val must be string, number or Buffer")}function Z(g,c,d,b,B){let R=1,D=g.length,ke=c.length;if(b!==void 0&&(b=String(b).toLowerCase(),b==="ucs2"||b==="ucs-2"||b==="utf16le"||b==="utf-16le")){if(g.length<2||c.length<2)return-1;R=2,D/=2,ke/=2,d/=2}function S($,C){return R===1?$[C]:$.readUInt16BE(C*R)}let P;if(B){let $=-1;for(P=d;P<D;P++)if(S(g,P)===S(c,$===-1?0:P-$)){if($===-1&&($=P),P-$+1===ke)return $*R}else $!==-1&&(P-=P-$),$=-1}else for(d+ke>D&&(d=D-ke),P=d;P>=0;P--){let $=!0;for(let C=0;C<ke;C++)if(S(g,P+C)!==S(c,C)){$=!1;break}if($)return P}return-1}p.prototype.includes=function(c,d,b){return this.indexOf(c,d,b)!==-1},p.prototype.indexOf=function(c,d,b){return ye(this,c,d,b,!0)},p.prototype.lastIndexOf=function(c,d,b){return ye(this,c,d,b,!1)};function Fe(g,c,d,b){d=Number(d)||0;const B=g.length-d;b?(b=Number(b),b>B&&(b=B)):b=B;const R=c.length;b>R/2&&(b=R/2);let D;for(D=0;D<b;++D){const ke=parseInt(c.substr(D*2,2),16);if(Ln(ke))return D;g[d+D]=ke}return D}function Ae(g,c,d,b){return rn(zn(c,g.length-d),g,d,b)}function Et(g,c,d,b){return rn(Wn(c),g,d,b)}function It(g,c,d,b){return rn(ho(c),g,d,b)}function rt(g,c,d,b){return rn(Tn(c,g.length-d),g,d,b)}p.prototype.write=function(c,d,b,B){if(d===void 0)B="utf8",b=this.length,d=0;else if(b===void 0&&typeof d=="string")B=d,b=this.length,d=0;else if(isFinite(d))d=d>>>0,isFinite(b)?(b=b>>>0,B===void 0&&(B="utf8")):(B=b,b=void 0);else throw new Error("Buffer.write(string, encoding, offset[, length]) is no longer supported");const R=this.length-d;if((b===void 0||b>R)&&(b=R),c.length>0&&(b<0||d<0)||d>this.length)throw new RangeError("Attempt to write outside buffer bounds");B||(B="utf8");let D=!1;for(;;)switch(B){case"hex":return Fe(this,c,d,b);case"utf8":case"utf-8":return Ae(this,c,d,b);case"ascii":case"latin1":case"binary":return Et(this,c,d,b);case"base64":return It(this,c,d,b);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return rt(this,c,d,b);default:if(D)throw new TypeError("Unknown encoding: "+B);B=(""+B).toLowerCase(),D=!0}},p.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}};function ft(g,c,d){return c===0&&d===g.length?t.fromByteArray(g):t.fromByteArray(g.slice(c,d))}function gt(g,c,d){d=Math.min(g.length,d);const b=[];let B=c;for(;B<d;){const R=g[B];let D=null,ke=R>239?4:R>223?3:R>191?2:1;if(B+ke<=d){let S,P,$,C;switch(ke){case 1:R<128&&(D=R);break;case 2:S=g[B+1],(S&192)===128&&(C=(R&31)<<6|S&63,C>127&&(D=C));break;case 3:S=g[B+1],P=g[B+2],(S&192)===128&&(P&192)===128&&(C=(R&15)<<12|(S&63)<<6|P&63,C>2047&&(C<55296||C>57343)&&(D=C));break;case 4:S=g[B+1],P=g[B+2],$=g[B+3],(S&192)===128&&(P&192)===128&&($&192)===128&&(C=(R&15)<<18|(S&63)<<12|(P&63)<<6|$&63,C>65535&&C<1114112&&(D=C))}}D===null?(D=65533,ke=1):D>65535&&(D-=65536,b.push(D>>>10&1023|55296),D=56320|D&1023),b.push(D),B+=ke}return kt(b)}const $e=4096;function kt(g){const c=g.length;if(c<=$e)return String.fromCharCode.apply(String,g);let d="",b=0;for(;b<c;)d+=String.fromCharCode.apply(String,g.slice(b,b+=$e));return d}function ge(g,c,d){let b="";d=Math.min(g.length,d);for(let B=c;B<d;++B)b+=String.fromCharCode(g[B]&127);return b}function Te(g,c,d){let b="";d=Math.min(g.length,d);for(let B=c;B<d;++B)b+=String.fromCharCode(g[B]);return b}function _e(g,c,d){const b=g.length;(!c||c<0)&&(c=0),(!d||d<0||d>b)&&(d=b);let B="";for(let R=c;R<d;++R)B+=vo[g[R]];return B}function qe(g,c,d){const b=g.slice(c,d);let B="";for(let R=0;R<b.length-1;R+=2)B+=String.fromCharCode(b[R]+b[R+1]*256);return B}p.prototype.slice=function(c,d){const b=this.length;c=~~c,d=d===void 0?b:~~d,c<0?(c+=b,c<0&&(c=0)):c>b&&(c=b),d<0?(d+=b,d<0&&(d=0)):d>b&&(d=b),d<c&&(d=c);const B=this.subarray(c,d);return Object.setPrototypeOf(B,p.prototype),B};function Ie(g,c,d){if(g%1!==0||g<0)throw new RangeError("offset is not uint");if(g+c>d)throw new RangeError("Trying to access beyond buffer length")}p.prototype.readUintLE=p.prototype.readUIntLE=function(c,d,b){c=c>>>0,d=d>>>0,b||Ie(c,d,this.length);let B=this[c],R=1,D=0;for(;++D<d&&(R*=256);)B+=this[c+D]*R;return B},p.prototype.readUintBE=p.prototype.readUIntBE=function(c,d,b){c=c>>>0,d=d>>>0,b||Ie(c,d,this.length);let B=this[c+--d],R=1;for(;d>0&&(R*=256);)B+=this[c+--d]*R;return B},p.prototype.readUint8=p.prototype.readUInt8=function(c,d){return c=c>>>0,d||Ie(c,1,this.length),this[c]},p.prototype.readUint16LE=p.prototype.readUInt16LE=function(c,d){return c=c>>>0,d||Ie(c,2,this.length),this[c]|this[c+1]<<8},p.prototype.readUint16BE=p.prototype.readUInt16BE=function(c,d){return c=c>>>0,d||Ie(c,2,this.length),this[c]<<8|this[c+1]},p.prototype.readUint32LE=p.prototype.readUInt32LE=function(c,d){return c=c>>>0,d||Ie(c,4,this.length),(this[c]|this[c+1]<<8|this[c+2]<<16)+this[c+3]*16777216},p.prototype.readUint32BE=p.prototype.readUInt32BE=function(c,d){return c=c>>>0,d||Ie(c,4,this.length),this[c]*16777216+(this[c+1]<<16|this[c+2]<<8|this[c+3])},p.prototype.readBigUInt64LE=Pt(function(c){c=c>>>0,Ue(c,"offset");const d=this[c],b=this[c+7];(d===void 0||b===void 0)&&pt(c,this.length-8);const B=d+this[++c]*2**8+this[++c]*2**16+this[++c]*2**24,R=this[++c]+this[++c]*2**8+this[++c]*2**16+b*2**24;return BigInt(B)+(BigInt(R)<<BigInt(32))}),p.prototype.readBigUInt64BE=Pt(function(c){c=c>>>0,Ue(c,"offset");const d=this[c],b=this[c+7];(d===void 0||b===void 0)&&pt(c,this.length-8);const B=d*2**24+this[++c]*2**16+this[++c]*2**8+this[++c],R=this[++c]*2**24+this[++c]*2**16+this[++c]*2**8+b;return(BigInt(B)<<BigInt(32))+BigInt(R)}),p.prototype.readIntLE=function(c,d,b){c=c>>>0,d=d>>>0,b||Ie(c,d,this.length);let B=this[c],R=1,D=0;for(;++D<d&&(R*=256);)B+=this[c+D]*R;return R*=128,B>=R&&(B-=Math.pow(2,8*d)),B},p.prototype.readIntBE=function(c,d,b){c=c>>>0,d=d>>>0,b||Ie(c,d,this.length);let B=d,R=1,D=this[c+--B];for(;B>0&&(R*=256);)D+=this[c+--B]*R;return R*=128,D>=R&&(D-=Math.pow(2,8*d)),D},p.prototype.readInt8=function(c,d){return c=c>>>0,d||Ie(c,1,this.length),this[c]&128?(255-this[c]+1)*-1:this[c]},p.prototype.readInt16LE=function(c,d){c=c>>>0,d||Ie(c,2,this.length);const b=this[c]|this[c+1]<<8;return b&32768?b|4294901760:b},p.prototype.readInt16BE=function(c,d){c=c>>>0,d||Ie(c,2,this.length);const b=this[c+1]|this[c]<<8;return b&32768?b|4294901760:b},p.prototype.readInt32LE=function(c,d){return c=c>>>0,d||Ie(c,4,this.length),this[c]|this[c+1]<<8|this[c+2]<<16|this[c+3]<<24},p.prototype.readInt32BE=function(c,d){return c=c>>>0,d||Ie(c,4,this.length),this[c]<<24|this[c+1]<<16|this[c+2]<<8|this[c+3]},p.prototype.readBigInt64LE=Pt(function(c){c=c>>>0,Ue(c,"offset");const d=this[c],b=this[c+7];(d===void 0||b===void 0)&&pt(c,this.length-8);const B=this[c+4]+this[c+5]*2**8+this[c+6]*2**16+(b<<24);return(BigInt(B)<<BigInt(32))+BigInt(d+this[++c]*2**8+this[++c]*2**16+this[++c]*2**24)}),p.prototype.readBigInt64BE=Pt(function(c){c=c>>>0,Ue(c,"offset");const d=this[c],b=this[c+7];(d===void 0||b===void 0)&&pt(c,this.length-8);const B=(d<<24)+this[++c]*2**16+this[++c]*2**8+this[++c];return(BigInt(B)<<BigInt(32))+BigInt(this[++c]*2**24+this[++c]*2**16+this[++c]*2**8+b)}),p.prototype.readFloatLE=function(c,d){return c=c>>>0,d||Ie(c,4,this.length),n.read(this,c,!0,23,4)},p.prototype.readFloatBE=function(c,d){return c=c>>>0,d||Ie(c,4,this.length),n.read(this,c,!1,23,4)},p.prototype.readDoubleLE=function(c,d){return c=c>>>0,d||Ie(c,8,this.length),n.read(this,c,!0,52,8)},p.prototype.readDoubleBE=function(c,d){return c=c>>>0,d||Ie(c,8,this.length),n.read(this,c,!1,52,8)};function we(g,c,d,b,B,R){if(!p.isBuffer(g))throw new TypeError('"buffer" argument must be a Buffer instance');if(c>B||c<R)throw new RangeError('"value" argument is out of bounds');if(d+b>g.length)throw new RangeError("Index out of range")}p.prototype.writeUintLE=p.prototype.writeUIntLE=function(c,d,b,B){if(c=+c,d=d>>>0,b=b>>>0,!B){const ke=Math.pow(2,8*b)-1;we(this,c,d,b,ke,0)}let R=1,D=0;for(this[d]=c&255;++D<b&&(R*=256);)this[d+D]=c/R&255;return d+b},p.prototype.writeUintBE=p.prototype.writeUIntBE=function(c,d,b,B){if(c=+c,d=d>>>0,b=b>>>0,!B){const ke=Math.pow(2,8*b)-1;we(this,c,d,b,ke,0)}let R=b-1,D=1;for(this[d+R]=c&255;--R>=0&&(D*=256);)this[d+R]=c/D&255;return d+b},p.prototype.writeUint8=p.prototype.writeUInt8=function(c,d,b){return c=+c,d=d>>>0,b||we(this,c,d,1,255,0),this[d]=c&255,d+1},p.prototype.writeUint16LE=p.prototype.writeUInt16LE=function(c,d,b){return c=+c,d=d>>>0,b||we(this,c,d,2,65535,0),this[d]=c&255,this[d+1]=c>>>8,d+2},p.prototype.writeUint16BE=p.prototype.writeUInt16BE=function(c,d,b){return c=+c,d=d>>>0,b||we(this,c,d,2,65535,0),this[d]=c>>>8,this[d+1]=c&255,d+2},p.prototype.writeUint32LE=p.prototype.writeUInt32LE=function(c,d,b){return c=+c,d=d>>>0,b||we(this,c,d,4,4294967295,0),this[d+3]=c>>>24,this[d+2]=c>>>16,this[d+1]=c>>>8,this[d]=c&255,d+4},p.prototype.writeUint32BE=p.prototype.writeUInt32BE=function(c,d,b){return c=+c,d=d>>>0,b||we(this,c,d,4,4294967295,0),this[d]=c>>>24,this[d+1]=c>>>16,this[d+2]=c>>>8,this[d+3]=c&255,d+4};function st(g,c,d,b,B){Re(c,b,B,g,d,7);let R=Number(c&BigInt(4294967295));g[d++]=R,R=R>>8,g[d++]=R,R=R>>8,g[d++]=R,R=R>>8,g[d++]=R;let D=Number(c>>BigInt(32)&BigInt(4294967295));return g[d++]=D,D=D>>8,g[d++]=D,D=D>>8,g[d++]=D,D=D>>8,g[d++]=D,d}function ht(g,c,d,b,B){Re(c,b,B,g,d,7);let R=Number(c&BigInt(4294967295));g[d+7]=R,R=R>>8,g[d+6]=R,R=R>>8,g[d+5]=R,R=R>>8,g[d+4]=R;let D=Number(c>>BigInt(32)&BigInt(4294967295));return g[d+3]=D,D=D>>8,g[d+2]=D,D=D>>8,g[d+1]=D,D=D>>8,g[d]=D,d+8}p.prototype.writeBigUInt64LE=Pt(function(c,d=0){return st(this,c,d,BigInt(0),BigInt("0xffffffffffffffff"))}),p.prototype.writeBigUInt64BE=Pt(function(c,d=0){return ht(this,c,d,BigInt(0),BigInt("0xffffffffffffffff"))}),p.prototype.writeIntLE=function(c,d,b,B){if(c=+c,d=d>>>0,!B){const S=Math.pow(2,8*b-1);we(this,c,d,b,S-1,-S)}let R=0,D=1,ke=0;for(this[d]=c&255;++R<b&&(D*=256);)c<0&&ke===0&&this[d+R-1]!==0&&(ke=1),this[d+R]=(c/D>>0)-ke&255;return d+b},p.prototype.writeIntBE=function(c,d,b,B){if(c=+c,d=d>>>0,!B){const S=Math.pow(2,8*b-1);we(this,c,d,b,S-1,-S)}let R=b-1,D=1,ke=0;for(this[d+R]=c&255;--R>=0&&(D*=256);)c<0&&ke===0&&this[d+R+1]!==0&&(ke=1),this[d+R]=(c/D>>0)-ke&255;return d+b},p.prototype.writeInt8=function(c,d,b){return c=+c,d=d>>>0,b||we(this,c,d,1,127,-128),c<0&&(c=255+c+1),this[d]=c&255,d+1},p.prototype.writeInt16LE=function(c,d,b){return c=+c,d=d>>>0,b||we(this,c,d,2,32767,-32768),this[d]=c&255,this[d+1]=c>>>8,d+2},p.prototype.writeInt16BE=function(c,d,b){return c=+c,d=d>>>0,b||we(this,c,d,2,32767,-32768),this[d]=c>>>8,this[d+1]=c&255,d+2},p.prototype.writeInt32LE=function(c,d,b){return c=+c,d=d>>>0,b||we(this,c,d,4,2147483647,-2147483648),this[d]=c&255,this[d+1]=c>>>8,this[d+2]=c>>>16,this[d+3]=c>>>24,d+4},p.prototype.writeInt32BE=function(c,d,b){return c=+c,d=d>>>0,b||we(this,c,d,4,2147483647,-2147483648),c<0&&(c=4294967295+c+1),this[d]=c>>>24,this[d+1]=c>>>16,this[d+2]=c>>>8,this[d+3]=c&255,d+4},p.prototype.writeBigInt64LE=Pt(function(c,d=0){return st(this,c,d,-BigInt("0x8000000000000000"),BigInt("0x7fffffffffffffff"))}),p.prototype.writeBigInt64BE=Pt(function(c,d=0){return ht(this,c,d,-BigInt("0x8000000000000000"),BigInt("0x7fffffffffffffff"))});function Wt(g,c,d,b,B,R){if(d+b>g.length)throw new RangeError("Index out of range");if(d<0)throw new RangeError("Index out of range")}function Sn(g,c,d,b,B){return c=+c,d=d>>>0,B||Wt(g,c,d,4),n.write(g,c,d,b,23,4),d+4}p.prototype.writeFloatLE=function(c,d,b){return Sn(this,c,d,!0,b)},p.prototype.writeFloatBE=function(c,d,b){return Sn(this,c,d,!1,b)};function Ut(g,c,d,b,B){return c=+c,d=d>>>0,B||Wt(g,c,d,8),n.write(g,c,d,b,52,8),d+8}p.prototype.writeDoubleLE=function(c,d,b){return Ut(this,c,d,!0,b)},p.prototype.writeDoubleBE=function(c,d,b){return Ut(this,c,d,!1,b)},p.prototype.copy=function(c,d,b,B){if(!p.isBuffer(c))throw new TypeError("argument should be a Buffer");if(b||(b=0),!B&&B!==0&&(B=this.length),d>=c.length&&(d=c.length),d||(d=0),B>0&&B<b&&(B=b),B===b||c.length===0||this.length===0)return 0;if(d<0)throw new RangeError("targetStart out of bounds");if(b<0||b>=this.length)throw new RangeError("Index out of range");if(B<0)throw new RangeError("sourceEnd out of bounds");B>this.length&&(B=this.length),c.length-d<B-b&&(B=c.length-d+b);const R=B-b;return this===c&&typeof r.prototype.copyWithin=="function"?this.copyWithin(d,b,B):r.prototype.set.call(c,this.subarray(b,B),d),R},p.prototype.fill=function(c,d,b,B){if(typeof c=="string"){if(typeof d=="string"?(B=d,d=0,b=this.length):typeof b=="string"&&(B=b,b=this.length),B!==void 0&&typeof B!="string")throw new TypeError("encoding must be a string");if(typeof B=="string"&&!p.isEncoding(B))throw new TypeError("Unknown encoding: "+B);if(c.length===1){const D=c.charCodeAt(0);(B==="utf8"&&D<128||B==="latin1")&&(c=D)}}else typeof c=="number"?c=c&255:typeof c=="boolean"&&(c=Number(c));if(d<0||this.length<d||this.length<b)throw new RangeError("Out of range index");if(b<=d)return this;d=d>>>0,b=b===void 0?this.length:b>>>0,c||(c=0);let R;if(typeof c=="number")for(R=d;R<b;++R)this[R]=c;else{const D=p.isBuffer(c)?c:p.from(c,B),ke=D.length;if(ke===0)throw new TypeError('The value "'+c+'" is invalid for argument "value"');for(R=0;R<b-d;++R)this[R+d]=D[R%ke]}return this};const St={};function ot(g,c,d){St[g]=class extends d{constructor(){super(),Object.defineProperty(this,"message",{value:c.apply(this,arguments),writable:!0,configurable:!0}),this.name=`${this.name} [${g}]`,this.stack,delete this.name}get code(){return g}set code(B){Object.defineProperty(this,"code",{configurable:!0,enumerable:!0,value:B,writable:!0})}toString(){return`${this.name} [${g}]: ${this.message}`}}}ot("ERR_BUFFER_OUT_OF_BOUNDS",function(g){return g?`${g} is outside of buffer bounds`:"Attempt to access memory outside buffer bounds"},RangeError),ot("ERR_INVALID_ARG_TYPE",function(g,c){return`The "${g}" argument must be of type number. Received type ${typeof c}`},TypeError),ot("ERR_OUT_OF_RANGE",function(g,c,d){let b=`The value of "${g}" is out of range.`,B=d;return Number.isInteger(d)&&Math.abs(d)>2**32?B=mt(String(d)):typeof d=="bigint"&&(B=String(d),(d>BigInt(2)**BigInt(32)||d<-(BigInt(2)**BigInt(32)))&&(B=mt(B)),B+="n"),b+=` It must be ${c}. Received ${B}`,b},RangeError);function mt(g){let c="",d=g.length;const b=g[0]==="-"?1:0;for(;d>=b+4;d-=3)c=`_${g.slice(d-3,d)}${c}`;return`${g.slice(0,d)}${c}`}function At(g,c,d){Ue(c,"offset"),(g[c]===void 0||g[c+d]===void 0)&&pt(c,g.length-(d+1))}function Re(g,c,d,b,B,R){if(g>d||g<c){const D=typeof c=="bigint"?"n":"";let ke;throw c===0||c===BigInt(0)?ke=`>= 0${D} and < 2${D} ** ${(R+1)*8}${D}`:ke=`>= -(2${D} ** ${(R+1)*8-1}${D}) and < 2 ** ${(R+1)*8-1}${D}`,new St.ERR_OUT_OF_RANGE("value",ke,g)}At(b,B,R)}function Ue(g,c){if(typeof g!="number")throw new St.ERR_INVALID_ARG_TYPE(c,"number",g)}function pt(g,c,d){throw Math.floor(g)!==g?(Ue(g,d),new St.ERR_OUT_OF_RANGE("offset","an integer",g)):c<0?new St.ERR_BUFFER_OUT_OF_BOUNDS:new St.ERR_OUT_OF_RANGE("offset",`>= 0 and <= ${c}`,g)}const He=/[^+/0-9A-Za-z-_]/g;function vt(g){if(g=g.split("=")[0],g=g.trim().replace(He,""),g.length<2)return"";for(;g.length%4!==0;)g=g+"=";return g}function zn(g,c){c=c||1/0;let d;const b=g.length;let B=null;const R=[];for(let D=0;D<b;++D){if(d=g.charCodeAt(D),d>55295&&d<57344){if(!B){if(d>56319){(c-=3)>-1&&R.push(239,191,189);continue}else if(D+1===b){(c-=3)>-1&&R.push(239,191,189);continue}B=d;continue}if(d<56320){(c-=3)>-1&&R.push(239,191,189),B=d;continue}d=(B-55296<<10|d-56320)+65536}else B&&(c-=3)>-1&&R.push(239,191,189);if(B=null,d<128){if((c-=1)<0)break;R.push(d)}else if(d<2048){if((c-=2)<0)break;R.push(d>>6|192,d&63|128)}else if(d<65536){if((c-=3)<0)break;R.push(d>>12|224,d>>6&63|128,d&63|128)}else if(d<1114112){if((c-=4)<0)break;R.push(d>>18|240,d>>12&63|128,d>>6&63|128,d&63|128)}else throw new Error("Invalid code point")}return R}function Wn(g){const c=[];for(let d=0;d<g.length;++d)c.push(g.charCodeAt(d)&255);return c}function Tn(g,c){let d,b,B;const R=[];for(let D=0;D<g.length&&!((c-=2)<0);++D)d=g.charCodeAt(D),b=d>>8,B=d%256,R.push(B),R.push(b);return R}function ho(g){return t.toByteArray(vt(g))}function rn(g,c,d,b){let B;for(B=0;B<b&&!(B+d>=c.length||B>=g.length);++B)c[B+d]=g[B];return B}function yt(g,c){return g instanceof c||g!=null&&g.constructor!=null&&g.constructor.name!=null&&g.constructor.name===c.name}function Ln(g){return g!==g}const vo=(function(){const g="0123456789abcdef",c=new Array(256);for(let d=0;d<16;++d){const b=d*16;for(let B=0;B<16;++B)c[b+B]=g[d]+g[B]}return c})();function Pt(g){return typeof BigInt>"u"?Kn:g}function Kn(){throw new Error("BigInt not supported")}})(Vy);function Fo(e,t){const n=Array.isArray(e)?e:[e];t?t.children=n:t=null;for(let o=0;o<n.length;o++){const i=n[o];i.parent&&i.parent.children!==n&&go(i),t?(i.prev=n[o-1]||null,i.next=n[o+1]||null):i.prev=i.next=null,i.parent=t}return t}function Qy(e,t){if(e==null)return[];if(typeof e=="string")return this._parse(e,this.options,!1,null).children.slice(0);if("length"in e){if(e.length===1)return this._makeDomArray(e[0],t);const n=[];for(let o=0;o<e.length;o++){const i=e[o];if(typeof i=="object"){if(i==null)continue;if(!("length"in i)){n.push(t?bi(i,!0):i);continue}}n.push(...this._makeDomArray(i,t))}return n}return[t?bi(e,!0):e]}function Yu(e){return function(...t){const n=this.length-1;return et(this,(o,i)=>{if(!nt(o))return;const r=typeof t[0]=="function"?t[0].call(o,i,this._render(o.children)):t,a=this._makeDomArray(r,i<n);e(a,o.children,o)})}}function qn(e,t,n,o,i){var r,a;const u=[t,n,...o],m=t===0?null:e[t-1],y=t+n>=e.length?null:e[t+n];for(let p=0;p<o.length;++p){const N=o[p],I=N.parent;if(I){const A=I.children.indexOf(N);A!==-1&&(I.children.splice(A,1),i===I&&t>A&&u[0]--)}N.parent=i,N.prev&&(N.prev.next=(r=N.next)!==null&&r!==void 0?r:null),N.next&&(N.next.prev=(a=N.prev)!==null&&a!==void 0?a:null),N.prev=p===0?m:o[p-1],N.next=p===o.length-1?y:o[p+1]}return m&&(m.next=o[0]),y&&(y.prev=o[o.length-1]),e.splice(...u)}function Zy(e){return(Ko(e)?e:this._make(e)).append(this),this}function Gy(e){return(Ko(e)?e:this._make(e)).prepend(this),this}const eg=Yu((e,t,n)=>{qn(t,t.length,0,e,n)}),tg=Yu((e,t,n)=>{qn(t,0,0,e,n)});function Ju(e){return function(t){const n=this.length-1,o=this.parents().last();for(let i=0;i<this.length;i++){const r=this[i],a=typeof t=="function"?t.call(r,i,r):typeof t=="string"&&!yp(t)?o.find(t).clone():t,[u]=this._makeDomArray(a,i<n);if(!u||!nt(u))continue;let m=u,y=0;for(;y<m.children.length;){const p=m.children[y];me(p)?(m=p,y=0):y++}e(r,m,[u])}return this}}const ng=Ju((e,t,n)=>{const{parent:o}=e;if(!o)return;const i=o.children,r=i.indexOf(e);Fo([e],t),qn(i,r,0,n,o)}),og=Ju((e,t,n)=>{nt(e)&&(Fo(e.children,t),Fo(n,e))});function ig(e){return this.parent(e).not("body").each((t,n)=>{this._make(n).replaceWith(n.children)}),this}function rg(e){const t=this[0];if(t){const n=this._make(typeof e=="function"?e.call(t,0,t):e).insertBefore(t);let o;for(let r=0;r<n.length;r++)n[r].type===Xs&&(o=n[r]);let i=0;for(;o&&i<o.children.length;){const r=o.children[i];r.type===Xs?(o=r,i=0):i++}o&&this._make(o).append(this)}return this}function sg(...e){const t=this.length-1;return et(this,(n,o)=>{if(!nt(n)||!n.parent)return;const i=n.parent.children,r=i.indexOf(n);if(r===-1)return;const a=typeof e[0]=="function"?e[0].call(n,o,this._render(n.children)):e,u=this._makeDomArray(a,o<t);qn(i,r+1,0,u,n.parent)})}function ag(e){typeof e=="string"&&(e=this._make(e)),this.remove();const t=[];for(const n of this._makeDomArray(e)){const o=this.clone().toArray(),{parent:i}=n;if(!i)continue;const r=i.children,a=r.indexOf(n);a!==-1&&(qn(r,a+1,0,o,i),t.push(...o))}return this._make(t)}function cg(...e){const t=this.length-1;return et(this,(n,o)=>{if(!nt(n)||!n.parent)return;const i=n.parent.children,r=i.indexOf(n);if(r===-1)return;const a=typeof e[0]=="function"?e[0].call(n,o,this._render(n.children)):e,u=this._makeDomArray(a,o<t);qn(i,r,0,u,n.parent)})}function lg(e){const t=this._make(e);this.remove();const n=[];return et(t,o=>{const i=this.clone().toArray(),{parent:r}=o;if(!r)return;const a=r.children,u=a.indexOf(o);u!==-1&&(qn(a,u,0,i,r),n.push(...i))}),this._make(n)}function dg(e){const t=e?this.filter(e):this;return et(t,n=>{go(n),n.prev=n.next=n.parent=null}),this}function ug(e){return et(this,(t,n)=>{const{parent:o}=t;if(!o)return;const i=o.children,r=typeof e=="function"?e.call(t,n,t):e,a=this._makeDomArray(r);Fo(a,null);const u=i.indexOf(t);qn(i,u,1,a,o),a.includes(t)||(t.parent=t.prev=t.next=null)})}function fg(){return et(this,e=>{if(nt(e)){for(const t of e.children)t.next=t.prev=t.parent=null;e.children.length=0}})}function mg(e){if(e===void 0){const t=this[0];return!t||!nt(t)?null:this._render(t.children)}return et(this,t=>{if(!nt(t))return;for(const o of t.children)o.next=o.prev=o.parent=null;const n=Ko(e)?e.toArray():this._parse(`${e}`,this.options,!1,t).children;Fo(n,t)})}function pg(){return this._render(this)}function yg(e){return e===void 0?pr(this):typeof e=="function"?et(this,(t,n)=>this._make(t).text(e.call(t,n,pr([t])))):et(this,t=>{if(!nt(t))return;for(const o of t.children)o.next=o.prev=o.parent=null;const n=new gu(`${e}`);Fo(n,t)})}function gg(){const e=Array.prototype.map.call(this.get(),n=>bi(n,!0)),t=new hu(e);for(const n of e)n.parent=t;return this._make(e)}const hg=Object.freeze(Object.defineProperty({__proto__:null,_makeDomArray:Qy,after:sg,append:eg,appendTo:Zy,before:cg,clone:gg,empty:fg,html:mg,insertAfter:ag,insertBefore:lg,prepend:tg,prependTo:Gy,remove:dg,replaceWith:ug,text:yg,toString:pg,unwrap:ig,wrap:ng,wrapAll:rg,wrapInner:og},Symbol.toStringTag,{value:"Module"}));function vg(e,t){if(e!=null&&t!=null||typeof e=="object"&&!Array.isArray(e))return et(this,(n,o)=>{me(n)&&Xu(n,e,t,o)});if(this.length!==0)return Qu(this[0],e)}function Xu(e,t,n,o){if(typeof t=="string"){const i=Qu(e),r=typeof n=="function"?n.call(e,o,i[t]):n;r===""?delete i[t]:r!=null&&(i[t]=r),e.attribs.style=wg(i)}else if(typeof t=="object"){const i=Object.keys(t);for(let r=0;r<i.length;r++){const a=i[r];Xu(e,a,t[a],r)}}}function Qu(e,t){if(!e||!me(e))return;const n=Eg(e.attribs.style);if(typeof t=="string")return n[t];if(Array.isArray(t)){const o={};for(const i of t)n[i]!=null&&(o[i]=n[i]);return o}return n}function wg(e){return Object.keys(e).reduce((t,n)=>`${t}${t?" ":""}${n}: ${e[n]};`,"")}function Eg(e){if(e=(e||"").trim(),!e)return{};const t={};let n;for(const o of e.split(";")){const i=o.indexOf(":");if(i<1||i===o.length-1){const r=o.trimEnd();r.length>0&&n!==void 0&&(t[n]+=`;${r}`)}else n=o.slice(0,i).trim(),t[n]=o.slice(i+1).trim()}return t}const bg=Object.freeze(Object.defineProperty({__proto__:null,css:vg},Symbol.toStringTag,{value:"Module"})),kl="input,select,textarea,keygen",Ig=/%20/g,Sl=/\r?\n/g;function kg(){return this.serializeArray().map(n=>`${encodeURIComponent(n.name)}=${encodeURIComponent(n.value)}`).join("&").replace(Ig,"+")}function Sg(){return this.map((e,t)=>{const n=this._make(t);return me(t)&&t.name==="form"?n.find(kl).toArray():n.filter(kl).toArray()}).filter('[name!=""]:enabled:not(:submit, :button, :image, :reset, :file):matches([checked], :not(:checkbox, :radio))').map((e,t)=>{var n;const o=this._make(t),i=o.attr("name"),r=(n=o.val())!==null&&n!==void 0?n:"";return Array.isArray(r)?r.map(a=>({name:i,value:a.replace(Sl,`\r
`)})):{name:i,value:r.replace(Sl,`\r
`)}}).toArray()}const Tg=Object.freeze(Object.defineProperty({__proto__:null,serialize:kg,serializeArray:Sg},Symbol.toStringTag,{value:"Module"}));function Lg(e){var t;return typeof e=="string"?{selector:e,value:"textContent"}:{selector:e.selector,value:(t=e.value)!==null&&t!==void 0?t:"textContent"}}function Cg(e){const t={};for(const n in e){const o=e[n],i=Array.isArray(o),{selector:r,value:a}=Lg(i?o[0]:o),u=typeof a=="function"?a:typeof a=="string"?m=>this._make(m).prop(a):m=>this._make(m).extract(a);if(i)t[n]=this._findBySelector(r,Number.POSITIVE_INFINITY).map((m,y)=>u(y,n,t)).get();else{const m=this._findBySelector(r,1);t[n]=m.length>0?u(m[0],n,t):void 0}}return t}const Bg=Object.freeze(Object.defineProperty({__proto__:null,extract:Cg},Symbol.toStringTag,{value:"Module"}));class zr{constructor(t,n,o){if(this.length=0,this.options=o,this._root=n,t){for(let i=0;i<t.length;i++)this[i]=t[i];this.length=t.length}}}zr.prototype.cheerio="[cheerio object]";zr.prototype.splice=Array.prototype.splice;zr.prototype[Symbol.iterator]=Array.prototype[Symbol.iterator];Object.assign(zr.prototype,Tp,Hy,hg,bg,Tg,Bg);var Tl;(function(e){e[e.EOF=-1]="EOF",e[e.NULL=0]="NULL",e[e.TABULATION=9]="TABULATION",e[e.CARRIAGE_RETURN=13]="CARRIAGE_RETURN",e[e.LINE_FEED=10]="LINE_FEED",e[e.FORM_FEED=12]="FORM_FEED",e[e.SPACE=32]="SPACE",e[e.EXCLAMATION_MARK=33]="EXCLAMATION_MARK",e[e.QUOTATION_MARK=34]="QUOTATION_MARK",e[e.AMPERSAND=38]="AMPERSAND",e[e.APOSTROPHE=39]="APOSTROPHE",e[e.HYPHEN_MINUS=45]="HYPHEN_MINUS",e[e.SOLIDUS=47]="SOLIDUS",e[e.DIGIT_0=48]="DIGIT_0",e[e.DIGIT_9=57]="DIGIT_9",e[e.SEMICOLON=59]="SEMICOLON",e[e.LESS_THAN_SIGN=60]="LESS_THAN_SIGN",e[e.EQUALS_SIGN=61]="EQUALS_SIGN",e[e.GREATER_THAN_SIGN=62]="GREATER_THAN_SIGN",e[e.QUESTION_MARK=63]="QUESTION_MARK",e[e.LATIN_CAPITAL_A=65]="LATIN_CAPITAL_A",e[e.LATIN_CAPITAL_Z=90]="LATIN_CAPITAL_Z",e[e.RIGHT_SQUARE_BRACKET=93]="RIGHT_SQUARE_BRACKET",e[e.GRAVE_ACCENT=96]="GRAVE_ACCENT",e[e.LATIN_SMALL_A=97]="LATIN_SMALL_A",e[e.LATIN_SMALL_Z=122]="LATIN_SMALL_Z"})(Tl||(Tl={}));var Ll;(function(e){e.controlCharacterInInputStream="control-character-in-input-stream",e.noncharacterInInputStream="noncharacter-in-input-stream",e.surrogateInInputStream="surrogate-in-input-stream",e.nonVoidHtmlElementStartTagWithTrailingSolidus="non-void-html-element-start-tag-with-trailing-solidus",e.endTagWithAttributes="end-tag-with-attributes",e.endTagWithTrailingSolidus="end-tag-with-trailing-solidus",e.unexpectedSolidusInTag="unexpected-solidus-in-tag",e.unexpectedNullCharacter="unexpected-null-character",e.unexpectedQuestionMarkInsteadOfTagName="unexpected-question-mark-instead-of-tag-name",e.invalidFirstCharacterOfTagName="invalid-first-character-of-tag-name",e.unexpectedEqualsSignBeforeAttributeName="unexpected-equals-sign-before-attribute-name",e.missingEndTagName="missing-end-tag-name",e.unexpectedCharacterInAttributeName="unexpected-character-in-attribute-name",e.unknownNamedCharacterReference="unknown-named-character-reference",e.missingSemicolonAfterCharacterReference="missing-semicolon-after-character-reference",e.unexpectedCharacterAfterDoctypeSystemIdentifier="unexpected-character-after-doctype-system-identifier",e.unexpectedCharacterInUnquotedAttributeValue="unexpected-character-in-unquoted-attribute-value",e.eofBeforeTagName="eof-before-tag-name",e.eofInTag="eof-in-tag",e.missingAttributeValue="missing-attribute-value",e.missingWhitespaceBetweenAttributes="missing-whitespace-between-attributes",e.missingWhitespaceAfterDoctypePublicKeyword="missing-whitespace-after-doctype-public-keyword",e.missingWhitespaceBetweenDoctypePublicAndSystemIdentifiers="missing-whitespace-between-doctype-public-and-system-identifiers",e.missingWhitespaceAfterDoctypeSystemKeyword="missing-whitespace-after-doctype-system-keyword",e.missingQuoteBeforeDoctypePublicIdentifier="missing-quote-before-doctype-public-identifier",e.missingQuoteBeforeDoctypeSystemIdentifier="missing-quote-before-doctype-system-identifier",e.missingDoctypePublicIdentifier="missing-doctype-public-identifier",e.missingDoctypeSystemIdentifier="missing-doctype-system-identifier",e.abruptDoctypePublicIdentifier="abrupt-doctype-public-identifier",e.abruptDoctypeSystemIdentifier="abrupt-doctype-system-identifier",e.cdataInHtmlContent="cdata-in-html-content",e.incorrectlyOpenedComment="incorrectly-opened-comment",e.eofInScriptHtmlCommentLikeText="eof-in-script-html-comment-like-text",e.eofInDoctype="eof-in-doctype",e.nestedComment="nested-comment",e.abruptClosingOfEmptyComment="abrupt-closing-of-empty-comment",e.eofInComment="eof-in-comment",e.incorrectlyClosedComment="incorrectly-closed-comment",e.eofInCdata="eof-in-cdata",e.absenceOfDigitsInNumericCharacterReference="absence-of-digits-in-numeric-character-reference",e.nullCharacterReference="null-character-reference",e.surrogateCharacterReference="surrogate-character-reference",e.characterReferenceOutsideUnicodeRange="character-reference-outside-unicode-range",e.controlCharacterReference="control-character-reference",e.noncharacterCharacterReference="noncharacter-character-reference",e.missingWhitespaceBeforeDoctypeName="missing-whitespace-before-doctype-name",e.missingDoctypeName="missing-doctype-name",e.invalidCharacterSequenceAfterDoctypeName="invalid-character-sequence-after-doctype-name",e.duplicateAttribute="duplicate-attribute",e.nonConformingDoctype="non-conforming-doctype",e.missingDoctype="missing-doctype",e.misplacedDoctype="misplaced-doctype",e.endTagWithoutMatchingOpenElement="end-tag-without-matching-open-element",e.closingOfElementWithOpenChildElements="closing-of-element-with-open-child-elements",e.disallowedContentInNoscriptInHead="disallowed-content-in-noscript-in-head",e.openElementsLeftAfterEof="open-elements-left-after-eof",e.abandonedHeadElementChild="abandoned-head-element-child",e.misplacedStartTagForHeadElement="misplaced-start-tag-for-head-element",e.nestedNoscriptInHead="nested-noscript-in-head",e.eofInElementThatCanContainOnlyText="eof-in-element-that-can-contain-only-text"})(Ll||(Ll={}));var Cl;(function(e){e[e.CHARACTER=0]="CHARACTER",e[e.NULL_CHARACTER=1]="NULL_CHARACTER",e[e.WHITESPACE_CHARACTER=2]="WHITESPACE_CHARACTER",e[e.START_TAG=3]="START_TAG",e[e.END_TAG=4]="END_TAG",e[e.COMMENT=5]="COMMENT",e[e.DOCTYPE=6]="DOCTYPE",e[e.EOF=7]="EOF",e[e.HIBERNATION=8]="HIBERNATION"})(Cl||(Cl={}));var lt;(function(e){e.HTML="http://www.w3.org/1999/xhtml",e.MATHML="http://www.w3.org/1998/Math/MathML",e.SVG="http://www.w3.org/2000/svg",e.XLINK="http://www.w3.org/1999/xlink",e.XML="http://www.w3.org/XML/1998/namespace",e.XMLNS="http://www.w3.org/2000/xmlns/"})(lt||(lt={}));var Bl;(function(e){e.TYPE="type",e.ACTION="action",e.ENCODING="encoding",e.PROMPT="prompt",e.NAME="name",e.COLOR="color",e.FACE="face",e.SIZE="size"})(Bl||(Bl={}));var Al;(function(e){e.NO_QUIRKS="no-quirks",e.QUIRKS="quirks",e.LIMITED_QUIRKS="limited-quirks"})(Al||(Al={}));var _;(function(e){e.A="a",e.ADDRESS="address",e.ANNOTATION_XML="annotation-xml",e.APPLET="applet",e.AREA="area",e.ARTICLE="article",e.ASIDE="aside",e.B="b",e.BASE="base",e.BASEFONT="basefont",e.BGSOUND="bgsound",e.BIG="big",e.BLOCKQUOTE="blockquote",e.BODY="body",e.BR="br",e.BUTTON="button",e.CAPTION="caption",e.CENTER="center",e.CODE="code",e.COL="col",e.COLGROUP="colgroup",e.DD="dd",e.DESC="desc",e.DETAILS="details",e.DIALOG="dialog",e.DIR="dir",e.DIV="div",e.DL="dl",e.DT="dt",e.EM="em",e.EMBED="embed",e.FIELDSET="fieldset",e.FIGCAPTION="figcaption",e.FIGURE="figure",e.FONT="font",e.FOOTER="footer",e.FOREIGN_OBJECT="foreignObject",e.FORM="form",e.FRAME="frame",e.FRAMESET="frameset",e.H1="h1",e.H2="h2",e.H3="h3",e.H4="h4",e.H5="h5",e.H6="h6",e.HEAD="head",e.HEADER="header",e.HGROUP="hgroup",e.HR="hr",e.HTML="html",e.I="i",e.IMG="img",e.IMAGE="image",e.INPUT="input",e.IFRAME="iframe",e.KEYGEN="keygen",e.LABEL="label",e.LI="li",e.LINK="link",e.LISTING="listing",e.MAIN="main",e.MALIGNMARK="malignmark",e.MARQUEE="marquee",e.MATH="math",e.MENU="menu",e.META="meta",e.MGLYPH="mglyph",e.MI="mi",e.MO="mo",e.MN="mn",e.MS="ms",e.MTEXT="mtext",e.NAV="nav",e.NOBR="nobr",e.NOFRAMES="noframes",e.NOEMBED="noembed",e.NOSCRIPT="noscript",e.OBJECT="object",e.OL="ol",e.OPTGROUP="optgroup",e.OPTION="option",e.P="p",e.PARAM="param",e.PLAINTEXT="plaintext",e.PRE="pre",e.RB="rb",e.RP="rp",e.RT="rt",e.RTC="rtc",e.RUBY="ruby",e.S="s",e.SCRIPT="script",e.SEARCH="search",e.SECTION="section",e.SELECT="select",e.SOURCE="source",e.SMALL="small",e.SPAN="span",e.STRIKE="strike",e.STRONG="strong",e.STYLE="style",e.SUB="sub",e.SUMMARY="summary",e.SUP="sup",e.TABLE="table",e.TBODY="tbody",e.TEMPLATE="template",e.TEXTAREA="textarea",e.TFOOT="tfoot",e.TD="td",e.TH="th",e.THEAD="thead",e.TITLE="title",e.TR="tr",e.TRACK="track",e.TT="tt",e.U="u",e.UL="ul",e.SVG="svg",e.VAR="var",e.WBR="wbr",e.XMP="xmp"})(_||(_={}));var L;(function(e){e[e.UNKNOWN=0]="UNKNOWN",e[e.A=1]="A",e[e.ADDRESS=2]="ADDRESS",e[e.ANNOTATION_XML=3]="ANNOTATION_XML",e[e.APPLET=4]="APPLET",e[e.AREA=5]="AREA",e[e.ARTICLE=6]="ARTICLE",e[e.ASIDE=7]="ASIDE",e[e.B=8]="B",e[e.BASE=9]="BASE",e[e.BASEFONT=10]="BASEFONT",e[e.BGSOUND=11]="BGSOUND",e[e.BIG=12]="BIG",e[e.BLOCKQUOTE=13]="BLOCKQUOTE",e[e.BODY=14]="BODY",e[e.BR=15]="BR",e[e.BUTTON=16]="BUTTON",e[e.CAPTION=17]="CAPTION",e[e.CENTER=18]="CENTER",e[e.CODE=19]="CODE",e[e.COL=20]="COL",e[e.COLGROUP=21]="COLGROUP",e[e.DD=22]="DD",e[e.DESC=23]="DESC",e[e.DETAILS=24]="DETAILS",e[e.DIALOG=25]="DIALOG",e[e.DIR=26]="DIR",e[e.DIV=27]="DIV",e[e.DL=28]="DL",e[e.DT=29]="DT",e[e.EM=30]="EM",e[e.EMBED=31]="EMBED",e[e.FIELDSET=32]="FIELDSET",e[e.FIGCAPTION=33]="FIGCAPTION",e[e.FIGURE=34]="FIGURE",e[e.FONT=35]="FONT",e[e.FOOTER=36]="FOOTER",e[e.FOREIGN_OBJECT=37]="FOREIGN_OBJECT",e[e.FORM=38]="FORM",e[e.FRAME=39]="FRAME",e[e.FRAMESET=40]="FRAMESET",e[e.H1=41]="H1",e[e.H2=42]="H2",e[e.H3=43]="H3",e[e.H4=44]="H4",e[e.H5=45]="H5",e[e.H6=46]="H6",e[e.HEAD=47]="HEAD",e[e.HEADER=48]="HEADER",e[e.HGROUP=49]="HGROUP",e[e.HR=50]="HR",e[e.HTML=51]="HTML",e[e.I=52]="I",e[e.IMG=53]="IMG",e[e.IMAGE=54]="IMAGE",e[e.INPUT=55]="INPUT",e[e.IFRAME=56]="IFRAME",e[e.KEYGEN=57]="KEYGEN",e[e.LABEL=58]="LABEL",e[e.LI=59]="LI",e[e.LINK=60]="LINK",e[e.LISTING=61]="LISTING",e[e.MAIN=62]="MAIN",e[e.MALIGNMARK=63]="MALIGNMARK",e[e.MARQUEE=64]="MARQUEE",e[e.MATH=65]="MATH",e[e.MENU=66]="MENU",e[e.META=67]="META",e[e.MGLYPH=68]="MGLYPH",e[e.MI=69]="MI",e[e.MO=70]="MO",e[e.MN=71]="MN",e[e.MS=72]="MS",e[e.MTEXT=73]="MTEXT",e[e.NAV=74]="NAV",e[e.NOBR=75]="NOBR",e[e.NOFRAMES=76]="NOFRAMES",e[e.NOEMBED=77]="NOEMBED",e[e.NOSCRIPT=78]="NOSCRIPT",e[e.OBJECT=79]="OBJECT",e[e.OL=80]="OL",e[e.OPTGROUP=81]="OPTGROUP",e[e.OPTION=82]="OPTION",e[e.P=83]="P",e[e.PARAM=84]="PARAM",e[e.PLAINTEXT=85]="PLAINTEXT",e[e.PRE=86]="PRE",e[e.RB=87]="RB",e[e.RP=88]="RP",e[e.RT=89]="RT",e[e.RTC=90]="RTC",e[e.RUBY=91]="RUBY",e[e.S=92]="S",e[e.SCRIPT=93]="SCRIPT",e[e.SEARCH=94]="SEARCH",e[e.SECTION=95]="SECTION",e[e.SELECT=96]="SELECT",e[e.SOURCE=97]="SOURCE",e[e.SMALL=98]="SMALL",e[e.SPAN=99]="SPAN",e[e.STRIKE=100]="STRIKE",e[e.STRONG=101]="STRONG",e[e.STYLE=102]="STYLE",e[e.SUB=103]="SUB",e[e.SUMMARY=104]="SUMMARY",e[e.SUP=105]="SUP",e[e.TABLE=106]="TABLE",e[e.TBODY=107]="TBODY",e[e.TEMPLATE=108]="TEMPLATE",e[e.TEXTAREA=109]="TEXTAREA",e[e.TFOOT=110]="TFOOT",e[e.TD=111]="TD",e[e.TH=112]="TH",e[e.THEAD=113]="THEAD",e[e.TITLE=114]="TITLE",e[e.TR=115]="TR",e[e.TRACK=116]="TRACK",e[e.TT=117]="TT",e[e.U=118]="U",e[e.UL=119]="UL",e[e.SVG=120]="SVG",e[e.VAR=121]="VAR",e[e.WBR=122]="WBR",e[e.XMP=123]="XMP"})(L||(L={}));_.A,L.A,_.ADDRESS,L.ADDRESS,_.ANNOTATION_XML,L.ANNOTATION_XML,_.APPLET,L.APPLET,_.AREA,L.AREA,_.ARTICLE,L.ARTICLE,_.ASIDE,L.ASIDE,_.B,L.B,_.BASE,L.BASE,_.BASEFONT,L.BASEFONT,_.BGSOUND,L.BGSOUND,_.BIG,L.BIG,_.BLOCKQUOTE,L.BLOCKQUOTE,_.BODY,L.BODY,_.BR,L.BR,_.BUTTON,L.BUTTON,_.CAPTION,L.CAPTION,_.CENTER,L.CENTER,_.CODE,L.CODE,_.COL,L.COL,_.COLGROUP,L.COLGROUP,_.DD,L.DD,_.DESC,L.DESC,_.DETAILS,L.DETAILS,_.DIALOG,L.DIALOG,_.DIR,L.DIR,_.DIV,L.DIV,_.DL,L.DL,_.DT,L.DT,_.EM,L.EM,_.EMBED,L.EMBED,_.FIELDSET,L.FIELDSET,_.FIGCAPTION,L.FIGCAPTION,_.FIGURE,L.FIGURE,_.FONT,L.FONT,_.FOOTER,L.FOOTER,_.FOREIGN_OBJECT,L.FOREIGN_OBJECT,_.FORM,L.FORM,_.FRAME,L.FRAME,_.FRAMESET,L.FRAMESET,_.H1,L.H1,_.H2,L.H2,_.H3,L.H3,_.H4,L.H4,_.H5,L.H5,_.H6,L.H6,_.HEAD,L.HEAD,_.HEADER,L.HEADER,_.HGROUP,L.HGROUP,_.HR,L.HR,_.HTML,L.HTML,_.I,L.I,_.IMG,L.IMG,_.IMAGE,L.IMAGE,_.INPUT,L.INPUT,_.IFRAME,L.IFRAME,_.KEYGEN,L.KEYGEN,_.LABEL,L.LABEL,_.LI,L.LI,_.LINK,L.LINK,_.LISTING,L.LISTING,_.MAIN,L.MAIN,_.MALIGNMARK,L.MALIGNMARK,_.MARQUEE,L.MARQUEE,_.MATH,L.MATH,_.MENU,L.MENU,_.META,L.META,_.MGLYPH,L.MGLYPH,_.MI,L.MI,_.MO,L.MO,_.MN,L.MN,_.MS,L.MS,_.MTEXT,L.MTEXT,_.NAV,L.NAV,_.NOBR,L.NOBR,_.NOFRAMES,L.NOFRAMES,_.NOEMBED,L.NOEMBED,_.NOSCRIPT,L.NOSCRIPT,_.OBJECT,L.OBJECT,_.OL,L.OL,_.OPTGROUP,L.OPTGROUP,_.OPTION,L.OPTION,_.P,L.P,_.PARAM,L.PARAM,_.PLAINTEXT,L.PLAINTEXT,_.PRE,L.PRE,_.RB,L.RB,_.RP,L.RP,_.RT,L.RT,_.RTC,L.RTC,_.RUBY,L.RUBY,_.S,L.S,_.SCRIPT,L.SCRIPT,_.SEARCH,L.SEARCH,_.SECTION,L.SECTION,_.SELECT,L.SELECT,_.SOURCE,L.SOURCE,_.SMALL,L.SMALL,_.SPAN,L.SPAN,_.STRIKE,L.STRIKE,_.STRONG,L.STRONG,_.STYLE,L.STYLE,_.SUB,L.SUB,_.SUMMARY,L.SUMMARY,_.SUP,L.SUP,_.TABLE,L.TABLE,_.TBODY,L.TBODY,_.TEMPLATE,L.TEMPLATE,_.TEXTAREA,L.TEXTAREA,_.TFOOT,L.TFOOT,_.TD,L.TD,_.TH,L.TH,_.THEAD,L.THEAD,_.TITLE,L.TITLE,_.TR,L.TR,_.TRACK,L.TRACK,_.TT,L.TT,_.U,L.U,_.UL,L.UL,_.SVG,L.SVG,_.VAR,L.VAR,_.WBR,L.WBR,_.XMP,L.XMP;const z=L;lt.HTML+"",z.ADDRESS,z.APPLET,z.AREA,z.ARTICLE,z.ASIDE,z.BASE,z.BASEFONT,z.BGSOUND,z.BLOCKQUOTE,z.BODY,z.BR,z.BUTTON,z.CAPTION,z.CENTER,z.COL,z.COLGROUP,z.DD,z.DETAILS,z.DIR,z.DIV,z.DL,z.DT,z.EMBED,z.FIELDSET,z.FIGCAPTION,z.FIGURE,z.FOOTER,z.FORM,z.FRAME,z.FRAMESET,z.H1,z.H2,z.H3,z.H4,z.H5,z.H6,z.HEAD,z.HEADER,z.HGROUP,z.HR,z.HTML,z.IFRAME,z.IMG,z.INPUT,z.LI,z.LINK,z.LISTING,z.MAIN,z.MARQUEE,z.MENU,z.META,z.NAV,z.NOEMBED,z.NOFRAMES,z.NOSCRIPT,z.OBJECT,z.OL,z.P,z.PARAM,z.PLAINTEXT,z.PRE,z.SCRIPT,z.SECTION,z.SELECT,z.SOURCE,z.STYLE,z.SUMMARY,z.TABLE,z.TBODY,z.TD,z.TEMPLATE,z.TEXTAREA,z.TFOOT,z.TH,z.THEAD,z.TITLE,z.TR,z.TRACK,z.UL,z.WBR,z.XMP,lt.MATHML+"",z.MI,z.MO,z.MN,z.MS,z.MTEXT,z.ANNOTATION_XML,lt.SVG+"",z.TITLE,z.FOREIGN_OBJECT,z.DESC,lt.XLINK+"",lt.XML+"",lt.XMLNS+"";z.H1,z.H2,z.H3,z.H4,z.H5,z.H6;_.STYLE,_.SCRIPT,_.XMP,_.IFRAME,_.NOEMBED,_.NOFRAMES,_.PLAINTEXT;var On;(function(e){e[e.DATA=0]="DATA",e[e.RCDATA=1]="RCDATA",e[e.RAWTEXT=2]="RAWTEXT",e[e.SCRIPT_DATA=3]="SCRIPT_DATA",e[e.PLAINTEXT=4]="PLAINTEXT",e[e.TAG_OPEN=5]="TAG_OPEN",e[e.END_TAG_OPEN=6]="END_TAG_OPEN",e[e.TAG_NAME=7]="TAG_NAME",e[e.RCDATA_LESS_THAN_SIGN=8]="RCDATA_LESS_THAN_SIGN",e[e.RCDATA_END_TAG_OPEN=9]="RCDATA_END_TAG_OPEN",e[e.RCDATA_END_TAG_NAME=10]="RCDATA_END_TAG_NAME",e[e.RAWTEXT_LESS_THAN_SIGN=11]="RAWTEXT_LESS_THAN_SIGN",e[e.RAWTEXT_END_TAG_OPEN=12]="RAWTEXT_END_TAG_OPEN",e[e.RAWTEXT_END_TAG_NAME=13]="RAWTEXT_END_TAG_NAME",e[e.SCRIPT_DATA_LESS_THAN_SIGN=14]="SCRIPT_DATA_LESS_THAN_SIGN",e[e.SCRIPT_DATA_END_TAG_OPEN=15]="SCRIPT_DATA_END_TAG_OPEN",e[e.SCRIPT_DATA_END_TAG_NAME=16]="SCRIPT_DATA_END_TAG_NAME",e[e.SCRIPT_DATA_ESCAPE_START=17]="SCRIPT_DATA_ESCAPE_START",e[e.SCRIPT_DATA_ESCAPE_START_DASH=18]="SCRIPT_DATA_ESCAPE_START_DASH",e[e.SCRIPT_DATA_ESCAPED=19]="SCRIPT_DATA_ESCAPED",e[e.SCRIPT_DATA_ESCAPED_DASH=20]="SCRIPT_DATA_ESCAPED_DASH",e[e.SCRIPT_DATA_ESCAPED_DASH_DASH=21]="SCRIPT_DATA_ESCAPED_DASH_DASH",e[e.SCRIPT_DATA_ESCAPED_LESS_THAN_SIGN=22]="SCRIPT_DATA_ESCAPED_LESS_THAN_SIGN",e[e.SCRIPT_DATA_ESCAPED_END_TAG_OPEN=23]="SCRIPT_DATA_ESCAPED_END_TAG_OPEN",e[e.SCRIPT_DATA_ESCAPED_END_TAG_NAME=24]="SCRIPT_DATA_ESCAPED_END_TAG_NAME",e[e.SCRIPT_DATA_DOUBLE_ESCAPE_START=25]="SCRIPT_DATA_DOUBLE_ESCAPE_START",e[e.SCRIPT_DATA_DOUBLE_ESCAPED=26]="SCRIPT_DATA_DOUBLE_ESCAPED",e[e.SCRIPT_DATA_DOUBLE_ESCAPED_DASH=27]="SCRIPT_DATA_DOUBLE_ESCAPED_DASH",e[e.SCRIPT_DATA_DOUBLE_ESCAPED_DASH_DASH=28]="SCRIPT_DATA_DOUBLE_ESCAPED_DASH_DASH",e[e.SCRIPT_DATA_DOUBLE_ESCAPED_LESS_THAN_SIGN=29]="SCRIPT_DATA_DOUBLE_ESCAPED_LESS_THAN_SIGN",e[e.SCRIPT_DATA_DOUBLE_ESCAPE_END=30]="SCRIPT_DATA_DOUBLE_ESCAPE_END",e[e.BEFORE_ATTRIBUTE_NAME=31]="BEFORE_ATTRIBUTE_NAME",e[e.ATTRIBUTE_NAME=32]="ATTRIBUTE_NAME",e[e.AFTER_ATTRIBUTE_NAME=33]="AFTER_ATTRIBUTE_NAME",e[e.BEFORE_ATTRIBUTE_VALUE=34]="BEFORE_ATTRIBUTE_VALUE",e[e.ATTRIBUTE_VALUE_DOUBLE_QUOTED=35]="ATTRIBUTE_VALUE_DOUBLE_QUOTED",e[e.ATTRIBUTE_VALUE_SINGLE_QUOTED=36]="ATTRIBUTE_VALUE_SINGLE_QUOTED",e[e.ATTRIBUTE_VALUE_UNQUOTED=37]="ATTRIBUTE_VALUE_UNQUOTED",e[e.AFTER_ATTRIBUTE_VALUE_QUOTED=38]="AFTER_ATTRIBUTE_VALUE_QUOTED",e[e.SELF_CLOSING_START_TAG=39]="SELF_CLOSING_START_TAG",e[e.BOGUS_COMMENT=40]="BOGUS_COMMENT",e[e.MARKUP_DECLARATION_OPEN=41]="MARKUP_DECLARATION_OPEN",e[e.COMMENT_START=42]="COMMENT_START",e[e.COMMENT_START_DASH=43]="COMMENT_START_DASH",e[e.COMMENT=44]="COMMENT",e[e.COMMENT_LESS_THAN_SIGN=45]="COMMENT_LESS_THAN_SIGN",e[e.COMMENT_LESS_THAN_SIGN_BANG=46]="COMMENT_LESS_THAN_SIGN_BANG",e[e.COMMENT_LESS_THAN_SIGN_BANG_DASH=47]="COMMENT_LESS_THAN_SIGN_BANG_DASH",e[e.COMMENT_LESS_THAN_SIGN_BANG_DASH_DASH=48]="COMMENT_LESS_THAN_SIGN_BANG_DASH_DASH",e[e.COMMENT_END_DASH=49]="COMMENT_END_DASH",e[e.COMMENT_END=50]="COMMENT_END",e[e.COMMENT_END_BANG=51]="COMMENT_END_BANG",e[e.DOCTYPE=52]="DOCTYPE",e[e.BEFORE_DOCTYPE_NAME=53]="BEFORE_DOCTYPE_NAME",e[e.DOCTYPE_NAME=54]="DOCTYPE_NAME",e[e.AFTER_DOCTYPE_NAME=55]="AFTER_DOCTYPE_NAME",e[e.AFTER_DOCTYPE_PUBLIC_KEYWORD=56]="AFTER_DOCTYPE_PUBLIC_KEYWORD",e[e.BEFORE_DOCTYPE_PUBLIC_IDENTIFIER=57]="BEFORE_DOCTYPE_PUBLIC_IDENTIFIER",e[e.DOCTYPE_PUBLIC_IDENTIFIER_DOUBLE_QUOTED=58]="DOCTYPE_PUBLIC_IDENTIFIER_DOUBLE_QUOTED",e[e.DOCTYPE_PUBLIC_IDENTIFIER_SINGLE_QUOTED=59]="DOCTYPE_PUBLIC_IDENTIFIER_SINGLE_QUOTED",e[e.AFTER_DOCTYPE_PUBLIC_IDENTIFIER=60]="AFTER_DOCTYPE_PUBLIC_IDENTIFIER",e[e.BETWEEN_DOCTYPE_PUBLIC_AND_SYSTEM_IDENTIFIERS=61]="BETWEEN_DOCTYPE_PUBLIC_AND_SYSTEM_IDENTIFIERS",e[e.AFTER_DOCTYPE_SYSTEM_KEYWORD=62]="AFTER_DOCTYPE_SYSTEM_KEYWORD",e[e.BEFORE_DOCTYPE_SYSTEM_IDENTIFIER=63]="BEFORE_DOCTYPE_SYSTEM_IDENTIFIER",e[e.DOCTYPE_SYSTEM_IDENTIFIER_DOUBLE_QUOTED=64]="DOCTYPE_SYSTEM_IDENTIFIER_DOUBLE_QUOTED",e[e.DOCTYPE_SYSTEM_IDENTIFIER_SINGLE_QUOTED=65]="DOCTYPE_SYSTEM_IDENTIFIER_SINGLE_QUOTED",e[e.AFTER_DOCTYPE_SYSTEM_IDENTIFIER=66]="AFTER_DOCTYPE_SYSTEM_IDENTIFIER",e[e.BOGUS_DOCTYPE=67]="BOGUS_DOCTYPE",e[e.CDATA_SECTION=68]="CDATA_SECTION",e[e.CDATA_SECTION_BRACKET=69]="CDATA_SECTION_BRACKET",e[e.CDATA_SECTION_END=70]="CDATA_SECTION_END",e[e.CHARACTER_REFERENCE=71]="CHARACTER_REFERENCE",e[e.AMBIGUOUS_AMPERSAND=72]="AMBIGUOUS_AMPERSAND"})(On||(On={}));On.DATA,On.RCDATA,On.RAWTEXT,On.SCRIPT_DATA,On.PLAINTEXT,On.CDATA_SECTION;const Ag=new Set([L.DD,L.DT,L.LI,L.OPTGROUP,L.OPTION,L.P,L.RB,L.RP,L.RT,L.RTC]);[...Ag,L.CAPTION,L.COLGROUP,L.TBODY,L.TD,L.TFOOT,L.TH,L.THEAD,L.TR];const Zu=new Set([L.APPLET,L.CAPTION,L.HTML,L.MARQUEE,L.OBJECT,L.TABLE,L.TD,L.TEMPLATE,L.TH]);[...Zu,L.OL,L.UL];[...Zu,L.BUTTON];L.ANNOTATION_XML,L.MI,L.MN,L.MO,L.MS,L.MTEXT;L.DESC,L.FOREIGN_OBJECT,L.TITLE;L.TR,L.TEMPLATE,L.HTML;L.TBODY,L.TFOOT,L.THEAD,L.TEMPLATE,L.HTML;L.TABLE,L.TEMPLATE,L.HTML;L.TD,L.TH;var na;(function(e){e[e.Marker=0]="Marker",e[e.Element=1]="Element"})(na||(na={}));na.Marker;new Map(["attributeName","attributeType","baseFrequency","baseProfile","calcMode","clipPathUnits","diffuseConstant","edgeMode","filterUnits","glyphRef","gradientTransform","gradientUnits","kernelMatrix","kernelUnitLength","keyPoints","keySplines","keyTimes","lengthAdjust","limitingConeAngle","markerHeight","markerUnits","markerWidth","maskContentUnits","maskUnits","numOctaves","pathLength","patternContentUnits","patternTransform","patternUnits","pointsAtX","pointsAtY","pointsAtZ","preserveAlpha","preserveAspectRatio","primitiveUnits","refX","refY","repeatCount","repeatDur","requiredExtensions","requiredFeatures","specularConstant","specularExponent","spreadMethod","startOffset","stdDeviation","stitchTiles","surfaceScale","systemLanguage","tableValues","targetX","targetY","textLength","viewBox","viewTarget","xChannelSelector","yChannelSelector","zoomAndPan"].map(e=>[e.toLowerCase(),e]));lt.XLINK,lt.XLINK,lt.XLINK,lt.XLINK,lt.XLINK,lt.XLINK,lt.XLINK,lt.XML,lt.XML,lt.XMLNS,lt.XMLNS;new Map(["altGlyph","altGlyphDef","altGlyphItem","animateColor","animateMotion","animateTransform","clipPath","feBlend","feColorMatrix","feComponentTransfer","feComposite","feConvolveMatrix","feDiffuseLighting","feDisplacementMap","feDistantLight","feFlood","feFuncA","feFuncB","feFuncG","feFuncR","feGaussianBlur","feImage","feMerge","feMergeNode","feMorphology","feOffset","fePointLight","feSpecularLighting","feSpotLight","feTile","feTurbulence","foreignObject","glyphRef","linearGradient","radialGradient","textPath"].map(e=>[e.toLowerCase(),e]));L.B,L.BIG,L.BLOCKQUOTE,L.BODY,L.BR,L.CENTER,L.CODE,L.DD,L.DIV,L.DL,L.DT,L.EM,L.EMBED,L.H1,L.H2,L.H3,L.H4,L.H5,L.H6,L.HEAD,L.HR,L.I,L.IMG,L.LI,L.LISTING,L.MENU,L.META,L.NOBR,L.OL,L.P,L.PRE,L.RUBY,L.S,L.SMALL,L.SPAN,L.STRONG,L.STRIKE,L.SUB,L.SUP,L.TABLE,L.TT,L.U,L.UL,L.VAR;var Pl;(function(e){e[e.INITIAL=0]="INITIAL",e[e.BEFORE_HTML=1]="BEFORE_HTML",e[e.BEFORE_HEAD=2]="BEFORE_HEAD",e[e.IN_HEAD=3]="IN_HEAD",e[e.IN_HEAD_NO_SCRIPT=4]="IN_HEAD_NO_SCRIPT",e[e.AFTER_HEAD=5]="AFTER_HEAD",e[e.IN_BODY=6]="IN_BODY",e[e.TEXT=7]="TEXT",e[e.IN_TABLE=8]="IN_TABLE",e[e.IN_TABLE_TEXT=9]="IN_TABLE_TEXT",e[e.IN_CAPTION=10]="IN_CAPTION",e[e.IN_COLUMN_GROUP=11]="IN_COLUMN_GROUP",e[e.IN_TABLE_BODY=12]="IN_TABLE_BODY",e[e.IN_ROW=13]="IN_ROW",e[e.IN_CELL=14]="IN_CELL",e[e.IN_SELECT=15]="IN_SELECT",e[e.IN_SELECT_IN_TABLE=16]="IN_SELECT_IN_TABLE",e[e.IN_TEMPLATE=17]="IN_TEMPLATE",e[e.AFTER_BODY=18]="AFTER_BODY",e[e.IN_FRAMESET=19]="IN_FRAMESET",e[e.AFTER_FRAMESET=20]="AFTER_FRAMESET",e[e.AFTER_AFTER_BODY=21]="AFTER_AFTER_BODY",e[e.AFTER_AFTER_FRAMESET=22]="AFTER_AFTER_FRAMESET"})(Pl||(Pl={}));L.TABLE,L.TBODY,L.TFOOT,L.THEAD,L.TR;L.CAPTION,L.COL,L.COLGROUP,L.TBODY,L.TD,L.TFOOT,L.TH,L.THEAD,L.TR;_.AREA,_.BASE,_.BASEFONT,_.BGSOUND,_.BR,_.COL,_.EMBED,_.FRAME,_.HR,_.IMG,_.INPUT,_.KEYGEN,_.LINK,_.META,_.PARAM,_.SOURCE,_.TRACK,_.WBR;const Pg=["https://frankfurt.monochrome.tf","https://virginia.monochrome.tf","https://ohio.monochrome.tf","https://singapore.monochrome.tf","https://california.monochrome.tf","https://oregon.monochrome.tf","https://jakarta.monochrome.tf","https://tokyo.monochrome.tf","https://london.monochrome.tf","https://triton.squid.wtf","https://aether.squid.wtf","https://zeus.squid.wtf","https://kraken.squid.wtf","https://phoenix.squid.wtf","https://shiva.squid.wtf","https://chaos.squid.wtf","https://hund.qqdl.site","https://katze.qqdl.site","https://vogel.qqdl.site","https://maus.qqdl.site","https://wolf.qqdl.site","https://monochrome.tf","https://music.binimum.org","https://tidal.squid.wtf","https://tidal.qqdl.site","https://hifi.401658.xyz","https://tidal.401658.xyz"],xl={async getDownloadDirectory(){const e="PlayTorrio/Music";try{await Yi.mkdir({path:e,directory:no.Documents,recursive:!0})}catch{}return e},async musicFetchJson(e){let t=null;for(const n of Pg)try{const i={url:`${n}${e}`,headers:{"User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36"}},r=await ul.get(i);if(r.status>=200&&r.status<300)return r.data;t=new Error(`HTTP ${r.status} from ${n}`)}catch(o){t=o}throw t||new Error("All music providers failed")},async searchMusic(e){if(!e||!e.trim())return[];try{const t=await this.musicFetchJson(`/search/?s=${encodeURIComponent(e.trim())}`),n=Array.isArray(t?.items)?t.items:[],o=n.filter(i=>(i.type||i.itemType||"").toString().toLowerCase()==="track"||i.audioQuality||i.artist);return o.length?o:n}catch(t){throw console.error("[MusicService] Search error:",t),t}},async getTrackDetails(e){try{return await this.musicFetchJson(`/track/?id=${encodeURIComponent(e)}&quality=LOSSLESS`)}catch(t){throw console.error("[MusicService] Get track error:",t),t}},async downloadTrack(e,t,n,o){console.log(`[MusicService] Starting download for ${t} (${e})...`);let i=null;try{const k=await this.getTrackDetails(e);if(Array.isArray(k)&&k.length>=3&&(i=k[2]?.OriginalTrackUrl||k[2]?.originalTrackUrl),!i&&Array.isArray(k))for(const A of k){const U=A?.OriginalTrackUrl||A?.originalTrackUrl;if(U&&!U.startsWith("http://www.tidal.com")){i=U;break}}}catch(k){throw console.error("[MusicService] Failed to fetch track details:",k),new Error("Failed to fetch track details")}if(!i)throw new Error("No valid track URL found");const r=k=>k.replace(/[<>:"/\\|?*]/g,"_").replace(/\s+/g," ").trim(),a=r(n||"Unknown Artist"),u=r(t||"Unknown Song");let m="mp3";const y=i.toLowerCase();y.includes(".flac")?m="flac":y.includes(".m4a")?m="m4a":y.includes(".aac")?m="aac":y.includes(".ogg")?m="ogg":y.includes(".wav")&&(m="wav");const p=`${a} - ${u}.${m}`;await this.getDownloadDirectory();const N=`PlayTorrio/Music/${p}`;console.log(`[MusicService] Downloading ${u} from ${i} to Documents/${N}`);const I={url:i,filePath:N,fileDirectory:no.Documents,method:"GET"};try{const k=await ul.downloadFile(I);if(k.path)return console.log(`[MusicService] Download success: ${k.path}`),{success:!0,path:k.path,filename:p,trackId:e,title:t,artist:n,cover:o};throw new Error("No path returned from download")}catch(k){throw console.error("[MusicService] Download failed:",k),k}},async listDownloads(){const e=await this.getDownloadDirectory();try{return(await Yi.readdir({path:e,directory:no.Documents})).files}catch{return[]}},async deleteDownload(e){const t=await this.getDownloadDirectory();try{return await Yi.deleteFile({path:`${t}/${e}`,directory:no.Documents}),!0}catch(n){throw console.error("[MusicService] Delete failed",n),n}},async getFileUri(e){const t=await this.getDownloadDirectory();try{return(await Yi.getUri({path:`${t}/${e}`,directory:no.Documents})).uri}catch{return null}}};console.log("[MAIN.JS] Script file loaded - this appears BEFORE imports");window.electronAPI=window.electronAPI||{};window.electronAPI.platform="android";const xg=window.fetch,oa="http://mock-backend",se=oa;window.fetch=async(e,t)=>{let n=e.toString();if(n.startsWith(oa)||n.includes("localhost:6987")){console.log("[FakeBackend]",t?.method||"GET",n);const o=n.replace(oa,"").replace("http://localhost:6987/api","").split("?")[0];if(o==="/settings"){const i=JSON.parse(localStorage.getItem("mock_settings")||"{}");if(t?.method==="POST"){const r=JSON.parse(t.body),a={...i,...r};return localStorage.setItem("mock_settings",JSON.stringify(a)),new Response(JSON.stringify({success:!0,settings:a}),{status:200})}return new Response(JSON.stringify(i),{status:200})}if(o==="/check-api-key"||o==="/get-api-key")return new Response(JSON.stringify({hasApiKey:!0,useTorrentless:!0,apiKey:"mock-key"}),{status:200});if(o==="/resume"||o==="/resume/all"){const i=JSON.parse(localStorage.getItem("mock_resume")||"{}");if(t?.method==="POST"){const r=JSON.parse(t.body);return r.key&&(i[r.key]=r,localStorage.setItem("mock_resume",JSON.stringify(i))),new Response(JSON.stringify({success:!0}),{status:200})}return t?.method==="DELETE"?new Response(JSON.stringify({success:!0}),{status:200}):o==="/resume/all"?new Response(JSON.stringify(Object.values(i)),{status:200}):new Response(JSON.stringify(i),{status:200})}return o.startsWith("/debrid")?new Response(JSON.stringify({success:!1,message:"Debrid not supported in standalone mode yet"}),{status:200}):(console.warn("[FakeBackend] Unhandled route:",o),new Response(JSON.stringify({success:!1,error:"Route not mocked"}),{status:404}))}return xg(e,t)};window.electronAPI.spawnMpvjsPlayer=async e=>{console.log("[ElectronShim] spawnMpvjsPlayer",e);try{return await Dr.play(e.url),{success:!0}}catch(t){return console.error("[ElectronShim] Player Error",t),{success:!1,message:t.message}}};window.electronAPI.openMpvDirect=async e=>{console.log("[ElectronShim] openMpvDirect",e);try{return await Dr.play(e),{success:!0}}catch(t){return console.error("[ElectronShim] Player Error",t),{success:!1,message:t.message}}};window.electronAPI.openInVLC=async e=>{console.log("[ElectronShim] openInVLC",e);const t=typeof e=="string"?e:e.url||e.streamUrl;try{return await Dr.playInVlc(t),{success:!0}}catch(n){return{success:!1,message:n.message}}};window.electronAPI.openInIINA=async e=>{console.log("[ElectronShim] openInIINA fallback",e);const t=typeof e=="string"?e:e.url||e.streamUrl;try{return await Dr.play(t),{success:!0}}catch(n){return{success:!1,message:n.message}}};window.electronAPI.openMPVDirect=window.electronAPI.openMpvDirect;window.electronAPI.openExternal=async e=>(console.log("[ElectronShim] openExternal",e),window.open(e,"_system"),Promise.resolve());window.electronAPI.showSaveDialog=async()=>({canceled:!0});window.electronAPI.showOpenDialog=async()=>({canceled:!0});window.electronAPI.writeFile=async()=>({success:!1,error:"Not supported on Android yet"});window.electronAPI.readFile=async()=>({success:!1,error:"Not supported on Android yet"});window.electronAPI.showFolderInExplorer=async()=>{};window.electronAPI.updateDiscordPresence=async()=>{};window.electronAPI.clearDiscordPresence=async()=>{};window.electronAPI.discoverChromecastDevices=async()=>({success:!1,devices:[]});window.electronAPI.castToChromecast=async()=>({success:!1});window.electronAPI.onUpdateChecking=()=>{};window.electronAPI.onUpdateNotAvailable=()=>{};window.electronAPI.onUpdateAvailable=()=>{};window.electronAPI.onUpdateProgress=()=>{};window.electronAPI.onUpdateDownloaded=()=>{};window.electronAPI.installUpdateNow=async()=>{};window.electronAPI.clearCache=async()=>({success:!0});window.electronAPI.selectCacheFolder=async()=>({canceled:!0});window.electronAPI.clearWebtorrentTemp=async()=>({success:!0});window.electronAPI.getFullscreen=async()=>!1;window.electronAPI.setFullscreen=async()=>{};let Si=localStorage.getItem("uiMode")||"new";function Fa(e){Si=e,document.body.classList.remove("ui-old","ui-new"),document.body.classList.add(`ui-${e}`),localStorage.setItem("uiMode",e)}Fa(Si);const $l={default:{primary:"#2a1847",secondary:"#8b5cf6",tertiary:"#c084fc",dark:"#120a1f",light:"#f8f9fa",gray:"#6c757d",accent:"#a855f7",cardBg:"#2a1847",modalBg:"linear-gradient(135deg, #2a1847, #120a1f)",headerBg:"#2a1847",inputBg:"rgba(255, 255, 255, 0.1)",hoverBg:"rgba(168, 85, 247, 0.2)"},"green-forest":{primary:"#1a3a2e",secondary:"#4caf50",tertiary:"#81c784",dark:"#0f1e17",light:"#f1f8f4",gray:"#6c8073",accent:"#66bb6a",cardBg:"#1e4d3a",modalBg:"linear-gradient(135deg, #1a3a2e, #0f1e17)",headerBg:"#1a3a2e",inputBg:"rgba(76, 175, 80, 0.15)",hoverBg:"rgba(76, 175, 80, 0.25)"},"cyberpunk-neon":{primary:"#1a1a2e",secondary:"#ff00ff",tertiary:"#00ffff",dark:"#0f0f1e",light:"#f0f0ff",gray:"#7070a0",accent:"#ff00aa",cardBg:"#252540",modalBg:"linear-gradient(135deg, #1a1a2e, #0f0f1e)",headerBg:"#1a1a2e",inputBg:"rgba(255, 0, 255, 0.15)",hoverBg:"rgba(255, 0, 255, 0.3)"},"ocean-breeze":{primary:"#1e3a5f",secondary:"#2196f3",tertiary:"#64b5f6",dark:"#0d1f36",light:"#e3f2fd",gray:"#607d8b",accent:"#42a5f5",cardBg:"#2a4a6f",modalBg:"linear-gradient(135deg, #1e3a5f, #0d1f36)",headerBg:"#1e3a5f",inputBg:"rgba(33, 150, 243, 0.15)",hoverBg:"rgba(33, 150, 243, 0.25)"},"cherry-blossom":{primary:"#4a2545",secondary:"#ff4081",tertiary:"#ff80ab",dark:"#1a0e1a",light:"#fff0f5",gray:"#8e7a8b",accent:"#f48fb1",cardBg:"#5a3555",modalBg:"linear-gradient(135deg, #4a2545, #1a0e1a)",headerBg:"#4a2545",inputBg:"rgba(255, 64, 129, 0.15)",hoverBg:"rgba(255, 64, 129, 0.25)"},"midnight-dark":{primary:"#1c1c2e",secondary:"#6366f1",tertiary:"#818cf8",dark:"#0a0a14",light:"#e0e7ff",gray:"#64748b",accent:"#7c3aed",cardBg:"#2a2a40",modalBg:"linear-gradient(135deg, #1c1c2e, #0a0a14)",headerBg:"#1c1c2e",inputBg:"rgba(99, 102, 241, 0.15)",hoverBg:"rgba(99, 102, 241, 0.25)"},"sunset-orange":{primary:"#3d2a1f",secondary:"#ff9800",tertiary:"#ffb74d",dark:"#1a0f0a",light:"#fff3e0",gray:"#8d6e63",accent:"#fb8c00",cardBg:"#4d3a2f",modalBg:"linear-gradient(135deg, #3d2a1f, #1a0f0a)",headerBg:"#3d2a1f",inputBg:"rgba(255, 152, 0, 0.15)",hoverBg:"rgba(255, 152, 0, 0.25)"}};let Ha=localStorage.getItem("appTheme")||"default";function Va(e){const t=$l[e]||$l.default,n=document.documentElement;n.style.setProperty("--primary",t.primary),n.style.setProperty("--secondary",t.secondary),n.style.setProperty("--tertiary",t.tertiary),n.style.setProperty("--dark",t.dark),n.style.setProperty("--light",t.light),n.style.setProperty("--gray",t.gray),n.style.setProperty("--vlc-orange",t.accent),n.style.setProperty("--card-bg",t.cardBg),n.style.setProperty("--modal-bg",t.modalBg),n.style.setProperty("--header-bg",t.headerBg),n.style.setProperty("--input-bg",t.inputBg),n.style.setProperty("--hover-bg",t.hoverBg),Ha=e,localStorage.setItem("appTheme",e)}Va(Ha);const Xe="b3556f3b206e16f82df4d1f6fd4545e6";let Gu=localStorage.getItem("useStreamingServers")==="true",Qi=localStorage.getItem("selectedServer")||"VidSrc TO",_t=[],wn=[];console.log("[DEBUG] JavaScript loaded, useStreamingServers:",Gu);const wt=document.getElementById("moviesGrid"),Er=document.getElementById("loadingIndicator");document.getElementById("homePage");const $g=document.getElementById("genresBtn");document.getElementById("genresPage");const Nl=document.getElementById("genresGrid"),Ml=document.getElementById("genresLoading");document.getElementById("genreDetailsPage");const Rl=document.getElementById("genreTitle"),ef=document.getElementById("toggleMovies"),tf=document.getElementById("toggleTV"),br=document.getElementById("genreResultsGrid"),_l=document.getElementById("genreLoadingIndicator"),Ti=document.getElementById("genreEmptyMessage"),Ir=document.getElementById("detailsModal"),Ng=document.getElementById("modalClose"),Mg=document.getElementById("modalBackdrop"),Rg=document.getElementById("modalPoster"),_g=document.getElementById("modalTitle"),Ug=document.getElementById("modalRating"),Og=document.getElementById("modalYear"),Dg=document.getElementById("modalRuntime"),Fg=document.getElementById("modalTagline"),Hg=document.getElementById("modalOverview"),Ul=document.getElementById("castGrid"),Ol=document.getElementById("similarGrid"),Ct=document.getElementById("torrentsList"),ai=document.getElementById("notification"),Vg=document.getElementById("watchNowBtn");document.getElementById("modalDoneWatchingBtn");const dt=document.getElementById("traktWatchlistBtn"),Dl=document.getElementById("seasonsContainer"),Fl=document.getElementById("seasonSelector"),ia=document.getElementById("episodesGrid"),jg=document.getElementById("refreshTorrents"),ja=document.getElementById("torrentsContainer"),xo=document.getElementById("torrentKeywordFilter"),kr=document.getElementById("discordModal"),Hl=document.getElementById("discordClose"),Vl=document.getElementById("discordJoinBtn"),jl=document.getElementById("discordDontShowBtn"),ql=document.getElementById("discordBtn"),or=document.getElementById("settingsModal"),qg=document.getElementById("clearCacheBtn"),zg=document.getElementById("settingsClose");document.getElementById("currentApiKey");const Wg=document.getElementById("newApiKey"),Kg=document.getElementById("saveSettings"),Yg=document.getElementById("cancelSettings");document.getElementById("useTorrentlessToggle");document.getElementById("jackettUrl");document.getElementById("cacheLocation");document.getElementById("selectCacheBtn");const Jg=document.getElementById("useDebridToggle"),Xg=document.getElementById("debridProvider"),Zi=document.getElementById("debridStatus");document.getElementById("debridToken");document.getElementById("saveDebridToken");document.getElementById("clearDebridToken");const Qg=document.getElementById("rdClientId"),zl=document.getElementById("rdDeviceLogin");document.getElementById("rdClientIdGroup");document.getElementById("rdButtons");document.getElementById("rdTokenGroup");document.getElementById("rdTokenButtons");const As=document.getElementById("rdCodePanel"),Wl=document.getElementById("rdUserCode"),Ps=document.getElementById("rdVerifyUrl"),Kl=document.getElementById("rdOpenVerify"),Yl=document.getElementById("rdCopyCode"),Jl=document.getElementById("rdCancelLogin"),Gi=document.getElementById("rdLoginStatus"),Xl=document.getElementById("adSection"),Sr=document.getElementById("adStartPin"),Bo=document.getElementById("adPinPanel"),xs=document.getElementById("adPinCode"),$s=document.getElementById("adUserUrl"),Ql=document.getElementById("adOpenUserUrl"),Zl=document.getElementById("adCopyPin"),Gl=document.getElementById("adCancelPin"),Ao=document.getElementById("adLoginStatus");document.getElementById("adApiKey");document.getElementById("adSaveApiKey");document.getElementById("adClearApiKey");document.getElementById("tbSection");document.getElementById("tbToken");document.getElementById("tbSaveToken");document.getElementById("tbClearToken");document.getElementById("pmSection");document.getElementById("pmApiKey");document.getElementById("pmSaveApiKey");document.getElementById("pmClearApiKey");document.getElementById("traktNotConnected");document.getElementById("traktConnected");document.getElementById("traktStatus");document.getElementById("traktConnectedStatus");document.getElementById("traktUsername");document.getElementById("traktLogin");document.getElementById("traktViewWatchlist");document.getElementById("traktViewHistory");document.getElementById("traktViewStats");document.getElementById("traktDisconnect");const ed=document.getElementById("traktCodePanel"),Zg=document.getElementById("traktUserCode"),Gg=document.getElementById("traktVerifyUrl");document.getElementById("traktOpenVerify");document.getElementById("traktCopyCode");document.getElementById("traktCancelLogin");const td=document.getElementById("traktLoginStatus"),fo=document.getElementById("traktAutoScrobble"),mo=document.getElementById("traktScrobbleProgress"),Tr=document.getElementById("traktSyncWatchlist"),ra=document.getElementById("mpvPlayerContainer"),on=document.getElementById("mpvPlayerTitle"),nd=document.getElementById("closePlayerBtn");document.getElementById("fileSelector");const cn=document.getElementById("fileList"),Ns=document.getElementById("subtitleControls"),ci=document.getElementById("subtitleList");document.getElementById("mpvPlayerArea");const Nt=document.getElementById("mpvLoading"),Ms=document.getElementById("mpvControls");function eh(e){try{return String(e||"").split(/[\\\/]/).pop()}catch{return e||""}}const ir=document.getElementById("openMPVBtn"),od=document.getElementById("openVLCBtn");window.electronAPI&&window.electronAPI.platform==="darwin"&&ir&&(ir.innerHTML='<i class="fas fa-external-link-alt"></i> Open in IINA',ir.id="openIINABtn");const id=document.getElementById("copyStreamBtn"),rd=document.getElementById("playNowBtn"),Nn=document.getElementById("streamSourceBadge"),Fn=document.getElementById("customPlayerContainer");document.getElementById("customPlayerTitle");const Mn=document.getElementById("customSourceBadge"),sd=document.getElementById("closeCustomPlayer"),Ve=document.getElementById("customVideo");document.getElementById("videoSource");const Rs=document.getElementById("loadingOverlay");document.getElementById("subtitleDisplay");const _s=document.getElementById("videoControls"),ad=document.getElementById("progressBar");document.getElementById("progressFilled");document.getElementById("currentTime");document.getElementById("totalTime");const Po=document.getElementById("playPauseBtn"),cd=document.getElementById("rewindBtn"),ld=document.getElementById("forwardBtn"),dd=document.getElementById("fullscreenBtn"),er=document.getElementById("subtitleFile"),Us=document.getElementById("htmlMuteBtn"),Os=document.getElementById("htmlVolume"),Lr=document.getElementById("htmlSubsBtn"),En=document.getElementById("htmlSubsPanel");document.getElementById("htmlSubsList");const Cr=document.getElementById("htmlSubsClose"),ud=document.getElementById("htmlSubsUploadBtn"),Ds=document.getElementById("subsSize");document.getElementById("subsSizeValue");const Fs=document.getElementById("subsColor"),Hs=document.getElementById("subsBackground"),Vs=document.getElementById("subsBackgroundOpacity");document.getElementById("subsOpacityValue");const js=document.getElementById("subsFont"),qs=document.getElementById("wcjsPlayerContainer");document.getElementById("wcjsPlayerTitle");document.getElementById("wcjsCanvas");document.getElementById("wcjsLoading");const fd=document.getElementById("closeWcjsPlayer");document.getElementById("wcjsControls");const md=document.getElementById("wcjsProgressBar");document.getElementById("wcjsProgressFilled");document.getElementById("wcjsCurrentTime");document.getElementById("wcjsTotalTime");const pd=document.getElementById("wcjsPlayPauseBtn"),yd=document.getElementById("wcjsRewindBtn"),gd=document.getElementById("wcjsForwardBtn"),hd=document.getElementById("wcjsFullscreenBtn"),vd=document.getElementById("wcjsMuteBtn"),wd=document.getElementById("wcjsVolume"),Ed=document.getElementById("wcjsSubtitleFile"),bd=document.getElementById("wcjsSubsBtn"),Id=document.getElementById("wcjsAudioBtn"),Rn=document.getElementById("wcjsSubsPanel"),_n=document.getElementById("wcjsAudioPanel");document.getElementById("wcjsSubsList");document.getElementById("wcjsAudioList");const kd=document.getElementById("wcjsSubsRefresh"),Sd=document.getElementById("wcjsSubsClose"),Td=document.getElementById("wcjsAudioClose");let Hn=1,zt=!1,ne=null,Le="movie",Ge=null,je=1,rr=null,mn=null,jt=null,Un=null,Ld=0,sa=null,th=[],Pe="jackett",Ht=null,Bt=null,io="popularity",ro="all",mi=[],Ze=null,De=null,aa=!1,po=!1,fn=!1,Vt=!1,un="realdebrid",bn="all",li=[],Mt=1;const zs=20;let Gt="seeders",qt="all",$o=[];function nh(){if(console.log("[Cleanup] Resetting streaming state..."),mn=null,rr=null,jt=null,Un=null,sa=null,Ze=null,De=null,window.hls){try{window.hls.destroy(),console.log("[Cleanup] HLS instance destroyed")}catch(e){console.warn("[Cleanup] Error destroying HLS:",e?.message)}window.hls=null}console.log("[Cleanup] Streaming state reset complete")}let ca=!1,di=[],nf="",pi=!1,yi=!1,sr=!0;async function of(){try{const e=await fetch(`${se}/settings`);if(e.ok){const t=await e.json();return sr=t.discordActivity===void 0?!0:t.discordActivity,sr}}catch(e){console.error("[Discord] Failed to check activity setting:",e)}return sr}async function Mo(e,t="PlayTorrio",n=null){if(!window.electronAPI?.updateDiscordPresence)return;if(!await of()){if(pi)try{await window.electronAPI.updateDiscordPresence(null),pi=!1}catch(i){console.error("[Discord] Failed to clear presence:",i)}return}try{pi=!0;let i=e;n!=null&&(i=`${e} - Season ${n}`);const r=`Watching: ${i}`,a=`via ${t}`;await window.electronAPI.updateDiscordPresence({details:r,state:a,startTimestamp:new Date,largeImageKey:"icon",largeImageText:"PlayTorrio App",smallImageKey:"play",smallImageText:"Streaming",buttons:[{label:"Download App",url:"https://github.com/ayman707-ux/PlayTorrio"}]})}catch(i){console.error("[Discord] Failed to update streaming presence:",i)}}async function Cd(e,t,n){if(!window.electronAPI?.updateDiscordPresence)return;if(!await of()){if(yi)try{await window.electronAPI.updateDiscordPresence(null),yi=!1}catch(i){console.error("[Discord] Failed to clear presence:",i)}return}try{yi=!0;const i=`ðŸŽµ ${e}`,r=t?`by ${t}${n?` - ${n}`:""}`:n||"Music";await window.electronAPI.updateDiscordPresence({details:i,state:r,startTimestamp:new Date,largeImageKey:"icon",largeImageText:"PlayTorrio App",smallImageKey:"music",smallImageText:"Listening",buttons:[{label:"Download App",url:"https://github.com/ayman707-ux/PlayTorrio"}]})}catch(i){console.error("[Discord] Failed to update music presence:",i)}}async function la(){if(window.electronAPI?.clearDiscordPresence)try{pi=!1,yi=!1,await window.electronAPI.clearDiscordPresence()}catch(e){console.error("[Discord] Failed to clear presence:",e)}}let Je="home",Br=new Map,Bd=!1,Dn=null,In="movie",gi=1;function Ad(){window.__onGCastApiAvailable=function(e){if(e)try{window.cast.framework.CastContext.getInstance().setOptions({receiverApplicationId:window.chrome.cast.media.DEFAULT_MEDIA_RECEIVER_APP_ID,autoJoinPolicy:window.chrome.cast.AutoJoinPolicy.ORIGIN_SCOPED}),console.log("Google Cast initialized successfully")}catch(t){console.error("Error initializing Cast:",t)}}}async function da(){ih(),mv(),lh();try{await ah()}catch(e){console.warn("Backend check failed (expected on Android without server):",e)}try{await Ar()}catch(e){console.warn("Debrid state check failed:",e)}typeof Kd=="function"&&Kd(),typeof initializeBookTorrio=="function"&&initializeBookTorrio(),typeof initializeAudioBooks=="function"&&initializeAudioBooks(),typeof initializeAnime=="function"&&initializeAnime(),typeof initializeManga=="function"&&initializeManga(),typeof Pd=="function"&&Pd(),typeof ha=="function"&&ha(),typeof $d=="function"&&$d(),typeof Ad=="function"&&Ad(),document.body.classList.contains("ui-new")&&(console.log("[DEBUG] ui-new class found, calling initializeNewUI..."),await Ev()),console.log("[DEBUG] Calling initMobileSidebar..."),oh()}function oh(){console.log("[MobileSidebar] Initializing mobile sidebar...");const e=document.getElementById("mobileMenuBtn"),t=document.getElementById("appSidebar"),n=document.getElementById("sidebarOverlay"),o=document.getElementById("sidebarCloseBtn");console.log("[MobileSidebar] Elements found:",{mobileMenuBtn:!!e,appSidebar:!!t,sidebarOverlay:!!n,sidebarCloseBtn:!!o});function i(m){if(console.log("[MobileSidebar] toggleSidebar called with show:",m),!t||!n){console.error("[MobileSidebar] Missing elements - cannot toggle sidebar");return}m?(console.log("[MobileSidebar] Adding mobile-open class"),t.classList.add("mobile-open"),n.classList.add("active"),document.body.classList.add("sidebar-open"),document.body.style.overflow="hidden"):(t.classList.remove("mobile-open"),n.classList.remove("active"),document.body.classList.remove("sidebar-open"),document.body.style.overflow="")}e?e.addEventListener("click",m=>{console.log("[MobileSidebar] Hamburger button clicked!"),m.stopPropagation(),i(!0)}):console.error("[MobileSidebar] mobileMenuBtn not found!"),o&&o.addEventListener("click",()=>i(!1)),n&&n.addEventListener("click",()=>i(!1));const r=document.getElementById("sidebarSettings");r&&r.addEventListener("click",()=>{i(!1);const m=document.getElementById("settingsModal");m&&(m.classList.add("active"),document.body.style.overflow="hidden")});const a=document.getElementById("quickRefresh");a&&a.addEventListener("click",()=>{i(!1),window.location.reload()}),document.querySelectorAll(".app-sidebar .nav-item").forEach(m=>{m.addEventListener("click",()=>{i(!1);const y=m.getAttribute("data-page");y&&(y==="home"?window.location.hash="#/":window.location.hash="#/"+y)})}),window.addEventListener("resize",()=>{window.innerWidth>768&&i(!1)})}function ih(){const e=document.querySelectorAll(".bottom-nav-item");console.log("[MobileNav] Setting up listeners for",e.length,"items"),e.forEach(t=>{t.addEventListener("click",n=>{n.preventDefault(),n.stopPropagation();const o=t.dataset.page;if(console.log("[MobileNav] Clicked:",o),o){let i="";o==="home"?i="#/":i="#/"+o,window.location.hash===i?(console.log("[MobileNav] Already on page, forcing view update"),updateActiveSection(o==="home"?"home":o==="genres"?"genreDetails":o)):window.location.hash=i}})})}function Pd(){const e=document.getElementById("windowsUsername");if(e)try{window.electronAPI&&window.electronAPI.getUsername?window.electronAPI.getUsername().then(t=>{t.success&&t.username&&(e.textContent=t.username)}).catch(()=>{xd(e)}):xd(e)}catch(t){console.error("Error getting username:",t)}}function xd(e){const t=localStorage.getItem("cacheLocation");if(t&&t.includes("Users\\")){const n=t.match(/Users\\([^\\]+)/);if(n&&n[1]){e.textContent=n[1];return}}fetch(`${se}/settings`).then(n=>n.json()).then(n=>{if(n.cacheLocation&&n.cacheLocation.includes("Users\\")){const o=n.cacheLocation.match(/Users\\([^\\]+)/);o&&o[1]&&(e.textContent=o[1])}}).catch(()=>{})}async function $d(){try{const e=await so.get("discord_dismissed")==="true";(e?.success?e.value:localStorage.getItem("pt_discord_dismissed_v1"))||setTimeout(()=>{Nd()},1e3)}catch(e){console.error("[Discord] Failed to check preference:",e),localStorage.getItem("pt_discord_dismissed_v1")||setTimeout(()=>{Nd()},1e3)}}function Nd(){kr&&(kr.classList.add("active"),document.body.style.overflow="hidden")}function Ws(){kr&&(kr.classList.remove("active"),document.body.style.overflow="auto")}function rh(){const e=document.getElementById("version163Modal");e&&(e.classList.add("active"),document.body.style.overflow="hidden")}function sh(e){switch(e){case"alldebrid":return"AllDebrid";case"torbox":return"TorBox";case"premiumize":return"Premiumize";case"realdebrid":default:return"Realâ€‘Debrid"}}async function Ar(){try{const e=await fetch(`${se}/settings`);if(e.ok){const t=await e.json();fn=!!t.useDebrid,Vt=!!t.debridAuth,un=t.debridProvider||"realdebrid",console.log("[UI][Debrid] state",{useDebrid:fn,debridAuth:Vt,debridProvider:un})}}catch(e){console.warn("[UI][Debrid] state load failed",e?.message)}}async function ah(){try{const t=await(await fetch(`${se}/check-api-key`)).json();aa=t.hasApiKey,po=!!t.useTorrentless,(aa||po)&&await qa()}catch(e){console.error("Error checking API key status:",e)}}async function qa(){try{const t=await(await fetch(`${se}/get-api-key`)).json(),n=t.hasApiKey?`Current: ${t.apiKey}`:"No API key configured";document.querySelectorAll("#currentApiKey").forEach(o=>{o.textContent=n})}catch(e){console.error("Error loading current API key:",e);try{const t=await fetch(`${se}/settings`);if(t.ok){const n=await t.json();fn=!!n.useDebrid,Vt=!!n.debridAuth}}catch{}document.querySelectorAll("#currentApiKey").forEach(t=>{t.textContent="Error loading API key"})}}async function Pr(){window.location.hash="#/settings"}async function ch(){await qa(),document.querySelectorAll("#newApiKey").forEach(r=>{r.value=""});const t=document.querySelectorAll("#uiModeNew"),n=document.querySelectorAll("#uiModeOld");t.forEach(r=>{Si==="new"&&(r.checked=!0)}),n.forEach(r=>{Si==="old"&&(r.checked=!0)}),document.querySelectorAll("#themeSelector").forEach(r=>{r&&(r.value=Ha)});const i=document.querySelectorAll("#fullscreenToggle");if(await Wr(),i.length>0&&window.electronAPI&&window.electronAPI.getFullscreen)try{const r=await window.electronAPI.getFullscreen();r.success&&i.forEach(a=>{a.checked=r.isFullscreen})}catch(r){console.error("Error loading fullscreen state:",r)}try{const r=await fetch(`${se}/settings`);if(r.ok){const a=await r.json();console.log("[Settings] Loaded settings:",a),po=!!a.useTorrentless;const u=a.autoUpdate!==!1;document.querySelectorAll("#autoUpdateToggle").forEach(Z=>{Z.checked=!!u});const y=a.discordActivity===void 0?!0:a.discordActivity;sr=y,document.querySelectorAll("#discordActivityToggle").forEach(Z=>{Z.checked=!!y}),document.querySelectorAll("#useTorrentlessToggle").forEach(Z=>{Z.checked=po});const I=a.torrentSource||"torrentio";console.log("[Settings] Set torrent source to:",I);const k=document.querySelectorAll("#torrentioBtn"),A=document.querySelectorAll("#inAppScraperBtn");k.length>0&&A.length>0&&(I==="torrentio"?(k.forEach(Z=>Z.classList.add("active")),A.forEach(Z=>Z.classList.remove("active"))):(k.forEach(Z=>Z.classList.remove("active")),A.forEach(Z=>Z.classList.add("active"))));const U=document.querySelectorAll("#jackettUrl");U.length>0&&a.jackettUrl&&U.forEach(Z=>{Z.value=a.jackettUrl});const W=document.querySelectorAll("#cacheLocation");W.length>0&&a.cacheLocation&&W.forEach(Z=>{Z.value=a.cacheLocation});const Y=document.querySelectorAll("#useDebridToggle");Y.length>0&&a.useDebrid!==void 0&&Y.forEach(Z=>{Z.checked=!!a.useDebrid});const ae=a.debridProvider||"realdebrid";document.querySelectorAll("#debridProvider").forEach(Z=>{Z.value=ae}),document.querySelectorAll("#debridStatus").forEach(Z=>{Z.textContent=a.debridAuth?"Logged in":"Not logged in"});const ve=document.querySelectorAll("#rdClientId");ve.length>0&&a.rdClientId&&ve.forEach(Z=>{Z.value=a.rdClientId}),fn=!!a.useDebrid,Vt=!!a.debridAuth;const Se=ae==="realdebrid",oe=ae==="alldebrid",X=ae==="torbox",ye=ae==="premiumize";document.querySelectorAll("#rdClientIdGroup").forEach(Z=>Z.style.display=Se?"":"none"),document.querySelectorAll("#rdButtons").forEach(Z=>Z.style.display=Se?"":"none"),document.querySelectorAll("#rdTokenGroup").forEach(Z=>Z.style.display=Se?"":"none"),document.querySelectorAll("#rdTokenButtons").forEach(Z=>Z.style.display=Se?"":"none"),document.querySelectorAll("#rdCodePanel").forEach(Z=>Z.style.display="none"),document.querySelectorAll("#adSection").forEach(Z=>Z.style.display=oe?"":"none"),document.querySelectorAll("#tbSection").forEach(Z=>Z.style.display=X?"":"none"),document.querySelectorAll("#pmSection").forEach(Z=>Z.style.display=ye?"":"none")}}catch{}}function ui(){or.classList.remove("active"),document.body.style.overflow="auto"}function lh(){const e=document.querySelectorAll(".settings-tab"),t=document.querySelectorAll(".settings-section");e.forEach(n=>{n.addEventListener("click",()=>{const o=n.getAttribute("data-section");e.forEach(r=>r.classList.remove("active")),t.forEach(r=>r.classList.remove("active")),n.classList.add("active");const i=document.getElementById(`${o}Content`);i&&i.classList.add("active")})})}let ln=null,Ro=null;function Md(e){if(!e)return{title:"Unknown",type:"movie",year:null};let t=e.replace(/\.(mkv|mp4|avi|mov|wmv|flv|webm)$/i,"").replace(/\.(720p|1080p|4k|2160p|480p|hdtv|bdrip|webrip|dvdrip|cam|ts|hdrip)/gi,"").replace(/\.(x264|x265|h264|h265|xvid|divx)/gi,"").replace(/\.(aac|ac3|dts|mp3|flac)/gi,"").replace(/[\[\]()]/g," ").replace(/\b(repack|proper|real|retail|uncut|unrated|extended|directors?\.cut)\b/gi,"").trim();const n=[/(.+?)[\s\.]S(\d{1,2})E(\d{1,2})/i,/(.+?)[\s\.]Season[\s\.](\d{1,2})[\s\.]Episode[\s\.](\d{1,2})/i,/(.+?)[\s\.](\d{1,2})x(\d{1,2})/i];for(const a of n){const u=t.match(a);if(u){const m=u[1].trim().replace(/[.\-_]/g," "),y=parseInt(u[2]),p=parseInt(u[3]),N=m.match(/\b(19\d{2}|20\d{2})\b/),I=N?parseInt(N[1]):null;return{title:m.replace(/\b(19\d{2}|20\d{2})\b/,"").trim()||m,type:"show",year:I,season:y,episode:p}}}const o=t.match(/\b(19\d{2}|20\d{2})\b/),i=o?parseInt(o[1]):null;return{title:t.replace(/\b(19\d{2}|20\d{2})\b/,"").trim()||t,type:"movie",year:i}}async function Wr(){try{const t=await(await fetch(`/api/trakt/status?ts=${Date.now()}`,{cache:"no-store"})).json();t.authenticated&&t.user?dh(t.user):ua()}catch(e){console.error("[TRAKT] Status check failed:",e),ua()}}function dh(e){const t=document.querySelectorAll("#traktNotConnected"),n=document.querySelectorAll("#traktConnected"),o=document.querySelectorAll("#traktUsername"),i=document.querySelectorAll("#traktStatus");t.forEach(r=>r.style.display="none"),n.forEach(r=>r.style.display="block"),o.forEach(r=>r.textContent=e.username||e.name||"User"),i.forEach(r=>{r.innerHTML='<i class="fas fa-check-circle"></i> Connected',r.style.color="#198754"})}function ua(){const e=document.querySelectorAll("#traktNotConnected"),t=document.querySelectorAll("#traktConnected"),n=document.querySelectorAll("#traktStatus");e.forEach(o=>o.style.display="block"),t.forEach(o=>o.style.display="none"),n.forEach(o=>{o.innerHTML='<i class="fas fa-times-circle"></i> Not connected',o.style.color="#dc3545"})}async function uh(){try{document.querySelectorAll("#traktLogin").forEach(u=>{u.disabled=!0,u.innerHTML='<i class="fas fa-spinner fa-spin"></i> Connecting...'});const n=await(await fetch("/api/trakt/device/code",{method:"POST"})).json();if(!n.success)throw new Error(n.error||"Failed to get device code");const o=document.querySelectorAll("#traktCodePanel"),i=document.querySelectorAll("#traktUserCode");o.forEach(u=>u.style.display="block"),i.forEach(u=>u.textContent=n.user_code);const r=document.querySelectorAll("#traktVerifyUrl"),a=document.querySelectorAll("#traktLoginStatus");r.forEach(u=>u.href=n.verification_url),a.forEach(u=>u.textContent="Waiting for authorizationâ€¦"),fh(n.device_code,n.interval||5)}catch(e){console.error("[TRAKT] Login error:",e),showNotification("Failed to start Trakt login: "+e.message,"error"),xr()}}function fh(e,t){ln&&clearInterval(ln),ln=setInterval(async()=>{try{const o=await(await fetch("/api/trakt/device/verify",{method:"POST"})).json();if(o.success)clearInterval(ln),ln=null,ed&&(ed.style.display="none"),showNotification("Successfully connected to Trakt!","success"),await Wr(),xr();else if(o.error==="pending")td&&(td.textContent="Waiting for authorizationâ€¦");else throw new Error(o.error||"Verification failed")}catch(n){console.error("[TRAKT] Polling error:",n),clearInterval(ln),ln=null,showNotification("Authentication failed: "+n.message,"error"),xr()}},t*1e3)}function xr(){const e=document.querySelectorAll("#traktLogin"),t=document.querySelectorAll("#traktCodePanel");e.forEach(n=>{n.disabled=!1,n.innerHTML='<i class="fas fa-sign-in-alt"></i> Connect to Trakt'}),t.forEach(n=>n.style.display="none"),ln&&(clearInterval(ln),ln=null)}function mh(){xr(),showNotification("Trakt login cancelled","info")}async function ph(){try{const t=await(await fetch("/api/trakt/logout",{method:"POST"})).json();if(t.success){document.querySelectorAll("#traktCodePanel").forEach(n=>n.style.display="none"),ua();try{await Wr()}catch{}try{typeof yo=="function"&&await yo()}catch{}showNotification("Disconnected from Trakt","success")}else throw new Error(t.error||"Failed to logout")}catch(e){console.error("[TRAKT] Logout error:",e),showNotification("Failed to disconnect: "+e.message,"error")}}async function Rd(e,t,n,o,i,r=0){if(fo.checked)try{const u=await(await fetch("/api/trakt/scrobble/start",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({title:e,type:t,year:n,season:o,episode:i,progress:r})})).json();u.success?(Ro={title:e,type:t,year:n,season:o,episode:i},console.log("[TRAKT] Started scrobbling:",e)):console.error("[TRAKT] Scrobble start failed:",u.error)}catch(a){console.error("[TRAKT] Scrobble start error:",a)}}async function _d(e){if(!(!Ro||!mo.checked))try{(await fetch("/api/trakt/scrobble/pause",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({...Ro,progress:e})})).ok&&console.log("[TRAKT] Paused scrobbling at",e+"%")}catch(t){console.error("[TRAKT] Scrobble pause error:",t)}}async function Ud(e){if(Ro)try{(await fetch("/api/trakt/scrobble/stop",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({...Ro,progress:e})})).ok&&(console.log("[TRAKT] Stopped scrobbling at",e+"%"),Ro=null)}catch(t){console.error("[TRAKT] Scrobble stop error:",t)}}function yh(){const e=Zg.textContent;navigator.clipboard.writeText(e).then(()=>{showNotification("Code copied to clipboard!","success")}).catch(()=>{showNotification("Failed to copy code","error")})}function gh(){const e=Gg.href;window.electronAPI&&window.electronAPI.openExternal?window.electronAPI.openExternal(e):window.open(e,"_blank")}async function hh(){if(!(!dt||!Ge))try{if(!(await(await fetch("/api/trakt/status")).json()).authenticated){dt.style.display="none";return}dt.style.display="block";const n=Ge.title||Ge.name,o=parseInt((Ge.release_date||Ge.first_air_date||"").substring(0,4));Li(!1)}catch(e){console.error("[TRAKT] Error setting up watchlist button:",e),dt.style.display="none"}}function Li(e){dt&&(e?(dt.innerHTML='<i class="fas fa-check"></i> In Watchlist',dt.classList.remove("btn-secondary"),dt.classList.add("btn-success"),dt.onclick=wh):(dt.innerHTML='<i class="fas fa-plus"></i> Add to Watchlist',dt.classList.remove("btn-success"),dt.classList.add("btn-secondary"),dt.onclick=vh))}async function vh(){if(Ge)try{dt.disabled=!0,dt.innerHTML='<i class="fas fa-spinner fa-spin"></i> Adding...';const e=Ge.title||Ge.name,t=parseInt((Ge.release_date||Ge.first_air_date||"").substring(0,4)),i=await(await fetch("/api/trakt/watchlist/add",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({title:e,type:Le==="tv"?"show":"movie",year:t})})).json();if(i.success)Li(!0),showNotification(`Added "${e}" to your Trakt watchlist!`,"success");else throw new Error(i.error||"Failed to add to watchlist")}catch(e){console.error("[TRAKT] Add to watchlist error:",e),showNotification("Failed to add to watchlist: "+e.message,"error"),Li(!1)}finally{dt.disabled=!1}}async function wh(){if(Ge)try{dt.disabled=!0,dt.innerHTML='<i class="fas fa-spinner fa-spin"></i> Removing...';const e=Ge.title||Ge.name,t=parseInt((Ge.release_date||Ge.first_air_date||"").substring(0,4)),i=await(await fetch("/api/trakt/watchlist/remove",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({title:e,type:Le==="tv"?"show":"movie",year:t})})).json();if(i.success)Li(!1),showNotification(`Removed "${e}" from your Trakt watchlist`,"success");else throw new Error(i.error||"Failed to remove from watchlist")}catch(e){console.error("[TRAKT] Remove from watchlist error:",e),showNotification("Failed to remove from watchlist: "+e.message,"error"),Li(!0)}finally{dt.disabled=!1}}let Od=!1,co=null,Eh=null;async function bh(){if(!Od)try{await yo(),rf(),Od=!0,console.log("[TRAKT PAGE] Initialized successfully")}catch(e){console.error("[TRAKT PAGE] Initialization error:",e)}}function rf(){function e(i,r){const a=document.getElementById(i);if(!a)return;const u=a.cloneNode(!0);a.parentNode.replaceChild(u,a),u.addEventListener("click",r)}e("traktAuthenticateBtn",Ih),e("traktPageDisconnect",Dd),e("traktDisconnectBtn",Dd),e("traktPageRefresh",()=>{yo()}),e("traktPageResyncLibrary",Uh),e("traktPageStats",()=>{try{Th()}catch{}}),e("traktVerifyDeviceBtn",sf),e("traktOpenUrlBtn",()=>{const i=document.getElementById("traktPageVerificationUrl")?.textContent;i&&window.electronAPI?.openExternal(i)}),e("traktCopyCodeBtn",Sh),document.querySelectorAll(".trakt-action-card").forEach(i=>{const r=i.cloneNode(!0);i.parentNode.replaceChild(r,i),r.addEventListener("click",Ph)});const t=document.getElementById("traktPageAutoScrobble"),n=document.getElementById("traktPageScrobbleProgress"),o=document.getElementById("traktPageWatchlistSync");t&&t.addEventListener("change",()=>{fo&&(fo.checked=t.checked)}),n&&n.addEventListener("change",()=>{mo&&(mo.checked=n.checked)}),o&&o.addEventListener("change",()=>{Tr&&(Tr.checked=o.checked)})}async function yo(){try{const t=await(await fetch(`/api/trakt/status?ts=${Date.now()}`,{cache:"no-store"})).json(),n=document.getElementById("traktStatusIndicator"),o=document.getElementById("traktStatusDescription"),i=document.getElementById("traktStatusActions"),r=document.getElementById("traktDeviceCodePanel"),a=document.getElementById("traktPageNotConnected"),u=document.getElementById("traktPageConnected"),m=document.getElementById("traktPageUsername");t.authenticated?(a&&(a.style.display="none"),u&&(u.style.display=""),m&&(m.textContent=t.user?.username||t.user?.name||"User"),r&&(r.style.display="none",delete r.dataset.manual),await Bh(),_h()):(u&&(u.style.display="none"),a&&(a.style.display=""),n&&(n.className="trakt-status-indicator disconnected",n.innerHTML='<i class="fas fa-times-circle"></i><span>Not Connected</span>'),o&&(o.textContent="Connect your Trakt account to automatically track what you watch, sync your watchlist, and get personalized recommendations."),i&&(i.innerHTML=`
                            <button id="traktAuthenticateBtn" class="trakt-btn trakt-btn-primary">
                                <i class="fas fa-link"></i>Connect to Trakt
                            </button>
                        `),r&&r.dataset.manual!=="true"&&(r.style.display="none"),Ah()),Rh(),rf()}catch(e){console.error("[TRAKT PAGE] Status update error:",e);const t=e&&e.message?e.message:"Unknown error";showNotification("Trakt status error: "+t,"error")}}async function Ih(){try{const t=await(await fetch("/api/trakt/device/code",{method:"POST"})).json();if(t.success)kh(t.device_code,t.user_code,t.verification_url,t.expires_in),co=setInterval(async()=>{await sf()},t.interval*1e3||5e3);else throw new Error(t.error||"Failed to get device code")}catch(e){console.error("[TRAKT PAGE] Auth start error:",e),showNotification("Failed to start authentication: "+e.message,"error")}}function kh(e,t,n,o){const i=document.getElementById("traktDeviceCodePanel"),r=document.getElementById("traktPageUserCode"),a=document.getElementById("traktPageVerificationUrl"),u=document.getElementById("traktDeviceCodeStatus");i&&(i.style.display="block",i.dataset.manual="true"),r&&(r.textContent=t),a&&(a.textContent=n),u&&(u.innerHTML="<span>Waiting for authorization... Please enter the code above on Trakt.tv</span>"),setTimeout(()=>{co&&(clearInterval(co),co=null,i&&(i.style.display="none",delete i.dataset.manual),showNotification("Device code expired. Please try again.","error"))},o*1e3)}async function sf(){try{const t=await(await fetch("/api/trakt/device/verify",{method:"POST"})).json();if(t.success){co&&(clearInterval(co),co=null);const n=document.getElementById("traktDeviceCodePanel");n&&(n.style.display="none"),showNotification("Successfully connected to Trakt!","success"),await yo()}else if(t.error==="pending"){const n=document.getElementById("traktDeviceCodeStatus");n&&(n.innerHTML="<span>Waiting for authorization... Please enter the code above on Trakt.tv</span>")}else throw new Error(t.error||"Verification failed")}catch(e){console.error("[TRAKT PAGE] Verify error:",e),e.message!=="pending"&&showNotification("Verification failed: "+e.message,"error")}}async function Dd(){try{const t=await(await fetch("/api/trakt/logout",{method:"POST"})).json();if(t.success){const n=document.getElementById("traktDeviceCodePanel");n&&(n.style.display="none");try{await yo()}catch{}try{await Wr()}catch{}showNotification("Successfully disconnected from Trakt","success")}else throw new Error(t.error||"Failed to disconnect")}catch(e){console.error("[TRAKT PAGE] Disconnect error:",e),showNotification("Failed to disconnect: "+e.message,"error")}}function Sh(){const e=document.getElementById("traktPageUserCode")?.textContent||document.querySelector("#traktCodePanel #traktUserCode")?.textContent||document.getElementById("traktUserCode")?.textContent;e&&navigator.clipboard&&navigator.clipboard.writeText(e).then(()=>{showNotification("Device code copied to clipboard!","success")}).catch(()=>{showNotification("Failed to copy code","error")})}async function Th(){try{showNotification("Loading your statistics...","info",2e3);const t=await(await fetch("/api/trakt/user/stats")).json();if(t.success&&t.stats)Lh(t.stats),showNotification("Statistics loaded successfully!","success",2e3);else throw new Error(t.error||"Failed to load statistics")}catch(e){console.error("[TRAKT] Detailed statistics error:",e),showNotification("Unable to load detailed statistics. Please ensure you're connected to Trakt and try again.","error",4e3)}}function Lh(e){const t=document.createElement("div");t.id="traktStatisticsModal",t.style.cssText=`
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.8);
                backdrop-filter: blur(8px);
                z-index: 20000;
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 2rem;
                animation: fadeIn 0.8s cubic-bezier(0.34, 1.56, 0.64, 1);
            `;const n=document.createElement("div");n.style.cssText=`
                background: linear-gradient(135deg, rgba(30, 30, 30, 0.95) 0%, rgba(20, 20, 20, 0.95) 100%);
                border-radius: 16px;
                padding: 2rem;
                max-width: 800px;
                width: 100%;
                max-height: 80vh;
                overflow-y: auto;
                border: 1px solid rgba(255, 255, 255, 0.1);
                box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            `;const o=e.movies||{watched:0,collected:0,ratings:0,minutes:0},i=e.shows||{watched:0,ratings:0},r=e.episodes||{watched:0,minutes:0},a=o.watched+i.watched,u=o.minutes+r.minutes,m=Math.round(u/60),y=Math.round(m/24);n.innerHTML=`
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                    <h2 style="margin: 0; color: #ed1c24; font-size: 1.8rem;">
                        <i class="fas fa-chart-bar"></i> Your Trakt Statistics
                    </h2>
                    <button onclick="closeTraktStatisticsModal()" style="
                        background: rgba(255, 255, 255, 0.1);
                        border: none;
                        color: white;
                        padding: 0.5rem;
                        border-radius: 50%;
                        cursor: pointer;
                        font-size: 1.2rem;
                        width: 40px;
                        height: 40px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                    ">Ã—</button>
                </div>

                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
                    <div style="background: rgba(237, 28, 36, 0.1); padding: 1.5rem; border-radius: 12px; border-left: 4px solid #ed1c24;">
                        <div style="font-size: 2rem; font-weight: bold; color: #ed1c24;">${a}</div>
                        <div style="color: #ccc; margin-top: 0.5rem;">Total Content Watched</div>
                        <div style="font-size: 0.9rem; color: #999; margin-top: 0.25rem;">Movies + Shows</div>
                    </div>
                    
                    <div style="background: rgba(34, 197, 94, 0.1); padding: 1.5rem; border-radius: 12px; border-left: 4px solid #22c55e;">
                        <div style="font-size: 2rem; font-weight: bold; color: #22c55e;">${y}</div>
                        <div style="color: #ccc; margin-top: 0.5rem;">Days Watched</div>
                        <div style="font-size: 0.9rem; color: #999; margin-top: 0.25rem;">${m} hours total</div>
                    </div>
                    
                    <div style="background: rgba(59, 130, 246, 0.1); padding: 1.5rem; border-radius: 12px; border-left: 4px solid #3b82f6;">
                        <div style="font-size: 2rem; font-weight: bold; color: #3b82f6;">${e.watchlist?.length||0}</div>
                        <div style="color: #ccc; margin-top: 0.5rem;">Watchlist Items</div>
                        <div style="font-size: 0.9rem; color: #999; margin-top: 0.25rem;">Pending to watch</div>
                    </div>
                    
                    <div style="background: rgba(245, 158, 11, 0.1); padding: 1.5rem; border-radius: 12px; border-left: 4px solid #f59e0b;">
                        <div style="font-size: 2rem; font-weight: bold; color: #f59e0b;">${e.ratings?.length||0}</div>
                        <div style="color: #ccc; margin-top: 0.5rem;">Items Rated</div>
                        <div style="font-size: 0.9rem; color: #999; margin-top: 0.25rem;">Your taste profile</div>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem;">
                    <div style="background: rgba(255, 255, 255, 0.05); padding: 1.5rem; border-radius: 12px;">
                        <h3 style="margin: 0 0 1rem 0; color: #ed1c24;">
                            <i class="fas fa-film"></i> Movies
                        </h3>
                        <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                            <div style="display: flex; justify-content: space-between;">
                                <span style="color: #ccc;">Watched:</span>
                                <span style="color: white; font-weight: bold;">${o.watched||0}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span style="color: #ccc;">Collected:</span>
                                <span style="color: white; font-weight: bold;">${o.collected||0}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span style="color: #ccc;">Rated:</span>
                                <span style="color: white; font-weight: bold;">${o.ratings||0}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span style="color: #ccc;">Watch Time:</span>
                                <span style="color: white; font-weight: bold;">${Math.round((o.minutes||0)/60)}h</span>
                            </div>
                        </div>
                    </div>

                    <div style="background: rgba(255, 255, 255, 0.05); padding: 1.5rem; border-radius: 12px;">
                        <h3 style="margin: 0 0 1rem 0; color: #ed1c24;">
                            <i class="fas fa-tv"></i> TV Shows
                        </h3>
                        <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                            <div style="display: flex; justify-content: space-between;">
                                <span style="color: #ccc;">Shows Watched:</span>
                                <span style="color: white; font-weight: bold;">${i.watched||0}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span style="color: #ccc;">Episodes:</span>
                                <span style="color: white; font-weight: bold;">${r.watched||0}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span style="color: #ccc;">Shows Rated:</span>
                                <span style="color: white; font-weight: bold;">${i.ratings||0}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span style="color: #ccc;">Watch Time:</span>
                                <span style="color: white; font-weight: bold;">${Math.round((r.minutes||0)/60)}h</span>
                            </div>
                        </div>
                    </div>
                </div>

                ${e.network?`
                <div style="background: rgba(255, 255, 255, 0.05); padding: 1.5rem; border-radius: 12px; margin-bottom: 1rem;">
                    <h3 style="margin: 0 0 1rem 0; color: #ed1c24;">
                        <i class="fas fa-users"></i> Social Network
                    </h3>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; text-align: center;">
                        <div>
                            <div style="font-size: 1.5rem; font-weight: bold; color: #3b82f6;">${e.network.friends||0}</div>
                            <div style="color: #ccc; font-size: 0.9rem;">Friends</div>
                        </div>
                        <div>
                            <div style="font-size: 1.5rem; font-weight: bold; color: #22c55e;">${e.network.followers||0}</div>
                            <div style="color: #ccc; font-size: 0.9rem;">Followers</div>
                        </div>
                        <div>
                            <div style="font-size: 1.5rem; font-weight: bold; color: #f59e0b;">${e.network.following||0}</div>
                            <div style="color: #ccc; font-size: 0.9rem;">Following</div>
                        </div>
                    </div>
                </div>
                `:""}

                <div style="text-align: center; margin-top: 2rem;">
                    <button onclick="window.electronAPI?.openExternal('https://trakt.tv/users/me')" style="
                        background: linear-gradient(135deg, #ed1c24 0%, #d41920 100%);
                        color: white;
                        border: none;
                        padding: 0.75rem 1.5rem;
                        border-radius: 8px;
                        font-weight: 600;
                        cursor: pointer;
                        margin-right: 1rem;
                    ">
                        <i class="fas fa-external-link-alt"></i> View Profile on Trakt
                    </button>
                    <button onclick="closeTraktStatisticsModal()" style="
                        background: rgba(255, 255, 255, 0.1);
                        color: white;
                        border: 1px solid rgba(255, 255, 255, 0.2);
                        padding: 0.75rem 1.5rem;
                        border-radius: 8px;
                        font-weight: 600;
                        cursor: pointer;
                    ">
                        Close
                    </button>
                </div>
            `,t.appendChild(n),document.body.appendChild(t),t.addEventListener("click",p=>{p.target===t&&Ch()}),showNotification("Statistics loaded successfully!","success")}function Ch(){const e=document.getElementById("traktStatisticsModal");e&&(e.style.animation="fadeOut 0.3s ease",setTimeout(()=>{e.remove()},300))}const af=document.createElement("style");af.textContent=`
            @keyframes fadeIn {
                from { opacity: 0; transform: scale(0.9); }
                to { opacity: 1; transform: scale(1); }
            }
            @keyframes fadeOut {
                from { opacity: 1; transform: scale(1); }
                to { opacity: 0; transform: scale(0.9); }
            }
        `;document.head.appendChild(af);async function Bh(){try{const t=await(await fetch("/api/trakt/user/stats")).json();t.success?(Eh=t.stats,Ks(t.stats),console.log("[TRAKT PAGE] Stats loaded successfully")):(console.log("[TRAKT PAGE] Using placeholder stats:",t.error),Ks({watchlist:[],collection:{movies:[],shows:[]},ratings:[],movies:{watched:0,collected:0,ratings:0},shows:{watched:0,collected:0,ratings:0}}))}catch(e){console.log("[TRAKT PAGE] Stats loading failed, using placeholders:",e),Ks({watchlist:[],collection:{movies:[],shows:[]},ratings:[],movies:{watched:0,collected:0,ratings:0},shows:{watched:0,collected:0,ratings:0}})}}function Ks(e){document.querySelectorAll(".trakt-action-card").forEach(n=>{const o=n.dataset.action,i=n.querySelector(".trakt-action-count");switch(o){case"watchlist":if(i){const r=e.watchlist?.length||0;i.textContent=r,i.style.display=r>0?"inline-block":"none"}break;case"history":if(i){const r=e.movies?.watched||0,a=e.shows?.watched||0,u=r+a;i.textContent=u,i.style.display=u>0?"inline-block":"none"}break;case"collection":if(i){const r=e.collection?.movies?.length||0,a=e.collection?.shows?.length||0,u=r+a;i.textContent=u,i.style.display=u>0?"inline-block":"none"}break;case"ratings":if(i){const r=e.ratings?.length||0;i.textContent=r,i.style.display=r>0?"inline-block":"none"}break}}),console.log("[TRAKT PAGE] Action grid updated with stats")}function Ah(){document.querySelectorAll(".trakt-action-card").forEach(t=>{const n=t.querySelector(".trakt-action-count");n&&(n.textContent="0")})}async function Ph(e){switch(e.currentTarget.dataset.action){case"watchlist":await xh();break;case"history":await $h();break;case"collection":await Nh();break;case"ratings":await Mh();break;default:showNotification("Feature coming soon!","info")}}async function xh(){try{const t=await(await fetch("/api/trakt/watchlist")).json();if(t.success&&t.watchlist){const n=t.watchlist.length;n>0?showNotification(`Your watchlist has ${n} items. They will appear automatically when browsing!`,"success"):showNotification("Your watchlist is empty. Add items by clicking the + button on movies and shows!","info")}else showNotification("Could not load watchlist. Make sure you're connected to Trakt.","error")}catch(e){console.error("[TRAKT] Watchlist details error:",e),showNotification("Failed to load watchlist details","error")}}async function $h(){try{const t=await(await fetch("/api/trakt/history")).json();if(t.success&&t.history){const n=t.history.length;n>0?showNotification(`You've watched ${n} items. Your watch history is automatically tracked!`,"success"):showNotification("No watch history yet. Start watching content and it will be tracked automatically!","info")}else showNotification("Could not load watch history. Make sure you're connected to Trakt.","error")}catch(e){console.error("[TRAKT] History details error:",e),showNotification("Failed to load watch history","error")}}async function Nh(){try{const t=await(await fetch("/api/trakt/collection")).json();if(t.success&&t.collection){const n=t.collection.movies?.length||0,o=t.collection.shows?.length||0,i=n+o;i>0?showNotification(`Your collection has ${n} movies and ${o} shows (${i} total)`,"success"):showNotification("Your collection is empty. Items are added automatically when you finish watching!","info")}else showNotification("Could not load collection. Make sure you're connected to Trakt.","error")}catch(e){console.error("[TRAKT] Collection details error:",e),showNotification("Failed to load collection details","error")}}async function Mh(){try{const t=await(await fetch("/api/trakt/ratings")).json();if(t.success&&t.ratings){const n=t.ratings.length;n>0?showNotification(`You've rated ${n} items on Trakt. Visit trakt.tv to rate more content!`,"success"):showNotification("You haven't rated anything yet. Visit trakt.tv to start rating movies and shows!","info")}else showNotification("Could not load ratings. Make sure you're connected to Trakt.","error")}catch(e){console.error("[TRAKT] Ratings details error:",e),showNotification("Failed to load ratings details","error")}}function Rh(){const e=document.getElementById("traktPageAutoScrobble"),t=document.getElementById("traktPageScrobbleProgress"),n=document.getElementById("traktPageWatchlistSync");e&&fo&&(e.checked=fo.checked),t&&mo&&(t.checked=mo.checked),n&&Tr&&(n.checked=Tr.checked)}let hi=!1;async function fa(e,t){try{if(!t)return null;const n="https://api.themoviedb.org/3",o=e==="tv"?`/tv/${t}`:`/movie/${t}`,i=`${n}${o}?api_key=${Xe}`,r=await fetch(i);return r.ok?await r.json():null}catch{return null}}function $r(e){try{return(e||"").substring(0,4)||""}catch{return""}}async function cf(e=50,t=100){try{await loadMyList();let n=0;for(let o=1;o<=e;o++){const r=await(await fetch(`/api/trakt/watchlist?type=mixed&page=${o}&limit=${t}`)).json();if(!r.success||!Array.isArray(r.watchlist)||r.watchlist.length===0)break;let a=0;for(const u of r.watchlist){const m=!!u.movie,y=!!u.show,p=m?"movie":y?"tv":null,I=(u.movie?.ids||u.show?.ids||{}).tmdb||null;if(!p||!I||wn.some(Ce=>Ce.id===I&&Ce.media_type===p))continue;const k=await fa(p,I),A=p==="tv"?k?.name||u.show?.title||"":k?.title||u.movie?.title||"",U=k?.poster_path||"",W=$r(p==="tv"?k?.first_air_date||u.show?.year:k?.release_date||u.movie?.year),Y=Number(k?.vote_average||0),ae={id:I,media_type:p,title:A,poster_path:U,year:W,vote_average:Y,added_date:u.listed_at||new Date().toISOString()};wn.unshift(ae),a++}if(n+=a,r.watchlist.length<t)break}return n>0&&(await saveMyList(),document.getElementById("myListPage")?.style.display!=="none"&&await displayMyList()),n}catch(n){return console.log("[TRAKT IMPORT] My List failed:",n?.message),0}}async function lf(e=50,t=100){try{await loadDoneWatching();let n=0;for(let o=1;o<=e;o++){const r=await(await fetch(`/api/trakt/history?type=mixed&page=${o}&limit=${t}`)).json();if(!r.success||!Array.isArray(r.history)||r.history.length===0)break;for(const a of r.history){const u=a.watched_at||new Date().toISOString();if(a.movie){const y=(a.movie.ids||{}).tmdb||null;if(!y||_t.some(I=>I.id===y&&I.media_type==="movie"&&!I.season&&!I.episode))continue;const p=await fa("movie",y),N={id:y,media_type:"movie",title:p?.title||a.movie.title||"",poster_path:p?.poster_path||"",year:$r(p?.release_date||a.movie.year),vote_average:Number(p?.vote_average||0),completed_date:u};_t.unshift(N),n++}else if(a.episode&&a.show){const y=(a.show.ids||{}).tmdb||null;if(!y)continue;const p=a.episode.season,N=a.episode.number;if(_t.some(A=>A.id===y&&A.media_type==="tv"&&A.season===p&&A.episode===N))continue;const I=await fa("tv",y),k={id:y,media_type:"tv",title:I?.name||a.show.title||"",poster_path:I?.poster_path||"",year:$r(I?.first_air_date||a.show.year),vote_average:Number(I?.vote_average||0),completed_date:u,season:p,episode:N,episode_title:a.episode.title||`S${p}E${N}`};_t.unshift(k),n++}}if(r.history.length<t)break}return n>0&&(await saveDoneWatching(),document.getElementById("doneWatchingPage")?.style.display!=="none"&&await displayDoneWatching()),n}catch(n){return console.log("[TRAKT IMPORT] Done Watching failed:",n?.message),0}}async function _h(){try{if(hi)return;const e=localStorage.getItem("traktLastImport");if(e&&(Date.now()-parseInt(e))/36e5<24){hi=!0;return}showNotification("Importing your Trakt data (watchlist & history)...","info");const[t,n]=await Promise.all([cf(),lf()]);hi=!0,localStorage.setItem("traktLastImport",Date.now().toString());const o=`Imported ${t} to My List and ${n} to Done Watching from Trakt`;showNotification(o,"success");try{document.querySelectorAll(".movie-card").forEach(i=>{const r=i.querySelector(".add-to-list-btn"),a=i.querySelector(".done-watching-btn"),m=((r?.getAttribute("onclick")||a?.getAttribute("onclick")||"")+"").match(/,(\s*)(\d+)(\s*),\s*'(movie|tv)'/);if(m){const y=parseInt(m[2],10),p=m[4];updateCardListStatus(i,y,p),updateCardDoneStatus(i,y,p)}})}catch{}}catch(e){console.log("[TRAKT IMPORT] unexpected error:",e?.message)}}async function Uh(){try{const e=document.getElementById("traktPageResyncLibrary");if(!e)return;const t=e.innerHTML;e.disabled=!0,e.innerHTML='<i class="fas fa-spinner fa-spin"></i> Syncing...',showNotification("Starting full Trakt library sync...","info"),hi=!1,localStorage.removeItem("traktLastImport");const[n,o]=await Promise.all([cf(50,100),lf(50,100)]);hi=!0,localStorage.setItem("traktLastImport",Date.now().toString());const i=`Sync complete! Imported ${n} to My List and ${o} to Done Watching from Trakt`;showNotification(i,"success");try{document.querySelectorAll(".movie-card").forEach(r=>{const a=r.querySelector(".add-to-list-btn"),u=r.querySelector(".done-watching-btn"),y=((a?.getAttribute("onclick")||u?.getAttribute("onclick")||"")+"").match(/,(\s*)(\d+)(\s*),\s*'(movie|tv)'/);if(y){const p=parseInt(y[2],10),N=y[4];updateCardListStatus(r,p,N),updateCardDoneStatus(r,p,N)}})}catch{}e.disabled=!1,e.innerHTML=t}catch(e){console.log("[TRAKT RESYNC] Error:",e?.message),showNotification("Trakt sync failed: "+e?.message,"error");const t=document.getElementById("traktPageResyncLibrary");t&&(t.disabled=!1,t.innerHTML='<i class="fas fa-cloud-download-alt"></i> Re-sync Library')}}async function Ys(){const e=document.querySelectorAll("#newApiKey");let t="";for(const G of e){const ve=(G.value||"").trim();if(ve&&(t=ve,G.offsetParent!==null))break}const n=document.querySelectorAll("#useTorrentlessToggle");let o=null;for(const G of n)if(G.offsetParent!==null){o=G;break}const i=o?!!o.checked:po,r=document.querySelectorAll("#jackettUrl");let a="";for(const G of r){const ve=(G.value||"").trim();if(ve&&(a=ve,G.offsetParent!==null))break}const u=document.querySelectorAll("#cacheLocation");let m="";for(const G of u){const ve=(G.value||"").trim();if(ve&&(m=ve,G.offsetParent!==null))break}const y=document.querySelectorAll("#autoUpdateToggle");let p=!0;for(const G of y)if(G.offsetParent!==null){p=!!G.checked;break}const N=document.querySelectorAll("#discordActivityToggle");let I=!0;for(const G of N)if(G.offsetParent!==null){I=!!G.checked;break}const k=document.querySelectorAll("#fullscreenToggle");let A=null;for(const G of k)if(G.offsetParent!==null){A=G;break}if(A&&window.electronAPI&&window.electronAPI.setFullscreen)try{const G=await window.electronAPI.setFullscreen(A.checked);G.success||(console.error("Failed to set fullscreen:",G.message),showNotification("Failed to change fullscreen mode"))}catch(G){console.error("Error setting fullscreen:",G),showNotification("Error changing fullscreen mode")}const U=document.querySelectorAll("#uiModeNew"),W=document.querySelectorAll("#uiModeOld");let Y=null;for(const G of U)if(G.offsetParent!==null)break;for(const G of W)if(G.offsetParent!==null){Y=G;break}let ae="new";Y&&Y.checked&&(ae="old"),ae!==Si&&Fa(ae);let Ce=null;try{const G={useTorrentless:i,autoUpdate:!!p,discordActivity:!!I};if(a&&(G.jackettUrl=a),m&&(G.cacheLocation=m),await fetch(`${se}/settings`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(G)}),po=i,I=!!I,I||(console.log("[Settings] Discord activity disabled, clearing presence"),await la()),t){const ve=await fetch(`${se}/set-api-key`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({apiKey:t})});let Se=null;try{Ce=await ve.json()}catch{Ce=null}if(ve.ok){aa=!0;try{const oe=await fetch(`${se}/key-location`);oe.ok&&(Se=await oe.json())}catch{}await qa(),Se?.hasApiKey&&Se?.path?showNotification(`Settings saved. API key updated at ${Se.path}`):showNotification("Settings saved. API key updated."),document.querySelectorAll("#newApiKey").forEach(oe=>{oe.value=""})}else showNotification(Ce?.error||"Failed to update API key")}else showNotification("Settings saved.")}catch(G){console.error("Error saving settings:",G)}finally{window.location.hash==="#/settings"||ui()}}function Fd(){window.location.hash="#/"}function Hd(){window.location.hash="#/genres"}function Oh(){const e=document.getElementById("custom-magnet-modal"),t=document.getElementById("custom-magnet-input");e&&(e.style.display="flex",e.classList.add("active"),e.style.opacity="1",e.style.pointerEvents="auto",t&&(t.value="",setTimeout(()=>t.focus(),100)))}function Vd(){window.location.hash="#/my-list"}function jd(){window.location.hash="#/done-watching"}function qd(){window.location.hash="#/trakt"}function zd(){window.location.hash="#/livetv"}function Wd(){window.location.hash="#/iptv";try{en()}catch{}}function Dh(){const e=document.getElementById("iptv-iframe"),t=document.getElementById("iptv-source-select");if(e){const n=t?t.value:"https://iptvplaytorrio.pages.dev/";e.src="about:blank",setTimeout(()=>{e.src=n,setTimeout(()=>{document.getElementById("iptv-page")&&(e.scrollIntoView({behavior:"smooth",block:"start"}),console.log("[IPTV] Auto-scrolled IPTV page to show iframe"))},300)},100),console.log("[IPTV] Page reloaded fresh with source:",n)}}function Kd(){const e=document.getElementById("iptv-source-select"),t=document.getElementById("iptv-iframe");e&&t&&(e.addEventListener("change",n=>{const o=n.target.value,r=n.target.selectedOptions[0].hasAttribute("data-external");console.log("[IPTV] Switching to source:",o,"external:",r),r?window.electronAPI?.openExternal&&(window.electronAPI.openExternal(o),showNotification("Opening IPTV Web App in browser...","info"),setTimeout(()=>{e.value="https://iptvplaytorrio.pages.dev/"},100)):(t.style.opacity="0.5",t.src="about:blank",setTimeout(()=>{t.src=o,t.style.opacity="1",showNotification("Loading IPTV source...","info")},100))}),t.addEventListener("load",()=>{console.log("[IPTV] Iframe loaded successfully"),t.style.opacity="1"}),t.addEventListener("error",n=>{console.error("[IPTV] Iframe failed to load:",n),showNotification("Failed to load IPTV source. Site may block embedding.","error"),t.style.opacity="1"}),console.log("[IPTV] Source selector initialized"))}function Ho(){const e=document.getElementById("iptv-iframe");e&&(e.src="about:blank",console.log("[IPTV] Page cleared - stopping all streams"))}function Ci(){try{const e=document.getElementById("iptv-iframe");e&&(e.src="about:blank",e.style.display="none",console.log("[IPTV] Default iframe disabled (custom Xtream active)"))}catch{}}function vi(){try{const e=document.getElementById("iptv-iframe");e&&(e.style.display="",(!e.src||e.src==="about:blank")&&(e.src="https://iptvplaytorrio.pages.dev/"),console.log("[IPTV] Default iframe enabled"))}catch{}}const ie={base:"",username:"",password:"",tab:"live",active:!1,mode:"none",liveCategories:[],vodCategories:[],seriesCategories:[],lastStreams:[],m3u:{items:[],categories:[]},displayedIndex:0,pageSize:50};async function df(){try{return(await(await fetch("/api/iptv/settings",{cache:"no-store"})).json())?.iptv||{lastMode:"iframe",rememberCreds:!1,xtream:{base:"",username:"",password:""},m3u:{url:""}}}catch{try{const e=JSON.parse(localStorage.getItem("xtreamCodesCreds")||"{}");return{lastMode:"iframe",rememberCreds:!!(e.base||e.username||e.password),xtream:{base:e.base||"",username:e.username||"",password:e.password||""},m3u:{url:""}}}catch{return{lastMode:"iframe",rememberCreds:!1,xtream:{base:"",username:"",password:""},m3u:{url:""}}}}}async function Nr(e={}){try{await fetch("/api/iptv/settings",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)})}catch(t){console.warn("[IPTV] Failed to save settings",t)}}async function Fh(e,t,n){try{let o=ma(e);const i=`username=${encodeURIComponent(t)}&password=${encodeURIComponent(n)}`;async function r(m){const y=`/api/proxy/xtream?base=${encodeURIComponent(m)}&params=${encodeURIComponent(i)}`,p=await fetch(y,{cache:"no-store"});if(!p.ok)throw new Error("Server returned "+p.status);return{data:await p.json(),baseUrl:m}}let{data:a,baseUrl:u}=await r(o);if(!a||a.nonJson||!a.user_info&&!a.server_info)try{const m=o.startsWith("https://")?o.replace(/^https:\/\//i,"http://"):o.replace(/^http:\/\//i,"https://"),y=await r(m);y?.data&&!y.data.nonJson&&(y.data.user_info||y.data.server_info)&&(a=y.data,u=y.baseUrl,o=m)}catch{}if(!a||a.nonJson)throw new Error("Non-JSON response");if(a.user_info&&String(a.user_info.status).toLowerCase()!=="active")throw new Error("Account is not active");ie.base=o,ie.username=t,ie.password=n,ie.tab="live",ie.active=!0,ie.mode="xtream",await uf();try{Ho(),Ci()}catch{}ao(),za(),await Bi(),en(),showNotification("Xtream Codes connected (restored)","success")}catch(o){console.warn("[XTREAM] auto-login failed:",o?.message||o);try{vi()}catch{}en()}}async function Hh(){try{const e=await df(),t=e?.lastMode||"iframe";if(t==="iframe"){try{vi(),ar()}catch{}en();return}if(t==="m3u"&&e?.m3u?.url){await cr(e.m3u.url);return}if(t==="xtream"&&e?.rememberCreds&&e?.xtream?.base&&e?.xtream?.username&&e?.xtream?.password){await Fh(e.xtream.base,e.xtream.username,e.xtream.password);return}try{vi(),ar()}catch{}en()}catch(e){console.warn("[IPTV] auto-restore failed:",e?.message||e);try{vi(),ar()}catch{}en()}}function ma(e){if(!e)return"";let t=(e+"").trim();/^https?:\/\//i.test(t)||(t="http://"+t);try{const n=new URL(t);t=n.origin+n.pathname}catch{}return t=t.replace(/\/+$/,""),t=t.replace(/\/(player_api\.php|xmltv\.php|get\.php)$/i,""),t=t.replace(/\/(c|panel_api|client_area)\/?$/i,""),t=t.replace(/\/+$/,""),t}async function Vh(e=!0){const t=document.getElementById("xtream-login-modal");if(t){if(e)try{const n=await df(),o=document.getElementById("xtream-base-url"),i=document.getElementById("xtream-username"),r=document.getElementById("xtream-password"),a=document.getElementById("xtream-remember"),u=document.getElementById("xtream-m3u-url");n?.xtream&&(n.rememberCreds&&(o&&(o.value=n.xtream.base||""),i&&(i.value=n.xtream.username||""),r&&(r.value=n.xtream.password||"")),a&&(a.checked=!!n.rememberCreds)),u&&n?.m3u?.url&&(u.value=n.m3u.url)}catch{}t.style.display="flex"}}function ao(){const e=document.getElementById("xtream-login-modal");e&&(e.style.display="none")}function za(){const e=document.getElementById("xtream-inline"),t=document.getElementById("xtream-grid"),n=document.getElementById("xtream-empty"),o=document.getElementById("xtream-search"),i=document.getElementById("xtream-category-select");e&&(e.style.display="block"),t&&(t.innerHTML=""),n&&(n.style.display=""),o&&(o.value=""),i&&(i.innerHTML='<option value="">All Categories</option>')}function ar(){const e=document.getElementById("xtream-inline");e&&(e.style.display="none")}let Ft=null;function jh(){return new Promise((e,t)=>{if(window.Hls)return e();const n=document.getElementById("hlsjs-script");if(n){n.addEventListener("load",()=>e()),n.addEventListener("error",()=>t(new Error("Failed to load hls.js")));return}const o=document.createElement("script");o.id="hlsjs-script",o.src="https://cdn.jsdelivr.net/npm/hls.js@latest",o.async=!0,o.onload=()=>e(),o.onerror=()=>t(new Error("Failed to load hls.js")),document.head.appendChild(o)})}async function Mr(e,t){const n=document.getElementById("xtream-player-modal"),o=document.getElementById("xtream-video"),i=document.getElementById("xtream-player-title"),r=document.getElementById("xtream-open-external"),a=document.getElementById("xtream-open-mpv"),u=document.getElementById("xtream-open-iina"),m=document.getElementById("xtream-open-vlc");if(!n||!o)return;try{o.pause()}catch{}try{Ft&&(Ft.destroy(),Ft=null)}catch{}o.removeAttribute("src"),o.load(),o.crossOrigin="anonymous",i&&(i.textContent=e||"Playing");const y=window.electronAPI?.platform;if(a&&(a.style.display=y==="win32"?"inline-flex":"none"),u&&(u.style.display=y==="darwin"?"inline-flex":"none"),r&&(r.onclick=()=>{window.electronAPI?.openExternal?window.electronAPI.openExternal(t):window.open(t,"_blank")}),a&&(a.onclick=async()=>{try{if(window.electronAPI&&window.electronAPI.platform==="win32"&&window.electronAPI.spawnMpvjsPlayer){const I={url:t},k=await window.electronAPI.spawnMpvjsPlayer(I);(!k||!k.success)&&showNotification(k?.message||"Failed to launch mpv.js player");return}showNotification("mpv.js player only available on Windows")}catch(I){showNotification("Failed to launch player: "+(I?.message||I))}}),u&&(u.onclick=async()=>{try{if(!window.electronAPI||!window.electronAPI.openInIINA){showNotification("IINA integration not available in this environment");return}const I={streamUrl:t},k=await window.electronAPI.openInIINA(I);(!k||!k.success)&&showNotification(k?.message||"Failed to launch IINA")}catch(I){showNotification("Failed to launch IINA: "+(I?.message||I))}}),m&&(m.onclick=async()=>{try{if(!window.electronAPI||!window.electronAPI.openInVLC){showNotification("VLC integration not available in this environment");return}const I={streamUrl:t},k=await window.electronAPI.openInVLC(I);(!k||!k.success)&&showNotification(k?.message||"Failed to launch VLC")}catch(I){showNotification("Failed to launch VLC: "+(I?.message||I))}}),n.style.display="flex",/\.m3u8(\?|$)/i.test(t))try{await jh(),window.Hls&&window.Hls.isSupported()?(Ft=new window.Hls({enableWorker:!0}),Ft.loadSource(t),Ft.attachMedia(o),Ft.on(window.Hls.Events.MANIFEST_PARSED,()=>{try{o.play().catch(()=>{})}catch{}}),Ft.on(window.Hls.Events.ERROR,(I,k)=>{if(k&&k.fatal){try{Ft.destroy()}catch{}if(Ft=null,ie.mode==="xtream"&&/\.m3u8(\?|$)/i.test(t)){const A=t.replace(/\.m3u8(\?.*)?$/i,".ts$1");try{o.src=A,o.load(),o.play().catch(()=>{showNotification('HLS failed. TS fallback also failed. Use "Open in Browser" if desired.',"error")})}catch{showNotification('HLS failed. Use "Open in Browser" if desired.',"error")}}else showNotification('HLS playback error. Use "Open in Browser" if desired.',"error")}})):o.canPlayType("application/vnd.apple.mpegurl")?(o.src=t,setTimeout(()=>{try{o.play().catch(()=>{})}catch{}},50)):showNotification('HLS not supported by this device. Use "Open in Browser" or external players.',"warning")}catch(I){console.error("[HLS] load error:",I),showNotification('Failed to initialize HLS. Use "Open in Browser" if desired.',"error")}else try{o.src=t,o.currentTime=0,o.load(),setTimeout(()=>{try{o.play().catch(()=>{})}catch{}},50)}catch{showNotification('Playback failed. Use "Open in Browser" if desired.',"error")}const N=()=>{showNotification('Playback error. Use "Open in Browser" if desired.',"error")};o.onerror=N}function pa(){const e=document.getElementById("xtream-player-modal"),t=document.getElementById("xtream-video");if(t){try{t.pause()}catch{}t.removeAttribute("src"),t.load()}try{Ft&&(Ft.destroy(),Ft=null)}catch{}e&&(e.style.display="none")}function en(){const e=document.getElementById("iptv-custom-btn");e&&(ie.active?(e.innerHTML='<i class="fas fa-exchange-alt"></i> Use PlayTorrio IPTV',e.title="Switch back to the default IPTV page"):(e.innerHTML='<i class="fas fa-user-lock"></i> Custom IPTV (Xtream Codes)',e.title="Login with your Xtream Codes provider"))}function qh(){if(ie.active){try{ar()}catch{}try{pa()}catch{}try{vi()}catch{}ie.active=!1,Nr({lastMode:"iframe"}),en(),showNotification("Switched to PlayTorrio IPTV","success")}else Vh(!0)}async function zh(){const e=document.getElementById("xtream-base-url"),t=document.getElementById("xtream-username"),n=document.getElementById("xtream-password"),o=document.getElementById("xtream-remember")?.checked,i=document.getElementById("xtream-login-status"),r=document.getElementById("xtream-login-submit"),a=ma(e.value),u=(t.value||"").trim(),m=(n.value||"").trim();if(!a||!u||!m){i&&(i.textContent="Please fill all fields.");return}r&&(r.disabled=!0,r.innerHTML='<i class="fas fa-spinner fa-spin"></i> Logging in...'),i&&(i.textContent="Contacting server...");try{let y=ma(a);const p=`username=${encodeURIComponent(u)}&password=${encodeURIComponent(m)}`;async function N(A){const U=`/api/proxy/xtream?base=${encodeURIComponent(A)}&params=${encodeURIComponent(p)}`,W=await fetch(U,{cache:"no-store"});if(!W.ok)throw new Error("Server returned "+W.status);return{data:await W.json(),baseUrl:A}}let{data:I,baseUrl:k}=await N(y);if(!I||I.nonJson||!I.user_info&&!I.server_info)try{const A=y.startsWith("https://")?y.replace(/^https:\/\//i,"http://"):y.replace(/^http:\/\//i,"https://"),U=await N(A);U?.data&&!U.data.nonJson&&(U.data.user_info||U.data.server_info)&&(I=U.data,k=U.baseUrl,y=A)}catch{}if(!I||I.nonJson){const A=I?.contentType?` (${I.contentType}${I.status?", "+I.status:""})`:"";throw new Error("Server returned non-JSON response"+A)}if(!I.user_info&&!I.server_info)throw new Error("Invalid response");if(I.user_info&&String(I.user_info.status).toLowerCase()!=="active")throw new Error("Account is not active");ie.base=y,ie.username=u,ie.password=m,ie.tab="live",ie.active=!0,ie.mode="xtream",o?await Nr({lastMode:"xtream",rememberCreds:!0,xtream:{base:a,username:u,password:m}}):await Nr({lastMode:"xtream",rememberCreds:!1,xtream:{base:"",username:"",password:""}}),i&&(i.textContent="Login successful. Loading categories..."),await uf();try{Ho(),Ci()}catch{}ao(),za(),await Bi(),showNotification("Xtream Codes connected","success"),en()}catch(y){console.error("[XTREAM] Login error:",y),i&&(i.textContent="Login failed: "+(y?.message||"Unknown error")),showNotification("Xtream login failed: "+(y?.message||"Unknown error"),"error")}finally{r&&(r.disabled=!1,r.innerHTML='<i class="fas fa-sign-in-alt"></i> Login')}}function Wh(e){const t=(e||"").split(/\r?\n/),n=[];let o=null;for(let r=0;r<t.length;r++){const a=t[r].trim();if(a)if(a.startsWith("#EXTINF:")){a.substring(a.indexOf(",")>-1?0:a.length);const u=a.substring(a.indexOf(",")+1).trim(),m={},y=/(\w[\w-]*)=\"([^\"]*)\"/g;let p;for(;(p=y.exec(a))!==null;)m[p[1]]=p[2];o={name:u||m["tvg-name"]||m["channel-name"]||"Channel",logo:m["tvg-logo"]||"",group:m["group-title"]||"Other",url:""}}else!a.startsWith("#")&&o&&(o.url=a,n.push(o),o=null)}const i=Array.from(new Set(n.map(r=>r.group||"Other"))).sort();return{items:n,categories:i}}async function cr(e){const t=document.getElementById("xtream-login-status");try{t&&(t.textContent="Loading playlist...");const n=`/api/proxy/fetch-text?url=${encodeURIComponent(e)}`,o=await fetch(n,{cache:"no-store"});if(!o.ok)throw new Error("Playlist request failed: "+o.status);const i=await o.text(),r=Wh(i);if(!r.items.length)throw new Error("No channels found in playlist");ie.m3u=r,ie.tab="live",ie.active=!0,ie.mode="m3u",await Nr({lastMode:"m3u",m3u:{url:e}});try{Ho(),Ci()}catch{}ao(),za(),await Bi(),en(),showNotification(`Loaded ${r.items.length} playlist items`,"success")}catch(n){console.error("[M3U] Load error:",n),t&&(t.textContent="Failed to load playlist: "+(n?.message||"Unknown error")),showNotification("Failed to load playlist: "+(n?.message||"Unknown error"),"error")}}function Yd(e){try{const t=(e||"").toLowerCase();return/\.(m3u8|mp4|mp3|aac|m4a|ts|webm|mkv|mov|avi)(\?|$)/.test(t)}catch{return!1}}async function lo(e){const{base:t,username:n,password:o}=ie,i=`username=${encodeURIComponent(n)}&password=${encodeURIComponent(o)}${e?"&"+e:""}`;async function r(m){const y=`/api/proxy/xtream?base=${encodeURIComponent(m)}&params=${encodeURIComponent(i)}`,p=await fetch(y,{cache:"no-store"});if(!p.ok)throw new Error("Request failed: "+p.status);return{data:await p.json(),baseUrl:m}}let{data:a,baseUrl:u}=await r(t);if(!a||a.nonJson)try{const m=t.startsWith("https://")?t.replace(/^https:\/\//i,"http://"):t.replace(/^http:\/\//i,"https://"),y=await r(m);y?.data&&!y.data.nonJson&&(a=y.data,u=y.baseUrl)}catch{}if(!a||a.nonJson){const m=a?.contentType?` (${a.contentType}${a.status?", "+a.status:""})`:"";throw new Error("Xtream API returned non-JSON"+m)}return a}async function uf(){try{const[e,t,n]=await Promise.all([lo("action=get_live_categories").catch(()=>[]),lo("action=get_vod_categories").catch(()=>[]),lo("action=get_series_categories").catch(()=>[])]);ie.liveCategories=Array.isArray(e)?e:[],ie.vodCategories=Array.isArray(t)?t:[],ie.seriesCategories=Array.isArray(n)?n:[]}catch(e){console.warn("[XTREAM] Failed to load some categories:",e)}}function Kh(){const e=document.getElementById("xtream-category-select");if(!e)return;const t=ie.tab;let n=[];ie.mode==="m3u"?n=ie.m3u?.categories||[]:t==="live"?n=ie.liveCategories:t==="vod"?n=ie.vodCategories:n=ie.seriesCategories;const o=e.value;e.innerHTML='<option value="">All Categories</option>',ie.mode==="m3u"?n.forEach(i=>{const r=document.createElement("option");r.value=i,r.textContent=i,e.appendChild(r)}):n.forEach(i=>{const r=document.createElement("option");r.value=i.category_id,r.textContent=i.category_name||"Category "+i.category_id,e.appendChild(r)}),[...e.options].some(i=>i.value===o)&&(e.value=o)}function Yh(e,t){const{base:n,username:o,password:i}=ie;if(!t)return"";if(ie.mode==="m3u")return t.url||"";const r=t.stream_id||t.series_id||t.id;if(e==="live"){const a=t?.container_extension?t.container_extension.replace(/^\./,""):"m3u8";return`${n}/live/${encodeURIComponent(o)}/${encodeURIComponent(i)}/${r}.${a}`}else if(e==="vod"){const a=t?.container_extension?t.container_extension.replace(/^\./,""):"mp4";return`${n}/movie/${encodeURIComponent(o)}/${encodeURIComponent(i)}/${r}.${a}`}return""}async function Jh(e=""){const t=ie.tab;try{let n=[];if(ie.mode==="m3u"){const o=ie.m3u?.items||[];e?n=o.filter(i=>(i.group||"")===e):n=o}else if(t==="live"){const o=e?`action=get_live_streams&category_id=${encodeURIComponent(e)}`:"action=get_live_streams";n=await lo(o)}else if(t==="vod"){const o=e?`action=get_vod_streams&category_id=${encodeURIComponent(e)}`:"action=get_vod_streams";n=await lo(o)}else{const o=e?`action=get_series&category_id=${encodeURIComponent(e)}`:"action=get_series";n=await lo(o)}ie.lastStreams=Array.isArray(n)?n:[],ie.displayedIndex=0,ie.pageSize=50}catch(n){console.error("[XTREAM] Load streams error:",n),ie.lastStreams=[]}}function ya(e=!1){const t=document.getElementById("xtream-grid"),n=document.getElementById("xtream-empty"),o=(document.getElementById("xtream-search")?.value||"").toLowerCase().trim();if(!t||!n)return;let i=ie.lastStreams||[];o&&(i=i.filter(p=>(p.name||p.title||"").toLowerCase().includes(o)));const r=e?ie.displayedIndex:0,a=r+ie.pageSize,u=i.slice(r,a);if(e||(t.innerHTML=""),!i.length){n.style.display="";return}n.style.display="none";const m=ie.tab;u.forEach(p=>{const N=document.createElement("div");N.className="music-card",N.style.cursor="default";const I=ie.mode==="m3u"?p.name||"Channel":p.name||p.title||`ID ${p.stream_id||p.series_id||""}`,k=ie.mode==="m3u"?p.logo||"":p.stream_icon||p.cover||p.movie_image||"",A=m==="series"&&ie.mode!=="m3u"?"":Yh(m,p),U=m==="series"&&ie.mode!=="m3u"?`
                    <button class="btn" style="padding:.4rem .7rem; border:none; border-radius:6px; background:linear-gradient(135deg,#f59e0b,#b45309); color:#fff; cursor:pointer;" data-action="series" data-id="${p.series_id}">
                        <i class="fas fa-list"></i> Episodes
                    </button>
                `:`
                    <button class="btn" style="padding:.4rem .7rem; border:none; border-radius:6px; background:linear-gradient(135deg,#10b981,#059669); color:#fff; cursor:pointer;" data-action="play" data-url="${A}" data-name="${I.replace(/"/g,"&quot;")}">
                        <i class="fas fa-play"></i> Play
                    </button>
                    <button class="btn" style="padding:.4rem .7rem; border:none; border-radius:6px; background:linear-gradient(135deg,#3b82f6,#2563eb); color:#fff; cursor:pointer;" data-action="open" data-url="${A}">
                        <i class="fas fa-external-link-alt"></i>
                    </button>
                    <button class="btn" style="padding:.4rem .7rem; border:none; border-radius:6px; background:rgba(255,255,255,.1); color:#fff; cursor:pointer;" data-action="copy" data-url="${A}">
                        <i class="fas fa-copy"></i>
                    </button>
                `;N.innerHTML=`
                    <div class="music-cover">
                        ${k?`<img loading="lazy" src="${k}" alt="${I}" onerror="this.style.display='none'">`:`<div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;background:rgba(255,255,255,.05)"><i class='fas fa-tv'></i></div>`}
                    </div>
                    <div class="music-info">
                        <div class="music-title">${I}</div>
                        <div class="music-actions" style="flex-wrap:wrap; gap:.4rem; margin-top:.4rem;">${U}</div>
                    </div>
                `,t.appendChild(N)}),ie.displayedIndex=a,Array.from(t.children).slice(-u.length).forEach(p=>{p.querySelectorAll('[data-action="play"]').forEach(N=>N.addEventListener("click",I=>{const k=I.currentTarget.getAttribute("data-url"),A=I.currentTarget.getAttribute("data-name");if(!k){showNotification("No stream URL found","error");return}Mr(A,k)})),p.querySelectorAll('[data-action="open"]').forEach(N=>N.addEventListener("click",I=>{const k=I.currentTarget.getAttribute("data-url");if(!k){showNotification("No stream URL found","error");return}window.electronAPI?.openExternal?window.electronAPI.openExternal(k):window.open(k,"_blank")})),p.querySelectorAll('[data-action="copy"]').forEach(N=>N.addEventListener("click",async I=>{const k=I.currentTarget.getAttribute("data-url");try{await navigator.clipboard.writeText(k),showNotification("Stream URL copied","success")}catch{showNotification("Copy failed","error")}})),p.querySelectorAll('[data-action="series"]').forEach(N=>N.addEventListener("click",I=>{const k=I.currentTarget.getAttribute("data-id");Xh(k)}))})}async function Xh(e){try{const t=await lo(`action=get_series_info&series_id=${encodeURIComponent(e)}`),n=t?.episodes?Object.values(t.episodes).flat():[];if(!n.length){showNotification("No episodes found","info");return}const o={};n.forEach(a=>{const u=a.season||"1";o[u]||(o[u]=[]),o[u].push(a)});const i=document.getElementById("xtream-grid");if(!i)return;i.innerHTML="",Object.keys(o).sort((a,u)=>parseInt(a)-parseInt(u)).forEach(a=>{const u=o[a],m=document.createElement("div");m.className="music-card",m.style.gridColumn="1 / -1",m.style.cursor="pointer",m.style.background="linear-gradient(135deg, rgba(59,130,246,0.1), rgba(37,99,235,0.05))",m.style.border="1px solid rgba(59,130,246,0.3)";const y=`season-${e}-${a}`;m.innerHTML=`
                        <div style="padding:1rem;">
                            <div style="display:flex; justify-content:space-between; align-items:center;">
                                <h3 style="color:#fff; margin:0; font-size:1.1rem;">
                                    <i class="fas fa-tv" style="color:#3b82f6;"></i> Season ${a}
                                    <span style="color:#9ca3af; font-size:0.9rem; margin-left:0.5rem;">(${u.length} episodes)</span>
                                </h3>
                                <button class="season-toggle" data-season-id="${y}" style="background:rgba(59,130,246,0.2); border:1px solid rgba(59,130,246,0.4); color:#3b82f6; padding:0.4rem 0.8rem; border-radius:6px; cursor:pointer;">
                                    <i class="fas fa-chevron-down"></i> Show Episodes
                                </button>
                            </div>
                            <div id="${y}" style="display:none; margin-top:1rem;">
                                <div style="display:grid; grid-template-columns:repeat(auto-fill,minmax(200px,1fr)); gap:0.75rem;"></div>
                            </div>
                        </div>
                    `,i.appendChild(m);const p=m.querySelector(".season-toggle"),N=m.querySelector(`#${y}`),I=N.querySelector("div");p.addEventListener("click",k=>{k.stopPropagation(),N.style.display==="none"?(I.children.length===0&&(u.forEach(U=>{const W=`E${U.episode_num} - ${U.title||"Episode"}`,Y=`${ie.base}/series/${encodeURIComponent(ie.username)}/${encodeURIComponent(ie.password)}/${U.id}.${(U.container_extension||"mp4").replace(/^\./,"")}`,ae=document.createElement("div");ae.style.cssText="background:rgba(0,0,0,0.3); border:1px solid rgba(255,255,255,0.1); border-radius:8px; padding:0.75rem; display:flex; flex-direction:column; gap:0.5rem;",ae.innerHTML=`
                                        <div style="color:#fff; font-weight:600; font-size:0.9rem;">${W}</div>
                                        <div style="display:flex; gap:0.4rem; flex-wrap:wrap;">
                                            <button class="btn" style="padding:.3rem .6rem; border:none; border-radius:6px; background:linear-gradient(135deg,#10b981,#059669); color:#fff; cursor:pointer; font-size:0.85rem;" data-action="play" data-url="${Y}" data-name="${W.replace(/"/g,"&quot;")}">
                                                <i class="fas fa-play"></i> Play
                                            </button>
                                            <button class="btn" style="padding:.3rem .6rem; border:none; border-radius:6px; background:linear-gradient(135deg,#3b82f6,#2563eb); color:#fff; cursor:pointer; font-size:0.85rem;" data-action="open" data-url="${Y}">
                                                <i class="fas fa-external-link-alt"></i>
                                            </button>
                                            <button class="btn" style="padding:.3rem .6rem; border:none; border-radius:6px; background:rgba(255,255,255,.1); color:#fff; cursor:pointer; font-size:0.85rem;" data-action="copy" data-url="${Y}">
                                                <i class="fas fa-copy"></i>
                                            </button>
                                        </div>
                                    `,I.appendChild(ae)}),I.querySelectorAll('[data-action="play"]').forEach(U=>U.addEventListener("click",W=>{const Y=W.currentTarget.getAttribute("data-url"),ae=W.currentTarget.getAttribute("data-name");if(!Y){showNotification("No stream URL found","error");return}Mr(ae,Y)})),I.querySelectorAll('[data-action="open"]').forEach(U=>U.addEventListener("click",W=>{const Y=W.currentTarget.getAttribute("data-url");if(!Y){showNotification("No stream URL found","error");return}window.electronAPI?.openExternal?window.electronAPI.openExternal(Y):window.open(Y,"_blank")})),I.querySelectorAll('[data-action="copy"]').forEach(U=>U.addEventListener("click",async W=>{const Y=W.currentTarget.getAttribute("data-url");try{await navigator.clipboard.writeText(Y),showNotification("Stream URL copied","success")}catch{showNotification("Copy failed","error")}}))),N.style.display="",p.innerHTML='<i class="fas fa-chevron-up"></i> Hide Episodes'):(N.style.display="none",p.innerHTML='<i class="fas fa-chevron-down"></i> Show Episodes')})})}catch(t){console.error("[XTREAM] Series info error:",t),showNotification("Failed to load episodes: "+(t?.message||"Unknown"),"error")}}async function Bi(){Kh();const e=document.getElementById("xtream-category-select"),t=e?e.value:"",n=document.getElementById("xtream-empty");n&&(n.style.display="",n.textContent="Loading..."),await Jh(t),ya()}function Qh(){const e=document.getElementById("iptv-custom-btn");e&&e.addEventListener("click",qh);const t=document.getElementById("xtream-login-close"),n=document.getElementById("xtream-login-cancel"),o=document.getElementById("xtream-login-submit");t&&t.addEventListener("click",ao),n&&n.addEventListener("click",ao),o&&o.addEventListener("click",zh);const i=document.getElementById("xtream-inline-content");i&&i.addEventListener("scroll",()=>{const{scrollTop:I,scrollHeight:k,clientHeight:A}=i;if(I+A>=k-200){const U=(document.getElementById("xtream-search")?.value||"").toLowerCase().trim();let W=ie.lastStreams||[];U&&(W=W.filter(Y=>(Y.name||Y.title||"").toLowerCase().includes(U))),ie.displayedIndex<W.length&&ya(!0)}});const r=document.getElementById("xtream-category-select");r&&r.addEventListener("change",()=>Bi());const a=document.getElementById("xtream-search");a&&a.addEventListener("input",()=>{ie.displayedIndex=0,ya(!1)}),document.querySelectorAll(".xtream-tab-btn").forEach(I=>{I.addEventListener("click",async k=>{document.querySelectorAll(".xtream-tab-btn").forEach(W=>{W.style.background="transparent",W.style.color="#ddd"});const A=k.currentTarget;A.style.background="#1b1b1b",A.style.color="#fff";const U=A.getAttribute("data-tab");if(ie.mode==="m3u"&&U!=="live"){showNotification("This playlist only supports Live channels","info");const W=document.querySelector('.xtream-tab-btn[data-tab="live"]');W&&(W.style.background="#1b1b1b",W.style.color="#fff"),ie.tab="live";return}ie.tab=U,await Bi()})});const u=document.getElementById("xtream-player-close");u&&u.addEventListener("click",pa);const m=document.getElementById("xtream-player-modal");m&&m.addEventListener("click",I=>{I.target===m&&pa()});const y=document.getElementById("xtream-m3u-submit"),p=document.getElementById("xtream-m3u-url");y&&y.addEventListener("click",async()=>{const I=(p?.value||"").trim();if(!I){showNotification("Please enter a playlist URL","warning");return}const k=document.getElementById("xtream-login-status");if(k&&(k.textContent=""),Yd(I)){try{Ho(),Ci()}catch{}ao(),ie.active=!0,ie.mode="direct",en(),Mr("Custom Stream",I)}else await cr(I)}),p&&p.addEventListener("keypress",async I=>{if(I.key==="Enter"){const k=(p?.value||"").trim();if(!k){showNotification("Please enter a playlist URL","warning");return}if(Yd(k)){try{Ho(),Ci()}catch{}ao(),ie.active=!0,ie.mode="direct",en(),Mr("Custom Stream",k)}else await cr(k)}}),document.querySelectorAll("#xtream-m3u-recommended .m3u-preset").forEach(I=>I.addEventListener("click",async()=>{const k=I.getAttribute("data-url"),A=document.getElementById("xtream-m3u-url");A&&(A.value=k),k&&await cr(k)}))}function Jd(){window.location.hash="#/games-downloader"}async function Zh(){try{console.log("[GAMES] Loading categories...");const e=document.getElementById("games-category-select");if(!e){console.error("[GAMES] Category select element not found");return}const t=["Action","Adventure","Anime","Building","First-person Shooter Games","Horror","Indie","Multiplayer","Nudity","Open World","Racing","Role-playing game","Sci-fi","Shooters","Simulation","Sports","Strategy","Survival","Uncategorized","Virtual Reality"];e.innerHTML='<option value="" style="background: var(--bg-secondary); color: var(--secondary); padding: 0.5rem; font-weight: 500;">Select a category...</option>',t.forEach(n=>{const o=document.createElement("option");o.value=n,o.textContent=n,o.style.cssText="background: var(--card-bg); color: var(--light); padding: 0.5rem; font-weight: 500;",e.appendChild(o)}),console.log("[GAMES] Categories populated in dropdown:",t.length)}catch(e){console.error("[GAMES] Failed to load categories:",e)}}async function Xd(e){const t=document.getElementById("games-search-status"),n=document.getElementById("games-results-section"),o=document.getElementById("games-empty-state"),i=document.getElementById("games-results-grid");document.getElementById("games-results-count");try{t.textContent=`Loading ${e} games...`,t.style.color="#8b5cf6",o.style.display="none";const r=await fetch(`http://localhost:6987/api/games/category/${encodeURIComponent(e)}`);if(!r.ok)throw new Error("Failed to load category");const a=await r.json();if(!a.games||a.games.length===0){t.textContent=`No games found in ${e}`,t.style.color="#ef4444",o.style.display="";return}window.allGames=a.games,window.currentGameIndex=0,window.gamesPerLoad=20,i.innerHTML="",n.style.display="",Wa()}catch(r){console.error("Browse by category error:",r),t.style.color="#ef4444",o.style.display=""}}async function Qd(e){const t=document.getElementById("games-search-status"),n=document.getElementById("games-results-section"),o=document.getElementById("games-empty-state"),i=document.getElementById("games-results-grid"),r=document.getElementById("games-results-count");if(!e||!e.trim()){t.textContent="Please enter a game name",t.style.color="#ef4444";return}try{t.textContent="Searching...",t.style.color="#8b5cf6",n.style.display="none",o.style.display="none";const a=await fetch(`http://localhost:6987/api/games/search/${encodeURIComponent(e)}`);if(!a.ok)throw new Error("Search failed");const u=await a.json();if(!u.games||u.games.length===0){t.textContent="No games found",t.style.color="#ef4444",o.style.display="";return}t.textContent=`Found ${u.count} game${u.count!==1?"s":""}`,t.style.color="#10b981",r.textContent=`${u.count} game${u.count!==1?"s":""}`,i.innerHTML="",u.games.forEach(m=>{const y=document.createElement("div");y.className="music-card",y.style.cursor="default";let p="";if(m.download_links&&typeof m.download_links=="object"){const A=[];Object.keys(m.download_links).forEach(U=>{const W=m.download_links[U];if(Array.isArray(W))W.forEach((Y,ae)=>{const Ce=Y.startsWith("//")?"https:"+Y:Y,G=U.charAt(0).toUpperCase()+U.slice(1)+(W.length>1?` ${ae+1}`:"");A.push({name:G,url:Ce})});else if(typeof W=="string"){const Y=W.startsWith("//")?"https:"+W:W,ae=U.charAt(0).toUpperCase()+U.slice(1);A.push({name:ae,url:Y})}}),A.length>0&&(p=A.map(U=>`
                                <button class="game-download-link" data-url="${U.url}" style="padding: 0.4rem 0.8rem; background: linear-gradient(135deg, #8b5cf6, #7c3aed); border: none; border-radius: 6px; color: white; font-size: 0.85rem; cursor: pointer; margin: 0.2rem; transition: transform 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                                    <i class="fas fa-download"></i> ${U.name}
                                </button>
                            `).join(""))}p||(p='<span style="color: var(--secondary); font-size: 0.85rem;">No download links available</span>');const N=m.imgID?`http://localhost:6987/api/games/image/${m.imgID}`:"https://via.placeholder.com/300x400?text=No+Image",I=m.game||m.name||"Unknown Game",k=Array.isArray(m.category)?m.category.join(", "):m.category||"N/A";y.innerHTML=`
                        <div class="music-cover">
                            <img loading="lazy" src="${N}" alt="${I}" onerror="this.src='https://via.placeholder.com/300x400?text=No+Image'">
                        </div>
                        <div class="music-info">
                            <div class="music-title">${I}</div>
                            <div class="music-artist" style="color: #8b5cf6;">${k}</div>
                            ${m.size?`<div style="color: var(--secondary); font-size: 0.85rem; margin: 0.3rem 0;"><i class="fas fa-hdd"></i> Size: ${m.size}</div>`:""}
                            ${m.version?`<div style="color: var(--secondary); font-size: 0.85rem; margin: 0.3rem 0;"><i class="fas fa-tag"></i> Version: ${m.version}</div>`:""}
                            ${m.description?`<div style="color: var(--secondary); font-size: 0.85rem; margin: 0.5rem 0; line-height: 1.4;">${m.description.substring(0,150)}${m.description.length>150?"...":""}</div>`:""}
                            <div class="music-actions" style="flex-wrap: wrap; margin-top: 0.5rem;">
                                ${p}
                            </div>
                        </div>
                    `,i.appendChild(y)}),i.querySelectorAll(".game-download-link").forEach(m=>{m.addEventListener("click",async y=>{const p=y.currentTarget.getAttribute("data-url");p&&window.electronAPI?.openExternal&&(await window.electronAPI.openExternal(p),showNotification("Opening download link in browser...","info"))})}),n.style.display="",o.style.display="none"}catch(a){console.error("Games search error:",a),t.textContent="Search failed. Please try again.",t.style.color="#ef4444",o.style.display=""}}async function ff(){const e=document.getElementById("games-search-status"),t=document.getElementById("games-results-section"),n=document.getElementById("games-empty-state"),o=document.getElementById("games-results-grid");document.getElementById("games-results-count");try{e.textContent="Loading games...",e.style.color="#8b5cf6",n.style.display="none";const i=await fetch("http://localhost:6987/api/games/all");if(!i.ok)throw new Error("Failed to load games");const r=await i.json();if(!r.games||r.games.length===0){e.textContent="No games available",e.style.color="#ef4444",n.style.display="";return}window.allGames=r.games,window.currentGameIndex=0,window.gamesPerLoad=20,o.innerHTML="",t.style.display="",Wa()}catch(i){console.error("Browse all games error:",i),e.style.color="#ef4444",n.style.display=""}}function Wa(){const e=document.getElementById("games-search-status"),t=document.getElementById("games-results-section"),n=document.getElementById("games-results-grid"),o=document.getElementById("games-results-count");if(!window.allGames||window.allGames.length===0)return;const i=window.currentGameIndex,r=Math.min(i+window.gamesPerLoad,window.allGames.length),a=window.allGames.slice(i,r);e.textContent=`Showing ${r} of ${window.allGames.length} games`,e.style.color="#10b981",o.textContent=`${r} / ${window.allGames.length} games`,a.forEach(m=>{const y=document.createElement("div");y.className="music-card",y.style.cursor="default";let p="";if(m.download_links&&typeof m.download_links=="object"){const A=[];Object.keys(m.download_links).forEach(U=>{const W=m.download_links[U];if(Array.isArray(W))W.forEach((Y,ae)=>{const Ce=Y.startsWith("//")?"https:"+Y:Y,G=U.charAt(0).toUpperCase()+U.slice(1)+(W.length>1?` ${ae+1}`:"");A.push({name:G,url:Ce})});else if(typeof W=="string"){const Y=W.startsWith("//")?"https:"+W:W,ae=U.charAt(0).toUpperCase()+U.slice(1);A.push({name:ae,url:Y})}}),A.length>0&&(p=A.map(U=>`
                            <button class="game-download-link" data-url="${U.url}" style="padding: 0.4rem 0.8rem; background: linear-gradient(135deg, #8b5cf6, #7c3aed); border: none; border-radius: 6px; color: white; font-size: 0.85rem; cursor: pointer; margin: 0.2rem; transition: transform 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                                <i class="fas fa-download"></i> ${U.name}
                            </button>
                        `).join(""))}p||(p='<span style="color: var(--secondary); font-size: 0.85rem;">No download links available</span>');const N=m.imgID?`http://localhost:6987/api/games/image/${m.imgID}`:"https://via.placeholder.com/300x400?text=No+Image",I=m.game||m.name||"Unknown Game",k=Array.isArray(m.category)?m.category.join(", "):m.category||"N/A";y.innerHTML=`
                    <div class="music-cover">
                        <img loading="lazy" src="${N}" alt="${I}" onerror="this.onerror=null; this.src='https://via.placeholder.com/300x400?text=${encodeURIComponent(I)}'">
                    </div>
                    <div class="music-info">
                        <div class="music-title">${I}</div>
                        <div class="music-artist" style="color: #8b5cf6;">${k}</div>
                        ${m.size?`<div style="color: var(--secondary); font-size: 0.85rem; margin: 0.3rem 0;"><i class="fas fa-hdd"></i> Size: ${m.size}</div>`:""}
                        ${m.version?`<div style="color: var(--secondary); font-size: 0.85rem; margin: 0.3rem 0;"><i class="fas fa-tag"></i> Version: ${m.version}</div>`:""}
                        ${m.description?`<div style="color: var(--secondary); font-size: 0.85rem; margin: 0.5rem 0; line-height: 1.4;">${m.description.substring(0,150)}${m.description.length>150?"...":""}</div>`:""}
                        <div class="music-actions" style="flex-wrap: wrap; margin-top: 0.5rem;">
                            ${p}
                        </div>
                    </div>
                `,n.appendChild(y)}),n.querySelectorAll(".game-download-link").forEach(m=>{m.addEventListener("click",async y=>{const p=y.currentTarget.getAttribute("data-url");p&&window.electronAPI?.openExternal&&(await window.electronAPI.openExternal(p),showNotification("Opening download link in browser...","info"))})}),window.currentGameIndex=r;let u=document.getElementById("games-load-more-btn");u||(u=document.createElement("button"),u.id="games-load-more-btn",u.innerHTML='<i class="fas fa-arrow-down"></i> Load More Games',u.style.cssText="display: block; margin: 2rem auto; padding: 0.75rem 2rem; background: linear-gradient(135deg, #f97316, #ea580c); border: none; border-radius: 8px; color: white; font-weight: 600; cursor: pointer; transition: transform 0.5s cubic-bezier(0.34, 1.56, 0.64, 1); font-size: 1rem;",u.onmouseover=()=>u.style.transform="scale(1.05)",u.onmouseout=()=>u.style.transform="scale(1)",u.onclick=Wa,n.parentElement.appendChild(u)),window.currentGameIndex>=window.allGames.length?u.style.display="none":u.style.display="block",t.style.display="",emptyState.style.display="none"}document.addEventListener("DOMContentLoaded",()=>{try{const y=localStorage.getItem("perfMode");(y==null?!0:y==="true")&&document.body.classList.add("perf-mode")}catch{}const e=document.getElementById("appSidebar"),t=document.getElementById("sidebarCloseBtn"),n=document.getElementById("sidebarToggleBtn");localStorage.getItem("sidebarHidden")==="true"&&e&&e.classList.add("sidebar-hidden"),t&&e&&t.addEventListener("click",y=>{y.stopPropagation(),e.classList.add("sidebar-hidden"),localStorage.setItem("sidebarHidden","true")}),n&&e&&n.addEventListener("click",()=>{e.classList.remove("sidebar-hidden"),localStorage.setItem("sidebarHidden","false")});const i=document.getElementById("games-search-input"),r=document.getElementById("games-search-btn"),a=document.getElementById("games-browse-all-btn"),u=document.getElementById("games-category-select"),m=document.getElementById("games-category-btn");i&&r&&(r.addEventListener("click",()=>{Qd(i.value)}),i.addEventListener("keypress",y=>{y.key==="Enter"&&Qd(i.value)})),a&&a.addEventListener("click",()=>{ff()}),u&&m&&(m.addEventListener("click",()=>{const y=u.value;y&&Xd(y)}),u.addEventListener("change",y=>{const p=y.target.value;p&&Xd(p)}));try{Qh(),en()}catch(y){console.warn("[XTREAM] bind failed",y)}Hh()});function Zd(){window.location.hash="#/minigames"}function Gh(){const e=document.getElementById("minigames-iframe");e&&(e.src="about:blank",setTimeout(()=>{e.src="https://playtorriogames.pages.dev/",setTimeout(()=>{document.getElementById("minigames-page")&&(e.scrollIntoView({behavior:"smooth",block:"start"}),console.log("[MINIGAMES] Auto-scrolled MiniGames page to show iframe"))},50)},100),console.log("[MINIGAMES] Page reloaded fresh"))}function ev(){const e=document.getElementById("minigames-iframe");e&&(e.src="about:blank",console.log("[MINIGAMES] Page cleared"))}function Gd(){window.location.hash="#/books"}function eu(){window.location.hash="#/music"}function tu(){window.location.hash="#/audiobooks",rv()}let tv=[],nv=!1,Rr=[],ov=0,mf="",iv=1;async function rv(){try{const e=document.getElementById("audiobooks-books-view"),t=document.getElementById("audiobooks-chapters-view"),n=document.getElementById("audiobookSearchResults"),o=document.getElementById("audiobookLoading"),i=document.getElementById("clearAudioBookSearchBtn"),r=document.getElementById("audiobookLoadMoreContainer");iv=1,nv=!1,e.style.display="block",t.style.display="none",i.style.display="none",n.innerHTML="",o.style.display="block";const u=await(await fetch("/api/audiobooks/all")).json();if(u.success&&u.data.length>0){tv=u.data;const m=u.data.filter(y=>{const p=y.title.toLowerCase();return!p.includes("1001 nights")&&!p.includes("the fox and the wolf")});sv(m),r.style.display="block"}else n.innerHTML=`
                        <div class="search-placeholder">
                            <i class="fas fa-exclamation-circle" style="font-size: 3rem; color: #e74c3c; margin-bottom: 1rem;"></i>
                            <h3>No AudioBooks Found</h3>
                            <p>Unable to load audiobooks at this time</p>
                        </div>
                    `,r.style.display="none"}catch(e){console.error("Error loading audiobooks:",e);const t=document.getElementById("audiobookSearchResults");t.innerHTML=`
                    <div class="search-placeholder">
                        <i class="fas fa-exclamation-circle" style="font-size: 3rem; color: #e74c3c; margin-bottom: 1rem;"></i>
                        <h3>Error Loading AudioBooks</h3>
                        <p>${e.message}</p>
                    </div>
                `,document.getElementById("audiobookLoadMoreContainer").style.display="none"}finally{document.getElementById("audiobookLoading").style.display="none"}}function sv(e){const t=document.getElementById("audiobookSearchResults");t.innerHTML="",e.forEach(n=>{const o=document.createElement("div");o.className="book-card",o.style.cursor="pointer",o.innerHTML=`
                    <div class="book-cover-container">
                        <img src="${n.image||"data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22200%22 height=%22280%22%3E%3Crect fill=%22%23ddd%22 width=%22200%22 height=%22280%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 text-anchor=%22middle%22 dy=%22.3em%22 fill=%22%23999%22 font-family=%22Arial%22 font-size=%2216%22%3ENo Image%3C/text%3E%3C/svg%3E"}" 
                             alt="${n.title}" 
                             class="book-cover"
                             onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22200%22 height=%22280%22%3E%3Crect fill=%22%23ddd%22 width=%22200%22 height=%22280%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 text-anchor=%22middle%22 dy=%22.3em%22 fill=%22%23999%22 font-family=%22Arial%22 font-size=%2216%22%3ENo Image%3C/text%3E%3C/svg%3E'">
                        <div class="playtorrio-logo">PlayTorrio</div>
                    </div>
                    <div class="book-info">
                        <h3 class="book-title">${n.title}</h3>
                    </div>
                `,o.onclick=()=>av(n),t.appendChild(o)})}async function av(e){try{const t=document.getElementById("audiobooks-books-view"),n=document.getElementById("audiobooks-chapters-view"),o=document.getElementById("audiobooksChapterBookTitle").querySelector("span"),i=document.getElementById("audiobooksChaptersList"),r=document.getElementById("audiobooksChapterLoading");mf=e.title,o.textContent=e.title,t.style.display="none",n.style.display="block",r.style.display="block",i.innerHTML="";const u=await(await fetch(`/api/audiobooks/chapters/${e.post_name}`)).json();u.success&&u.data?(Rr=u.data,cv()):i.innerHTML=`
                        <div style="text-align: center; padding: 2rem; color: #666;">
                            <i class="fas fa-exclamation-circle" style="font-size: 3rem; color: #e74c3c; margin-bottom: 1rem;"></i>
                            <h3>Failed to Load Chapters</h3>
                            <p>Unable to load chapters for this audiobook</p>
                        </div>
                    `}catch(t){console.error("Error loading chapters:",t);const n=document.getElementById("audiobooksChaptersList");n.innerHTML=`
                    <div style="text-align: center; padding: 2rem; color: #666;">
                        <i class="fas fa-exclamation-circle" style="font-size: 3rem; color: #e74c3c; margin-bottom: 1rem;"></i>
                        <h3>Error Loading Chapters</h3>
                        <p>${t.message}</p>
                    </div>
                `}finally{document.getElementById("audiobooksChapterLoading").style.display="none"}}function cv(){const e=document.getElementById("audiobooksChaptersList");e.innerHTML="",Rr.forEach((t,n)=>{const o=document.createElement("div");o.className="book-card",o.style.cursor="pointer",o.style.padding="15px 20px",o.style.display="flex",o.style.justifyContent="space-between",o.style.alignItems="center",o.style.gap="10px",o.setAttribute("data-chapter-index",n);const i=document.createElement("div");i.style.flex="1",i.style.display="flex",i.style.justifyContent="space-between",i.style.alignItems="center",i.style.minWidth="0",i.innerHTML=`
                    <span style="font-weight: 600; font-size: 15px;">${t.track}. ${t.name}</span>
                    <span style="color: #666; font-size: 13px;">${t.duration}</span>
                `,i.onclick=()=>pf(n);const r=document.createElement("button");r.className="action-btn",r.innerHTML='<i class="fas fa-download"></i> Download',r.style.background="linear-gradient(135deg, #8b5cf6, #7c3aed)",r.onclick=a=>{a.stopPropagation(),lv(t)},o.appendChild(i),o.appendChild(r),e.appendChild(o)})}async function pf(e){try{ov=e;const t=Rr[e];if(t.chapter_id==="0"||t.post_id==="0"){e<Rr.length-1&&pf(e+1);return}const n=document.getElementById("audiobooksPlayer"),o=document.getElementById("audiobooksAudioElement"),i=document.getElementById("audiobooksPlayerTitle"),r=document.getElementById("audiobooksPlayerChapter"),a=document.getElementById("audiobooksPlayPauseBtn");dv(e),i.textContent=mf,r.textContent=t.name,n.style.display="block";const m=await(await fetch("/api/audiobooks/stream",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({chapterId:parseInt(t.chapter_id),serverType:1})})).json();m.success&&m.data.link_mp3?(o.src=m.data.link_mp3,o.play(),a.innerHTML='<i class="fas fa-pause"></i>'):showNotification("Failed to get audio stream","error")}catch(t){console.error("Error playing chapter:",t),showNotification("Error playing chapter: "+t.message,"error")}}async function lv(e,t){try{if(e.chapter_id==="0"||e.post_id==="0"){showNotification("Cannot download welcome track","error");return}const o=await(await fetch("/api/audiobooks/stream",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({chapterId:parseInt(e.chapter_id),serverType:1})})).json();o.success&&o.data.link_mp3?window.electronAPI&&window.electronAPI.openExternal?(await window.electronAPI.openExternal(o.data.link_mp3),showNotification("Opening download in browser","success")):(window.open(o.data.link_mp3,"_blank"),showNotification("Download opened","success")):showNotification("Failed to get download link","error")}catch(n){console.error("Error downloading chapter:",n),showNotification("Error downloading: "+n.message,"error")}}function dv(e){document.querySelectorAll("#audiobooksChaptersList .book-card").forEach((n,o)=>{o===e?(n.style.background="linear-gradient(135deg, #8b5cf6, #7c3aed)",n.style.color="white",n.querySelector("span:last-child").style.color="rgba(255,255,255,0.9)"):(n.style.background="",n.style.color="",n.querySelector("span:last-child").style.color="#666")})}function nu(){window.location.hash="#/booktorrio"}function ou(){window.location.hash="#/anime"}function iu(){window.location.hash="#/manga"}function ru(){window.location.hash="#/comics"}function su(){window.location.hash="#/downloader"}let Js=[],to=[];async function uv(){const e=document.getElementById("livetv-category-select"),t=document.getElementById("livetv-grid"),n=document.getElementById("livetv-empty");if(e)try{n&&(n.style.display="",n.innerHTML='<div class="livetv-loading"><i class="fas fa-spinner"></i><p>Loading sports...</p></div>'),t&&(t.innerHTML=""),console.log("[LiveTV] Fetching sports from API...");const o=await fetch("https://watchfooty.st/api/v1/sports");if(!o.ok)throw new Error(`API returned ${o.status}: ${o.statusText}`);const i=await o.json();if(console.log("[LiveTV] Received sports:",i),!Array.isArray(i)||i.length===0)throw new Error("No sports data received from API");to=i.map(r=>r.name),console.log("[LiveTV] Available categories:",to),e.innerHTML="",i.forEach(r=>{const a=document.createElement("option");a.value=r.name;const m={football:"âš½",soccer:"âš½",tennis:"ðŸŽ¾",basketball:"ðŸ€",hockey:"ðŸ’",baseball:"âš¾",rugby:"ðŸ‰",cricket:"ðŸ",motorsport:"ðŸŽï¸","motor-sport":"ðŸŽï¸",golf:"â›³",boxing:"ðŸ¥Š",mma:"ðŸ¥‹",ufc:"ðŸ¥‹",fighting:"ðŸ¥‹",other:"ðŸ“º"}[r.name.toLowerCase()]||"ðŸ“º";a.textContent=`${m} ${r.displayName}`,e.appendChild(a)}),console.log("[LiveTV] Populated dropdown with",i.length,"sports"),console.log("[LiveTV] Sports list:",to),to.includes("football")?(e.value="football",console.log("[LiveTV] Default sport set to: football")):to.length>0&&(e.value=to[0],console.log("[LiveTV] Default sport set to:",to[0])),console.log("[LiveTV] Loading matches for:",e.value),await ga(e.value)}catch(o){console.error("[LiveTV] Error during initialization:",o),n&&(n.style.display="",n.innerHTML=`<i class="fas fa-exclamation-triangle" style="font-size: 3em; opacity: 0.3; color: #ef4444;"></i><p>Failed to load Live TV: ${o.message}</p><p style="font-size: 0.9em; opacity: 0.7;">Check console for details</p>`)}}async function ga(e){const t=document.getElementById("livetv-grid"),n=document.getElementById("livetv-empty"),o=document.getElementById("livetv-search-input");if(!(!t||!n))try{n.style.display="",n.innerHTML='<div class="livetv-loading"><i class="fas fa-spinner"></i><p>Loading matches...</p></div>',t.innerHTML="",console.log(`[LiveTV] Fetching matches for category: ${e}`);const i=await fetch(`https://watchfooty.st/api/v1/matches/${e}`);if(!i.ok)throw new Error(`API returned ${i.status}: ${i.statusText}`);Js=await i.json(),console.log(`[LiveTV] Received ${Js.length} matches for ${e}`);const r=o?o.value.trim().toLowerCase():"";let a=Js;if(r&&(a=a.filter(k=>{const A=(k.title||"").toLowerCase(),U=(k.league||"").toLowerCase(),W=(k.teams?.home?.name||"").toLowerCase(),Y=(k.teams?.away?.name||"").toLowerCase();return A.includes(r)||U.includes(r)||W.includes(r)||Y.includes(r)}),console.log(`[LiveTV] Filtered to ${a.length} matches matching "${r}"`)),a.sort((k,A)=>{const U={in:0,pre:1,post:2},W=U[k.status]??3,Y=U[A.status]??3;return W!==Y?W-Y:(k.timestamp||0)-(A.timestamp||0)}),a.length===0){t.innerHTML="",n.style.display="",r?n.innerHTML=`<i class="fas fa-search" style="font-size: 3em; opacity: 0.3;"></i><p>No matches found for "${r}"</p>`:n.innerHTML=`<i class="fas fa-tv" style="font-size: 3em; opacity: 0.3;"></i><p>No matches available for ${e}</p>`,console.log("[LiveTV] No matches to display");return}n.style.display="none",t.innerHTML="";const u=a.filter(k=>k.status==="in").length,m=a.filter(k=>k.status==="pre").length,y=a.filter(k=>k.status==="post").length;console.log(`[LiveTV] Match breakdown: ${u} live, ${m} upcoming, ${y} finished`),console.log("[LiveTV] Rendering match grid...");const p=a.filter(k=>k.status==="in").length,N=a.filter(k=>k.status==="pre").length,I=document.getElementById("livetv-match-count");if(I&&(p>0||N>0)){let k="";p>0&&(k+=`<span style="display: inline-flex; align-items: center; gap: 0.4rem; color: #ef4444; font-weight: 600; letter-spacing: 0.5px;"><i class="fas fa-circle" style="font-size: 0.4rem; animation: blink 1s infinite;"></i>${p} LIVE</span>`),N>0&&(k&&(k+='<span style="color: rgba(255,255,255,0.3); font-weight: 300;">â€¢</span>'),k+=`<span style="display: inline-flex; align-items: center; gap: 0.4rem; color: #60a5fa; font-weight: 500;"><i class="far fa-clock" style="font-size: 0.75rem;"></i>${N} Upcoming</span>`),I.innerHTML=k,I.style.display="inline-flex"}else I&&(I.style.display="none");a.forEach(k=>{const A=document.createElement("div");A.className="livetv-match-card";const U=k.poster?`https://watchfooty.st${k.poster}`:"",W=U?`<img loading="lazy" src="${U}" alt="${k.title}" class="livetv-poster" onerror="this.parentElement.querySelector('.livetv-poster-placeholder').style.display='flex'; this.style.display='none';">
                           <div class="livetv-poster-placeholder" style="display:none;"><i class="fas fa-play-circle"></i></div>`:'<div class="livetv-poster-placeholder"><i class="fas fa-play-circle"></i></div>',ae=new Date(k.date).toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit"});let Ce="";k.status==="in"?Ce=`<span style="background: linear-gradient(135deg, #ef4444, #dc2626); color: #fff; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 700; animation: pulse 2s infinite; box-shadow: 0 0 10px rgba(239,68,68,0.5);"><i class="fas fa-circle" style="font-size: 0.5rem; margin-right: 0.25rem; animation: blink 1s infinite;"></i>${k.currentMinute||"LIVE"}</span>`:k.status==="pre"?Ce='<span style="background: rgba(59,130,246,0.2); color: #3b82f6; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 600; border: 1px solid rgba(59,130,246,0.3);">UPCOMING</span>':k.status==="post"&&(Ce='<span style="background: rgba(107,114,128,0.2); color: #9ca3af; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 600;">FINISHED</span>');const G=k.scores?.home!==void 0&&k.scores?.away!==void 0?`<span style="background: rgba(16,185,129,0.2); color: #10b981; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 700; border: 1px solid rgba(16,185,129,0.3);">${k.scores.home} - ${k.scores.away}</span>`:"";A.innerHTML=`
                        ${W}
                        <div class="livetv-match-info">
                            <h4 class="livetv-match-title">${k.title}</h4>
                            <div style="display: flex; gap: 0.5rem; align-items: center; margin-top: 0.5rem; flex-wrap: wrap;">
                                <span class="livetv-match-category">${k.league||k.sport}</span>
                                ${Ce}
                                ${G}
                            </div>
                            <div style="font-size: 0.85rem; color: rgba(255,255,255,0.6); margin-top: 0.25rem;">
                                <i class="fas fa-clock"></i> ${ae}
                            </div>
                            <button class="livetv-watch-btn">
                                <i class="fas fa-play"></i> Watch Now (${k.streams?.length||0} streams)
                            </button>
                        </div>
                    `,A.querySelector(".livetv-watch-btn").addEventListener("click",()=>fv(k)),t.appendChild(A)})}catch(i){console.error("Error loading matches:",i),t.innerHTML="",n.style.display="",n.innerHTML='<i class="fas fa-exclamation-triangle" style="font-size: 3em; opacity: 0.3; color: #ef4444;"></i><p>Failed to load matches. Please try again.</p>'}}async function fv(e){const t=document.getElementById("livetv-streams-modal"),n=document.getElementById("livetv-streams-title"),o=document.getElementById("livetv-streams-list");if(!(!t||!n||!o)){n.textContent=e.title,o.innerHTML='<div class="livetv-loading"><i class="fas fa-spinner"></i><p>Preparing streams...</p></div>',t.style.display="flex";try{const i=e.streams||[];if(i.length===0){o.innerHTML='<div class="livetv-empty"><p>No streams available for this match</p></div>';return}o.innerHTML="",i.forEach((r,a)=>{const u=document.createElement("div");u.className="livetv-stream-item";const m=r.language||"Unknown",y=r.quality||"SD",p=y.toLowerCase().includes("hd")||y==="1080p"||y==="720p"?'<span class="livetv-stream-badge hd">HD</span>':"",N=r.ads?'<span class="livetv-stream-badge ads" style="background: rgba(239,68,68,0.2); color: #ef4444;"><i class="fas fa-ad"></i> Ads</span>':"",I=r.nsfw?'<span class="livetv-stream-badge nsfw" style="background: rgba(168,85,247,0.2); color: #a855f7;">18+</span>':"";u.innerHTML=`
                        <div class="livetv-stream-info">
                            <div class="livetv-stream-source">
                                <i class="fas fa-broadcast-tower"></i> Stream ${a+1}
                            </div>
                            <div class="livetv-stream-details">
                                ${p}
                                <span class="livetv-stream-badge quality">
                                    <i class="fas fa-video"></i> ${y}
                                </span>
                                <span class="livetv-stream-badge language">
                                    <i class="fas fa-language"></i> ${m}
                                </span>
                                ${N}
                                ${I}
                            </div>
                        </div>
                        <div class="livetv-stream-actions">
                            <button class="livetv-play-stream-btn" data-stream-url="${r.url}">
                                <i class="fas fa-play"></i> Play Stream
                            </button>
                            <button class="livetv-copy-link-btn">
                                <i class="fas fa-copy"></i> Copy Link
                            </button>
                        </div>
                    `,u.querySelector(".livetv-play-stream-btn").addEventListener("click",U=>{U.stopPropagation();const W=r.url;console.log("[LiveTV] Playing stream:",W),t.style.display="none";const Y=document.getElementById("livetv-stream-viewer");Y&&Y.remove();const ae=document.createElement("div");ae.id="livetv-stream-viewer",ae.style.cssText="position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: #000; z-index: 99999; display: flex; flex-direction: column;",ae.innerHTML=`
                            <div style="position: absolute; top: 1rem; left: 1rem; z-index: 100000;">
                                <button id="livetv-back-btn" style="
                                    background: linear-gradient(135deg, #ef4444, #dc2626);
                                    color: #fff;
                                    border: none;
                                    padding: 0.75rem 1.5rem;
                                    border-radius: 8px;
                                    font-weight: 700;
                                    cursor: pointer;
                                    display: flex;
                                    align-items: center;
                                    gap: 0.5rem;
                                    box-shadow: 0 4px 12px rgba(0,0,0,0.5);
                                    transition: all 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94), transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
                                " onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 6px 16px rgba(239,68,68,0.6)';" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.5)';">
                                    <i class="fas fa-arrow-left"></i> Back
                                </button>
                            </div>
                            <iframe 
                                src="${W}" 
                                style="width: 100%; height: 100%; border: none;"
                                frameborder="0"
                                scrolling="no"
                                allowfullscreen="true"
                                webkitallowfullscreen="true"
                                mozallowfullscreen="true"
                                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                                referrerpolicy="origin"
                            ></iframe>
                        `,document.body.appendChild(ae),document.getElementById("livetv-back-btn").addEventListener("click",()=>{ae.remove(),console.log("[LiveTV] Stream viewer closed")});const G=ve=>{ve.key==="Escape"&&(ae.remove(),document.removeEventListener("keydown",G),console.log("[LiveTV] Stream viewer closed via ESC"))};document.addEventListener("keydown",G)});const A=u.querySelector(".livetv-copy-link-btn");A.addEventListener("click",async U=>{U.stopPropagation();try{await navigator.clipboard.writeText(r.url);const W=A.innerHTML;A.innerHTML='<i class="fas fa-check"></i> Copied!',A.style.background="linear-gradient(135deg, #10b981, #059669)",setTimeout(()=>{A.innerHTML=W,A.style.background=""},2e3)}catch(W){console.error("Failed to copy:",W)}}),o.appendChild(u)})}catch(i){console.error("Error loading streams:",i),o.innerHTML='<div class="livetv-empty"><p>Failed to load streams. Please try again.</p></div>'}}}function mv(){if(typeof videojs<"u")try{window.vjsPlayer=videojs("customVideo",{controls:!1,preload:"metadata",fluid:!1,fill:!0}),console.log("Video.js initialized")}catch(s){console.warn("Video.js initialization failed:",s)}Hl&&Hl.addEventListener("click",Ws),Vl&&Vl.addEventListener("click",async()=>{const s="https://discord.gg/bbkVHRHnRk";try{window.electronAPI?.openExternal?await window.electronAPI.openExternal(s):window.open(s,"_blank","noopener"),localStorage.setItem("pt_discord_dismissed_v1","true"),window.electronAPI?.setUserPref&&await so.set("discord_dismissed","true"),Ws(),showNotification("Opening Discord invite...","success")}catch(l){console.error("Failed to open Discord:",l),showNotification("Failed to open Discord link","error")}}),jl&&jl.addEventListener("click",async()=>{localStorage.setItem("pt_discord_dismissed_v1","true"),window.electronAPI?.setUserPref&&await so.set("discord_dismissed","true"),Ws(),showNotification("We'll stop showing this.","success")}),ql&&ql.addEventListener("click",async()=>{const s="https://discord.gg/bbkVHRHnRk";try{window.electronAPI?.openExternal?await window.electronAPI.openExternal(s):window.open(s,"_blank","noopener"),showNotification("Opening Discord...","success")}catch(l){console.error("Failed to open Discord:",l),showNotification("Failed to open Discord link","error")}});const e=document.getElementById("donateBtn");e&&e.addEventListener("click",async()=>{const s="https://ko-fi.com/ayman228x";try{window.electronAPI?.openExternal?await window.electronAPI.openExternal(s):window.open(s,"_blank","noopener"),showNotification("Opening Ko-fi...","success")}catch(l){console.error("Failed to open Ko-fi:",l),showNotification("Failed to open Ko-fi link","error")}});const t=document.getElementById("close-chromecast-modal");t&&t.addEventListener("click",()=>{const s=document.getElementById("chromecast-device-modal");s&&(s.style.display="none",s.classList.remove("active"),s.style.opacity="0",s.style.pointerEvents="none")}),qg.addEventListener("click",async()=>{const s=await window.electronAPI.clearCache();showNotification(s.message,s.success?"success":"error")}),window.electronAPI&&window.electronAPI.selectCacheFolder&&document.querySelectorAll("#selectCacheBtn").forEach(l=>l.addEventListener("click",async f=>{f.preventDefault();try{const v=await window.electronAPI.selectCacheFolder();if(v.success&&v.path){const w=(l.closest(".settings-card-body, .api-input-group, .form-group")||document).querySelector("#cacheLocation");if(w)w.value=v.path;else{const h=document.querySelectorAll("#cacheLocation");let T=!1;for(const x of h)if(x.offsetParent!==null){x.value=v.path,T=!0;break}!T&&h.length>0&&(h[0].value=v.path)}}}catch(v){console.error("Error selecting cache folder:",v),showNotification("Failed to select folder")}})),zg.addEventListener("click",ui),Kg.addEventListener("click",Ys),Yg.addEventListener("click",ui);const n=document.getElementById("saveSettingsPage"),o=document.getElementById("cancelSettingsPage");n&&n.addEventListener("click",Ys),o&&o.addEventListener("click",()=>{window.history.back()}),document.querySelectorAll("#themeSelector").forEach(s=>{s&&s.addEventListener("change",l=>{const f=l.target.value;Va(f),showNotification(`Theme changed to ${l.target.options[l.target.selectedIndex].text}`,"success")})}),document.querySelectorAll("#videoTutorialBtn").forEach(s=>{s.addEventListener("click",async()=>{window.electronAPI?.openExternal&&await window.electronAPI.openExternal("https://www.youtube.com/watch?v=3igLReZFFzg")})});const a=document.querySelectorAll("#useTorrentlessToggle");a.forEach(s=>{s.addEventListener("change",async l=>{const f=!!l.target.checked;try{(await fetch(`${se}/settings`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({useTorrentless:f})})).ok?(po=f,a.forEach(E=>E.checked=f),showNotification(f?"Watch without Jackett enabled.":"Watch without Jackett disabled.")):(l.target.checked=!f,showNotification("Failed to update setting."))}catch{l.target.checked=!f,showNotification("Failed to update setting.")}})});const u=document.querySelectorAll("#torrentioBtn"),m=document.querySelectorAll("#inAppScraperBtn");if(u.length>0&&m.length>0){const s=async l=>{console.log("================================="),console.log("[Settings] Button clicked! Changing source to:",l);try{const f=await fetch(`${se}/settings`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({torrentSource:l})}),v=await f.json();console.log("[Settings] Server response:",v),f.ok?(l==="torrentio"?(u.forEach(E=>E.classList.add("active")),m.forEach(E=>E.classList.remove("active")),console.log("[Settings] UI updated: Torrentio active")):(u.forEach(E=>E.classList.remove("active")),m.forEach(E=>E.classList.add("active")),console.log("[Settings] UI updated: In-App Scraper active")),console.log("[Settings] SUCCESS! Setting saved:",l),console.log("================================="),showNotification(`Torrent source changed to ${l==="torrentio"?"Torrentio":"In-App Scraper"}`)):(console.error("[Settings] FAILED to save setting"),console.log("================================="),showNotification("Failed to update torrent source."))}catch(f){console.error("[Settings] ERROR:",f),console.log("================================="),showNotification("Failed to update torrent source.")}};u.forEach(l=>{l.addEventListener("click",()=>s("torrentio"))}),m.forEach(l=>{l.addEventListener("click",()=>s("in-app-scraper"))})}if(Jg||Xg){const s=async()=>{const E=document.querySelectorAll("#useDebridToggle");let w=!1;for(const V of E)if(V.offsetParent!==null){w=!!V.checked;break}const h=document.querySelectorAll("#debridProvider");let T="realdebrid";for(const V of h)if(V.offsetParent!==null){T=V.value;break}const x=document.querySelectorAll("#rdClientId");let O="";for(const V of x)if(V.offsetParent!==null){O=(V.value||"").trim();break}const q=O;try{const V=await fetch(`${se}/settings`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({useDebrid:w,debridProvider:T,rdClientId:q})});if(!V.ok)throw new Error("save failed");await V.json(),fn=w,un=T;const Q=T==="realdebrid",ee=T==="alldebrid",ue=T==="torbox",xe=T==="premiumize";document.querySelectorAll("#rdClientIdGroup").forEach(pe=>pe.style.display=Q?"":"none"),document.querySelectorAll("#rdButtons").forEach(pe=>pe.style.display=Q?"":"none"),document.querySelectorAll("#rdTokenGroup").forEach(pe=>pe.style.display=Q?"":"none"),document.querySelectorAll("#rdTokenButtons").forEach(pe=>pe.style.display=Q?"":"none"),document.querySelectorAll("#rdCodePanel").forEach(pe=>pe.style.display="none"),document.querySelectorAll("#adSection").forEach(pe=>pe.style.display=ee?"":"none"),document.querySelectorAll("#tbSection").forEach(pe=>pe.style.display=ue?"":"none"),document.querySelectorAll("#pmSection").forEach(pe=>pe.style.display=xe?"":"none"),showNotification("Debrid settings saved.")}catch{showNotification("Failed to save debrid settings")}};document.querySelectorAll("#useDebridToggle").forEach(E=>{E.addEventListener("change",s)}),document.querySelectorAll("#debridProvider").forEach(E=>{E.addEventListener("change",s)}),document.querySelectorAll("#rdClientId").forEach(E=>{E.addEventListener("change",s)})}document.querySelectorAll("#saveDebridToken").forEach(l=>l.addEventListener("click",async()=>{const f=document.querySelectorAll("#debridToken");let v="";for(const E of f)if(E.offsetParent!==null){v=(E.value||"").trim();break}if(!v){showNotification("Enter a token first");return}try{(await fetch(`${se}/debrid/token`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({token:v})})).ok?(document.querySelectorAll("#debridStatus").forEach(w=>{w.textContent="Logged in"}),f.forEach(w=>{w.value=""}),showNotification("Debrid token saved.")):showNotification("Failed to save token")}catch{showNotification("Failed to save token")}})),document.querySelectorAll("#clearDebridToken").forEach(l=>l.addEventListener("click",async()=>{try{(await fetch(`${se}/debrid/token`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({token:""})})).ok?(document.querySelectorAll("#debridStatus").forEach(v=>{v.textContent="Not logged in"}),showNotification("Logged out of Debrid.")):showNotification("Failed to logout")}catch{showNotification("Failed to logout")}}));let y=null;function p(){y&&(clearInterval(y),y=null)}async function N(){try{const s=(Qg?.value||"").trim(),l=`${se}/debrid/rd/device-code${s?`?client_id=${encodeURIComponent(s)}`:""}`,f=await fetch(l);if(!f.ok){let h="RD device-code start failed";try{const T=await f.json();T?.error&&(h=T.error)}catch{try{h=await f.text()}catch{}}Gi.textContent="Error starting login",showNotification(h);return}const v=await f.json();As.style.display="block",Wl.textContent=v.user_code||"----",Ps.textContent=v.verification_url||"https://real-debrid.com/device",Ps.href=v.verification_url||"https://real-debrid.com/device",Gi.textContent="Waiting for approvalâ€¦";const E=Math.max(3,Number(v.interval||5))*1e3,w=v.device_code;p(),y=setInterval(async()=>{try{const h=await fetch(`${se}/debrid/rd/poll`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({device_code:w,client_id:s||void 0})});if(h.ok)p(),Gi.textContent="Logged in!",document.querySelectorAll("#debridStatus").forEach(T=>{T.textContent="Logged in"}),Vt=!0,showNotification("Realâ€‘Debrid connected"),setTimeout(()=>{As.style.display="none"},800);else{const T=await h.text();/expired|invalid/i.test(T)&&(p(),Gi.textContent="Code expired. Try again.")}}catch{}},E)}catch{showNotification("Failed to start device login")}}zl&&zl.addEventListener("click",N),Kl&&Kl.addEventListener("click",async()=>{const s=Ps?.href||"https://real-debrid.com/device";window.electronAPI?.openExternal?await window.electronAPI.openExternal(s):window.open(s,"_blank")}),Yl&&Yl.addEventListener("click",async()=>{try{await navigator.clipboard.writeText(Wl?.textContent||""),showNotification("Code copied")}catch{}}),Jl&&Jl.addEventListener("click",async()=>{p(),As.style.display="none"});let I=null,k="",A="";function U(){I&&(clearInterval(I),I=null)}async function W(){try{await Ar()}catch{}if(fn&&un==="alldebrid"&&Vt){showNotification("Already logged in to AllDebrid");return}try{const s=await fetch(`${se}/debrid/ad/pin`),l=await s.json();s.ok&&l.pin&&l.check?(k=l.pin,A=l.check,Bo&&(Bo.style.display="block"),xs&&(xs.textContent=k),$s&&($s.href=l.user_url||"https://alldebrid.com/pin/"),Ao&&(Ao.textContent="Waitingâ€¦"),U(),I=setInterval(async()=>{try{const f=await fetch(`${se}/debrid/ad/check`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({pin:k,check:A})}),v=await f.json();f.ok&&v.success?(U(),document.querySelectorAll("#debridStatus").forEach(E=>{E.textContent="Logged in"}),Vt=!0,Ao&&(Ao.textContent="Logged in!"),showNotification("AllDebrid connected"),setTimeout(()=>{Bo&&(Bo.style.display="none")},800)):f.ok||(U(),Ao&&(Ao.textContent=v?.error||"PIN expired"))}catch{}},5e3)):showNotification(l?.error||"Failed to start AllDebrid PIN")}catch{showNotification("Failed to start AllDebrid PIN")}}Sr&&Sr.addEventListener("click",W),Ql&&Ql.addEventListener("click",async()=>{const s=$s?.href||"https://alldebrid.com/pin/";window.electronAPI?.openExternal?await window.electronAPI.openExternal(s):window.open(s,"_blank")}),Zl&&Zl.addEventListener("click",async()=>{try{await navigator.clipboard.writeText(xs?.textContent||""),showNotification("PIN copied")}catch{}}),Gl&&Gl.addEventListener("click",()=>{U(),Bo&&(Bo.style.display="none")});function Y(s,l){return s?s.querySelector(l):null}async function ae(s){const l=s.closest("#rdButtons")?.parentElement||s.parentElement,f=Y(l,'[id="rdClientId"]'),v=Y(l,'[id="rdCodePanel"]'),E=Y(l,'[id="rdUserCode"]'),w=Y(l,'[id="rdVerifyUrl"]'),h=Y(l,'[id="rdLoginStatus"]'),T=Y(l,'[id="rdOpenVerify"]'),x=Y(l,'[id="rdCopyCode"]'),O=Y(l,'[id="rdCancelLogin"]'),q=(f?.value||"").trim(),V=`${se}/debrid/rd/device-code${q?`?client_id=${encodeURIComponent(q)}`:""}`;try{const Q=await fetch(V);if(!Q.ok){let pe="RD device-code start failed";try{const Ke=await Q.json();Ke?.error&&(pe=Ke.error)}catch{try{pe=await Q.text()}catch{}}h&&(h.textContent="Error starting login"),showNotification(pe);return}const ee=await Q.json();v&&(v.style.display="block"),E&&(E.textContent=ee.user_code||"----"),w&&(w.textContent=ee.verification_url||"https://real-debrid.com/device",w.href=ee.verification_url||"https://real-debrid.com/device"),h&&(h.textContent="Waiting for approvalâ€¦");const ue=Math.max(3,Number(ee.interval||5))*1e3,xe=ee.device_code;p(),y=setInterval(async()=>{try{const pe=await fetch(`${se}/debrid/rd/poll`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({device_code:xe,client_id:q||void 0})});if(pe.ok){p(),h&&(h.textContent="Logged in!"),document.querySelectorAll("#debridStatus").forEach(Ke=>{Ke.textContent="Logged in"}),Vt=!0,document.querySelectorAll("#useDebridToggle").forEach(Ke=>{try{Ke.checked=!0}catch{}}),document.querySelectorAll("#debridProvider").forEach(Ke=>{try{Ke.value="realdebrid"}catch{}});try{await fetch(`${se}/settings`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({useDebrid:!0,debridProvider:"realdebrid"})})}catch{}showNotification("Realâ€‘Debrid connected"),setTimeout(()=>{v&&(v.style.display="none")},800)}else{const Ke=await pe.text();/expired|invalid/i.test(Ke)&&(p(),h&&(h.textContent="Code expired. Try again."))}}catch{}},ue),l&&!l.dataset.rdBound&&(l.dataset.rdBound="1",T&&T.addEventListener("click",async()=>{const pe=w?.href||"https://real-debrid.com/device";window.electronAPI?.openExternal?await window.electronAPI.openExternal(pe):window.open(pe,"_blank")}),x&&x.addEventListener("click",async()=>{try{await navigator.clipboard.writeText(E?.textContent||""),showNotification("Code copied")}catch{}}),O&&O.addEventListener("click",()=>{p(),v&&(v.style.display="none")}))}catch{showNotification("Failed to start device login")}}async function Ce(s){const l=s.closest("#adSection")||s.parentElement,f=Y(l,'[id="adPinPanel"]'),v=Y(l,'[id="adPinCode"]'),E=Y(l,'[id="adUserUrl"]'),w=Y(l,'[id="adLoginStatus"]'),h=Y(l,'[id="adOpenUserUrl"]'),T=Y(l,'[id="adCopyPin"]'),x=Y(l,'[id="adCancelPin"]');try{await Ar()}catch{}if(fn&&un==="alldebrid"&&Vt){showNotification("Already logged in to AllDebrid");return}try{const O=await fetch(`${se}/debrid/ad/pin`),q=await O.json();O.ok&&q.pin&&q.check?(k=q.pin,A=q.check,f&&(f.style.display="block"),v&&(v.textContent=k),E&&(E.href=q.user_url||"https://alldebrid.com/pin/"),w&&(w.textContent="Waitingâ€¦"),U(),I=setInterval(async()=>{try{const V=await fetch(`${se}/debrid/ad/check`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({pin:k,check:A})}),Q=await V.json();if(V.ok&&Q.success){U(),document.querySelectorAll("#debridStatus").forEach(ee=>{ee.textContent="Logged in"}),Vt=!0,w&&(w.textContent="Logged in!"),document.querySelectorAll("#useDebridToggle").forEach(ee=>{try{ee.checked=!0}catch{}}),document.querySelectorAll("#debridProvider").forEach(ee=>{try{ee.value="alldebrid"}catch{}});try{await fetch(`${se}/settings`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({useDebrid:!0,debridProvider:"alldebrid"})})}catch{}showNotification("AllDebrid connected"),setTimeout(()=>{f&&(f.style.display="none")},800)}else V.ok||(U(),w&&(w.textContent=Q?.error||"PIN expired"))}catch{}},5e3),l&&!l.dataset.adBound&&(l.dataset.adBound="1",h&&h.addEventListener("click",async()=>{const V=E?.href||"https://alldebrid.com/pin/";window.electronAPI?.openExternal?await window.electronAPI.openExternal(V):window.open(V,"_blank")}),T&&T.addEventListener("click",async()=>{try{await navigator.clipboard.writeText(v?.textContent||""),showNotification("PIN copied")}catch{}}),x&&x.addEventListener("click",()=>{U(),f&&(f.style.display="none")}))):showNotification(q?.error||"Failed to start AllDebrid PIN")}catch{showNotification("Failed to start AllDebrid PIN")}}document.querySelectorAll("#rdDeviceLogin").forEach(s=>{s.dataset.boundRd||(s.dataset.boundRd="1",s.addEventListener("click",()=>ae(s)))}),document.querySelectorAll("#adStartPin").forEach(s=>{s.dataset.boundAd||(s.dataset.boundAd="1",s.addEventListener("click",()=>Ce(s)))}),document.querySelectorAll("#adSaveApiKey").forEach(s=>s.addEventListener("click",async()=>{const l=document.querySelectorAll("#adApiKey");let f="";for(const v of l)if(v.offsetParent!==null){f=(v.value||"").trim();break}if(!f){showNotification("Enter an AllDebrid API key");return}try{const v=await fetch(`${se}/debrid/ad/apikey`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({apikey:f})});if(v.ok)document.querySelectorAll("#debridStatus").forEach(E=>{E.textContent="Logged in"}),showNotification("AllDebrid API key saved"),l.forEach(E=>{E.value=""});else{const E=await v.text();showNotification(E||"Failed to save")}}catch{showNotification("Failed to save")}})),document.querySelectorAll("#adClearApiKey").forEach(s=>s.addEventListener("click",async()=>{try{(await fetch(`${se}/debrid/ad/apikey`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({apikey:""})})).ok&&(document.querySelectorAll("#debridStatus").forEach(f=>{f.textContent="Not logged in"}),showNotification("Logged out of AllDebrid"))}catch{}})),document.querySelectorAll("#tbSaveToken").forEach(s=>s.addEventListener("click",async()=>{const l=document.querySelectorAll("#tbToken");let f="";for(const v of l)if(v.offsetParent!==null){f=(v.value||"").trim();break}if(!f){showNotification("Enter a TorBox token");return}try{const v=await fetch(`${se}/debrid/tb/token`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({token:f})});if(v.ok)document.querySelectorAll("#debridStatus").forEach(E=>{E.textContent="Logged in"}),l.forEach(E=>{E.value=""}),showNotification("TorBox token saved");else{const E=await v.text();showNotification(E||"Failed to save")}}catch{showNotification("Failed to save")}})),document.querySelectorAll("#tbClearToken").forEach(s=>s.addEventListener("click",async()=>{try{(await fetch(`${se}/debrid/tb/token`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({token:""})})).ok&&(document.querySelectorAll("#debridStatus").forEach(f=>{f.textContent="Not logged in"}),showNotification("Logged out of TorBox"))}catch{}})),document.querySelectorAll("#pmSaveApiKey").forEach(s=>s.addEventListener("click",async()=>{const l=document.querySelectorAll("#pmApiKey");let f="";for(const v of l)if(v.offsetParent!==null){f=(v.value||"").trim();break}if(!f){showNotification("Enter a Premiumize API key");return}try{const v=await fetch(`${se}/debrid/pm/apikey`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({apikey:f})});if(v.ok)document.querySelectorAll("#debridStatus").forEach(E=>{E.textContent="Logged in"}),l.forEach(E=>{E.value=""}),showNotification("Premiumize API key saved");else{const E=await v.text();showNotification(E||"Failed to save")}}catch{showNotification("Failed to save")}})),document.querySelectorAll("#pmClearApiKey").forEach(s=>s.addEventListener("click",async()=>{try{(await fetch(`${se}/debrid/pm/apikey`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({apikey:""})})).ok&&(document.querySelectorAll("#debridStatus").forEach(f=>{f.textContent="Not logged in"}),showNotification("Logged out of Premiumize"))}catch{}}));const G=document.querySelectorAll("#febboxTokenInput"),ve=localStorage.getItem("febboxToken");ve&&G.forEach(s=>{try{s.value=ve}catch{}}),document.querySelectorAll("#saveFebboxToken").forEach(s=>s.addEventListener("click",()=>{let f=(s.closest(".settings-card-body, .api-input-group, .form-group")||document).querySelector("#febboxTokenInput");if(!f){for(const E of G)if(E.offsetParent!==null){f=E;break}}const v=(f?.value||"").trim();v?(localStorage.setItem("febboxToken",v),G.forEach(E=>{try{E.value=v}catch{}}),showNotification("Febbox token saved successfully","success")):(localStorage.removeItem("febboxToken"),G.forEach(E=>{try{E.value=""}catch{}}),showNotification("Febbox token cleared, using default","success"))}));const oe=document.querySelectorAll("#traktLogin"),X=document.querySelectorAll("#traktDisconnect"),ye=document.querySelectorAll("#traktCopyCode"),Z=document.querySelectorAll("#traktOpenVerify"),Fe=document.querySelectorAll("#traktCancelLogin");oe.forEach(s=>s.addEventListener("click",uh)),X.forEach(s=>s.addEventListener("click",ph)),ye.forEach(s=>s.addEventListener("click",yh)),Z.forEach(s=>s.addEventListener("click",gh)),Fe.forEach(s=>s.addEventListener("click",mh)),document.querySelectorAll("#traktViewWatchlist").forEach(s=>{s.addEventListener("click",async()=>{try{const f=await(await fetch("/api/trakt/watchlist?type=mixed")).json();f.success&&f.watchlist?(showNotification(`Found ${f.watchlist.length} items in your watchlist`,"info"),console.log("[TRAKT] Watchlist:",f.watchlist)):showNotification("Failed to load watchlist","error")}catch(l){console.error("[TRAKT] Watchlist error:",l),showNotification("Failed to load watchlist","error")}})}),document.querySelectorAll("#traktViewHistory").forEach(s=>{s.addEventListener("click",async()=>{try{const f=await(await fetch("/api/trakt/history?type=mixed&limit=20")).json();f.success&&f.history?(showNotification(`Loaded ${f.history.length} recent items from your history`,"info"),console.log("[TRAKT] History:",f.history)):showNotification("Failed to load history","error")}catch(l){console.error("[TRAKT] History error:",l),showNotification("Failed to load history","error")}})}),document.querySelectorAll("#traktViewStats").forEach(s=>{s.addEventListener("click",async()=>{try{const f=await(await fetch("/api/trakt/stats")).json();if(f.success&&f.stats){const v=f.stats,E=`Movies: ${v.movies?.watched||0} watched, Shows: ${v.shows?.watched||0} watched, Episodes: ${v.episodes?.watched||0} watched`;showNotification(E,"info",5e3),console.log("[TRAKT] Stats:",v)}else showNotification("Failed to load stats","error")}catch(l){console.error("[TRAKT] Stats error:",l),showNotification("Failed to load stats","error")}})});const rt=document.getElementById("jackettTutorialBtn");rt&&rt.addEventListener("click",async()=>{const s="https://www.youtube.com/watch?v=3igLReZFFzg&t";if(window.electronAPI?.openExternal){if(!(await window.electronAPI.openExternal(s))?.success){showNotification("Failed to open browser. Copying link to clipboard.");try{await navigator.clipboard.writeText(s)}catch{}}}else{showNotification("Copying link to clipboard. Open it in your browser.");try{await navigator.clipboard.writeText(s)}catch{}}}),document.addEventListener("keydown",s=>{s.key==="Escape"&&(ra.classList.contains("active")?(s.preventDefault(),s.stopPropagation(),closePlayer(!1)):or.classList.contains("active")&&(s.preventDefault(),s.stopPropagation(),ui()))}),Wg.addEventListener("keypress",s=>{s.key==="Enter"&&Ys()});const ft=document.getElementById("searchInput");ft.addEventListener("keypress",async s=>{if(s.key==="Enter"&&ft.value.trim()!==""){s.preventDefault();const l=ft.value.trim();Je!=="home"&&(window.location.hash="#/"),await vv(l)}});const gt=document.getElementById("backToHomeBtn");gt&&gt.querySelector("button").addEventListener("click",()=>{if(ft.value="",ca=!1,di=[],nf="",gt.style.display="none",document.body.classList.contains("ui-new")){const s=document.getElementById("slidersContainer"),l=document.getElementById("heroSection");s&&(s.style.display="block"),l&&(l.style.display="block"),wt.style.display="none",wt.innerHTML=""}}),$g.addEventListener("click",()=>{window.location.hash="#/genres"});const $e=document.getElementById("custom-magnet-modal"),kt=document.getElementById("close-custom-magnet-modal"),ge=document.getElementById("cancel-custom-magnet-btn"),Te=document.getElementById("play-custom-magnet-btn"),_e=document.getElementById("custom-magnet-input");kt&&$e&&kt.addEventListener("click",()=>{$e.style.display="none",$e.classList.remove("active"),$e.style.opacity="0",$e.style.pointerEvents="none"}),ge&&$e&&ge.addEventListener("click",()=>{$e.style.display="none",$e.classList.remove("active"),$e.style.opacity="0",$e.style.pointerEvents="none"}),Te&&$e&&_e&&Te.addEventListener("click",async()=>{const s=_e.value.trim();if(!s){showNotification("Please enter a magnet link","warning");return}if(!s.startsWith("magnet:")){showNotification("Invalid magnet link format","error");return}$e.style.display="none";try{await startStream(s)}catch(l){console.error("Error playing custom magnet:",l),showNotification("Failed to play magnet link","error")}}),$e&&$e.addEventListener("click",s=>{s.target===$e&&($e.style.display="none",$e.classList.remove("active"),$e.style.opacity="0",$e.style.pointerEvents="none")});const qe=document.getElementById("myListBtn");qe&&qe.addEventListener("click",()=>{window.location.hash="#/my-list"});const Ie=document.getElementById("doneWatchingBtn");Ie&&Ie.addEventListener("click",()=>{window.location.hash="#/done-watching"}),window.addEventListener("hashchange",ha);let we=!1;function st(s){we||(we=!0,requestAnimationFrame(()=>{try{Tv(s)}finally{we=!1}}))}if(document.body.classList.contains("ui-new")){const s=document.querySelector(".app-main main");s&&s.addEventListener("scroll",st,{passive:!0})}else window.addEventListener("scroll",st,{passive:!0});Ng.addEventListener("click",du),nd&&typeof closePlayer=="function"&&nd.addEventListener("click",closePlayer),sd&&typeof closeCustomPlayer_=="function"&&sd.addEventListener("click",closeCustomPlayer_),Vg.addEventListener("click",s=>{console.log("[DEBUG] Watch button clicked!");try{const l=localStorage.getItem("useStreamingServers")==="true";if(console.log("[DEBUG] Streaming mode:",l,"mediaType:",Le),l){console.log("[DEBUG] Streaming mode enabled, showing server selection");const f={id:ne?.id,type:Le||"movie",title:ne?.title||ne?.name||"Untitled",subtitle:Le==="tv"&&je&&Bt?`Season ${je} Episode ${Bt}`:"",year:(ne?.release_date||ne?.first_air_date||"").substring(0,4),rating:Number(ne?.vote_average||0).toFixed(1),poster:ne?.poster_path?`https://image.tmdb.org/t/p/w342${ne.poster_path}`:""};console.log("[DEBUG] Calling showServerSelection with:",f),us(f)}else console.log("[DEBUG] Streaming mode disabled, showing torrents"),wi(s),setTimeout(()=>{const f=document.querySelector(".provider-buttons");f&&f.scrollIntoView({behavior:"smooth",block:"start"})},200)}catch(l){console.error("[DEBUG] Error in Watch Now handler:",l)}});const ht=document.getElementById("useStreamsBtn");ht&&ht.addEventListener("click",()=>{const l=!(localStorage.getItem("useStreamingServers")==="true");localStorage.setItem("useStreamingServers",l?"true":"false"),document.querySelectorAll("#useStreamingServersToggle").forEach(v=>v.checked=l),Vi(),showNotification(`Streaming mode ${l?"enabled":"disabled"}`,l?"success":"info")}),jg.addEventListener("click",()=>{Or(Ht,Bt)});const Wt=document.getElementById("torrentSortSelect");function Sn(){const s=Wt?Wt.value:"seeders";console.log("[SORT] Changing from",Gt,"to",s),Gt=s;try{typeof Mt=="number"&&(Mt=1)}catch{}if(Pe==="nuvio"&&$o.length>0){console.log("[SORT] Re-rendering Nuvio streams with mode:",Gt);try{Ea($o)}catch{}}else if(Pe==="moviebox"){console.log("[SORT] Skipping re-render for provider:",Pe,"(sorting not supported)");return}else if(Pe==="111477"&&window._last111477Files){console.log("[SORT] Re-rendering 111477 files with mode:",Gt);try{ba(window._last111477Files)}catch{}}else{console.log("[SORT] Re-rendering torrents page with mode:",Gt);try{renderTorrentsPage()}catch{}}}Wt&&(Wt.addEventListener("change",Sn),Wt.addEventListener("input",Sn));const Ut=document.getElementById("torrentSizeFilterSelect");function St(){qt=Ut&&Ut.value?Ut.value:"all",console.log("[FILTER] Size filter changed to:",qt);try{typeof Mt=="number"&&(Mt=1)}catch{}if(Pe==="nuvio"&&$o.length>0){console.log("[FILTER] Re-rendering Nuvio streams with filter:",qt);try{Ea($o)}catch{}}else if(Pe==="moviebox"){console.log("[FILTER] Skipping re-render for provider:",Pe,"(filtering not supported)");return}else if(Pe==="111477"&&window._last111477Files){console.log("[FILTER] Re-rendering 111477 files with filter:",qt);try{ba(window._last111477Files)}catch{}}else{console.log("[FILTER] Re-rendering torrents page with filter:",qt);try{renderTorrentsPage()}catch{}}}Ut&&(Ut.addEventListener("change",St),Ut.addEventListener("input",St)),document.querySelectorAll(".provider-btn").forEach(s=>{s.addEventListener("click",()=>{document.querySelectorAll(".provider-btn").forEach(l=>l.classList.remove("active")),s.classList.add("active"),Pe=s.dataset.provider,console.log("[Provider] Switched to:",Pe);try{const l=document.getElementById("torrentsList");if(l){const f=Pe==="moviebox"?"MovieBox":Pe==="nuvio"?"Nuvio":Pe==="comet"?"Comet":Pe==="111477"?"111477":"torrents";l.innerHTML=`<div class="loading"><i class="fas fa-spinner"></i> Searching ${f}...</div>`}}catch{}Pe==="moviebox"?hf(Ht,Bt):Or(Ht,Bt)})}),xo&&xo.addEventListener("input",()=>{Mt=1,renderTorrentsPage()});const ot=document.getElementById("resumeModal"),mt=document.getElementById("resumeClose"),At=document.getElementById("resumeTime"),Re=document.getElementById("resumeContinue"),Ue=document.getElementById("resumeStartOver");function pt(s){try{return formatDuration(Math.floor(Number(s||0)))}catch{return"00:00"}}function He(){ot?.classList.remove("active")}function vt(){ot?.classList.add("active")}if(ot){ot.addEventListener("click",l=>{l.target===ot&&He()});const s=ot.querySelector(".modal-content");s&&s.addEventListener("click",l=>l.stopPropagation())}function zn(s){if(!s||typeof s!="string")return null;const l=s.replace(/[_\.-]/g," ").toLowerCase();let f=/\b[s](\d{1,2})\s*[\.\-\s_]*[e](\d{1,3})\b/i.exec(s);return f?{season:parseInt(f[1],10),episode:parseInt(f[2],10)}:(f=/\b[s](\d{1,2})\s*[\.\-\s_]*(?:ep|episode)\s*(\d{1,3})\b/i.exec(s),f?{season:parseInt(f[1],10),episode:parseInt(f[2],10)}:(f=/[\[(]\s*s?(\d{1,2})\s*[\.\-\s_]*e?(\d{1,3})\s*[\])]?/i.exec(s),f&&f[1]&&f[2]?{season:parseInt(f[1],10),episode:parseInt(f[2],10)}:(f=/(?:^|\D)(\d{1,2})\s*[x]\s*(\d{1,3})(?!\d)/i.exec(s),f?{season:parseInt(f[1],10),episode:parseInt(f[2],10)}:(f=/[\[(]\s*(\d{1,2})\s*[-_]\s*(\d{1,3})\s*[\])]/i.exec(s),f?{season:parseInt(f[1],10),episode:parseInt(f[2],10)}:(f=/(season|series)\s*(\d{1,2})\s*(?:episode|ep)\s*(\d{1,3})/i.exec(l),f?{season:parseInt(f[2],10),episode:parseInt(f[3],10)}:(f=/(?:episode|ep)\s*(\d{1,3})\s*(season|series)\s*(\d{1,2})/i.exec(l),f?{season:parseInt(f[3],10),episode:parseInt(f[1],10)}:(f=/\b[s](\d{1,2})\s+(\d{1,3})\b/i.exec(l),f?{season:parseInt(f[1],10),episode:parseInt(f[2],10)}:(f=/\b(?:episode|ep)\s*(\d{1,3})\b/i.exec(l),f?{season:void 0,episode:parseInt(f[1],10)}:null))))))))}async function Wn(){if(!mn){showNotification("No file selected to play");return}try{const l=ne?.id?.toString()||"";let f=null,v=null;if(Le==="tv"&&Pe==="nuvio")Ht&&Bt&&(f=String(Ht),v=String(Bt));else if(Le==="tv"&&jt){const w=zn(jt);w&&(typeof w.season=="number"&&typeof w.episode=="number"?(f=String(w.season),v=String(w.episode)):typeof w.episode=="number"&&je&&(f=String(je),v=String(w.episode)))}if((await window.electronAPI.spawnMpvjsPlayer({url:mn,tmdbId:l,seasonNum:f,episodeNum:v})).success){showNotification("Player launched");return}console.log("[Play Now] mpv.js not available, using HTML5 player")}catch(l){console.log("[Play Now] Using HTML5 player:",l.message)}let s=De;if((!s||typeof s.position!="number")&&Ze)try{s=await fetchResume(Ze)}catch{}if(s&&typeof s.position=="number"&&s.position>0){De=s,At.textContent=pt(s.position),vt();const l=async()=>{try{if(Ze&&De&&typeof De.position=="number"){const h=jt||ne?.title||ne?.name||"";await fetch(`${se}/resume`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({key:Ze,position:Math.floor(De.position||0),duration:Math.floor(De.duration||0),title:h})})}}catch{}He(),openCustomPlayer(),v()},f=async()=>{try{Ze&&await fetch(`${se}/resume?key=${encodeURIComponent(Ze)}`,{method:"DELETE"})}catch{}De=null,He(),openCustomPlayer();try{const h=()=>{try{saveResumeThrottled(!0)}catch{}Ve.removeEventListener("timeupdate",h)};Ve.addEventListener("timeupdate",h)}catch{}v()},v=()=>{Re.removeEventListener("click",l),Ue.removeEventListener("click",f),mt.removeEventListener("click",E),document.removeEventListener("keydown",w)},E=()=>{He(),v()},w=h=>{h.key==="Escape"&&(He(),v())};Re.addEventListener("click",l),Ue.addEventListener("click",f),mt.addEventListener("click",E),document.addEventListener("keydown",w);return}openCustomPlayer()}async function Tn(){let s=De;if((!s||typeof s.position!="number")&&Ze)try{s=await fetchResume(Ze)}catch{}if(s&&typeof s.position=="number"&&s.position>0){De=s,At.textContent=pt(s.position),vt();const l=async()=>{try{if(Ze&&De&&typeof De.position=="number"){const h=jt||ne?.title||ne?.name||"";await fetch(`${se}/resume`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({key:Ze,position:Math.floor(De.position||0),duration:Math.floor(De.duration||0),title:h})})}}catch{}He(),await openInMPV(),v()},f=async()=>{try{Ze&&await fetch(`${se}/resume?key=${encodeURIComponent(Ze)}`,{method:"DELETE"})}catch{}De=null,He(),await openInMPV(),v()},v=()=>{Re.removeEventListener("click",l),Ue.removeEventListener("click",f),mt.removeEventListener("click",E),document.removeEventListener("keydown",w)},E=()=>{He(),v()},w=h=>{h.key==="Escape"&&(He(),v())};Re.addEventListener("click",l),Ue.addEventListener("click",f),mt.addEventListener("click",E),document.addEventListener("keydown",w);return}await openInMPV()}ir.addEventListener("click",Tn);async function ho(){let s=De;if((!s||typeof s.position!="number")&&Ze)try{s=await fetchResume(Ze)}catch{}if(s&&typeof s.position=="number"&&s.position>0){De=s,At.textContent=pt(s.position),vt();const l=async()=>{try{if(Ze&&De&&typeof De.position=="number"){const h=jt||ne?.title||ne?.name||"";await fetch(`${se}/resume`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({key:Ze,position:Math.floor(De.position||0),duration:Math.floor(De.duration||0),title:h})})}}catch{}He(),await openInVLC(),v()},f=async()=>{try{Ze&&await fetch(`${se}/resume?key=${encodeURIComponent(Ze)}`,{method:"DELETE"})}catch{}De=null,He(),await openInVLC(),v()},v=()=>{Re.removeEventListener("click",l),Ue.removeEventListener("click",f),mt.removeEventListener("click",E),document.removeEventListener("keydown",w)},E=()=>{He(),v()},w=h=>{h.key==="Escape"&&(He(),v())};Re.addEventListener("click",l),Ue.addEventListener("click",f),mt.addEventListener("click",E),document.addEventListener("keydown",w);return}await openInVLC()}let rn=!1;(async()=>{try{if(!window.electronAPI?.invoke)return;if(rn=(await window.electronAPI.invoke("get-platform"))?.isMac||!1,rn){const l=()=>{document.querySelectorAll('#openVLCBtn, .vlc-nuvio-btn, [class*="vlc"][class*="btn"]').forEach(v=>{v&&v.textContent&&v.textContent.includes("VLC")&&(v.style.display="none")})};l(),setInterval(l,2e3),console.log("[Platform] VLC buttons hidden on macOS")}}catch(s){console.error("[Platform] Failed to get platform info:",s)}})(),od&&od.addEventListener("click",ho),id&&typeof copyStreamUrl=="function"&&id.addEventListener("click",copyStreamUrl),rd&&typeof Wn=="function"&&rd.addEventListener("click",Wn);const yt=document.getElementById("castToChromecastBtn");yt&&yt.addEventListener("click",castMPVToChromecast),Po&&typeof togglePlayPause=="function"&&Po.addEventListener("click",togglePlayPause),cd&&typeof skipTime=="function"&&cd.addEventListener("click",()=>skipTime(-10)),ld&&typeof skipTime=="function"&&ld.addEventListener("click",()=>skipTime(10)),dd&&typeof toggleFullscreen=="function"&&dd.addEventListener("click",toggleFullscreen);const Ln=document.getElementById("castBtn");Ln&&typeof castToChromecast=="function"&&Ln.addEventListener("click",castToChromecast),ad&&typeof seekVideo=="function"&&ad.addEventListener("click",seekVideo),er&&typeof handleSubtitleUpload=="function"&&er.addEventListener("change",handleSubtitleUpload),Os&&Ve&&Os.addEventListener("input",()=>{Ve.volume=Math.max(0,Math.min(1,Number(Os.value)/100))}),Us&&Ve&&Us.addEventListener("click",()=>{Ve.muted=!Ve.muted,Us.innerHTML=Ve.muted?'<i class="fas fa-volume-mute"></i>':'<i class="fas fa-volume-up"></i>'}),Lr&&En&&Lr.addEventListener("click",()=>{En.style.display==="block"?En.style.display="none":(En.style.display="block",typeof fetchAndRenderHtmlSubs=="function"&&fetchAndRenderHtmlSubs(),typeof updateSubtitleControlDisplays=="function"&&updateSubtitleControlDisplays())}),Cr&&En&&Cr.addEventListener("click",()=>En.style.display="none"),ud&&er&&ud.addEventListener("click",()=>er.click()),Ds&&Ds.addEventListener("input",()=>{Number(Ds.value),updateSubtitleControlDisplays(),applySubtitleSettings()}),Fs&&Fs.addEventListener("input",()=>{Fs.value,applySubtitleSettings()}),Hs&&Hs.addEventListener("input",()=>{Hs.value,applySubtitleSettings()}),Vs&&Vs.addEventListener("input",()=>{Number(Vs.value),updateSubtitleControlDisplays(),applySubtitleSettings()}),js&&js.addEventListener("change",()=>{js.value,applySubtitleSettings()}),fd&&typeof closeWCJSPlayer=="function"&&fd.addEventListener("click",closeWCJSPlayer),pd&&typeof wcjsTogglePlayPause=="function"&&pd.addEventListener("click",wcjsTogglePlayPause),yd&&typeof wcjsSkipTime=="function"&&yd.addEventListener("click",()=>wcjsSkipTime(-10)),gd&&typeof wcjsSkipTime=="function"&&gd.addEventListener("click",()=>wcjsSkipTime(10)),hd&&typeof wcjsToggleFullscreen=="function"&&hd.addEventListener("click",wcjsToggleFullscreen),md&&typeof wcjsSeek=="function"&&md.addEventListener("click",wcjsSeek),vd&&typeof wcjsToggleMute=="function"&&vd.addEventListener("click",wcjsToggleMute),wd&&typeof wcjsSetVolume=="function"&&wd.addEventListener("input",wcjsSetVolume),Ed&&typeof wcjsHandleSubtitleUpload=="function"&&Ed.addEventListener("change",wcjsHandleSubtitleUpload),bd&&Rn&&_n&&bd.addEventListener("click",()=>{Rn.style.display==="block"?Rn.style.display="none":(Rn.style.display="block",_n.style.display="none",typeof fetchAndRenderSubtitles=="function"&&fetchAndRenderSubtitles())}),Id&&_n&&Rn&&Id.addEventListener("click",()=>{_n.style.display==="block"?_n.style.display="none":(_n.style.display="block",Rn.style.display="none",typeof renderAudioTracks=="function"&&renderAudioTracks())}),kd&&typeof fetchAndRenderSubtitles=="function"&&kd.addEventListener("click",fetchAndRenderSubtitles),Sd&&Rn&&Sd.addEventListener("click",()=>Rn.style.display="none"),Td&&_n&&Td.addEventListener("click",()=>_n.style.display="none"),Ve&&Rs&&(Ve.addEventListener("loadstart",()=>{Rs.style.display="flex"}),Ve.addEventListener("canplay",()=>{Rs.style.display="none"})),Ve&&(typeof updateProgress=="function"&&Ve.addEventListener("timeupdate",updateProgress),typeof updateDuration=="function"&&Ve.addEventListener("loadedmetadata",updateDuration),Ve.addEventListener("play",()=>{if(Po&&(Po.innerHTML='<i class="fas fa-pause"></i>'),currentStreamTitle&&fo&&fo.checked&&typeof Md=="function"&&typeof Rd=="function"){const s=Ve.currentTime/Ve.duration*100,{title:l,type:f,year:v,season:E,episode:w}=Md(currentStreamTitle);Rd(l,f,v,E,w,Math.floor(s))}}),Ve.addEventListener("pause",()=>{if(Po&&(Po.innerHTML='<i class="fas fa-play"></i>'),Ve.duration&&mo&&mo.checked&&typeof _d=="function"){const s=Ve.currentTime/Ve.duration*100;_d(Math.floor(s))}}),Ve.addEventListener("ended",()=>{Ve.duration&&typeof Ud=="function"&&Ud(100)})),Ir.addEventListener("click",s=>{s.target===Ir&&du()}),Fn.addEventListener("click",s=>{s.target===Fn&&closeCustomPlayer_()}),qs.addEventListener("click",s=>{s.target===qs&&closeWCJSPlayer()}),or.addEventListener("click",s=>{s.target===or&&ui()}),document.querySelectorAll(".category").forEach(s=>{s.addEventListener("click",()=>{if(document.querySelectorAll(".category").forEach(l=>l.classList.remove("active")),s.classList.add("active"),bn=s.dataset.category,document.body.classList.contains("ui-new")){const l=document.getElementById("slidersContainer"),f=document.getElementById("heroSection"),v=document.getElementById("backToHomeBtn");if(ca){wt.innerHTML="";let E=di;bn==="movie"?E=di.filter(w=>w.media_type==="movie"):bn==="tv"&&(E=di.filter(w=>w.media_type==="tv")),Vo(E)}else bn==="all"?(l&&(l.style.display="block"),f&&(f.style.display="block"),v&&(v.style.display="none"),wt.style.display="none",wt.innerHTML=""):(l&&(l.style.display="none"),f&&(f.style.display="none"),v&&(v.style.display="none"),wt.style.display="grid",wt.innerHTML="",Hn=1,_r(bn))}else wt.innerHTML="",Hn=1,_r(bn)})}),ef.addEventListener("click",()=>{In!=="movie"&&au("movie")}),tf.addEventListener("click",()=>{In!=="tv"&&au("tv")}),document.addEventListener("keydown",s=>{if(Fn.classList.contains("active"))switch(s.code){case"Space":s.preventDefault(),togglePlayPause();break;case"ArrowRight":skipTime(10);break;case"ArrowLeft":skipTime(-10);break;case"KeyF":toggleFullscreen();break;case"Escape":closeCustomPlayer_();break}else if(qs.classList.contains("active"))switch(s.code){case"Space":s.preventDefault(),wcjsTogglePlayPause();break;case"ArrowRight":wcjsSkipTime(10);break;case"ArrowLeft":wcjsSkipTime(-10);break;case"KeyF":wcjsToggleFullscreen();break;case"Escape":closeWCJSPlayer();break}});const vo=document.getElementById("sidebarLogo");vo&&vo.addEventListener("click",()=>{window.location.href="http://localhost:6987"});const Pt=document.querySelector(".logo");Pt&&Pt.addEventListener("click",s=>{s.preventDefault(),window.location.href="http://localhost:6987"});const Kn=document.querySelectorAll(".nav-item[data-page]");Kn.forEach(s=>{s.addEventListener("click",()=>{const l=s.dataset.page;Kn.forEach(f=>f.classList.remove("active")),s.classList.add("active"),l==="home"?Fd():l==="genres"?Hd():l==="my-list"?Vd():l==="done-watching"?jd():l==="trakt"?qd():l==="livetv"?zd():l==="iptv"?Wd():l==="games-downloader"?Jd():l==="minigames"?Zd():l==="books"?Gd():l==="audiobooks"?tu():l==="music"?eu():l==="booktorrio"?nu():l==="anime"?ou():l==="comics"?ru():l==="manga"?iu():l==="downloader"&&su()})});const g=document.getElementById("customMagnetBtn"),c=document.getElementById("custom-magnet-modal"),d=document.getElementById("custom-magnet-input");g&&c&&g.addEventListener("click",s=>{s.preventDefault(),s.stopPropagation(),console.log("Custom Magnet nav button clicked!"),c.style.display="flex",d&&(d.value="",setTimeout(()=>d.focus(),100))});const b=document.getElementById("sidebarClearCache");b&&b.addEventListener("click",async()=>{const s=await window.electronAPI.clearCache();showNotification(s.message,s.success?"success":"error")});const B=document.getElementById("sidebarSettings");B&&B.addEventListener("click",Pr);const R=document.getElementById("floatingNavContainer"),D=document.getElementById("floatingNavBtn"),ke=document.getElementById("floatingNavMenu");D&&D.addEventListener("click",s=>{s.stopPropagation(),R.classList.toggle("active")}),ke&&ke.addEventListener("click",s=>{const l=s.target.closest(".floating-nav-item");if(l){const f=l.getAttribute("data-action");switch(R.classList.remove("active"),f){case"settings":Pr();break;case"home":Fd();break;case"genres":Hd();break;case"my-list":Vd();break;case"done-watching":jd();break;case"livetv":zd();break;case"iptv":Wd();break;case"games-downloader":Jd();break;case"minigames":Zd();break;case"music":eu();break;case"books":Gd();break;case"audiobooks":tu();break;case"booktorrio":nu();break;case"anime":ou();break;case"comics":ru();break;case"manga":iu();break;case"downloader":su();break;case"trakt":qd();break}}}),document.addEventListener("click",s=>{R&&!R.contains(s.target)&&R.classList.remove("active")});let S=[];const P=document.getElementById("books-search-input"),$=document.getElementById("books-search-btn"),C=document.getElementById("books-loading"),M=document.getElementById("books-empty"),F=document.getElementById("books-results"),j=document.getElementById("books-results-grid"),H=document.getElementById("books-results-title"),te=document.getElementById("books-results-count"),Ee=document.getElementById("books-reader-modal"),fe=document.getElementById("books-reader-back");document.getElementById("books-reader-title");const be=document.getElementById("books-reader-frame");async function re(s){if(!s||s.trim().length===0){showNotification("Please enter a search term","warning");return}const l=s.trim();console.log("[BOOKS] Searching for:",l),M.style.display="none",F.style.display="none",C.style.display="block";try{const f=encodeURIComponent(l);let v="http://localhost:6987/zlib";try{if(window.electronAPI?.booksGetUrl){const h=await window.electronAPI.booksGetUrl();h?.success&&h?.url&&(v=h.url)}}catch{}const E=await fetch(`${v}/search/${f}`);if(!E.ok){const h=await E.json().catch(()=>({}));throw new Error(h.error||`HTTP ${E.status}: ${E.statusText}`)}const w=await E.json();console.log("[BOOKS] Search results:",w),C.style.display="none",w.results&&w.results.length>0?(S=w.results,ze(w.results,l),showNotification(`Found ${w.results.length} books`,"success")):(F.style.display="none",M.style.display="block",M.innerHTML=`
                            <div class="books-empty-icon">
                                <i class="fas fa-search"></i>
                            </div>
                            <h3>No Books Found</h3>
                            <p>No results found for "${l}". Try a different search term.</p>
                        `,showNotification("No books found for your search","info"))}catch(f){console.error("[BOOKS] Search error:",f),C.style.display="none",F.style.display="none",M.style.display="block";const v=f.message||"Unknown error",E=v.includes("Unable to connect")||v.includes("503");M.innerHTML=`
                        <div class="books-empty-icon">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                        <h3>Search Error</h3>
                        <p>${E?"Z-Library servers are currently unreachable. This may be due to ISP blocking or regional restrictions.":"Failed to search books. Please check your connection and try again."}</p>
                        ${E?'<p style="font-size: 0.9em; opacity: 0.7; margin-top: 0.5rem;">ðŸ’¡ Tip: Try using a VPN if Z-Library is blocked in your region.</p>':""}
                        <p style="font-size: 0.85em; opacity: 0.6; margin-top: 1rem;">Error: ${v}</p>
                    `,showNotification(E?"Z-Library unreachable - try VPN":"Failed to search books","error")}}function ze(s,l){H.textContent=`Search Results for "${l}"`,te.textContent=`${s.length} book${s.length!==1?"s":""} found`,j.innerHTML="",s.forEach(E=>{const w=document.createElement("div");w.className="books-book-card",w.innerHTML=`
                        <div class="books-book-cover">
                            <img loading="lazy" src="${E.photo}" alt="${E.title}" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                            <div class="books-book-cover-placeholder" style="display: none;">
                                <i class="fas fa-book"></i>
                            </div>
                            <div class="books-book-format">${E.format}</div>
                        </div>
                        <div class="books-book-info">
                            <h3 class="books-book-title">${E.title}</h3>
                            <p class="books-book-author">by ${E.author}</p>
                            ${E.year?`<span class="books-book-year">${E.year}</span>`:""}
                            <div class="books-book-actions">
                                <button class="books-read-btn" data-read-link="${E.readLink}" data-title="${E.title}">
                                    <i class="fas fa-book-open"></i>
                                    Read Now
                                </button>
                                <button class="books-download-btn" data-book-url="${E.bookUrl}" title="View on Z-Library">
                                    <i class="fas fa-external-link-alt"></i>
                                </button>
                            </div>
                        </div>
                    `,j.appendChild(w)}),j.querySelectorAll(".books-read-btn").forEach(E=>{E.addEventListener("click",w=>{const h=w.currentTarget.getAttribute("data-read-link"),T=w.currentTarget.getAttribute("data-title");h&&window.electronAPI?.openExternal&&(console.log("[BOOKS] Opening book reader in browser:",T,h),window.electronAPI.openExternal(h),showNotification(`Opening "${T}" in browser...`,"success"))})}),j.querySelectorAll(".books-download-btn").forEach(E=>{E.addEventListener("click",w=>{const h=w.currentTarget.getAttribute("data-book-url");h&&window.electronAPI.openExternal(h)})}),M.style.display="none",F.style.display="block"}let Tt=[];const Qe=document.getElementById("music-search-input"),wo=document.getElementById("music-search-btn"),Kt=document.getElementById("music-loading"),K=document.getElementById("music-empty"),de=document.getElementById("music-results"),ce=document.getElementById("music-results-grid"),Me=document.getElementById("music-results-count"),We=document.getElementById("music-results-title"),he=document.getElementById("music-player-modal"),Lt=document.getElementById("music-player-back"),tn=document.getElementById("music-player-minimize"),pn=document.getElementById("music-player-title"),xt=document.getElementById("music-player-song-title"),Yt=document.getElementById("music-player-artist"),Ne=document.getElementById("music-player-cover"),J=document.getElementById("music-player-audio"),tt=document.getElementById("music-play-pause-btn"),Yn=document.getElementById("music-backward-btn"),Jo=document.getElementById("music-forward-btn"),Ot=document.getElementById("music-prev-track-btn"),Jn=document.getElementById("music-next-track-btn"),Kr=document.getElementById("music-progress-bar"),Yr=document.getElementById("music-progress-fill"),Jr=document.getElementById("music-current-time"),Xr=document.getElementById("music-total-time"),Qr=document.getElementById("music-volume-slider"),vf=document.getElementById("music-volume-fill"),yn=document.getElementById("music-autoplay-toggle"),at=document.getElementById("music-mini-player"),Ya=document.getElementById("music-player-maximize"),Eo=document.getElementById("mini-player-song-title"),bo=document.getElementById("mini-player-artist"),Ye=document.getElementById("mini-play-pause-btn"),Ja=document.getElementById("mini-backward-btn"),Xa=document.getElementById("mini-forward-btn"),Qa=document.getElementById("mini-prev-track-btn"),Za=document.getElementById("mini-next-track-btn"),Zr=document.getElementById("mini-progress-bar"),Ga=document.getElementById("mini-progress-fill"),ec=document.getElementById("mini-current-time"),tc=document.getElementById("mini-total-time"),Xn=document.getElementById("music-playlist-chooser"),nc=document.getElementById("playlist-chooser-back"),$i=document.getElementById("playlist-chooser-list"),Gr=document.getElementById("playlist-chooser-empty"),Ni=document.getElementById("playlist-chooser-new-name"),oc=document.getElementById("playlist-chooser-create");let Io=null;function ko(s){if(!s)return"";try{return`https://resources.tidal.com/images/${s.replace(/-/g,"/")}/320x320.jpg`}catch{return""}}function Xo(s){if(!isFinite(s))return"0:00";const l=Math.floor(s/60),f=Math.floor(s%60).toString().padStart(2,"0");return`${l}:${f}`}async function ic(s){if(!s||!s.trim()){showNotification("Please enter a search term","warning");return}const l=s.trim();K.style.display="none",de.style.display="none",Kt.style.display="block";try{const f=await xl.searchMusic(l);if(Kt.style.display="none",!f||!f.length){de.style.display="none",K.style.display="block",K.innerHTML=`
                            <div class="books-empty-icon"><i class="fas fa-search"></i></div>
                            <h3>No Music Found</h3>
                            <p>No results found for "${l}". Try a different search.</p>
                        `,showNotification("No music found for your search","info");return}Tt=f,es(f,l),showNotification(`Found ${f.length} items`,"success")}catch(f){console.error("[MUSIC] Search error",f),Kt.style.display="none",de.style.display="none",K.style.display="block",K.innerHTML=`
                        <div class="books-empty-icon"><i class="fas fa-exclamation-triangle"></i></div>
                        <h3>Search Error</h3>
                        <p>Failed to search music. Please try again.</p>
                    `,showNotification("Failed to search music","error")}}function es(s,l){window.currentMusicResults=s,window.currentMusicQuery=l,We.textContent=`Search Results for "${l}"`,Me.textContent=`${s.length} item${s.length!==1?"s":""} found`;const f=document.getElementById("music-page");f&&f.classList.remove("playlist-open");const v=document.getElementById("my-albums");v&&(v.style.display="none");const E=document.getElementById("music-album-view");E&&(E.style.display="none"),ce.innerHTML="";const w=[];s.forEach(h=>{const T=h.id||h.trackId||h.itemId,x=h.title||h.trackTitle||"Unknown Title",O=h.artist&&(h.artist.name||h.artist)||h.artists&&h.artists[0]?.name||"Unknown Artist",q=h.album?.cover||h.cover||h.albumCover||"",V=ko(q)||"https://via.placeholder.com/320x320?text=Music";T&&w.push({id:String(T),title:x,artist:O,cover:V});const Q=document.createElement("div");Q.className="music-card";const ee=Cn().some(xe=>xe.id==T),ue=Bn(T);Q.innerHTML=`
                        <div class="music-cover">
                            <img loading="lazy" src="${V}" alt="${x}">
                        </div>
                        <div class="music-info">
                            <div class="music-title">${x}</div>
                            <div class="music-artist">${O}</div>
                            <div class="music-actions">
                                <button class="music-play-btn" data-id="${T}" data-title="${x.replace(/\"/g,"&quot;")}" data-artist="${O.replace(/\"/g,"&quot;")}" data-cover="${V}"><i class="fas fa-play"></i> Play</button>
                                <button class="music-heart-btn ${ee?"added":""}" title="${ee?"In My Music":"Add to My Music"}" data-id="${T}" data-title="${x.replace(/\"/g,"&quot;")}" data-artist="${O.replace(/\"/g,"&quot;")}" data-cover="${V}"><i class="fas fa-heart"></i></button>
                                <button class="music-plus-btn" title="Add to Playlist" data-id="${T}" data-title="${x.replace(/\"/g,"&quot;")}" data-artist="${O.replace(/\"/g,"&quot;")}" data-cover="${V}"><i class="fas fa-plus"></i></button>
                                ${ue?`<button class="music-download-btn downloaded" title="Downloaded" data-id="${T}" data-title="${x.replace(/\"/g,"&quot;")}" data-artist="${O.replace(/\"/g,"&quot;")}" data-cover="${V}"><i class="fas fa-check-circle"></i></button>`:`<button class="music-download-btn" title="Download" data-id="${T}" data-title="${x.replace(/\"/g,"&quot;")}" data-artist="${O.replace(/\"/g,"&quot;")}" data-cover="${V}"><i class="fas fa-download"></i></button>`}
                            </div>
                        </div>
                    `,ce.appendChild(Q)}),ce.querySelectorAll(".music-play-btn").forEach(h=>{h.addEventListener("click",async T=>{const x=String(T.currentTarget.getAttribute("data-id")),O=w.findIndex(q=>String(q.id)===x);if(O>=0)oi(w,O);else{const q=T.currentTarget.closest(".music-card"),V=q.querySelector(".music-title")?.textContent||"Unknown Title",Q=q.querySelector(".music-artist")?.textContent||"Unknown Artist",ee=q.querySelector("img")?.src||"";await hn({trackId:x,title:V,artistName:Q,coverSrc:ee})}})}),ce.querySelectorAll(".music-heart-btn").forEach(h=>{h.addEventListener("click",T=>{const x=T.currentTarget,O=Cn(),q={id:x.getAttribute("data-id"),title:x.getAttribute("data-title"),artist:x.getAttribute("data-artist"),cover:x.getAttribute("data-cover")};O.find(V=>V.id===q.id)?showNotification("Already in My Music","info"):(O.push(q),ns(O),showNotification(`Saved "${q.title}" to My Music`,"success"),x.classList.add("added"),x.title="In My Music")})}),ce.querySelectorAll(".music-plus-btn").forEach(h=>{h.addEventListener("click",T=>{const x=T.currentTarget,O={id:x.getAttribute("data-id"),title:x.getAttribute("data-title"),artist:x.getAttribute("data-artist"),cover:x.getAttribute("data-cover")};Ui(O)})}),ce.querySelectorAll(".music-download-btn").forEach(h=>{h.addEventListener("click",async T=>{if(nn||Xt){showNotification("Please wait for the current download to finish","info");return}const x=T.currentTarget,O=x.getAttribute("data-id"),q=x.getAttribute("data-title"),V=x.getAttribute("data-artist"),Q=x.getAttribute("data-cover");if(Bn(O)){showNotification("Track already downloaded","info");return}await _i(O,q,V,Q)})}),K.style.display="none",de.style.display="block"}const rc=document.getElementById("music-album-search-btn");document.getElementById("music-albums");const So=document.getElementById("music-albums-grid"),ts=document.getElementById("music-albums-count");document.getElementById("music-album-view");const sc=document.getElementById("album-close-btn"),Qo=document.getElementById("album-tracks"),wf=document.getElementById("album-view-title"),Ef=document.getElementById("album-view-meta"),bf=document.getElementById("album-view-cover");function Zo(s){const l=["music-results","my-music","music-playlists","music-albums","music-album-view"],f=document.getElementById("music-empty");l.forEach(E=>{const w=document.getElementById(E);w&&(w.style.display="none")}),f&&(f.style.display="none");const v=document.getElementById("music-page");v&&v.classList.remove("playlist-open"),s==="results"&&(document.getElementById("music-results").style.display=""),s==="my-music"&&(document.getElementById("my-music").style.display=""),s==="music-playlists"&&(document.getElementById("music-playlists").style.display=""),s==="albums"&&(document.getElementById("music-albums").style.display=""),s==="album-view"&&(document.getElementById("music-album-view").style.display=""),s==="my-albums"&&(document.getElementById("my-albums").style.display="")}async function If(s){if(!s||!s.trim()){showNotification("Please enter an album search term","warning");return}Zo("albums"),So.innerHTML="",ts.textContent="Searchingâ€¦";try{const l=await musicFetchJson(`/search/?al=${encodeURIComponent(s.trim())}`),f=l&&l.albums&&Array.isArray(l.albums.items)?l.albums.items:[];kf(f)}catch(l){console.error("[MUSIC] Album search error",l),ts.textContent="Error searching albums"}}function kf(s){if(So.innerHTML="",ts.textContent=`${s.length} album${s.length===1?"":"s"}`,!s.length){So.innerHTML='<div class="album-empty">No albums found.</div>';return}s.forEach(l=>{const f=l.artists&&l.artists[0]?.name?l.artists[0].name:"Unknown Artist",v=l.cover?ko(l.cover):"",E=document.createElement("div");E.className="album-card";const w=Go().some(h=>String(h.id)===String(l.id));E.innerHTML=`
                        <img loading="lazy" class="album-cover" src="${v}" alt="${l.title}">
                        <div class="album-body">
                            <div class="album-title">${l.title}</div>
                            <div class="album-artist">${f}</div>
                            <div class="album-meta">
                                <span>${l.type||"ALBUM"}</span>
                                <span>Â·</span>
                                <span>${l.numberOfTracks||0} tracks</span>
                                ${l.releaseDate?`<span>Â·</span><span>${l.releaseDate}</span>`:""}
                            </div>
                            <div style="display:flex; gap:0.5rem;">
                                <button class="album-open-btn"><i class="fas fa-folder-open"></i> Open</button>
                                <button class="album-heart-btn ${w?"added":""}" title="${w?"In My Albums":"Save Album"}"><i class="fas fa-heart"></i></button>
                            </div>
                        </div>`,E.querySelector(".album-open-btn").addEventListener("click",()=>ac(l)),E.querySelector(".album-heart-btn").addEventListener("click",()=>Sf(l,E.querySelector(".album-heart-btn"))),So.appendChild(E)})}let Dt=[];async function ac(s){try{Zo("album-view"),Qo.innerHTML='<div class="album-empty">Loading tracksâ€¦</div>',Dt=[];const l=await musicFetchJson(`/album/?id=${encodeURIComponent(s.id)}`);let f=null,v=[];Array.isArray(l)?(f=l[0]||null,v=(l[1]?.items||[]).map(V=>V?.item).filter(Boolean)):(Array.isArray(l?.tracks)&&(v=l.tracks),f=s||null);const E=f?.title||s?.title||"Album",w=f?.artist?.name||f?.artists&&f.artists[0]?.name||s?.artists&&s.artists[0]?.name||"Unknown Artist",h=f?.numberOfTracks??s?.numberOfTracks??(Array.isArray(v)?v.length:0),T=f?.releaseDate||s?.releaseDate||"",x=f?.cover||s?.cover||"";wf.textContent=E,Ef.textContent=`${w} Â· ${h} tracks${T?" Â· "+T:""}`,bf.src=x?ko(x):"";const O=x?ko(x):"";Dt=v.map((q,V)=>{const Q=q.id||q.trackNumber||V+1,ee=q.title||q.name||`Track ${V+1}`,ue=q.artists&&q.artists[0]?.name?q.artists[0].name:w;return{id:Q,title:ee,artist:ue,cover:O}}).filter(q=>q.id),cc(v,{artists:[{name:w}],cover:x})}catch(l){console.error("[MUSIC] openAlbum error",l),Qo.innerHTML='<div class="album-empty">Failed to load album.</div>',Dt=[]}}function cc(s,l){if(!s.length){Qo.innerHTML='<div class="album-empty">No tracks found in this album.</div>';return}Qo.innerHTML="";const f=l.cover?ko(l.cover):"";s.forEach((v,E)=>{const w=v.id||v.trackNumber||E+1,h=v.title||v.name||`Track ${E+1}`,T=v.artists&&v.artists[0]?.name?v.artists[0].name:l.artists&&l.artists[0]?.name?l.artists[0].name:"Unknown Artist",x=typeof v.duration=="number"?v.duration:v.durationMs?Math.round(v.durationMs/1e3):0,O=Bn(w),q=O?"track-download-btn downloaded":"track-download-btn",V=O?"fas fa-check-circle":"fas fa-download",Q=O?"Downloaded":"Download",ee=document.createElement("div");ee.className="track-row",ee.innerHTML=`
                        <div class="track-index">${E+1}</div>
                        <div class="track-title">${h} <span style="color:#94a3b8; font-weight:600;">Â· ${T}</span></div>
                        <div class="track-duration">${Xo(x)}</div>
                        <div class="track-actions">
                            <button class="track-play-btn"><i class="fas fa-play"></i> Play</button>
                            <button class="${q}" title="${Q}" data-id="${w}" data-title="${h.replace(/\"/g,"&quot;")}" data-artist="${T.replace(/\"/g,"&quot;")}" data-cover="${f}"><i class="${V}"></i> Download</button>
                            <button class="track-plus-btn"><i class="fas fa-plus"></i> Playlist</button>
                            <button class="track-heart-btn"><i class="fas fa-heart"></i> Save</button>
                        </div>`,ee.querySelector(".track-play-btn").addEventListener("click",()=>{if(!v.id){showNotification("Unable to play: missing track id","error");return}const ue=Dt.findIndex(xe=>String(xe.id)===String(v.id));ue>=0?oi(Dt,ue):hn({trackId:v.id,title:h,artistName:T,coverSrc:f})}),ee.querySelector(".track-download-btn").addEventListener("click",async()=>{if(!v.id){showNotification("Unable to download: missing track id","error");return}if(Bn(w)){showNotification("Track already downloaded","info");return}await _i(w,h,T,f),cc(s,l)}),ee.querySelector(".track-plus-btn").addEventListener("click",()=>{if(!v.id){showNotification("Unable to add: missing track id","error");return}Ui({id:String(v.id),title:h,artist:T,cover:f})}),ee.querySelector(".track-heart-btn").addEventListener("click",()=>{if(!v.id){showNotification("Unable to save: missing track id","error");return}const ue=Cn();ue.find(xe=>String(xe.id)===String(v.id))?showNotification("Already in My Music","info"):(ue.push({id:String(v.id),title:h,artist:T,cover:f}),ns(ue),showNotification(`Saved "${h}" to My Music`,"success"))}),Qo.appendChild(ee)})}rc&&rc.addEventListener("click",()=>If(Qe?.value||"")),sc&&sc.addEventListener("click",()=>{So&&So.children.length?Zo("albums"):(ce&&ce.children.length,Zo("results"))});const lc=document.getElementById("album-play-all-btn");lc&&lc.addEventListener("click",()=>{if(Dt.length===0){showNotification("No tracks to play","info");return}An(Dt)});const dc=document.getElementById("album-save-all-btn");dc&&dc.addEventListener("click",()=>{if(!Dt||Dt.length===0){showNotification("No tracks to save","info");return}Ui([...Dt])});const uc=document.getElementById("album-shuffle-btn");uc&&uc.addEventListener("click",()=>{if(!Dt||Dt.length===0){showNotification("No tracks to shuffle","info");return}const s=[...Dt];for(let l=s.length-1;l>0;l--){const f=Math.floor(Math.random()*(l+1));[s[l],s[f]]=[s[f],s[l]]}An(s)});const fc=document.getElementById("my-music-play-all-btn");fc&&fc.addEventListener("click",()=>{const s=Cn();if(s.length===0){showNotification("No tracks in My Music","info");return}An(s)});const mc=document.getElementById("my-music-shuffle-btn");mc&&mc.addEventListener("click",()=>{const s=Cn();if(!s||s.length===0){showNotification("No tracks in My Music","info");return}const l=[...s];for(let f=l.length-1;f>0;f--){const v=Math.floor(Math.random()*(f+1));[l[f],l[v]]=[l[v],l[f]]}An(l)});const pc="pt_my_albums_v1";function Go(){try{return JSON.parse(localStorage.getItem(pc)||"[]")}catch{return[]}}function yc(s){try{localStorage.setItem(pc,JSON.stringify(s))}catch{}}function Sf(s,l){const f=Go();if(f.find(w=>String(w.id)===String(s.id))){showNotification("Album already saved","info"),l&&l.classList.add("added");return}const E={id:s.id,title:s.title,cover:s.cover||null,artist:s.artist?.name||s.artists&&s.artists[0]?.name||"Unknown Artist",numberOfTracks:s.numberOfTracks||0,releaseDate:s.releaseDate||""};f.push(E),yc(f),showNotification(`Saved "${E.title}" to My Albums`,"success"),l&&l.classList.add("added")}function gc(){const s=document.getElementById("my-albums-grid"),l=document.getElementById("my-albums-count"),f=document.getElementById("my-albums-empty"),v=Go();if(s.innerHTML="",!v.length){l.textContent="0 albums",f.style.display="";return}f.style.display="none",l.textContent=`${v.length} album${v.length===1?"":"s"}`,v.forEach(E=>{const w=document.createElement("div");w.className="album-card";const h=E.cover?ko(E.cover):"";w.innerHTML=`
                        <img loading="lazy" class="album-cover" src="${h}" alt="${E.title}">
                        <div class="album-body">
                            <div class="album-title">${E.title}</div>
                            <div class="album-artist">${E.artist||""}</div>
                            <div class="album-meta"><span>${E.numberOfTracks||0} tracks</span>${E.releaseDate?`<span>Â·</span><span>${E.releaseDate}</span>`:""}</div>
                            <div style="display:flex; gap:0.5rem;">
                                <button class="album-open-btn" data-id="${E.id}"><i class="fas fa-folder-open"></i> Open</button>
                                <button class="album-heart-btn added" title="Remove from My Albums" data-remove="true" data-id="${E.id}"><i class="fas fa-trash"></i></button>
                            </div>
                        </div>`,s.appendChild(w)}),s.querySelectorAll(".album-open-btn").forEach(E=>{E.addEventListener("click",()=>{const w=E.getAttribute("data-id"),h=Go().find(T=>String(T.id)===String(w));h&&ac(h)})}),s.querySelectorAll('.album-heart-btn[data-remove="true"]').forEach(E=>{E.addEventListener("click",()=>{const w=E.getAttribute("data-id"),h=Go().filter(T=>String(T.id)!==String(w));yc(h),gc(),showNotification("Removed album","info")})})}const hc=document.getElementById("music-my-albums-btn");hc&&hc.addEventListener("click",()=>{const s=document.getElementById("my-albums"),l=document.getElementById("music-results"),f=document.getElementById("music-empty"),v=document.getElementById("my-music"),E=document.getElementById("music-playlists"),w=document.getElementById("music-downloaded"),h=document.getElementById("music-albums"),T=document.getElementById("music-album-view");s.style.display!=="none"?(s.style.display="none",h&&h.children.length?h.style.display="block":ce&&ce.children.length?(l.style.display="block",f.style.display="none"):(l.style.display="none",f.style.display=""),T&&(T.style.display="none")):(gc(),s.style.display="block",l.style.display="none",f.style.display="none",v.style.display="none",E.style.display="none",w&&(w.style.display="none"),h&&(h.style.display="none"),T&&(T.style.display="none"))});const vc="pt_my_music_v1";function Cn(){try{return JSON.parse(localStorage.getItem(vc)||"[]")}catch{return[]}}function ns(s){try{localStorage.setItem(vc,JSON.stringify(s))}catch{}}const wc="pt_playlists_v1";function Jt(){try{return JSON.parse(localStorage.getItem(wc)||"[]")}catch{return[]}}function Qn(s){try{localStorage.setItem(wc,JSON.stringify(s))}catch{}}function Tf(s,l){const f=Jt(),v=f.find(E=>E.id===s);return v?(v.tracks||(v.tracks=[]),v.tracks.find(E=>E.id===l.id)?!1:(v.tracks.push(l),Qn(f),!0)):!1}function Lf(s,l){if(!Array.isArray(l)||l.length===0)return{added:0,total:0};const f=Jt(),v=f.find(h=>h.id===s);if(!v)return{added:0,total:l.length};Array.isArray(v.tracks)||(v.tracks=[]);const E=new Set(v.tracks.map(h=>String(h.id)));let w=0;return l.forEach(h=>{if(!h||h.id==null)return;const T=String(h.id);E.has(T)||(v.tracks.push(h),E.add(T),w++)}),w>0&&Qn(f),{added:w,total:l.length}}const Ec="pt_downloaded_music_v1";function sn(){try{return JSON.parse(localStorage.getItem(Ec)||"[]")}catch{return[]}}function os(s){try{localStorage.setItem(Ec,JSON.stringify(s))}catch{}}function Bn(s){return sn().some(f=>String(f.id)===String(s))}function Cf(s){const l=sn();return l.find(f=>String(f.id)===String(s.id))?!1:(l.push(s),os(l),!0)}function Bf(s){const l=sn().filter(f=>String(f.id)!==String(s));os(l)}async function Af(){try{const s=sn();if(!Array.isArray(s)||s.length===0)return[];const l=Array.from(new Set(s.map(h=>h&&h.filePath).filter(Boolean)));if(l.length===0)return s;const f=await fetch("/api/music/exists-batch",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({filePaths:l})});if(!f.ok)return s;const v=await f.json(),E=v&&v.results||{},w=s.filter(h=>h&&h.filePath&&E[h.filePath]);return w.length!==s.length&&os(w),w}catch(s){return console.warn("[Music] Reconcile with disk failed:",s),sn()}}let Xt=null,Mi=null,nn=null,To=null,bc=!1,Ri=!1,gn=[],is=!1;function Ic(){const s=document.getElementById("music-download-queue-info"),l=document.getElementById("music-download-queue-count");gn.length>0?(s&&(s.style.display="block"),l&&(l.textContent=gn.length)):s&&(s.style.display="none")}async function kc(){if(is||gn.length===0)return;is=!0;const s=gn.shift();Ic();try{await Sc(s.trackId,s.title,s.artistName,s.coverSrc)}catch(l){console.error("Queue download error:",l),showNotification(`Failed to download "${s.title}"`,"error")}is=!1}async function Pf(s){try{if(!s||s.startsWith("data:"))return s||"";const l=await fetch(s);if(!l.ok)throw new Error("Image fetch failed");const f=await l.blob();return await new Promise((v,E)=>{const w=new FileReader;w.onloadend=()=>v(w.result),w.onerror=E,w.readAsDataURL(f)})}catch(l){return console.warn("Cover to dataURL failed, keeping URL:",l?.message||l),s||""}}function ei(s,l){const f=document.getElementById("music-download-progress-fill"),v=document.getElementById("music-download-status");f&&(f.style.width=s),v&&(v.textContent=l);const E=document.getElementById("music-download-minimized-progress"),w=document.getElementById("music-download-minimized-status");E&&(E.style.width=s),w&&(w.textContent=l)}async function Sc(s,l,f,v){if(nn||Xt){console.warn("Download already in progress, skipping");return}Xt=new AbortController,Mi=null,Ri=!1,nn=Date.now().toString();try{const E=document.getElementById("music-download-modal"),w=document.getElementById("music-download-minimized"),h=document.getElementById("music-download-song-name"),T=document.getElementById("music-download-artist-name"),x=document.getElementById("music-download-minimized-song"),O=document.getElementById("music-download-minimized-artist");E.style.display="none",w.style.display="block",Ri=!0,h&&(h.textContent=l),T&&(T.textContent=f),x&&(x.textContent=l),O&&(O.textContent=f),ei("0%","Starting download...");let q=setInterval(()=>{ei("50%","Downloading...")},500),V;try{V=await xl.downloadTrack(s,l,f,v)}finally{clearInterval(q)}let Q=v;try{Q=await Pf(v)}catch{}if(V&&V.success){Cf({id:String(s),title:l,artist:f,cover:Q,filePath:V.path}),ei("100%","âœ“ Download complete!"),setTimeout(()=>{const xe=document.getElementById("music-download-modal"),pe=document.getElementById("music-download-minimized");xe&&(xe.style.display="none"),pe&&(pe.style.display="none"),Xt=null,Mi=null,nn=null;try{Qe&&Qe.focus&&Qe.focus()}catch{}gn.length>0&&setTimeout(()=>kc(),500)},1500),showNotification(`Downloaded "${l}"`,"success");const ee=window.currentMusicResults||[],ue=window.currentMusicQuery||"";ee.length>0&&es(ee,ue)}else throw new Error("Download failed")}catch(E){console.error("Initial download error:",E);const w=document.getElementById("music-download-modal"),h=document.getElementById("music-download-minimized");w.style.display="none",h.style.display="none",Xt=null,showNotification(`Failed to start download: ${E.message}`,"error");try{Qe&&Qe.focus&&Qe.focus()}catch{}gn.length>0&&setTimeout(()=>kc(),1e3)}}async function _i(s,l,f,v){if(sn().some(w=>w.id===String(s))){showNotification(`"${l}" is already downloaded`,"info");return}if(gn.some(w=>w.trackId===s)){showNotification(`"${l}" is already in queue`,"info");return}if(nn||Xt){gn.push({trackId:s,title:l,artistName:f,coverSrc:v}),Ic(),showNotification(`"${l}" added to download queue (position ${gn.length})`,"info");return}await Sc(s,l,f,v)}const Tc=document.getElementById("music-download-minimize-btn");Tc&&Tc.addEventListener("click",()=>{const s=document.getElementById("music-download-modal"),l=document.getElementById("music-download-minimized");s.style.display="none",l.style.display="block",Ri=!0});const Lc=document.getElementById("music-download-restore-btn");Lc&&Lc.addEventListener("click",()=>{const s=document.getElementById("music-download-modal"),l=document.getElementById("music-download-minimized");s.style.display="flex",l.style.display="none",Ri=!1});const Cc=document.getElementById("music-download-cancel-btn");Cc&&Cc.addEventListener("click",async()=>{try{if(bc=!0,To&&(clearInterval(To),To=null),Xt)try{Xt.abort()}catch{}nn&&await fetch("/api/music/download/cancel",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({downloadId:nn})}).catch(()=>{})}finally{const s=document.getElementById("music-download-modal"),l=document.getElementById("music-download-minimized");s&&(s.style.display="none"),l&&(l.style.display="none"),Xt=null,Mi=null,nn=null,ei("0%",""),showNotification("Download cancelled","info");try{Qe&&Qe.focus&&Qe.focus()}catch{}}});const Bc=document.getElementById("music-download-cancel-minimized-btn");Bc&&Bc.addEventListener("click",async()=>{try{if(bc=!0,To&&(clearInterval(To),To=null),Xt)try{Xt.abort()}catch{}nn&&await fetch("/api/music/download/cancel",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({downloadId:nn})}).catch(()=>{})}finally{const s=document.getElementById("music-download-modal"),l=document.getElementById("music-download-minimized");s&&(s.style.display="none"),l&&(l.style.display="none"),Xt=null,Mi=null,nn=null,ei("0%",""),showNotification("Download cancelled","info");try{Qe&&Qe.focus&&Qe.focus()}catch{}}});function ti(){if(!document.getElementById("music-playlists"))return;const l=document.getElementById("playlists-list"),f=document.getElementById("playlists-empty"),v=Jt();if(l.innerHTML="",!v.length){f.style.display="";return}f.style.display="none",v.forEach(E=>{const w=document.createElement("div");w.className="music-card",w.innerHTML=`
                        <div class="music-info">
                            <div class="music-title">${E.name}</div>
                            <div class="music-artist">${E.tracks?.length||0} track${(E.tracks?.length||0)!==1?"s":""}</div>
                            <div class="music-actions">
                                <button class="playlist-open-btn" data-id="${E.id}"><i class="fas fa-folder-open"></i> Open</button>
                                <button class="playlist-export-btn" data-id="${E.id}" title="Export playlist"><i class="fas fa-file-export"></i> Export</button>
                                <button class="playlist-delete-btn" data-id="${E.id}"><i class="fas fa-trash"></i></button>
                            </div>
                        </div>`,l.appendChild(w)}),l.querySelectorAll(".playlist-open-btn").forEach(E=>{E.addEventListener("click",w=>{const h=w.currentTarget.getAttribute("data-id");rs(h)})}),l.querySelectorAll(".playlist-export-btn").forEach(E=>{E.addEventListener("click",w=>{const h=w.currentTarget.getAttribute("data-id");xf(h)})}),l.querySelectorAll(".playlist-delete-btn").forEach(E=>{E.addEventListener("click",w=>{const h=w.currentTarget.getAttribute("data-id"),T=Jt().filter(x=>x.id!==h);Qn(T),ti(),showNotification("Playlist deleted","info")})})}function rs(s){const f=Jt().find(O=>O.id===s);if(!f)return;const v=document.getElementById("music-results"),E=document.getElementById("music-empty"),w=document.getElementById("my-music");w.style.display="none",v.style.display="block",E.style.display="none",We.textContent=`Playlist: ${f.name}`;const h=document.getElementById("music-page");h&&h.classList.add("playlist-open");const T=v.querySelector(".books-results-header");if(T&&!T.querySelector("#playlist-close-btn")){const O=document.createElement("button");O.id="playlist-play-all-btn",O.className="action-btn",O.style.background="linear-gradient(135deg, #ec4899, #a855f7)",O.innerHTML='<i class="fas fa-play"></i><span>Play All</span>',T.appendChild(O),O.addEventListener("click",()=>{const Q=f.tracks||[];if(Q.length===0){showNotification("No tracks in this playlist","info");return}An(Q)});const q=document.createElement("button");q.id="playlist-shuffle-btn",q.className="action-btn",q.title="Shuffle and play this playlist",q.innerHTML='<i class="fas fa-random"></i><span>Shuffle</span>',T.appendChild(q),q.addEventListener("click",()=>{const Q=(f.tracks||[]).slice();if(Q.length===0){showNotification("No tracks in this playlist","info");return}for(let ee=Q.length-1;ee>0;ee--){const ue=Math.floor(Math.random()*(ee+1));[Q[ee],Q[ue]]=[Q[ue],Q[ee]]}An(Q)});const V=document.createElement("button");V.id="playlist-close-btn",V.className="playlist-close-btn",V.style.marginLeft="auto",V.innerHTML='<i class="fas fa-times"></i><span>Close Playlist</span>',T.appendChild(V),V.addEventListener("click",()=>{h&&h.classList.remove("playlist-open");const Q=document.getElementById("playlist-play-all-btn"),ee=document.getElementById("playlist-shuffle-btn"),ue=document.getElementById("playlist-close-btn");Q&&Q.remove(),ee&&ee.remove(),ue&&ue.remove(),v.style.display="none",E.style.display="none";const xe=document.getElementById("music-playlists");if(xe){xe.style.display="block";try{ti()}catch{}}})}const x=f.tracks||[];Me.textContent=`${x.length} track${x.length!==1?"s":""}`,ce.innerHTML="",x.forEach(O=>{const q=document.createElement("div");q.className="music-card";const Q=Bn(O.id)?`<button class="music-download-btn downloaded" title="Downloaded" data-id="${O.id}" data-title="${O.title.replace(/\"/g,"&quot;")}" data-artist="${O.artist.replace(/\"/g,"&quot;")}" data-cover="${O.cover}"><i class="fas fa-check-circle"></i></button>`:`<button class="music-download-btn" title="Download" data-id="${O.id}" data-title="${O.title.replace(/\"/g,"&quot;")}" data-artist="${O.artist.replace(/\"/g,"&quot;")}" data-cover="${O.cover}"><i class="fas fa-download"></i></button>`;q.innerHTML=`
                        <div class="music-cover"><img loading="lazy" src="${O.cover}" alt="${O.title}"></div>
                        <div class="music-info">
                            <div class="music-title">${O.title}</div>
                            <div class="music-artist">${O.artist}</div>
                            <div class="music-actions">
                                <button class="music-play-btn" data-id="${O.id}" data-title="${O.title}" data-artist="${O.artist}" data-cover="${O.cover}"><i class="fas fa-play"></i> Play</button>
                                ${Q}
                                <button class="playlist-delete-btn playlist-remove-btn" data-id="${O.id}" data-pl="${s}" title="Remove from Playlist"><i class="fas fa-trash"></i></button>
                            </div>
                        </div>`,ce.appendChild(q)}),ce.querySelectorAll(".music-play-btn").forEach(O=>{O.addEventListener("click",q=>{const V=q.currentTarget,Q=(f.tracks||[]).map(ue=>({id:String(ue.id),title:ue.title,artist:ue.artist,cover:ue.cover})),ee=Q.findIndex(ue=>String(ue.id)===String(V.getAttribute("data-id")));ee>=0&&Q.length?oi(Q,ee):hn({trackId:V.getAttribute("data-id"),title:V.getAttribute("data-title"),artistName:V.getAttribute("data-artist"),coverSrc:V.getAttribute("data-cover")})})}),ce.querySelectorAll(".music-download-btn").forEach(O=>{O.addEventListener("click",async q=>{q.stopPropagation();const V=q.currentTarget,Q=V.getAttribute("data-id"),ee=V.getAttribute("data-title"),ue=V.getAttribute("data-artist"),xe=V.getAttribute("data-cover");if(Bn(Q)){showNotification("Track already downloaded","info");return}await _i(Q,ee,ue,xe),rs(s)})}),ce.querySelectorAll(".playlist-remove-btn").forEach(O=>{O.addEventListener("click",q=>{const V=q.currentTarget.getAttribute("data-id"),Q=q.currentTarget.getAttribute("data-pl"),ee=Jt(),ue=ee.find(xe=>xe.id===Q);ue&&(ue.tracks=(ue.tracks||[]).filter(xe=>xe.id!==V),Qn(ee),rs(Q),showNotification("Removed from playlist","info"))})})}function Ui(s){Io=s;const l=Jt();!Xn||!$i||!Gr||($i.innerHTML="",l.length?(Gr.style.display="none",l.forEach(f=>{const v=document.createElement("div");v.className="music-card",v.innerHTML=`
                            <div class="music-info">
                                <div class="music-title">${f.name}</div>
                                <div class="music-artist">${f.tracks?.length||0} track${(f.tracks?.length||0)!==1?"s":""}</div>
                                <div class="music-actions">
                                    <button class="playlist-open-btn playlist-choose-btn" data-id="${f.id}"><i class="fas fa-check"></i><span>Add Here</span></button>
                                </div>
                            </div>`,$i.appendChild(v)}),$i.querySelectorAll(".playlist-choose-btn").forEach(f=>{f.addEventListener("click",()=>{const v=f.getAttribute("data-id"),E=Jt().find(w=>w.id===v)?.name||"playlist";if(Array.isArray(Io)){const{added:w,total:h}=Lf(v,Io);w>0?showNotification(`Added ${w} of ${h} to ${E}`,"success"):showNotification("All tracks already in playlist","info")}else{const w=Tf(v,Io);showNotification(w?`Added to ${E}`:"Already in playlist",w?"success":"info")}ss()})})):Gr.style.display="",Xn.style.display="flex")}function ss(){Xn&&(Xn.style.display="none"),Io=null,Ni&&(Ni.value="")}async function xf(s){try{const f=Jt().find(T=>T.id===s);if(!f){showNotification("Playlist not found","error");return}const v={name:f.name,tracks:f.tracks||[],exportedAt:new Date().toISOString(),version:"1.0"},E=JSON.stringify(v,null,2);if(!window.electronAPI?.showSaveDialog){const T=new Blob([E],{type:"application/json"}),x=URL.createObjectURL(T),O=document.createElement("a");O.href=x,O.download=`${f.name.replace(/[^a-z0-9]/gi,"_")}_playlist.json`,O.click(),URL.revokeObjectURL(x),showNotification("Playlist exported","success");return}const w=await window.electronAPI.showSaveDialog({title:"Export Playlist",defaultPath:`${f.name.replace(/[^a-z0-9]/gi,"_")}_playlist.json`,filters:[{name:"JSON Files",extensions:["json"]},{name:"All Files",extensions:["*"]}]});if(w.canceled||!w.filePath)return;const h=await window.electronAPI.writeFile(w.filePath,E);h.success?showNotification("Playlist exported successfully","success"):showNotification("Failed to export playlist: "+(h.error||"Unknown error"),"error")}catch(l){console.error("Export error:",l),showNotification("Failed to export playlist","error")}}async function $f(){try{if(!window.electronAPI?.showOpenDialog){showNotification("Import not supported in this environment","error");return}const s=await window.electronAPI.showOpenDialog({title:"Import Playlist",filters:[{name:"JSON Files",extensions:["json"]},{name:"All Files",extensions:["*"]}],properties:["openFile"]});if(s.canceled||!s.filePaths||s.filePaths.length===0)return;const l=await window.electronAPI.readFile(s.filePaths[0]);if(!l.success){showNotification("Failed to read file: "+(l.error||"Unknown error"),"error");return}let f;try{f=JSON.parse(l.data)}catch{showNotification("Invalid playlist file format","error");return}if(!f.name||!Array.isArray(f.tracks)){showNotification("Invalid playlist data","error");return}const v=Jt();let E=f.name,w=1;for(;v.find(T=>T.name.toLowerCase()===E.toLowerCase());)E=`${f.name} (${w})`,w++;const h={id:"pl_"+Math.random().toString(36).slice(2,10),name:E,tracks:f.tracks};v.push(h),Qn(v),ti(),showNotification(`Playlist "${E}" imported with ${f.tracks.length} track${f.tracks.length!==1?"s":""}`,"success")}catch(s){console.error("Import error:",s),showNotification("Failed to import playlist","error")}}function Ac(){if(!document.getElementById("music-downloaded"))return;const l=document.getElementById("music-downloaded-grid"),f=document.getElementById("music-downloaded-empty"),v=document.getElementById("music-downloaded-count"),E=document.getElementById("downloaded-play-all-btn"),w=document.getElementById("downloaded-shuffle-btn"),h=sn();if(l.innerHTML="",!h.length){v&&(v.textContent="0 items"),f.style.display="",E&&(E.style.display="none"),w&&(w.style.display="none");return}f.style.display="none",v&&(v.textContent=`${h.length} item${h.length!==1?"s":""}`),E&&(E.style.display=""),w&&(w.style.display=""),h.forEach(T=>{const x=document.createElement("div");x.className="music-card",x.innerHTML=`
                        <div class="music-cover"><img loading="lazy" src="${T.cover}" alt="${T.title}"></div>
                        <div class="music-info">
                            <div class="music-title">${T.title}</div>
                            <div class="music-artist">${T.artist}</div>
                            <div class="music-actions">
                                <button class="music-play-btn" data-id="${T.id}" data-title="${T.title}" data-artist="${T.artist}" data-cover="${T.cover}"><i class="fas fa-play"></i> Play</button>
                                <button class="music-folder-btn" data-path="${T.filePath}" title="Open Folder"><i class="fas fa-folder-open"></i></button>
                                <button class="music-delete-downloaded-btn" data-id="${T.id}" data-path="${T.filePath}" title="Delete"><i class="fas fa-trash"></i></button>
                            </div>
                        </div>`,l.appendChild(x)}),l.querySelectorAll(".music-play-btn").forEach(T=>{T.addEventListener("click",x=>{const O=x.currentTarget,q=h.map(Q=>({id:String(Q.id),title:Q.title,artist:Q.artist,cover:Q.cover})),V=q.findIndex(Q=>String(Q.id)===String(O.getAttribute("data-id")));V>=0&&q.length?oi(q,V):hn({trackId:O.getAttribute("data-id"),title:O.getAttribute("data-title"),artistName:O.getAttribute("data-artist"),coverSrc:O.getAttribute("data-cover")})})}),l.querySelectorAll(".music-folder-btn").forEach(T=>{T.addEventListener("click",async x=>{const O=x.currentTarget.getAttribute("data-path");if(O&&window.electronAPI?.showFolderInExplorer)try{const q=Math.max(O.lastIndexOf("/"),O.lastIndexOf("\\")),V=q>0?O.substring(0,q):O;await window.electronAPI.showFolderInExplorer(V)}catch(q){console.error("Failed to open folder:",q),showNotification("Failed to open folder","error")}})}),l.querySelectorAll(".music-delete-downloaded-btn").forEach(T=>{T.addEventListener("click",async x=>{const O=x.currentTarget.getAttribute("data-id"),q=x.currentTarget.getAttribute("data-path");if(confirm("Delete this downloaded track?"))try{const V=await fetch("/api/music/delete",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({filePath:q})});if(!V.ok){const ue=await V.json();throw new Error(ue.error||"Delete failed")}Bf(O),Array.isArray(window.currentPlayQueue)&&(window.currentPlayQueue=window.currentPlayQueue.filter(ue=>String(ue.id)!==String(O)),typeof window.currentQueueIndex=="number"&&(window.currentQueueIndex=Math.min(window.currentQueueIndex,Math.max(0,window.currentPlayQueue.length-1)))),Ac(),showNotification("Track deleted","success");const Q=window.currentMusicResults||[],ee=window.currentMusicQuery||"";Q.length>0&&es(Q,ee)}catch(V){console.error("Delete error:",V),showNotification(`Delete failed: ${V.message}`,"error")}})})}nc&&Xn&&(nc.addEventListener("click",ss),Xn.addEventListener("click",s=>{s.target===Xn&&ss()})),oc&&oc.addEventListener("click",()=>{const s=(Ni.value||"").trim();if(!s){showNotification("Enter a playlist name","warning");return}const l=Jt();if(l.find(v=>v.name.toLowerCase()===s.toLowerCase())){showNotification("Playlist exists","info");return}const f="pl_"+Math.random().toString(36).slice(2,10);l.push({id:f,name:s,tracks:[]}),Qn(l),Ni.value="",Ui(Io||null),showNotification("Playlist created","success")});function as(){const s=Cn(),l=document.getElementById("my-music-grid"),f=document.getElementById("my-music-count"),v=document.getElementById("my-music-empty");if(l.innerHTML="",!s.length){f.textContent="0 items",v.style.display="";return}v.style.display="none",f.textContent=`${s.length} item${s.length!==1?"s":""}`,s.forEach(E=>{const w=document.createElement("div");w.className="music-card";const T=Bn(E.id)?`<button class="music-download-btn downloaded" title="Downloaded" data-id="${E.id}" data-title="${E.title.replace(/\"/g,"&quot;")}" data-artist="${E.artist.replace(/\"/g,"&quot;")}" data-cover="${E.cover}"><i class="fas fa-check-circle"></i></button>`:`<button class="music-download-btn" title="Download" data-id="${E.id}" data-title="${E.title.replace(/\"/g,"&quot;")}" data-artist="${E.artist.replace(/\"/g,"&quot;")}" data-cover="${E.cover}"><i class="fas fa-download"></i></button>`;w.innerHTML=`
                        <div class="music-cover"><img loading="lazy" src="${E.cover}" alt="${E.title}"></div>
                        <div class="music-info">
                            <div class="music-title">${E.title}</div>
                            <div class="music-artist">${E.artist}</div>
                            <div class="music-actions">
                                <button class="music-play-btn" data-id="${E.id}"><i class="fas fa-play"></i> Play</button>
                                ${T}
                                <button class="music-add-btn" title="Remove from My Music" data-remove="true" data-id="${E.id}"><i class="fas fa-trash"></i></button>
                            </div>
                        </div>`,l.appendChild(w)}),l.querySelectorAll(".music-play-btn").forEach(E=>{E.addEventListener("click",async w=>{const h=String(w.currentTarget.getAttribute("data-id")),T=Cn().map(O=>({id:String(O.id),title:O.title,artist:O.artist,cover:O.cover})),x=T.findIndex(O=>String(O.id)===h);if(x>=0&&T.length)oi(T,x);else{const O=w.currentTarget.closest(".music-card"),q=O.querySelector(".music-title")?.textContent||"Unknown Title",V=O.querySelector(".music-artist")?.textContent||"Unknown Artist",Q=O.querySelector("img")?.src||"";await hn({trackId:h,title:q,artistName:V,coverSrc:Q})}})}),l.querySelectorAll(".music-download-btn").forEach(E=>{E.addEventListener("click",async w=>{w.stopPropagation();const h=w.currentTarget,T=h.getAttribute("data-id"),x=h.getAttribute("data-title"),O=h.getAttribute("data-artist"),q=h.getAttribute("data-cover");if(Bn(T)){showNotification("Track already downloaded","info");return}await _i(T,x,O,q),as()})}),l.querySelectorAll('.music-add-btn[data-remove="true"]').forEach(E=>{E.addEventListener("click",w=>{const h=w.currentTarget.getAttribute("data-id"),T=Cn().filter(x=>x.id!==h);ns(T),as(),showNotification("Removed from My Music","info")})})}const Pc=document.getElementById("music-my-btn");Pc&&Pc.addEventListener("click",()=>{const s=document.getElementById("my-music"),l=document.getElementById("music-results"),f=document.getElementById("music-empty"),v=document.getElementById("music-playlists"),E=document.getElementById("music-downloaded"),w=document.getElementById("my-albums"),h=document.getElementById("music-albums"),T=document.getElementById("music-album-view");if(s.style.display!=="none"){s.style.display="none",ce&&ce.children.length?(l.style.display="block",f.style.display="none"):(l.style.display="none",f.style.display=""),v.style.display="none",E&&(E.style.display="none"),w&&(w.style.display="none"),h&&(h.style.display="none"),T&&(T.style.display="none");const O=document.getElementById("music-page");O&&O.classList.remove("playlist-open")}else{as(),s.style.display="block",l.style.display="none",f.style.display="none",v.style.display="none",E&&(E.style.display="none"),w&&(w.style.display="none"),h&&(h.style.display="none"),T&&(T.style.display="none");const O=document.getElementById("music-page");O&&O.classList.remove("playlist-open")}});const xc=document.getElementById("music-playlists-btn");xc&&xc.addEventListener("click",()=>{const s=document.getElementById("music-playlists"),l=document.getElementById("music-results"),f=document.getElementById("music-empty"),v=document.getElementById("my-music"),E=document.getElementById("music-downloaded"),w=document.getElementById("my-albums");if(s.style.display!=="none"){s.style.display="none",ce&&ce.children.length?(l.style.display="block",f.style.display="none"):(l.style.display="none",f.style.display="");const T=document.getElementById("music-page");T&&T.classList.remove("playlist-open"),w&&(w.style.display="none")}else{ti(),s.style.display="block",l.style.display="none",f.style.display="none",v.style.display="none",E&&(E.style.display="none"),w&&(w.style.display="none");const T=document.getElementById("music-page");T&&T.classList.remove("playlist-open")}});const $c=document.getElementById("music-downloaded-btn");$c&&$c.addEventListener("click",async()=>{const s=document.getElementById("music-downloaded"),l=document.getElementById("music-results"),f=document.getElementById("music-empty"),v=document.getElementById("my-music"),E=document.getElementById("music-playlists"),w=document.getElementById("my-albums");if(s.style.display!=="none"){s.style.display="none",ce&&ce.children.length?(l.style.display="block",f.style.display="none"):(l.style.display="none",f.style.display="");const T=document.getElementById("music-page");T&&T.classList.remove("playlist-open"),w&&(w.style.display="none")}else{try{await Af()}catch{}Ac(),s.style.display="block",l.style.display="none",f.style.display="none",v.style.display="none",E&&(E.style.display="none"),w&&(w.style.display="none");const T=document.getElementById("music-page");T&&T.classList.remove("playlist-open")}});const Nc=document.getElementById("downloaded-play-all-btn");Nc&&Nc.addEventListener("click",()=>{const s=sn();if(s.length===0){showNotification("No tracks to play","info");return}const l=s.map(f=>({id:String(f.id),title:f.title,artist:f.artist,cover:f.cover}));An(l)});const Mc=document.getElementById("downloaded-shuffle-btn");Mc&&Mc.addEventListener("click",()=>{const s=sn();if(s.length===0){showNotification("No tracks to play","info");return}const l=s.map(f=>({id:String(f.id),title:f.title,artist:f.artist,cover:f.cover}));for(let f=l.length-1;f>0;f--){const v=Math.floor(Math.random()*(f+1));[l[f],l[v]]=[l[v],l[f]]}An(l)});const Rc=document.getElementById("playlist-create-btn"),_c=document.getElementById("playlist-name-input");Rc&&Rc.addEventListener("click",()=>{const s=(_c.value||"").trim();if(!s){showNotification("Enter a playlist name","warning");return}const l=Jt();if(l.find(v=>v.name.toLowerCase()===s.toLowerCase())){showNotification("Playlist exists","info");return}const f="pl_"+Math.random().toString(36).slice(2,10);l.push({id:f,name:s,tracks:[]}),Qn(l),_c.value="",ti(),showNotification("Playlist created","success")});const Uc=document.getElementById("playlist-import-btn");Uc&&Uc.addEventListener("click",()=>{$f()});async function hn({trackId:s,title:l,artistName:f,coverSrc:v}){if(!s){showNotification("Missing track ID","error");return}try{const w=sn().find(q=>String(q.id)===String(s));if(w&&w.filePath){for(console.log("[MUSIC] Playing downloaded file:",w.filePath),ni?(at.style.display="block",he.style.display="none"):(he.style.display="flex",at.style.display="none"),pn.textContent="Now Playing (Offline)",xt.textContent=l,Yt.textContent=f,v&&(Ne.src=v),tt.innerHTML='<i class="fas fa-spinner fa-spin"></i>',Eo&&(Eo.textContent=l),bo&&(bo.textContent=f),Ye&&(Ye.innerHTML='<i class="fas fa-spinner fa-spin"></i>');J.firstChild;)J.removeChild(J.firstChild);const q=document.createElement("source");if(q.src=`/api/music/serve/${encodeURIComponent(w.filePath)}`,q.type="audio/flac",J.appendChild(q),J.load(),he.style.display==="none"&&at.style.display==="none"){console.log("[MUSIC] Player was closed, aborting playback");return}try{await J.play()}catch{if(await new Promise(Q=>setTimeout(Q,150)),he.style.display==="none"&&at.style.display==="none"){console.log("[MUSIC] Player was closed during retry, aborting playback");return}await J.play()}if(he.style.display==="none"&&at.style.display==="none"){J.pause();return}tt.innerHTML='<i class="fas fa-pause"></i>',Ye&&(Ye.innerHTML='<i class="fas fa-pause"></i>'),an(),Cd(l,f,"");return}ni?(at.style.display="block",he.style.display="none"):(he.style.display="flex",at.style.display="none"),pn.textContent="Now Playing",xt.textContent=l,Yt.textContent=f,v&&(Ne.src=v),tt.innerHTML='<i class="fas fa-spinner fa-spin"></i>',Eo&&(Eo.textContent=l),bo&&(bo.textContent=f),Ye&&(Ye.innerHTML='<i class="fas fa-spinner fa-spin"></i>');const h=await musicFetchJson(`/track/?id=${encodeURIComponent(s)}&quality=LOSSLESS`);if(he.style.display==="none"&&at.style.display==="none"){console.log("[MUSIC] Player was closed during fetch, aborting playback");return}let T=null;if(Array.isArray(h)&&h.length>=3&&(T=h[2]?.OriginalTrackUrl||h[2]?.originalTrackUrl),!T&&Array.isArray(h))for(const q of h){const V=q?.OriginalTrackUrl||q?.originalTrackUrl;if(V&&!V.startsWith("http://www.tidal.com")){T=V;break}}if(!T)throw new Error("Track URL not found");for(;J.firstChild;)J.removeChild(J.firstChild);const x=document.createElement("source");x.src=T;const O=T.toLowerCase();if(O.includes(".flac")?x.type="audio/flac":O.includes(".mp4")||O.includes(".m4a")?x.type="audio/mp4":O.includes(".aac")?x.type="audio/aac":(O.includes(".ogg")||O.includes(".ogx"))&&(x.type="audio/ogg"),J.appendChild(x),J.load(),he.style.display==="none"&&at.style.display==="none"){console.log("[MUSIC] Player was closed before playback, aborting");return}try{await J.play()}catch{if(await new Promise(V=>setTimeout(V,150)),he.style.display==="none"&&at.style.display==="none"){console.log("[MUSIC] Player was closed during retry, aborting playback");return}await J.play()}if(he.style.display==="none"&&at.style.display==="none"){J.pause();return}tt.innerHTML='<i class="fas fa-pause"></i>',Ye&&(Ye.innerHTML='<i class="fas fa-pause"></i>'),an(),Cd(l,f,"")}catch(E){console.error("[MUSIC] Play error",E),showNotification("Failed to play track","error"),(he.style.display!=="none"||at.style.display!=="none")&&(he.style.display="none",at.style.display="none")}}function Lo(){yi&&la();try{if(J){try{J.pause()}catch{}for(J.removeAttribute("src");J.firstChild;)J.removeChild(J.firstChild);J.load()}}catch{}Yr&&(Yr.style.width="0%"),Jr&&(Jr.textContent="0:00"),Xr&&(Xr.textContent="0:00"),tt&&(tt.innerHTML='<i class="fas fa-play"></i>'),he&&(he.style.display="none"),at&&(at.style.display="none"),ni=!1}let ct=[],bt=0;const cs="pt_music_autoplay_next_v1";let vn=!1,ni=!1;try{vn=localStorage.getItem(cs)==="1"}catch{}function ls(){yn&&(vn?(yn.style.background="linear-gradient(135deg, rgba(236,72,153,0.25), rgba(168,85,247,0.25))",yn.style.borderColor="rgba(236,72,153,0.55)",yn.style.color="#fff"):(yn.style.background="rgba(236,72,153,0.08)",yn.style.borderColor="rgba(236,72,153,0.35)",yn.style.color="#ec4899"))}ls(),yn&&yn.addEventListener("click",()=>{vn=!vn;try{localStorage.setItem(cs,vn?"1":"0")}catch{}ls(),showNotification(`Autoplay ${vn?"enabled":"disabled"}`,"info")});function oi(s,l){if(!Array.isArray(s)||s.length===0)return ct=[],bt=0,!1;ct=s,bt=Math.max(0,Math.min(l||0,s.length-1));const f=ct[bt];return hn({trackId:f.id,title:f.title,artistName:f.artist,coverSrc:f.cover}),!0}function An(s){if(!s||s.length===0){showNotification("No tracks to play","info");return}vn=!0;try{localStorage.setItem(cs,"1")}catch{}ls(),ct=s,bt=0;const l=s[0];hn({trackId:l.id,title:l.title,artistName:l.artist,coverSrc:l.cover}),showNotification(`Playing ${s.length} track${s.length!==1?"s":""}`,"success")}function ds(){if(ct.length===0)return;if(bt++,bt>=ct.length){ct=[],bt=0,showNotification("Queue finished","info"),vn&&Lo();return}const s=ct[bt];hn({trackId:s.id,title:s.title,artistName:s.artist,coverSrc:s.cover})}function Oc(){if(ct.length===0)return;if((J?.currentTime||0)>3){try{J.currentTime=0}catch{}return}if(bt<=0)return;bt--;const s=ct[bt];hn({trackId:s.id,title:s.title,artistName:s.artist,coverSrc:s.cover})}function an(){Jr.textContent=Xo(J.currentTime||0),Xr.textContent=Xo(J.duration||0);const s=(J.currentTime||0)/(J.duration||1)*100;Yr.style.width=`${s}%`,ec&&(ec.textContent=Xo(J.currentTime||0)),tc&&(tc.textContent=Xo(J.duration||0)),Ga&&(Ga.style.width=`${s}%`)}function Nf(){he&&(he.style.display="none"),at&&(at.style.display="block"),ni=!0,Ye&&(Ye.innerHTML=J.paused?'<i class="fas fa-play"></i>':'<i class="fas fa-pause"></i>')}function Mf(){at&&(at.style.display="none"),he&&(he.style.display="flex"),ni=!1}if(J&&(J.addEventListener("timeupdate",an),J.addEventListener("loadedmetadata",an),J.addEventListener("ended",()=>{if(tt.innerHTML='<i class="fas fa-play"></i>',Ye&&(Ye.innerHTML='<i class="fas fa-play"></i>'),vn){if(ct.length>0&&bt<ct.length-1){setTimeout(()=>ds(),400);return}(ct.length===0||bt>=ct.length-1)&&setTimeout(()=>Lo(),250)}})),tt&&tt.addEventListener("click",async()=>{if(J.paused){try{await J.play()}catch{}tt.innerHTML='<i class="fas fa-pause"></i>',Ye&&(Ye.innerHTML='<i class="fas fa-pause"></i>')}else J.pause(),tt.innerHTML='<i class="fas fa-play"></i>',Ye&&(Ye.innerHTML='<i class="fas fa-play"></i>')}),Yn&&Yn.addEventListener("click",()=>{J.currentTime=Math.max(0,(J.currentTime||0)-10),an()}),Jo&&Jo.addEventListener("click",()=>{const s=J.duration||0;J.currentTime=Math.min(s,(J.currentTime||0)+10),an()}),Jn&&Jn.addEventListener("click",()=>{ct.length!==0&&(bt<ct.length-1?ds():Lo())}),Ot&&Ot.addEventListener("click",()=>{Oc()}),Kr&&Kr.addEventListener("click",s=>{const l=Kr.getBoundingClientRect(),f=s.clientX-l.left,v=Math.min(1,Math.max(0,f/l.width));J.currentTime=v*(J.duration||0),an()}),Qr){const s=l=>{const f=Qr.getBoundingClientRect(),v=l-f.left,E=Math.min(1,Math.max(0,v/f.width));J.volume=E,vf.style.width=`${E*100}%`};Qr.addEventListener("click",l=>s(l.clientX))}Lt&&he&&(Lt.addEventListener("click",Lo),he.addEventListener("click",s=>{s.target===he&&Lo()})),tn&&tn.addEventListener("click",()=>{Nf(),Eo&&(Eo.textContent=xt.textContent),bo&&(bo.textContent=Yt.textContent)}),Ya&&Ya.addEventListener("click",Mf),Ye&&Ye.addEventListener("click",async()=>{if(J.paused){try{await J.play()}catch{}Ye.innerHTML='<i class="fas fa-pause"></i>',tt.innerHTML='<i class="fas fa-pause"></i>'}else J.pause(),Ye.innerHTML='<i class="fas fa-play"></i>',tt.innerHTML='<i class="fas fa-play"></i>'}),Ja&&Ja.addEventListener("click",()=>{J.currentTime=Math.max(0,(J.currentTime||0)-10),an()}),Xa&&Xa.addEventListener("click",()=>{const s=J.duration||0;J.currentTime=Math.min(s,(J.currentTime||0)+10),an()}),Qa&&Qa.addEventListener("click",()=>{ct.length>0&&bt>0&&Oc()}),Za&&Za.addEventListener("click",()=>{ct.length>0&&bt<ct.length-1&&ds()}),Zr&&Zr.addEventListener("click",s=>{const l=Zr.getBoundingClientRect(),f=s.clientX-l.left,v=Math.min(1,Math.max(0,f/l.width));J.currentTime=v*(J.duration||0),an()}),document.addEventListener("keydown",s=>{if(!he||he.style.display==="none")return;const l=document.activeElement&&document.activeElement.tagName||"",f=["INPUT","TEXTAREA"].includes(l);s.key==="Escape"?(s.preventDefault(),Lo()):s.key===" "&&!f&&(s.preventDefault(),J.paused?(J.play(),tt.innerHTML='<i class="fas fa-pause"></i>',Ye&&(Ye.innerHTML='<i class="fas fa-pause"></i>')):(J.pause(),tt.innerHTML='<i class="fas fa-play"></i>',Ye&&(Ye.innerHTML='<i class="fas fa-play"></i>')))}),wo&&Qe&&(wo.addEventListener("click",()=>ic(Qe.value)),Qe.addEventListener("keydown",s=>{s.key==="Enter"&&ic(Qe.value)}));function Dc(){Ee.style.display="none",be.src="",document.body.classList.remove("books-reader-open")}$&&$.addEventListener("click",()=>{const s=P.value;re(s)}),P&&P.addEventListener("keypress",s=>{if(s.key==="Enter"){const l=P.value;re(l)}}),fe&&fe.addEventListener("click",Dc),Ee?.addEventListener("click",s=>{s.target===Ee&&Dc()});const Rf=[{name:"Videasy",getUrl:(s,l,f,v)=>s==="movie"?`https://player.videasy.net/movie/${l}`:`https://player.videasy.net/tv/${l}/${f}/${v}`},{name:"LunaStream",getUrl:(s,l,f,v)=>s==="movie"?`https://lunastream.fun/watch/movie/${l}`:`https://lunastream.fun/watch/tv/${l}/${f}/${v}`},{name:"VidRock",getUrl:(s,l,f,v)=>s==="movie"?`https://vidrock.net/movie/${l}`:`https://vidrock.net/tv/${l}/${f}/${v}`},{name:"HexaWatch",getUrl:(s,l,f,v)=>s==="movie"?`https://hexa.watch/watch/movie/${l}`:`https://hexa.watch/watch/tv/${l}/${f}/${v}`},{name:"FMovies",getUrl:(s,l,f,v)=>s==="movie"?`https://www.fmovies.gd/watch/movie/${l}`:`https://www.fmovies.gd/watch/tv/${l}/${f}/${v}`},{name:"Xprime",getUrl:(s,l,f,v)=>s==="movie"?`https://xprime.tv/watch/${l}`:`https://xprime.tv/watch/${l}/${f}/${v}`},{name:"Vidnest",getUrl:(s,l,f,v)=>s==="movie"?`https://vidnest.fun/movie/${l}`:`https://vidnest.fun/tv/${l}/${f}/${v}`},{name:"veloratv",getUrl:(s,l,f,v)=>s==="movie"?`https://veloratv.ru/watch/movie/${l}`:`https://veloratv.ru/watch/tv/${l}/${f}/${v}`},{name:"Vidfast 1",getUrl:(s,l,f,v)=>s==="movie"?`https://vidfast.pro/movie/${l}`:`https://vidfast.pro/tv/${l}/${f}/${v}`},{name:"Vidfast 2",getUrl:(s,l,f,v)=>s==="movie"?`https://vidfast.to/embed/movie/${l}`:`https://vidfast.to/embed/tv/${l}/${f}/${v}`},{name:"111Movies",getUrl:(s,l,f,v)=>s==="movie"?`https://111movies.com/movie/${l}`:`https://111movies.com/tv/${l}/${f}/${v}`},{name:"MovieClub",getUrl:(s,l,f,v)=>s==="movie"?`https://moviesapi.club/movie/${l}`:`https://moviesapi.club/tv/${l}-${f}-${v}`},{name:"MapleTV",getUrl:(s,l,f,v)=>s==="movie"?`https://mapple.uk/watch/movie/${l}`:`https://mapple.uk/watch/tv/${l}-${f}-${v}`},{name:"2Embed",getUrl:(s,l,f,v)=>`https://multiembed.mov/?video_id=${l}&tmdb=1&media_type=${s}${s==="tv"?`&season=${f}&episode=${v}`:""}`},{name:"SmashyStream",getUrl:(s,l,f,v)=>s==="movie"?`https://player.smashy.stream/movie/${l}`:`https://player.smashy.stream/tv/${l}?s=${f}&e=${v}`},{name:"Autoembed",getUrl:(s,l,f,v)=>s==="movie"?`https://player.autoembed.cc/embed/movie/${l}`:`https://player.autoembed.cc/embed/tv/${l}/${f}/${v}`},{name:"GoDrivePlayer",getUrl:(s,l,f,v)=>s==="movie"?`https://godriveplayer.com/player.php?imdb=${l}`:`https://godriveplayer.com/player.php?type=tv&tmdb=${l}&season=${f}&episode=${v}`},{name:"VidWTF Premium",getUrl:(s,l,f,v)=>s==="movie"?`https://vidsrc.wtf/api/4/movie/?id=${l}&color=e01621`:`https://vidsrc.wtf/api/4/tv/?id=${l}&s=${f}&e=${v}&color=e01621`}],Oi=document.getElementById("server-selection-modal"),Fc=document.getElementById("server-selection-back");document.getElementById("server-selection-title");const _f=document.getElementById("server-media-poster"),Uf=document.getElementById("server-media-title"),Of=document.getElementById("server-media-subtitle"),Df=document.getElementById("server-media-year"),Ff=document.getElementById("server-media-rating"),Pn=document.getElementById("server-dropdown"),Hc=document.getElementById("server-watch-btn"),Vc=document.getElementById("server-torrent-btn"),Di=document.getElementById("video-player-modal"),jc=document.getElementById("video-player-back"),Hf=document.getElementById("video-player-title"),Fi=document.getElementById("video-player-frame"),qc=document.getElementById("video-player-fullscreen");let $t=null;function Vf(){Pn.innerHTML="",Rf.forEach(s=>{const l=document.createElement("option");l.value=s.name,l.textContent=s.name,s.name===Qi&&(l.selected=!0),Pn.appendChild(l)})}function us(s){$t=s,console.log("[SERVERS] Showing server selection for:",s),Uf.textContent=s.title,Of.textContent=s.subtitle||"",Df.textContent=s.year||"",Ff.textContent=s.rating?`â˜… ${s.rating}`:"",_f.src=s.poster||"",Vf(),Oi.style.display="flex",document.body.classList.add("server-modal-open")}function fs(){console.log("[SERVERS] Hiding server selection modal");const s=document.getElementById("server-video-section");s&&s.style.display!=="none"&&(console.log("[SERVERS] Closing active video player before hiding modal"),Hi()),Oi.style.display="none",document.body.classList.remove("server-modal-open"),$t=null,console.log("[SERVERS] Server selection modal hidden and video stopped")}console.log("[DEBUG] showServerSelection function exists:",typeof us);function jf(s,l){console.log("[SERVERS] Opening video player for:",l,s);const f=ne?.title||ne?.name||l;let v;Pe==="jackett"?v="Jackett":Pe==="nuvio"?v="Nuvio":Pe==="comet"?v="Comet":Pe==="111477"?v="111477":Pe==="moviebox"?v="MovieBox":Pe==="torrentio"?v="Torrentio":Pe==="torrentless"?v="PlayTorrio":v="App Sources",Mo(f,v,Le==="tv"&&je?je:null);const w=document.getElementById("server-video-section"),h=document.getElementById("server-video-title"),T=document.getElementById("server-video-frame");w&&h&&T?(h.textContent=l,T.removeAttribute("sandbox"),T.expectedUrl=s,T.originalDomain=new URL(s).origin,qf(T,s),T.src=s,w.style.display="block",setTimeout(()=>{w.scrollIntoView({behavior:"smooth",block:"start"})},500),console.log("[SERVERS] Embedded video player displayed successfully")):(console.error("[SERVERS] Embedded video elements not found, falling back to fullscreen"),Hf.textContent=l,Fi.removeAttribute("sandbox"),Fi.src=s,Di.style.display="flex",document.body.classList.add("video-modal-open"),fs())}function qf(s,l){const f={"vidrock.net":/^https:\/\/vidrock\.net\/(movie|tv)\/\d+(\?.*)?$/,"hexa.watch":/^https:\/\/hexa\.watch\/watch\/(movie|tv)\/\d+(\?.*)?$/,"www.fmovies.gd":/^https:\/\/www\.fmovies\.gd\/watch\/(movie|tv)\/\d+(\?.*)?$/,"xprime.tv":/^https:\/\/xprime\.tv\/watch\/\d+(\?.*)?$/,"vidnest.fun":/^https:\/\/vidnest\.fun\/(movie|tv)\/\d+(\?.*)?$/,"player.videasy.net":/^https:\/\/player\.videasy\.net\/(movie|tv)\/\d+(\?.*)?$/,"lunastream.fun":/^https:\/\/lunastream\.fun\/watch\/(movie\/\d+|tv\/\d+\/\d+\/\d+)(\?.*)?$/,"veloratv.ru":/^https:\/\/veloratv\.ru\/watch\/(movie|tv)\/\d+(\?.*)?$/,"vidfast.pro":/^https:\/\/vidfast\.pro\/(movie\/\d+|tv\/\d+\/\d+\/\d+)(\?.*)?$/,"vidfast.to":/^https:\/\/vidfast\.to\/embed\/(movie\/\d+|tv\/\d+\/\d+\/\d+)(\?.*)?$/,"111movies.com":/^https:\/\/111movies\.com\/(movie\/\d+|tv\/\d+\/\d+\/\d+)(\?.*)?$/,"moviesapi.club":/^https:\/\/moviesapi\.club\/(movie\/\d+|tv\/\d+-\d+-\d+)(\?.*)?$/,"mapple.uk":/^https:\/\/mapple\.uk\/watch\/(movie\/\d+|tv\/\d+-\d+-\d+)(\?.*)?$/,"multiembed.mov":/^https:\/\/multiembed\.mov\/\?video_id=\d+&tmdb=1&media_type=(movie|tv)(\&.*)?$/,"player.smashy.stream":/^https:\/\/player\.smashy\.stream\/(movie\/\d+|tv\/\d+\?s=\d+&e=\d+)(\?.*)?$/,"player.autoembed.cc":/^https:\/\/player\.autoembed\.cc\/embed\/(movie|tv)\/\d+(\?.*)?$/,"godriveplayer.com":/^https:\/\/godriveplayer\.com\/player\.php\?(imdb=\d+|type=tv&tmdb=\d+&season=\d+&episode=\d+)(\&.*)?$/,"databasegdriveplayer.xyz":/^https:\/\/databasegdriveplayer\.xyz\/+player\.php\?tmdb=\d+(\&.*)?$/,"database.gdriveplayer.us":/^https:\/\/database\.gdriveplayer\.us\/player\.php\?type=series&tmdb=\d+&season=\d+&episode=\d+(\&.*)?$/,"cinemaos.tech":/^https:\/\/cinemaos\.tech\/player\/\d+(?:\/\d+\/\d+)?(\?.*)?$/,"primesrc.me":/^https:\/\/primesrc\.me\/embed\/(movie|tv)\?tmdb=\d+(?:&season=\d+&episode=\d+)?(\&.*)?$/,"vidsrc.wtf":/^https:\/\/vidsrc\.wtf\/api\/(1|2|3|4)\/(movie|tv)\/\?id=\d+(\&.*)?$/},v=new URL(l).hostname,E=f[v];if(!E){console.warn("[SERVERS] No URL pattern defined for domain:",v);return}console.log("[SERVERS] Setting up URL monitoring for domain:",v),console.log("[SERVERS] Expected URL pattern:",E),console.log("[SERVERS] Initial URL:",l),s.addEventListener("load",function(){try{const h=s.contentWindow.location.href;if(console.log("[SERVERS] Iframe loaded URL:",h),E.test(h))console.log("[SERVERS] âœ… URL pattern valid:",h);else{console.error("[SERVERS] âŒ URL VIOLATION DETECTED!"),console.error("[SERVERS] Current URL:",h),console.error("[SERVERS] Expected pattern:",E.toString()),console.error("[SERVERS] Closing player immediately!"),Hi();return}}catch{console.log("[SERVERS] Iframe access blocked (CORS) - this is normal for streaming sites")}}),s.addEventListener("beforeunload",function(){console.log("[SERVERS] Iframe beforeunload detected - page changing")});const w=setInterval(()=>{try{if(!s||!s.contentWindow||!s.parentNode){console.log("[SERVERS] Iframe no longer exists, clearing monitor"),clearInterval(w);return}const h=s.contentWindow.location.href;if(h&&!E.test(h)){console.error("[SERVERS] âŒ PERIODIC CHECK: URL violation detected!"),console.error("[SERVERS] Current URL:",h),console.error("[SERVERS] Expected pattern:",E.toString()),clearInterval(w),console.log("[SERVERS] Player closed: Detected navigation away from streaming content"),Hi();return}console.log("[SERVERS] ðŸ” Periodic check: URL monitoring active")}catch{console.log("[SERVERS] ðŸ” Periodic check: CORS blocked (streaming site active)")}},1e3);s.monitorInterval=w}function Hi(){console.log("[SERVERS] Closing video player due to URL violation"),pi&&la();const s=document.getElementById("server-video-section"),l=document.getElementById("server-video-frame");s&&(s.style.display="none",console.log("[SERVERS] Video player box hidden")),l&&(l.monitorInterval&&(clearInterval(l.monitorInterval),console.log("[SERVERS] URL monitoring interval cleared")),l.src="about:blank",l.removeAttribute("expectedUrl"),l.removeAttribute("originalDomain"),console.log("[SERVERS] Iframe cleared and server removed"));const f=document.getElementById("server-video-title");f&&(f.textContent="Player Closed"),console.log("[SERVERS] Video player completely shut down")}function zc(){Di.style.display="none",Fi.src="",document.body.classList.remove("video-modal-open")}function Wc(s,l){console.log("[SERVERS] Generating URL for server:",l,"media:",s);const v={CinemaOS:(w,h,T,x)=>w==="movie"?`https://cinemaos.tech/player/${h}`:`https://cinemaos.tech/player/${h}/${T}/${x}`,Videasy:(w,h,T,x)=>w==="movie"?`https://player.videasy.net/movie/${h}`:`https://player.videasy.net/tv/${h}/${T}/${x}`,LunaStream:(w,h,T,x)=>w==="movie"?`https://lunastream.fun/watch/movie/${h}`:`https://lunastream.fun/watch/tv/${h}/${T}/${x}`,VidRock:(w,h,T,x)=>w==="movie"?`https://vidrock.net/movie/${h}`:`https://vidrock.net/tv/${h}/${T}/${x}`,HexaWatch:(w,h,T,x)=>w==="movie"?`https://hexa.watch/watch/movie/${h}`:`https://hexa.watch/watch/tv/${h}/${T}/${x}`,FMovies:(w,h,T,x)=>w==="movie"?`https://www.fmovies.gd/watch/movie/${h}`:`https://www.fmovies.gd/watch/tv/${h}/${T}/${x}`,Xprime:(w,h,T,x)=>w==="movie"?`https://xprime.tv/watch/${h}`:`https://xprime.tv/watch/${h}/${T}/${x}`,Vidnest:(w,h,T,x)=>w==="movie"?`https://vidnest.fun/movie/${h}`:`https://vidnest.fun/tv/${h}/${T}/${x}`,veloratv:(w,h,T,x)=>w==="movie"?`https://veloratv.ru/watch/movie/${h}`:`https://veloratv.ru/watch/tv/${h}/${T}/${x}`,"Vidfast 1":(w,h,T,x)=>w==="movie"?`https://vidfast.pro/movie/${h}`:`https://vidfast.pro/tv/${h}/${T}/${x}`,"Vidfast 2":(w,h,T,x)=>w==="movie"?`https://vidfast.to/embed/movie/${h}`:`https://vidfast.to/embed/tv/${h}/${T}/${x}`,"111Movies":(w,h,T,x)=>w==="movie"?`https://111movies.com/movie/${h}`:`https://111movies.com/tv/${h}/${T}/${x}`,"VidSrc 1":(w,h,T,x)=>w==="movie"?`https://vidsrc.wtf/api/1/movie/?id=${h}&color=e01621`:`https://vidsrc.wtf/api/1/tv/?id=${h}&s=${T}&e=${x}&color=e01621`,"VidSrc 2":(w,h,T,x)=>w==="movie"?`https://vidsrc.wtf/api/2/movie/?id=${h}&color=e01621`:`https://vidsrc.wtf/api/2/tv/?id=${h}&s=${T}&e=${x}&color=e01621`,"VidSrc 3":(w,h,T,x)=>w==="movie"?`https://vidsrc.wtf/api/3/movie/?id=${h}&color=e01621`:`https://vidsrc.wtf/api/3/tv/?id=${h}&s=${T}&e=${x}&color=e01621`,"VidSrc 4":(w,h,T,x)=>w==="movie"?`https://vidsrc.wtf/api/4/movie/?id=${h}&color=e01621`:`https://vidsrc.wtf/api/4/tv/?id=${h}&s=${T}&e=${x}&color=e01621`,PrimeSrc:(w,h,T,x)=>w==="movie"?`https://primesrc.me/embed/movie?tmdb=${h}`:`https://primesrc.me/embed/tv?tmdb=${h}&season=${T}&episode=${x}`,MovieClub:(w,h,T,x)=>w==="movie"?`https://moviesapi.club/movie/${h}`:`https://moviesapi.club/tv/${h}-${T}-${x}`,MapleTV:(w,h,T,x)=>w==="movie"?`https://mapple.uk/watch/movie/${h}`:`https://mapple.uk/watch/tv/${h}-${T}-${x}`,"2Embed":(w,h,T,x)=>`https://multiembed.mov/?video_id=${h}&tmdb=1&media_type=${w}${w==="tv"?`&season=${T}&episode=${x}`:""}`,SmashyStream:(w,h,T,x)=>w==="movie"?`https://player.smashy.stream/movie/${h}`:`https://player.smashy.stream/tv/${h}?s=${T}&e=${x}`,Autoembed:(w,h,T,x)=>w==="movie"?`https://player.autoembed.cc/embed/movie/${h}`:`https://player.autoembed.cc/embed/tv/${h}/${T}/${x}`,GoDrivePlayer:(w,h,T,x)=>w==="movie"?`https://godriveplayer.com/player.php?imdb=${h}`:`https://godriveplayer.com/player.php?type=tv&tmdb=${h}&season=${T}&episode=${x}`,"VidWTF Premium":(w,h,T,x)=>w==="movie"?`https://vidsrc.wtf/api/4/movie/?id=${h}&color=e01621`:`https://vidsrc.wtf/api/4/tv/?id=${h}&s=${T}&e=${x}&color=e01621`,"CinemaOS Embed":(w,h,T,x)=>w==="movie"?`https://cinemaos.tech/embed/movie/${h}`:`https://cinemaos.tech/embed/tv/${h}/${T}/${x}`,"GDrivePlayer API":(w,h,T,x)=>w==="movie"?`https://databasegdriveplayer.xyz/player.php?tmdb=${h}`:`https://database.gdriveplayer.us/player.php?type=series&tmdb=${h}&season=${T}&episode=${x}`,Nontongo:(w,h,T,x)=>w==="movie"?`https://nontongo.win/embed/movie/${h}`:`https://nontongo.win/embed/tv/${h}/${T}/${x}`,SpencerDevs:(w,h,T,x)=>w==="movie"?`https://spencerdevs.xyz/movie/${h}`:`https://spencerdevs.xyz/tv/${h}/${T}/${x}`,VidAPI:(w,h,T,x)=>w==="movie"?`https://vidapi.xyz/embed/movie/${h}`:`https://vidapi.xyz/embed/tv/${h}/${T}/${x}`,Vidify:(w,h,T,x)=>w==="movie"?`https://vidify.top/embed/movie/${h}`:`https://vidify.top/embed/tv/${h}/${T}/${x}`,"VidSrc CX":(w,h,T,x)=>w==="movie"?`https://vidsrc.cx/embed/movie/${h}`:`https://vidsrc.cx/embed/tv/${h}/${T}/${x}`,"VidSrc ME":(w,h,T,x)=>w==="movie"?`https://vidsrc.me/embed/movie/${h}`:`https://vidsrc.me/embed/tv/${h}/${T}/${x}`,"VidSrc TO":(w,h,T,x)=>w==="movie"?`https://vidsrc.to/embed/movie/${h}`:`https://vidsrc.to/embed/tv/${h}/${T}/${x}`,"VidSrc VIP":(w,h,T,x)=>w==="movie"?`https://vidsrc.vip/embed/movie/${h}`:`https://vidsrc.vip/embed/tv/${h}/${T}/${x}`,VixSrc:(w,h,T,x)=>w==="movie"?`https://vixsrc.to/movie/${h}/`:`https://vixsrc.to/tv/${h}/${T}/${x}/`}[l];if(!v)return console.error("[SERVERS] Server not found:",l),null;const E=v(s.type,s.id,s.season,s.episode);return console.log("[SERVERS] Generated URL:",E),E}Fc&&Fc.addEventListener("click",fs),Pn&&Pn.addEventListener("change",s=>{Qi=s.target.value,localStorage.setItem("selectedServer",Qi),console.log("[SERVERS] Selected server:",Qi)}),Hc&&Hc.addEventListener("click",()=>{console.log("[SERVERS] Start Watching button clicked!");const s=$t||window.currentMediaData;if(console.log("[SERVERS] currentMediaData:",$t),console.log("[SERVERS] window.currentMediaData:",window.currentMediaData),console.log("[SERVERS] Using mediaData:",s),!s){console.error("[SERVERS] No media data available"),alert("No media selected. Please select a movie or show first.");return}if(s.type==="tv"){const v=s.season||je||Ht||1,E=s.episode||Bt||1;console.log("[SERVERS] TV show detected - Season:",v,"Episode:",E),s.season=v,s.episode=E}const l=Pn?Pn.value:localStorage.getItem("selectedServer")||"VidSrc TO";console.log("[SERVERS] Selected server:",l);const f=Wc(s,l);if(console.log("[SERVERS] Generated stream URL:",f),f){const v=s.type==="tv"?`${s.title} S${s.season}E${s.episode} - ${l}`:`${s.title} - ${l}`;console.log("[SERVERS] Calling showVideoPlayer with:",v),jf(f,v)}else showNotification("Failed to generate streaming URL","error")}),Vc&&Vc.addEventListener("click",()=>{if(console.log("[SERVERS] Use Torrent Instead button clicked!"),localStorage.setItem("useStreamingServers","false"),console.log("[SERVERS] Disabled streaming servers mode"),document.querySelectorAll("#useStreamingServersToggle").forEach(l=>{l.checked=!1}),Vi(),fs(),$t&&$t.fallbackToTorrent)console.log("[SERVERS] Calling fallback function"),$t.fallbackToTorrent();else{console.log("[SERVERS] No fallback function, manually showing torrents");const l=localStorage.getItem("useStreamingServers")==="true";console.log("[SERVERS] Streaming mode after toggle:",l),!l&&typeof wi=="function"&&wi(null,$t?.season,$t?.episode)}});const Kc=document.getElementById("server-video-close"),Yc=document.getElementById("server-video-frame");Kc&&Kc.addEventListener("click",()=>{Hi()}),Pn&&Pn.addEventListener("change",s=>{const l=s.target.value,f=document.getElementById("server-video-section");if(f&&f.style.display!=="none"&&$t){console.log("[SERVERS] Switching to server:",l),localStorage.setItem("selectedServer",l);const v=Wc($t,l);if(v&&Yc){Yc.src=v;const E=document.getElementById("server-video-title");E&&(E.textContent=`${$t.title} - ${l}`),console.log("[SERVERS] Successfully switched to:",l)}else{console.error("[SERVERS] Failed to generate URL for server:",l);const E=localStorage.getItem("selectedServer")||"VidSrc TO";s.target.value=E}}}),jc&&jc.addEventListener("click",()=>{zc(),$t&&us($t)}),qc&&qc.addEventListener("click",()=>{const s=Fi;s.requestFullscreen?s.requestFullscreen():s.webkitRequestFullscreen?s.webkitRequestFullscreen():s.msRequestFullscreen&&s.msRequestFullscreen()}),Oi?.addEventListener("click",s=>{s.target===Oi&&s.stopPropagation()}),document.querySelector("#server-selection-modal .server-selection-content")?.addEventListener("click",s=>s.stopPropagation()),Di?.addEventListener("click",s=>{s.target===Di&&zc()});function Vi(){const s=document.getElementById("watchNowBtn"),l=document.getElementById("watchNowNote"),f=document.getElementById("useStreamsBtn"),v=localStorage.getItem("useStreamingServers")==="true";s&&(v?Le==="tv"?(s.style.display="none",l&&(l.style.display="")):(s.style.display="",s.innerHTML='<i class="fas fa-play"></i> Watch Now',l&&(l.style.display="none")):(s.style.display="",s.innerHTML='<i class="fas fa-play"></i> Find Media',l&&(l.style.display="none"))),f&&(v?f.innerHTML='<i class="fas fa-magnet"></i> Use Torrents instead':f.innerHTML='<i class="fas fa-broadcast-tower"></i> Use Streams instead')}const ms=document.querySelectorAll("#useStreamingServersToggle");if(ms.length>0){const s=localStorage.getItem("useStreamingServers")==="true";ms.forEach(l=>{l.checked=s,l.addEventListener("change",f=>{const v=f.target.checked;localStorage.setItem("useStreamingServers",v),console.log("[SERVERS] Streaming servers mode:",v?"enabled":"disabled"),ms.forEach(E=>E.checked=v),Vi()})})}Vi();const xn=document.getElementById("downloaderQuery"),Jc=document.getElementById("downloaderSearchBtn"),ii=document.getElementById("downloaderResults"),$n=document.getElementById("downloaderEmpty"),ji=document.getElementById("downloaderFilterMovies"),qi=document.getElementById("downloaderFilterTV");let Zn="movies";async function zi(s){if(!ii||!$n)return;const l=(s||"").trim();if(ii.innerHTML="",ii.classList.remove("single"),!l){$n.style.display="",$n.textContent="Type a search above to see results.";return}$n.style.display="none";try{let f=[];try{const w=await fetch(`http://localhost:6987/111477/api/tmdb/search/${encodeURIComponent(l)}`);if(w.ok){const h=await w.json();f=Array.isArray(h?.results)?h.results:[]}}catch{}if(!f.length){const[w,h]=await Promise.all([fetch(`https://api.themoviedb.org/3/search/movie?api_key=${Xe}&query=${encodeURIComponent(l)}&page=1&include_adult=false`),fetch(`https://api.themoviedb.org/3/search/tv?api_key=${Xe}&query=${encodeURIComponent(l)}&page=1&include_adult=false`)]),[T,x]=[await w.json(),await h.json()],O=Array.isArray(T?.results)?T.results.map(V=>({title:V.title,posterPath:V.poster_path?`https://image.tmdb.org/t/p/w500${V.poster_path}`:"",releaseDate:V.release_date||"",year:V.release_date?String(V.release_date).slice(0,4):"",tmdbId:V.id,mediaType:"movie"})):[],q=Array.isArray(x?.results)?x.results.map(V=>({title:V.name,posterPath:V.poster_path?`https://image.tmdb.org/t/p/w500${V.poster_path}`:"",releaseDate:V.first_air_date||"",year:V.first_air_date?String(V.first_air_date).slice(0,4):"",tmdbId:V.id,mediaType:"tv"})):[];f=[...O,...q]}const v=f.filter(w=>{const h=(w.mediaType||w.media_type||(w.firstAirDate||w.name?"tv":"movie")).toLowerCase();return Zn==="movies"?h==="movie":h==="tv"});if(v.length)f=v;else if(Zn==="tv"){const h=await(await fetch(`https://api.themoviedb.org/3/search/tv?api_key=${Xe}&query=${encodeURIComponent(l)}&page=1&include_adult=false`)).json();f=Array.isArray(h?.results)?h.results.map(T=>({title:T.name,posterPath:T.poster_path?`https://image.tmdb.org/t/p/w500${T.poster_path}`:"",releaseDate:T.first_air_date||"",year:T.first_air_date?String(T.first_air_date).slice(0,4):"",tmdbId:T.id,mediaType:"tv"})):[]}else{const h=await(await fetch(`https://api.themoviedb.org/3/search/movie?api_key=${Xe}&query=${encodeURIComponent(l)}&page=1&include_adult=false`)).json();f=Array.isArray(h?.results)?h.results.map(T=>({title:T.title,posterPath:T.poster_path?`https://image.tmdb.org/t/p/w500${T.poster_path}`:"",releaseDate:T.release_date||"",year:T.release_date?String(T.release_date).slice(0,4):"",tmdbId:T.id,mediaType:"movie"})):[]}if(f=f.slice(0,10),!f.length){$n.style.display="",$n.textContent=Zn==="movies"?"No movies found.":"No TV shows found.";return}const E=document.createDocumentFragment();f.forEach(w=>{const h=document.createElement("div");h.className="downloader-item",h.tabIndex=0;const T=w.posterPath||"",x=w.title||w.name||w.constructedName||"Untitled",O=w.year||(w.releaseDate?String(w.releaseDate).slice(0,4):""),q=w.tmdbId||w.id||w.tmdb_id||"",V=w.mediaType||w.media_type||(w.firstAirDate||w.name?"tv":"movie");q&&(h.dataset.tmdbId=String(q)),V&&(h.dataset.mediaType=String(V)),h.innerHTML=`
                            <img loading="lazy" class="downloader-thumb" src="${T}" alt="${x.replace(/"/g,"&quot;")}" onerror="this.style.opacity=0;" />
                            <div class="downloader-meta">
                                <div class="downloader-title">${x}</div>
                                <div class="downloader-year">${O||""}</div>
                            </div>`,h.addEventListener("click",Q=>{Q.preventDefault(),Q.stopPropagation();const ee=ii;document.querySelectorAll(".downloader-item").forEach(pe=>{pe!==h&&pe.remove()}),ee.classList.add("single"),document.querySelectorAll(".downloader-item.selected").forEach(pe=>pe.classList.remove("selected")),h.classList.add("selected");const ue=h.dataset.tmdbId,xe=(h.dataset.mediaType||"movie").toLowerCase();ee.querySelectorAll(".downloader-files-card, .downloader-tv-controls").forEach(pe=>pe.remove()),ue&&(xe==="tv"?Wf(ue,ee):zf(ue,ee))}),E.appendChild(h)}),ii.appendChild(E)}catch(f){console.error("Downloader search failed:",f),$n.style.display="",$n.textContent="Search failed."}}function Xc(s,l,f){if(f&&l.dataset.filesLoadKey&&l.dataset.filesLoadKey!==f)return;const v=document.createElement("div");v.className="trakt-card downloader-files-card",v.style.maxWidth="900px",v.style.width="100%";const E=document.createElement("div");if(E.className="trakt-card-body",E.innerHTML=`<h3 style="margin-bottom:0.75rem;">Available files (${s.length})</h3>`,s.length){const w=document.createElement("div");if(w.style.display="flex",w.style.flexDirection="column",w.style.gap="0.5rem",s.slice(0,100).forEach(h=>{const T=document.createElement("div");T.style.display="flex",T.style.justifyContent="space-between",T.style.alignItems="center",T.style.background="rgba(255,255,255,0.06)",T.style.border="1px solid rgba(255,255,255,0.08)",T.style.borderRadius="10px",T.style.padding="0.6rem 0.8rem";const x=document.createElement("div");x.style.flex="1",x.style.marginRight="0.75rem",x.style.overflow="hidden",x.style.whiteSpace="nowrap",x.style.textOverflow="ellipsis",x.textContent=h.name||"File";const O=document.createElement("div");O.style.color="#9ca3af",O.style.marginRight="0.75rem",O.style.minWidth="80px",O.style.textAlign="right",O.textContent=h.sizeFormatted||"";const q=document.createElement("button");q.className="api-btn api-btn-primary",q.innerHTML='<i class="fas fa-download"></i> Download',q.addEventListener("click",async V=>{V.preventDefault(),V.stopPropagation();const Q=h.url||"";if(Q)try{window.electronAPI?.openExternal?await window.electronAPI.openExternal(Q):window.open(Q,"_blank","noopener")}catch{window.open(Q,"_blank")}}),T.appendChild(x),T.appendChild(O),T.appendChild(q),w.appendChild(T)}),E.appendChild(w),s.length>100){const h=document.createElement("div");h.style.marginTop="0.5rem",h.style.color="#9ca3af",h.style.fontSize="0.9rem",h.style.textAlign="center",h.textContent=`Showing first 100 of ${s.length} files`,E.appendChild(h)}}else{const w=document.createElement("div");w.className="downloader-empty",w.textContent="No files found for this title.",E.appendChild(w)}v.appendChild(E),l.querySelectorAll(".downloader-files-card").forEach(w=>w.remove()),l.appendChild(v)}function Qc(s){const l=`${Date.now()}_${Math.random().toString(36).slice(2)}`;return s.dataset.filesLoadKey=l,l}async function zf(s,l){try{const f=Qc(l),v=await fetch(`http://localhost:6987/111477/api/tmdb/movie/${encodeURIComponent(s)}`);if(!v.ok)throw new Error(`HTTP ${v.status}`);const E=await v.json();let w=[];Array.isArray(E?.results)?E.results.forEach(h=>{h.success&&Array.isArray(h.files)&&(w=w.concat(h.files))}):Array.isArray(E?.files)&&(w=E.files),Xc(w,l,f)}catch(f){console.error("Failed to load files by TMDB id",f),showNotification("Failed to load files for this title")}}async function Wf(s,l){const f=document.createElement("div");f.className="trakt-card downloader-tv-controls",f.style.maxWidth="900px",f.style.width="100%";const v=document.createElement("div");v.className="trakt-card-body",v.innerHTML='<h3 style="margin-bottom:0.75rem;">Pick season and episode</h3>';const E=document.createElement("div");E.style.display="flex",E.style.gap="0.75rem",E.style.alignItems="center",E.style.flexWrap="wrap";const w=document.createElement("label");w.textContent="Season",w.style.marginRight="0.25rem";const h=document.createElement("select");h.style.padding="0.5rem 0.6rem",h.style.borderRadius="8px",h.style.border="1px solid rgba(255,255,255,0.15)",h.style.background="rgba(0,0,0,0.25)",h.style.color="#fff";const T=document.createElement("label");T.textContent="Episode",T.style.marginRight="0.25rem";const x=document.createElement("select");x.style.padding="0.5rem 0.6rem",x.style.borderRadius="8px",x.style.border="1px solid rgba(255,255,255,0.15)",x.style.background="rgba(0,0,0,0.25)",x.style.color="#fff",x.disabled=!0,E.appendChild(w),E.appendChild(h),E.appendChild(T),E.appendChild(x),v.appendChild(E),f.appendChild(v),l.appendChild(f);try{const q=await(await fetch(`https://api.themoviedb.org/3/tv/${encodeURIComponent(s)}?api_key=${Xe}`)).json(),V=q?.number_of_seasons||(Array.isArray(q?.seasons)?q.seasons.length:0),Q=[];for(let ee=1;ee<=V;ee++)Q.push(ee);if(!Q.length){showNotification("No seasons found for this show");return}h.innerHTML=Q.map(ee=>`<option value="${ee}">S${String(ee).padStart(2,"0")}</option>`).join(""),h.addEventListener("change",async()=>{const ee=Number(h.value);x.disabled=!0,x.innerHTML="",l.querySelectorAll(".downloader-files-card").forEach(ue=>ue.remove());try{const xe=await(await fetch(`https://api.themoviedb.org/3/tv/${encodeURIComponent(s)}/season/${encodeURIComponent(ee)}?api_key=${Xe}`)).json(),pe=Array.isArray(xe?.episodes)?xe.episodes.map(Ke=>Ke.episode_number):[];if(!pe.length&&Number.isFinite(xe?.episode_count))for(let Ke=1;Ke<=xe.episode_count;Ke++)pe.push(Ke);x.innerHTML=pe.map(Ke=>`<option value="${Ke}">E${String(Ke).padStart(2,"0")}</option>`).join(""),x.disabled=pe.length===0}catch(ue){console.error("Failed to fetch episodes list",ue),showNotification("Failed to load episodes")}}),x.addEventListener("change",async()=>{const ee=Number(h.value),ue=Number(x.value);l.querySelectorAll(".downloader-files-card").forEach(xe=>xe.remove());try{const xe=Qc(l),pe=await fetch(`http://localhost:6987/111477/api/tmdb/tv/${encodeURIComponent(s)}/season/${encodeURIComponent(ee)}/episode/${encodeURIComponent(ue)}`);if(!pe.ok)throw new Error(`HTTP ${pe.status}`);const Ke=await pe.json();let Ki=[];Array.isArray(Ke?.results)?Ke.results.forEach(ps=>{ps.success&&Array.isArray(ps.files)&&(Ki=Ki.concat(ps.files))}):Array.isArray(Ke?.files)&&(Ki=Ke.files),Xc(Ki,l,xe)}catch(xe){console.error("Failed to load TV episode files",xe),showNotification("Failed to load files for this episode")}}),h.dispatchEvent(new Event("change"))}catch(O){console.error("Failed to fetch TV info",O),showNotification("Failed to load TV seasons")}}ji&&qi&&(ji.addEventListener("click",()=>{Zn!=="movies"&&(Zn="movies",ji.classList.add("active"),qi.classList.remove("active"),xn.value.trim()&&zi(xn.value))}),qi.addEventListener("click",()=>{Zn!=="tv"&&(Zn="tv",qi.classList.add("active"),ji.classList.remove("active"),xn.value.trim()&&zi(xn.value))})),Jc&&xn&&(Jc.addEventListener("click",()=>zi(xn.value)),xn.addEventListener("keydown",s=>{s.key==="Enter"&&zi(xn.value)}));const Zc=document.getElementById("quickRefresh");Zc&&Zc.addEventListener("click",()=>{window.location.reload()});const Gc=document.getElementById("sortBtn"),el=document.getElementById("filterBtn");Gc&&Gc.addEventListener("click",()=>{io==="popularity"?(io="rating",showNotification("Sorted by Rating â­")):io==="rating"?(io="date",showNotification("Sorted by Release Date ðŸ“…")):(io="popularity",showNotification("Sorted by Popularity ðŸ”¥")),cu()}),el&&el.addEventListener("click",()=>{ro==="all"?(ro="hd",showNotification("Filter: HD Quality (7+ rating) ðŸŽ¬")):ro==="hd"?(ro="4k",showNotification("Filter: 4K Quality (8+ rating) âœ¨")):(ro="all",showNotification("Filter: All Content ðŸ“º")),cu()});const ri=document.getElementById("livetv-category-select");ri&&ri.addEventListener("change",()=>{ga(ri.value)});const tl=document.getElementById("livetv-search-input");if(tl){let s;tl.addEventListener("input",()=>{clearTimeout(s),s=setTimeout(()=>{ga(ri?ri.value:"football")},300)})}const nl=document.getElementById("livetv-streams-close");nl&&nl.addEventListener("click",()=>{const s=document.getElementById("livetv-streams-modal");s&&(s.style.display="none")});const ol=document.getElementById("livetv-modal-back");ol&&ol.addEventListener("click",()=>{const s=document.getElementById("livetv-stream-modal"),l=document.getElementById("livetv-stream-iframe");s&&(s.style.display="none"),l&&(l.src="")});const Gn=document.getElementById("livetv-copy-stream-btn");Gn&&Gn.addEventListener("click",async()=>{const l=document.getElementById("livetv-stream-modal")?.dataset.currentStreamUrl;if(l)try{await navigator.clipboard.writeText(l);const f=Gn.innerHTML;Gn.innerHTML='<i class="fas fa-check"></i> Copied!',Gn.style.background="linear-gradient(135deg, #10b981, #059669)",setTimeout(()=>{Gn.innerHTML=f,Gn.style.background="linear-gradient(135deg, #3b82f6, #2563eb)"},2e3)}catch(f){console.error("Failed to copy:",f),showNotification("Failed to copy link","error")}});const Wi=document.getElementById("livetv-streams-modal");Wi&&Wi.addEventListener("click",s=>{s.target===Wi&&(Wi.style.display="none")})}async function ha(){const e=window.location.hash||"#/";if(e==="#/"||e==="#"){Je="home",it("home"),document.body.classList.contains("ui-new")||wt.children.length===0&&(Hn=1,wt.innerHTML="",await _r(bn));return}if(e.startsWith("#/genre/")){const t=decodeURIComponent(e.slice(8)).trim();Je="genreDetails",it("genreDetails"),await va(),await hv(t);return}else if(e==="#/genres"){Je="genres",it("genres"),await va(),gv();return}else if(e==="#/my-list"){Je="my-list",it("my-list"),await displayMyList();return}else if(e==="#/done-watching"){Je="done-watching",it("done-watching"),await displayDoneWatching();return}else if(e==="#/trakt"){Je="trakt",it("trakt");return}else if(e==="#/livetv"){Je="livetv",it("livetv"),await uv();return}else if(e==="#/iptv"){Je="iptv",it("iptv"),Dh();return}else if(e==="#/games-downloader"){Je="games-downloader",it("games-downloader");return}else if(e==="#/minigames"){Je="minigames",it("minigames"),Gh();return}else if(e==="#/books"){Je="books",it("books");return}else if(e==="#/audiobooks"){Je="audiobooks",it("audiobooks");return}else if(e==="#/music"){Je="music",it("music");return}else if(e==="#/booktorrio"){Je="booktorrio",it("booktorrio");return}else if(e==="#/anime"){Je="anime",it("anime");return}else if(e==="#/comics"){Je="comics",it("comics");return}else if(e==="#/manga"){Je="manga",it("manga");return}else if(e==="#/downloader"){Je="downloader",it("downloader");return}else if(e==="#/settings"){Je="settings",it("settings"),await ch();return}Je="home",it("home")}function it(e){if(["homePage","genresPage","genreDetailsPage","myListPage","doneWatchingPage","trakt-page","livetv-page","iptv-page","games-downloader-page","minigames-page","books-page","music-page","audiobooks-page","booktorrio-page","anime-page","comics-page","comics-reader-page","manga-page","manga-reader-page","downloader-page","settings-page"].forEach(i=>{const r=document.getElementById(i);r&&(r.style.display="none")}),e!=="music"){const i=document.getElementById("music-player-audio"),r=document.getElementById("music-player-modal"),a=document.getElementById("music-mini-player");if(!(a&&a.style.display!=="none")){if(i)try{i.pause()}catch{}r&&(r.style.display="none")}}if(e!=="iptv")try{Ho()}catch{}if(e!=="minigames")try{ev()}catch{}const o={home:"homePage",genres:"genresPage",genreDetails:"genreDetailsPage","my-list":"myListPage","done-watching":"doneWatchingPage",trakt:"trakt-page",livetv:"livetv-page",iptv:"iptv-page","games-downloader":"games-downloader-page",minigames:"minigames-page",books:"books-page",music:"music-page",audiobooks:"audiobooks-page",booktorrio:"booktorrio-page",anime:"anime-page",comics:"comics-page","comics-reader":"comics-reader-page",manga:"manga-page","manga-reader":"manga-reader-page",downloader:"downloader-page",settings:"settings-page"}[e];if(o){const i=document.getElementById(o);if(i&&(i.style.display=""),e==="trakt"&&i)if(!i.dataset.initialized)bh(),i.dataset.initialized="true";else try{yo()}catch{}if(e==="comics"&&i)try{initializeComics()}catch(r){console.error("Error initializing comics:",r)}else console.log("[COMICS] Deactivating comics page"),typeof comicsPageActive<"u"&&(comicsPageActive=!1);if(e==="games-downloader"&&i&&!i.dataset.gamesLoaded)try{setTimeout(()=>{Zh(),ff()},100),i.dataset.gamesLoaded="true"}catch(r){console.error("Error loading games:",r)}e==="minigames"&&window.electronAPI?.updateDiscordPresence&&window.electronAPI.updateDiscordPresence({details:"Playing mini games",state:"PlayTorrio MiniGames",largeImageKey:"playtorrio",largeImageText:"PlayTorrio",smallImageKey:"gaming",smallImageText:"Gaming"}).catch(r=>console.error("Discord presence error:",r)),e==="games-downloader"&&window.electronAPI?.updateDiscordPresence&&window.electronAPI.updateDiscordPresence({details:"Browsing PC games",state:"Games Downloader",largeImageKey:"playtorrio",largeImageText:"PlayTorrio",smallImageKey:"download",smallImageText:"Downloading"}).catch(r=>console.error("Discord presence error:",r))}yv(e),pv(e),zt=!1,window.scrollTo({top:0,behavior:"smooth"})}function pv(e){const t=document.getElementById("floatingNavContainer");t&&(e==="home"?t.classList.add("show-on-home"):(t.classList.remove("show-on-home"),t.classList.remove("active")))}function yv(e){document.querySelectorAll(".nav-item[data-page]").forEach(r=>{r.classList.remove("active"),(r.dataset.page===e||e==="genreDetails"&&r.dataset.page==="genres")&&r.classList.add("active")});const n={home:null,genres:document.getElementById("genresBtn"),"my-list":document.getElementById("myListBtn"),"done-watching":document.getElementById("doneWatchingBtn"),trakt:null};Object.values(n).forEach(r=>{r&&r.classList.remove("active")});const o=n[e];o&&o.classList.add("active"),document.querySelectorAll(".bottom-nav-item").forEach(r=>{r.classList.remove("active");const a=r.dataset.page;(e===a||e==="home"&&a==="home"||e==="genreDetails"&&a==="genres")&&r.classList.add("active")})}async function va(){if(!Bd)try{Ml.style.display="block";const[e,t]=await Promise.all([fetch(`https://api.themoviedb.org/3/genre/movie/list?api_key=${Xe}`),fetch(`https://api.themoviedb.org/3/genre/tv/list?api_key=${Xe}`)]),[n,o]=await Promise.all([e.json(),t.json()]),i=new Map;(n.genres||[]).forEach(r=>{const a=r.name.toLowerCase();i.set(a,{name:r.name,movieId:r.id,tvId:null})}),(o.genres||[]).forEach(r=>{const a=r.name.toLowerCase();i.has(a)?i.get(a).tvId=r.id:i.set(a,{name:r.name,movieId:null,tvId:r.id})}),Br=i,Bd=!0}catch(e){console.error("Error loading genres:",e)}finally{Ml.style.display="none"}}function gv(){Nl.innerHTML="",Array.from(Br.values()).sort((t,n)=>t.name.localeCompare(n.name)).forEach(t=>{const n=document.createElement("div");n.className="genre-card",n.innerHTML=`
                    <div class="genre-info">
                        <div class="genre-title">${t.name}</div>
                        <div class="genre-availability">
                            ${t.movieId?'<span class="genre-chip"><i class="fas fa-film"></i> Movie</span>':""}
                            ${t.tvId?'<span class="genre-chip"><i class="fas fa-tv"></i> TV</span>':""}
                        </div>
                    </div>
                `,n.addEventListener("click",()=>{window.location.hash=`#/genre/${encodeURIComponent(t.name)}`}),Nl.appendChild(n)})}function yf(){ef.classList.toggle("active",In==="movie"),tf.classList.toggle("active",In==="tv")}async function hv(e){const t=e.toLowerCase();if(Dn=Br.get(t),Dn||(await va(),Dn=Br.get(t)),!Dn){Rl.textContent=e,br.innerHTML="",Ti.style.display="block";return}Rl.textContent=Dn.name,In=Dn.movieId?"movie":"tv",yf(),br.innerHTML="",Ti.style.display="none",gi=1,await Ka()}function au(e){In=e,yf(),br.innerHTML="",Ti.style.display="none",gi=1,zt=!1,Ka()}async function Ka(){if(zt)return;const e=In==="movie"?Dn.movieId:Dn.tvId;if(!e){Ti.style.display="block";return}zt=!0,_l.style.display="block";try{const t=`https://api.themoviedb.org/3/discover/${In}?api_key=${Xe}&with_genres=${e}&sort_by=popularity.desc&page=${gi}`,i=(await(await fetch(t)).json()).results||[];gi===1&&i.length===0?Ti.style.display="block":(wa(i,In),gi++)}catch(t){console.error("Error loading genre items:",t)}finally{zt=!1,_l.style.display="none"}}function wa(e,t){e.forEach(n=>{if(!n.poster_path)return;const o=document.createElement("div");o.className="movie-card";const i=n.title||n.name||"Untitled",r=(n.release_date||n.first_air_date||"").substring(0,4),a=(n.vote_average||0).toFixed(1),u=t==="movie"?`<button class="done-watching-btn" onclick="toggleDoneWatching(event, ${n.id}, '${t}', '${i.replace(/'/g,"\\'")}', '${n.poster_path}', '${r}', ${n.vote_average||0})">
                        <i class="fas fa-check"></i>
                      </button>`:"";o.innerHTML=`
                    <button class="add-to-list-btn" onclick="toggleMyList(event, ${n.id}, '${t}', '${i.replace(/'/g,"\\'")}', '${n.poster_path}', '${r}', ${n.vote_average||0})">
                        <i class="fas fa-plus"></i>
                    </button>
                    ${u}
                    <img loading="lazy" decoding="async" src="https://image.tmdb.org/t/p/w342${n.poster_path}" alt="${i}" class="movie-poster">
                    <div class="movie-info">
                        <h3 class="movie-title">${i}</h3>
                        <p class="movie-year">${r}</p>
                    </div>
                    <div class="movie-rating">
                        <i class="fas fa-star"></i> ${a}
                    </div>
                `,o.addEventListener("click",()=>kn(n,t)),br.appendChild(o)})}async function _r(e="all"){if(!zt){zt=!0,Er.style.display="block",Hn===1&&(mi=[]);try{let t;e==="all"?t=`https://api.themoviedb.org/3/trending/all/week?api_key=${Xe}&page=${Hn}`:t=`https://api.themoviedb.org/3/trending/${e}/week?api_key=${Xe}&page=${Hn}`;const o=await(await fetch(t)).json();Vo(o.results,Hn>1),Hn++}catch(t){console.error("Error fetching movies:",t)}finally{zt=!1,Er.style.display="none"}}}async function vv(e){if(!zt){if(zt=!0,document.body.classList.contains("ui-new")){const t=document.getElementById("slidersContainer"),n=document.getElementById("heroSection"),o=document.getElementById("backToHomeBtn");t&&(t.style.display="none"),n&&(n.style.display="none"),o&&(o.style.display="block"),wt.style.display="grid"}wt.innerHTML="",Er.style.display="block";try{const n=await(await fetch(`https://api.themoviedb.org/3/search/multi?api_key=${Xe}&query=${encodeURIComponent(e)}&page=1`)).json();di=n.results||[],nf=e,ca=!0,Vo(n.results)}catch(t){console.error("Error searching movies:",t)}zt=!1,Er.style.display="none"}}function Vo(e,t=!0){t?mi=[...mi,...e]:mi=[...e];let n=wv([...e]);const o=document.createDocumentFragment();for(const i of n){if(!i.poster_path)continue;const r=document.createElement("div");r.className="movie-card",r.dataset.rating=i.vote_average||0,r.dataset.date=i.release_date||i.first_air_date||"";const a=i.media_type||"movie",u=a==="movie"?`<button class="done-watching-btn" onclick="toggleDoneWatching(event, ${i.id}, '${a}', '${(i.title||i.name||"").replace(/'/g,"\\'")}', '${i.poster_path}', '${(i.release_date||i.first_air_date||"").substring(0,4)}', ${i.vote_average||0})">
                        <i class="fas fa-check"></i>
                      </button>`:"",m=(i.release_date||i.first_air_date||"").substring(0,4),y=(i.title||i.name||"").replace(/'/g,"\\'"),p=`https://image.tmdb.org/t/p/w342${i.poster_path}`;r.innerHTML=`
                    <button class="add-to-list-btn" onclick="toggleMyList(event, ${i.id}, '${a}', '${y}', '${i.poster_path}', '${m}', ${i.vote_average||0})">
                        <i class="fas fa-plus"></i>
                    </button>
                    ${u}
                    <img loading="lazy" decoding="async" src="${p}" alt="${y}" class="movie-poster">
                    <div class="movie-info">
                        <h3 class="movie-title">${i.title||i.name}</h3>
                        <p class="movie-year">${m}</p>
                    </div>
                    <div class="movie-rating">
                        <i class="fas fa-star"></i> ${Number(i.vote_average||0).toFixed(1)}
                    </div>
                `,r.addEventListener("click",()=>kn(i,i.media_type||null)),o.appendChild(r)}wt.appendChild(o);try{if(document.body.classList.contains("perf-mode"))for(;wt.children.length>300;)wt.removeChild(wt.firstElementChild)}catch{}}function wv(e){let t=[...e];return ro==="hd"?t=t.filter(n=>(n.vote_average||0)>=7):ro==="4k"&&(t=t.filter(n=>(n.vote_average||0)>=8)),io==="rating"?t.sort((n,o)=>(o.vote_average||0)-(n.vote_average||0)):io==="date"&&t.sort((n,o)=>{const i=new Date(n.release_date||n.first_air_date||0);return new Date(o.release_date||o.first_air_date||0)-i}),t}function cu(){wt.innerHTML="",Vo(mi,!1)}async function Ev(){if(console.log("[DEBUG] initializeNewUI() called"),!document.body.classList.contains("ui-new"))return;const e=document.getElementById("heroSection"),t=document.getElementById("slidersContainer"),n=document.getElementById("moviesGrid"),o=document.getElementById("loadingIndicator");console.log("[DEBUG] Elements found:",{heroSection:!!e,slidersContainer:!!t,moviesGrid:!!n,loadingIndicator:!!o}),e&&(e.style.display="block"),t&&(t.style.display="block"),n&&(n.style.display="none"),await Promise.all([bv(),kv()]),Sv(),o&&(o.style.display="none")}async function bv(){try{const t=await(await fetch(`https://api.themoviedb.org/3/trending/all/day?api_key=${Xe}`)).json();if(t.results&&t.results.length>0){const n=t.results[Math.floor(Math.random()*Math.min(5,t.results.length))];Iv(n)}}catch(e){console.error("Error loading hero content:",e)}}function Iv(e){const t=document.getElementById("heroBackdrop"),n=document.getElementById("heroTitle"),o=document.getElementById("heroOverview"),i=document.getElementById("heroYear"),r=document.getElementById("heroRating"),a=document.getElementById("heroRatingValue");document.getElementById("heroRuntime");const u=document.getElementById("heroPlayBtn"),m=document.getElementById("heroInfoBtn");e.backdrop_path&&(t.src=`https://image.tmdb.org/t/p/original${e.backdrop_path}`),n.textContent=e.title||e.name,o.textContent=e.overview||"No description available.";const y=(e.release_date||e.first_air_date||"").substring(0,4);i.textContent=y,e.vote_average&&(r.style.display="flex",a.textContent=Number(e.vote_average).toFixed(1));const p=e.media_type||"movie";u.onclick=()=>kn(e,p),m.onclick=()=>kn(e,p)}async function kv(){try{const[e,t,n,o]=await Promise.all([fetch(`https://api.themoviedb.org/3/trending/all/week?api_key=${Xe}`).then(i=>i.json()),fetch(`https://api.themoviedb.org/3/movie/popular?api_key=${Xe}`).then(i=>i.json()),fetch(`https://api.themoviedb.org/3/movie/top_rated?api_key=${Xe}`).then(i=>i.json()),fetch(`https://api.themoviedb.org/3/tv/popular?api_key=${Xe}`).then(i=>i.json())]);tr("trendingSlider",e.results.slice(0,20)),tr("popularSlider",t.results.slice(0,20)),tr("topratedSlider",n.results.slice(0,20)),tr("tvshowsSlider",o.results.slice(0,20))}catch(e){console.error("Error loading sliders:",e)}}function tr(e,t){const n=document.getElementById(e);n&&(n.innerHTML="",t.forEach(o=>{if(!o.poster_path)return;const i=document.createElement("div");i.className="slider-item";const r=(o.release_date||o.first_air_date||"").substring(0,4),a=o.media_type||(e.includes("tv")?"tv":"movie");i.innerHTML=`
                    <img src="https://image.tmdb.org/t/p/w342${o.poster_path}" alt="${o.title||o.name}" class="slider-poster">
                    <div class="slider-info">
                        <div class="slider-item-title">${o.title||o.name}</div>
                        <div class="slider-item-meta">
                            <span class="slider-rating">
                                <i class="fas fa-star"></i>
                                ${Number(o.vote_average||0).toFixed(1)}
                            </span>
                            <span class="slider-year">${r}</span>
                        </div>
                    </div>
                `,i.onclick=()=>kn(o,a),n.appendChild(i)}))}function Sv(){document.querySelectorAll(".slider-arrow").forEach(n=>{n.addEventListener("click",()=>{const o=n.dataset.slider,i=n.classList.contains("slider-arrow-left"),r=document.querySelector(`#${o}Slider`).parentElement;if(!r)return;const a=810,u=r.scrollLeft,m=i?u-a:u+a;r.scrollTo({left:m,behavior:"smooth"})})}),document.querySelectorAll(".slider-container").forEach(n=>{n.addEventListener("scroll",()=>{lu(n)}),lu(n)})}function lu(e){if(!e.querySelector(".slider-track"))return;const n=e.closest(".slider-section");if(!n)return;const o=n.querySelector(".slider-arrow-left"),i=n.querySelector(".slider-arrow-right"),r=e.scrollLeft,a=e.scrollWidth,u=e.clientWidth;o&&o.classList.toggle("disabled",r<=0),i&&i.classList.toggle("disabled",r+u>=a-10)}function Tv(e){let t=!1;if(!(document.body.classList.contains("ui-new")&&Je==="home"&&bn==="all")){if(document.body.classList.contains("ui-new")){const n=document.querySelector(".app-main main");if(n){const o=n.scrollTop,i=n.scrollHeight,r=n.clientHeight;t=o+r>=i-500&&!zt}}else t=window.innerHeight+window.scrollY>=document.body.offsetHeight-500&&!zt;t&&(Je==="home"?_r(bn):Je==="genreDetails"&&Ka())}}async function kn(e,t=null){ne=e,t?Le=t==="tv"?"tv":"movie":e.media_type?Le=e.media_type==="tv"?"tv":"movie":Le=e.name&&!e.title?"tv":"movie",console.log("[MODAL] Opening modal for:",e.title||e.name,"Type:",Le),ja.style.display="none",Ct.innerHTML="",Mg.src=`https://image.tmdb.org/t/p/w1280${e.backdrop_path||e.poster_path||""}`,Rg.src=`https://image.tmdb.org/t/p/w342${e.poster_path||e.backdrop_path||""}`,_g.textContent=e.title||e.name||"Untitled",Ug.textContent=Number(e.vote_average||0).toFixed(1),Og.textContent=(e.release_date||e.first_air_date||"").substring(0,4),Hg.textContent=e.overview||"",Ge=e,hh();try{await loadDoneWatching()}catch{}const n=document.getElementById("modalDoneWatchingBtn");if(n){const i=Le,r=(e.title||e.name||"").replace(/'/g,"\\'"),a=e.poster_path||"",u=(e.release_date||e.first_air_date||"").substring(0,4),m=e.vote_average||0;n.setAttribute("onclick",`toggleDoneWatching(event, ${e.id}, '${i}', '${r}', '${a}', '${u}', ${m})`);const y=(Array.isArray(_t)?_t:[]).some(p=>p.id===e.id&&p.media_type===i&&!p.season&&!p.episode);n.classList.toggle("is-done",!!y),n.innerHTML=`<i class="fas ${y?"fa-check-circle":"fa-check"}"></i>`,n.title=y?"Remove from Done Watching":"Mark as Done Watching"}const o=`https://api.themoviedb.org/3/${Le}/${e.id}?api_key=${Xe}&append_to_response=credits,similar`;try{const r=await(await fetch(o)).json();if(Dg.textContent=r.runtime?`${r.runtime} min`:r.episode_run_time&&r.episode_run_time.length?`${r.episode_run_time[0]} min`:"",Fg.textContent=r.tagline||"",Lv(r.credits?.cast||[]),Cv(r.similar?.results||[],Le),Le==="tv"){Dl.style.display="block",Bv(r.seasons||[]);const a=(r.seasons||[]).find(u=>u.season_number!==0);a&&(je=a.season_number,gf(a.season_number))}else Dl.style.display="none"}catch(i){console.error("Error fetching details:",i)}Ir.classList.add("active"),document.body.style.overflow="hidden";try{updateWatchButtonText()}catch{}}function du(){Ir.classList.remove("active"),document.body.style.overflow="auto",Pe="playtorrio",document.querySelectorAll(".provider-btn").forEach(e=>{e.dataset.provider==="playtorrio"?e.classList.add("active"):e.classList.remove("active")}),Ht=null,Bt=null}function Lv(e){Ul.innerHTML="",(e||[]).slice(0,10).forEach(t=>{const n=document.createElement("div");n.className="cast-card",n.innerHTML=`
                    <img src="${t.profile_path?`https://image.tmdb.org/t/p/w185${t.profile_path}`:"https://via.placeholder.com/185x278"}" alt="${t.name}" class="cast-img">
                    <p class="cast-name">${t.name}</p>
                    <p class="cast-character">${t.character||""}</p>
                `,Ul.appendChild(n)})}function Cv(e,t){Ol.innerHTML="",(e||[]).slice(0,5).forEach(n=>{if(!n.poster_path)return;const o=document.createElement("div");o.className="movie-card",o.innerHTML=`
                    <img src="https://image.tmdb.org/t/p/w300${n.poster_path}" alt="${n.title||n.name}" class="movie-poster" style="height: 225px;">
                    <div class="movie-info">
                        <h3 class="movie-title">${n.title||n.name}</h3>
                    </div>
                `,o.addEventListener("click",()=>kn(n,t)),Ol.appendChild(o)})}function Bv(e){Fl.innerHTML="",e.forEach(t=>{if(t.season_number===0)return;const n=document.createElement("button");n.className="season-btn",n.textContent=t.name,n.dataset.seasonNumber=t.season_number,t.season_number===je&&n.classList.add("active"),n.addEventListener("click",()=>{je=t.season_number,document.querySelectorAll(".season-btn").forEach(o=>o.classList.remove("active")),n.classList.add("active"),gf(je),ja.style.display="block",Or(je)}),Fl.appendChild(n)})}async function gf(e){ia.innerHTML='<div class="loading"><i class="fas fa-spinner"></i></div>';try{const n=await(await fetch(`https://api.themoviedb.org/3/tv/${ne.id}/season/${e}?api_key=${Xe}`)).json();Av(n.episodes||[])}catch(t){console.error(`Error fetching episodes for season ${e}:`,t)}}function Av(e){ia.innerHTML="",e.forEach(t=>{const n=document.createElement("div");n.className="episode-card";const o=_t.some(i=>i.id===Ge.id&&i.media_type==="tv"&&i.season===je&&i.episode===t.episode_number);n.innerHTML=`
                    <img src="${t.still_path?`https://image.tmdb.org/t/p/w300${t.still_path}`:"https://via.placeholder.com/300x169"}" alt="${t.name}" class="episode-img">
                    <div class="episode-info">
                        <h4 class="episode-title">E${t.episode_number}: ${t.name}</h4>
                        <p class="episode-date">${t.air_date||""}</p>
                        <div class="episode-actions">
                            <button class="episode-done-btn ${o?"is-done":""}" 
                                    onclick="toggleEpisodeDoneWatching(event, ${Ge.id}, '${Ge.title||Ge.name}', ${je}, ${t.episode_number}, '${t.name.replace(/'/g,"\\'")}', '${Ge.release_date?.substring(0,4)||Ge.first_air_date?.substring(0,4)||""}', '${Ge.poster_path||""}')"
                                    title="${o?"Remove from Done Watching":"Mark Episode as Done Watching"}">
                                <i class="fas ${o?"fa-check-circle":"fa-check"}"></i>
                            </button>
                        </div>
                    </div>
                `,n.addEventListener("click",i=>{if(!i.target.closest(".episode-done-btn")){console.log("[DEBUG] Episode card clicked! Season:",je,"Episode:",t.episode_number),document.querySelectorAll(".episode-card").forEach(r=>r.classList.remove("selected")),n.classList.add("selected");try{wi(i,je,t.episode_number)}catch(r){console.error("[DEBUG] Error in episode showTorrents:",r)}}}),ia.appendChild(n)})}function wi(e,t=null,n=null){const o=localStorage.getItem("useStreamingServers")==="true";if(console.log("[SERVERS] showTorrents called with streaming mode:",o),console.log("[SERVERS] Season:",t,"Episode:",n),o){console.log("[SERVERS] Streaming servers enabled, showing server selection"),Pv(t,n);return}console.log("[SERVERS] Streaming servers disabled, showing torrents"),ja.style.display="block",Or(t,n)}function Pv(e=null,t=null){if(console.log("[SERVERS] showStreamingServerSelection called with:",{season:e,episode:t}),!ne){console.error("[SERVERS] No currentContent available"),showNotification("No content selected","error");return}console.log("[SERVERS] Current content:",ne),console.log("[SERVERS] Current media type:",Le);const n={type:Le,id:ne.id,title:ne.title||ne.name,season:e,episode:t,year:Le==="movie"?(ne.release_date||"").substring(0,4):(ne.first_air_date||"").substring(0,4),rating:ne.vote_average?parseFloat(ne.vote_average).toFixed(1):null,poster:ne.poster_path?`https://image.tmdb.org/t/p/w342${ne.poster_path}`:null,subtitle:e&&t?`Season ${e}, Episode ${t}`:Le==="tv"?"TV Show":"Movie",fallbackToTorrent:()=>{Gu=!1,localStorage.setItem("useStreamingServers","false"),updateWatchButtonText(),wi(null,e,t)}};console.log("[SERVERS] Media data prepared:",n);try{window.currentMediaData=n,currentMediaData=n;const o=document.getElementById("server-selection-modal"),i=document.getElementById("server-media-title"),r=document.getElementById("server-media-subtitle"),a=document.getElementById("server-media-year"),u=document.getElementById("server-media-rating"),m=document.getElementById("server-media-poster"),y=document.getElementById("server-dropdown");if(!o)throw new Error("Server selection modal not found in DOM");if(i&&(i.textContent=n.title),r&&(r.textContent=n.subtitle||""),a&&(a.textContent=n.year||""),u&&(u.textContent=n.rating?`â˜… ${n.rating}`:""),m&&(m.src=n.poster||""),y){const p=localStorage.getItem("selectedServer")||"VidSrc TO";y.innerHTML="";const N=[{name:"CinemaOS"},{name:"Videasy"},{name:"LunaStream"},{name:"Vidfast 1"},{name:"Vidfast 2"},{name:"111Movies"},{name:"VidSrc 1"},{name:"VidSrc 2"},{name:"VidSrc 3"},{name:"VidSrc 4"},{name:"PrimeSrc"},{name:"VidRock"},{name:"HexaWatch"},{name:"FMovies"},{name:"Xprime"},{name:"Vidnest"},{name:"veloratv"},{name:"MovieClub"},{name:"MapleTV"},{name:"2Embed"},{name:"SmashyStream"},{name:"Autoembed"},{name:"GoDrivePlayer"},{name:"VidWTF Premium"},{name:"GDrivePlayer API"},{name:"Nontongo"},{name:"SpencerDevs"},{name:"VidAPI"},{name:"Vidify"},{name:"VidSrc CX"},{name:"VidSrc ME"},{name:"VidSrc TO"},{name:"VidSrc VIP"},{name:"VixSrc"}];console.log("[SERVERS] Using servers array with length:",N.length),N.forEach(I=>{const k=document.createElement("option");k.value=I.name,k.textContent=I.name,I.name===p&&(k.selected=!0),y.appendChild(k)}),console.log("[SERVERS] Dropdown populated with",y.options.length,"options")}o.style.display="flex",document.body.classList.add("server-modal-open"),console.log("[SERVERS] Server selection modal displayed successfully")}catch(o){console.error("[SERVERS] Error showing server selection:",o),alert("Error loading streaming servers: "+o.message)}}async function xv(e=null,t=null){if(!ne)return;const n=document.getElementById("torrentsList");n.innerHTML='<div class="loading"><i class="fas fa-spinner"></i> Searching Nuvio...</div>';try{const o=ne.id,i=Le,r=`https://api.themoviedb.org/3/${i}/${o}/external_ids?api_key=${Xe}`,a=await fetch(r);if(!a.ok)throw new Error("Failed to get IMDB ID from TMDB");const m=(await a.json()).imdb_id;if(!m)throw new Error("No IMDB ID found for this content");const N=(localStorage.getItem("febboxToken")||"").trim()||"eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpYXQiOjE3NTU5MzQ2NzcsIm5iZiI6MTc1NTkzNDY3NywiZXhwIjoxNzg3MDM4Njk3LCJkYXRhIjp7InVpZCI6OTY3OTA3LCJ0b2tlbiI6ImRjZTBiZTUyNzgzODU1Njg5ZjNlMjBhZTIzODU2YzlkIn19.yAuVwTgLyO7sTH5rOi_-UaVAHqO0YzUkykXgQC2ci2E",I="https://nuviostreams.hayd.uk",k=`cookies=${encodeURIComponent(JSON.stringify([N]))}`,A="region=UK3",U="providers=showbox,vidzee,vidsrc,vixsrc,mp4hydra,uhdmovies,moviesmod,4khdhub,topmovies";let W;if(i==="movie")W=`${I}/${k}/${A}/${U}/stream/movie/${encodeURIComponent(m)}.json`;else if(e&&t)W=`${I}/${k}/${A}/${U}/stream/series/${encodeURIComponent(m)}:${encodeURIComponent(e)}:${encodeURIComponent(t)}.json`;else throw new Error("Season and episode required for TV shows");console.log("[Nuvio] Trying direct URL:",W);let Y=null,ae=!1;try{const X=await fetch(W);if(ae=X.ok,!X.ok)throw new Error(`HTTP ${X.status}`);Y=await X.json()}catch(X){console.warn("[Nuvio] Direct fetch failed, falling back to backend proxy:",X?.message||X);let ye;i==="movie"?ye=`${se}/nuvio/stream/movie/${m}?cookie=ui%3D${encodeURIComponent(N)}&region=US`:ye=`${se}/nuvio/stream/series/${m}:${e}:${t}?cookie=ui%3D${encodeURIComponent(N)}&region=US`,console.log("[Nuvio] Fetching via proxy:",ye);const Z=await fetch(ye);if(!Z.ok)throw new Error(`Proxy Nuvio error: ${Z.statusText}`);Y=await Z.json(),ae=!0}if(!ae||!Y)throw new Error("Failed to load Nuvio streams");const Ce=Y.streams||[];if(console.log("[Nuvio] Found",Ce.length,"streams"),Ce.length===0){n.innerHTML='<div class="error-message"><i class="fas fa-info-circle"></i> No Nuvio streams found</div>';return}const G=Ce.map((X,ye)=>({s:X,i:ye})),ve=/moviesmod/i,Se=/1080p/i;G.sort((X,ye)=>{const Z=ve.test(X.s?.name||"")||ve.test(X.s?.title||""),Fe=ve.test(ye.s?.name||"")||ve.test(ye.s?.title||"");if(Z&&!Fe)return-1;if(!Z&&Fe)return 1;if(Z&&Fe){const Ae=Se.test(X.s?.name||"")||Se.test(X.s?.title||""),Et=Se.test(ye.s?.name||"")||Se.test(ye.s?.title||"");if(Ae&&!Et)return-1;if(!Ae&&Et)return 1}return X.i-ye.i}),$o=G.map(X=>X.s).map(X=>{const ye=(X.title||"").match(/([\d.]+)\s*(GB|MB)/i);let Z=0;if(ye){const Fe=parseFloat(ye[1]);Z=ye[2].toUpperCase()==="GB"?Fe*1024*1024*1024:Fe*1024*1024}return{...X,sizeBytes:Z}}),Ea($o)}catch(o){console.error("[Nuvio] Error:",o),n.innerHTML=`<div class="error-message"><i class="fas fa-exclamation-triangle"></i> Nuvio Error: ${o.message}</div>`}}function Ea(e){const t=document.getElementById("torrentsList");if(!e||e.length===0){t.innerHTML='<div class="error-message"><i class="fas fa-info-circle"></i> No streams available</div>';return}let n=e.slice();if(typeof qt=="string"&&qt!=="all"&&(console.log("[Nuvio] Applying size filter:",qt),n=n.filter(r=>Ur(r.sizeBytes)),console.log("[Nuvio] After filter:",n.length,"of",e.length,"streams remain")),n.length===0){t.innerHTML="<p>No streams match your size filter.</p>";return}let o=n.slice();const i=typeof Gt=="string"?Gt:"seeders";i==="size-asc"?(console.log("[Nuvio] Sorting by size ascending"),o.sort((r,a)=>(r.sizeBytes||0)-(a.sizeBytes||0))):i==="size-desc"?(console.log("[Nuvio] Sorting by size descending"),o.sort((r,a)=>(a.sizeBytes||0)-(r.sizeBytes||0))):console.log("[Nuvio] Using default priority order (MoviesMod first)"),t.innerHTML="",o.forEach((r,a)=>{const u=document.createElement("div");u.className="torrent-item",u.style.cursor="default";const m=r.name||`Stream ${a+1}`,y=r.title||"",p=r.url,N=y.split(`
`),I=N[0]||"",k=N[1]||"",U=window.electronAPI?.platform==="darwin"?"":`
                    <button class="torrent-btn vlc-nuvio-btn" data-url="${p}" data-name="${m}">
                        <i class="fas fa-external-link-alt"></i> Open in VLC
                    </button>
                `;u.innerHTML=`
                    <div class="torrent-info">
                        <div class="torrent-name">${m}</div>
                        ${I?`<div style="color: var(--gray); font-size: 0.85rem; margin: 0.25rem 0;">${I}</div>`:""}
                        ${k?`<div class="torrent-details">
                            <span>${k}</span>
                        </div>`:""}
                    </div>
                    <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                        <button class="torrent-btn play-nuvio-btn" data-url="${p}" data-name="${m}">
                            <i class="fas fa-play"></i> Play Now
                        </button>
                        <button class="torrent-btn mpv-nuvio-btn" data-url="${p}" data-name="${m}">
                            <i class="fas fa-external-link-alt"></i> Open in MPV
                        </button>
                        ${U}
                        <button class="torrent-btn cast-nuvio-btn" data-url="${p}" data-name="${m}">
                            <i class="fas fa-tv"></i> Cast
                        </button>
                        <button class="torrent-btn copy-nuvio-btn" data-url="${p}" data-name="${m}">
                            <i class="fas fa-copy"></i> Copy Link
                        </button>
                    </div>
                `,t.appendChild(u)}),document.querySelectorAll(".play-nuvio-btn").forEach(r=>{r.addEventListener("click",async()=>{const a=r.dataset.url,u=r.dataset.name;try{mn=a,jt=u;let m=!1;try{const N=ne?.id?.toString()||"";let I=null,k=null;if(Le==="tv"&&Ht&&Bt&&(I=String(Ht),k=String(Bt)),(await window.electronAPI.spawnMpvjsPlayer({url:a,tmdbId:N,seasonNum:I,episodeNum:k}))?.success){m=!0,showNotification("Player launched");return}}catch{}const y=ne?.title||ne?.name||"Video";Mo(y,"Nuvio",Le==="tv"&&je?je:null),openCustomPlayer()}catch(m){console.error("[Nuvio] Play Now error:",m),showNotification("Failed to play stream","error")}})}),document.querySelectorAll(".mpv-nuvio-btn").forEach(r=>{r.addEventListener("click",()=>{const a=r.dataset.url,u=r.dataset.name;$v(a,u)})}),document.querySelectorAll(".vlc-nuvio-btn").forEach(r=>{r.addEventListener("click",()=>{const a=r.dataset.url,u=r.dataset.name;Nv(a,u)})}),document.querySelectorAll(".cast-nuvio-btn").forEach(r=>{r.addEventListener("click",async()=>{const a=r.dataset.url,u=r.dataset.name;try{mn=a,jt=u,await showChromecastDevicePicker()}catch(m){console.error("[Nuvio] Cast error:",m),showNotification("Failed to initiate casting","error")}})}),document.querySelectorAll(".copy-nuvio-btn").forEach(r=>{r.addEventListener("click",async()=>{const a=r.dataset.url,u=r.dataset.name;try{await navigator.clipboard.writeText(a),showNotification(`Stream link copied: ${u}`,"success")}catch(m){console.error("[Nuvio] Copy error:",m),showNotification("Failed to copy link","error")}})})}async function $v(e,t){try{if(console.log("[Nuvio] Opening in MPV:",e),!window.electronAPI||!window.electronAPI.openInMPV){showNotification("MPV integration not available","error");return}mn=e,jt=t;const n={streamUrl:e,infoHash:null,startSeconds:void 0},o=await window.electronAPI.openInMPV(n);o.success?showNotification("Opened in MPV","success"):showNotification(`MPV Error: ${o.message}`,"error")}catch(n){console.error("[Nuvio] MPV open error:",n),showNotification("Failed to open in MPV","error")}}async function Nv(e,t){try{if(console.log("[Nuvio] Opening in VLC:",e),!window.electronAPI||!window.electronAPI.openInVLC){showNotification("VLC integration not available","error");return}mn=e,jt=t;const n=ne?.title||ne?.name||"Video";Mo(n,"Nuvio",Le==="tv"&&je?je:null);const i={streamUrl:e,infoHash:rr&&rr.infoHash?rr.infoHash:null,startSeconds:De&&typeof De.position=="number"&&De.position>10?Math.floor(De.position):void 0},r=await window.electronAPI.openInVLC(i);r?.success?showNotification("Opened in VLC","success"):showNotification(`VLC Error: ${r?.message||r?.error||"Unknown error"}`,"error")}catch(n){console.error("[Nuvio] VLC open error:",n),showNotification("Failed to open in VLC","error")}}async function Mv(e=null,t=null){if(!ne)return;const n=document.getElementById("torrentsList");n.innerHTML='<div class="loading"><i class="fas fa-spinner"></i> Searching Comet...</div>';try{const o=ne.id,i=Le,r=`https://api.themoviedb.org/3/${i}/${o}/external_ids?api_key=${Xe}`,a=await fetch(r);if(!a.ok)throw new Error("Failed to get IMDB ID from TMDB");const m=(await a.json()).imdb_id;if(!m)throw new Error("No IMDB ID found for this content");const y="eyJtYXhSZXN1bHRzUGVyUmVzb2x1dGlvbiI6MCwibWF4U2l6ZSI6MCwiY2FjaGVkT25seSI6dHJ1ZSwicmVtb3ZlVHJhc2giOnRydWUsInJlc3VsdEZvcm1hdCI6WyJhbGwiXSwiZGVicmlkU2VydmljZSI6InRvcnJlbnQiLCJkZWJyaWRBcGlLZXkiOiIiLCJkZWJyaWRTdHJlYW1Qcm94eVBhc3N3b3JkIjoiIiwibGFuZ3VhZ2VzIjp7ImV4Y2x1ZGUiOltdLCJwcmVmZXJyZWQiOlsiZW4iXX0sInJlc29sdXRpb25zIjp7fSwib3B0aW9ucyI6eyJyZW1vdmVfcmFua3NfdW5kZXIiOi0xMDAwMDAwMDAwMCwiYWxsb3dfZW5nbGlzaF9pbl9sYW5ndWFnZXMiOmZhbHNlLCJyZW1vdmVfdW5rbm93bl9sYW5ndWFnZXMiOmZhbHNlfX0=";let p;if(i==="movie")p=`${se}/comet/stream/movie/${m}?config=${y}`;else if(e&&t)p=`${se}/comet/stream/series/${m}:${e}:${t}?config=${y}`;else throw new Error("Season and episode required for TV shows");console.log("[Comet] Fetching from:",p);const N=await fetch(p);if(!N.ok)throw new Error(`Comet error: ${N.statusText}`);const k=(await N.json()).streams||[];if(console.log("[Comet] Found",k.length,"streams"),k.length===0){n.innerHTML='<div class="error-message"><i class="fas fa-info-circle"></i> No Comet torrents found</div>';return}const A=k.map(U=>{const W=U.infoHash,Y=U.sources||[],ae=U.name||"Unknown",Ce=U.description||"",G=U.behaviorHints&&U.behaviorHints.filename?U.behaviorHints.filename:ae,ve=U.behaviorHints&&U.behaviorHints.filename||G,Se=U.fileIdx!==void 0?U.fileIdx:0;let oe=`magnet:?xt=urn:btih:${W}&dn=${encodeURIComponent(ve)}`;Y.forEach(ye=>{oe+=`&tr=${encodeURIComponent(ye)}`}),Se>0&&(oe+=`&so=${Se}`);let X=0;return U.behaviorHints&&U.behaviorHints.videoSize&&(X=U.behaviorHints.videoSize),{title:G,magnet:oe,seeders:0,size:X,description:Ce}}).filter(Boolean);console.log("[Comet] Converted",A.length,"torrents"),displayTorrents(A,e,t)}catch(o){console.error("[Comet] Error:",o),n.innerHTML=`<div class="error-message"><i class="fas fa-exclamation-triangle"></i> Comet Error: ${o.message}</div>`}}async function Rv(e=null,t=null){if(!ne)return;const n=document.getElementById("torrentsList");n.innerHTML='<div class="loading"><i class="fas fa-spinner"></i> Searching 111477...</div>';try{let o=function(I){const k=["2160p","4K","1080p","720p","480p","360p"];for(const A of k)if(I.includes(A))return A;return I.match(/BluRay|Blu-Ray/i)?"BluRay":I.match(/WEBRip|WEB-DL/i)?"WEB":I.match(/HDTV/i)?"HDTV":"Unknown"},i=function(I){if(!I||I===0)return"Unknown Size";const k=["Bytes","KB","MB","GB","TB"],A=Math.floor(Math.log(I)/Math.log(1024));return parseFloat((I/Math.pow(1024,A)).toFixed(2))+" "+k[A]};const r=ne.id,a=Le;let u;if(a==="movie")u=`http://localhost:6987/111477/api/tmdb/movie/${encodeURIComponent(r)}`;else if(e&&t)u=`http://localhost:6987/111477/api/tmdb/tv/${encodeURIComponent(r)}/season/${encodeURIComponent(e)}/episode/${encodeURIComponent(t)}`;else throw new Error("Season and episode required for TV shows");console.log("[111477] Fetching from:",u);const m=await fetch(u);if(!m.ok)throw new Error(`111477 API error: ${m.statusText}`);const y=await m.json();let p=[];if(Array.isArray(y?.results)?y.results.forEach(I=>{I.success&&Array.isArray(I.files)&&(p=p.concat(I.files))}):Array.isArray(y?.files)&&(p=y.files),console.log("[111477] Found",p.length,"files"),p.length===0){n.innerHTML='<div class="error-message"><i class="fas fa-info-circle"></i> No 111477 streams found</div>';return}const N=p.map(I=>{const k=I.name||"",A=o(k),U=parseInt(I.size)||0,W=i(U);return{...I,quality:A,sizeFormatted:W,sizeBytes:U}});window._last111477Files=N,ba(N)}catch(o){console.error("[111477] Error:",o),n.innerHTML=`<div class="error-message"><i class="fas fa-exclamation-triangle"></i> 111477 Error: ${o.message}</div>`}}function Ur(e){const t=Number(e)||0;try{switch(qt){case"gte-1g":return t>=1024**3;case"gte-2g":return t>=2*1024**3;case"2-4g":return t>=2*1024**3&&t<4*1024**3;case"4-8g":return t>=4*1024**3&&t<8*1024**3;case"gte-8g":return t>=8*1024**3;case"all":default:return!0}}catch{return!0}}function ba(e){const t=document.getElementById("torrentsList");t.innerHTML="";let n=(e||[]).slice();try{const o=typeof Gt=="string"?Gt:"seeders";n=n.filter(i=>Ur(i.sizeBytes)),o==="size-desc"?n.sort((i,r)=>Number(r.sizeBytes||0)-Number(i.sizeBytes||0)):n.sort((i,r)=>Number(i.sizeBytes||0)-Number(r.sizeBytes||0))}catch{}n.forEach(o=>{const i=document.createElement("div");i.className="torrent-item",i.style.display="flex",i.style.justifyContent="space-between",i.style.alignItems="center",i.style.padding="1rem",i.style.marginBottom="0.5rem",i.style.background="rgba(255,255,255,0.05)",i.style.borderRadius="8px",i.style.cursor="pointer";const r=document.createElement("div");r.style.flex="1";const a=document.createElement("div");a.style.fontWeight="500",a.style.marginBottom="0.25rem",a.textContent=o.name||"Unknown";const u=document.createElement("div");u.style.fontSize="0.85rem",u.style.opacity="0.7",u.textContent=`${o.quality} â€¢ ${o.sizeFormatted}`,r.appendChild(a),r.appendChild(u);const m=document.createElement("button");m.className="btn",m.innerHTML='<i class="fas fa-play"></i> Play Now',m.style.marginLeft="1rem",m.onclick=async p=>{if(p.stopPropagation(),!o.url){showNotification("No stream URL available");return}try{const N=ne?.id?.toString()||"";let I=null,k=null;Le==="tv"&&Ht&&Bt&&(I=String(Ht),k=String(Bt));let A=!1;try{(await window.electronAPI.spawnMpvjsPlayer({url:o.url,tmdbId:N,seasonNum:I,episodeNum:k}))?.success&&(A=!0,showNotification("Player launched"))}catch{}if(!A){mn=o.url,jt=o.name||"Video";const U=ne?.title||ne?.name||"Video";Mo(U,"111477",Le==="tv"&&je?je:null),openCustomPlayer()}}catch(N){console.error("[111477] Play Now error:",N),showNotification("Failed to play: "+(N?.message||"Unknown error"))}};const y=document.createElement("button");if(y.className="btn",y.innerHTML='<i class="fas fa-play"></i> Open in MPV',y.style.marginLeft="1rem",y.onclick=async p=>{if(p.stopPropagation(),o.url){console.log("[111477] Opening in MPV:",o.url);try{const N=ne?.title||ne?.name||"Video";Mo(N,"111477",Le==="tv"&&je?je:null);const k=await window.electronAPI.openMPVDirect(o.url);k&&k.success?showNotification("Opening stream in MPV... Please Wait","success",5e3):showNotification("Failed to open in MPV: "+(k?.error||"Unknown error"))}catch(N){console.error("[111477] MPV error:",N),showNotification("Failed to open in MPV: "+N.message)}}else showNotification("No stream URL available")},i.appendChild(r),i.appendChild(m),i.appendChild(y),window.electronAPI.platform==="darwin"){const p=document.createElement("button");p.className="btn",p.innerHTML='<i class="fas fa-film"></i> Open in IINA',p.style.marginLeft="0.5rem",p.onclick=async N=>{if(N.stopPropagation(),o.url){console.log("[IINA] Opening in IINA:",o.url);try{const I=ne?.title||ne?.name||"Video";Mo(I,"IINA",Le==="tv"&&je?je:null);const A=await window.electronAPI.openInIINA({streamUrl:o.url,infoHash:currentInfoHash||null,startSeconds:0});A&&A.success?showNotification("Opening stream in IINA...","success",3e3):A&&A.message&&A.message.includes("not installed")?showNotification("IINA not installed. Please install IINA from iina.io","error",5e3):showNotification("Failed to open in IINA: "+(A?.message||"Unknown error"))}catch(I){console.error("[IINA] Error:",I),showNotification("Failed to open in IINA: "+I.message)}}else showNotification("No stream URL available")},i.appendChild(p)}t.appendChild(i)})}async function hf(e=null,t=null){if(!ne)return;const n=document.getElementById("torrentsList");n.innerHTML='<div class="loading"><i class="fas fa-spinner"></i> Searching MovieBox...</div>';try{const o=ne.id,i=Le,r=k=>{const A=Number(k)||0;if(A<=0)return"";const U=["Bytes","KB","MB","GB","TB"],W=Math.floor(Math.log(A)/Math.log(1024));return`${(A/Math.pow(1024,W)).toFixed(2)} ${U[W]}`};let a;if(i==="movie")a=`http://localhost:6987/moviebox/${encodeURIComponent(o)}`;else if(e&&t)a=`http://localhost:6987/moviebox/tv/${encodeURIComponent(o)}/${encodeURIComponent(e)}/${encodeURIComponent(t)}`;else throw new Error("Season and episode required for TV shows");console.log("[MovieBox] Fetching:",a);const u=await fetch(a,{credentials:"include"});let m="",y=null;try{m=await u.text();try{y=JSON.parse(m)}catch{}}catch{}const p=k=>{if(!k||typeof k!="string")return null;const A=k.match(/\((\d+)\s*seconds?\)/i);return A?parseInt(A[1],10):null};if(!u.ok){const k=y&&typeof y.error=="string"&&y.error||m||u.statusText||"",A=p(k);if(A){n.innerHTML=`<div class="error-message"><i class="fas fa-hourglass-half"></i> MovieBox cooldown: Please wait ${A} seconds and try again.</div>`;return}const U=`MovieBox error: ${u.status} ${u.statusText||""}`.trim();throw new Error(U)}if(y&&y.ok===!1&&typeof y.error=="string"){const k=p(y.error),A=k?`Please wait ${k} seconds and try again.`:"Please wait a bit and try again.";n.innerHTML=`<div class="error-message"><i class="fas fa-hourglass-half"></i> MovieBox cooldown: ${A}</div>`;return}let N=[];if(Array.isArray(y.streams)?N=y.streams:Array.isArray(y.results)?N=y.results.map(k=>{const A=parseInt(k.size,10)||0;return{source:k.source||"unknown",url:k.url,resolutions:(k.resolutions??"").toString(),size:r(A),format:"MP4",codecName:"",headers:{}}}):N=[],console.log("[MovieBox] Found",N.length,"streams"),N.length===0){n.innerHTML='<div class="error-message"><i class="fas fa-info-circle"></i> No MovieBox streams found</div>';return}const I={};for(const k of N){const A=k.source||"unknown";I[A]=I[A]||[],I[A].push(k)}Uv(I)}catch(o){console.error("[MovieBox] Error:",o),n.innerHTML=`<div class="error-message"><i class="fas fa-exclamation-triangle"></i> MovieBox Error: ${o.message}</div>`}}function _v(e){const t=parseInt(String(e).replace(/[^0-9]/g,""),10)||0;return t>=1080?5e6:t>=720?25e5:t>=480?12e5:t>=360?6e5:0}function Uv(e){const t=document.getElementById("torrentsList");t.innerHTML="";const n=Object.keys(e);if(n.length===0){t.innerHTML='<div class="error-message"><i class="fas fa-info-circle"></i> No streams available</div>';return}n.forEach(o=>{const i=e[o]||[],r=i[0],a=document.createElement("div");a.className="torrent-item",a.style.cursor="default",a.innerHTML=`
                    <div class="torrent-info">
                        <div class="torrent-name">MovieBox - ${o}</div>
                        <div class="torrent-details"><span>${r&&r.format||""}${r&&r.codecName?" â€¢ "+r.codecName:""}</span></div>
                    </div>
                    <div class="torrent-actions" data-src="${encodeURIComponent(o)}"></div>
                `,t.appendChild(a);const u=a.querySelector(".torrent-actions");i.forEach(m=>{const y=(m.resolutions||"").toString().trim(),p=y?`${y}${/p$/.test(y)?"":"p"}`:m.format||"Open",N=document.createElement("button");N.className="torrent-btn",N.textContent=p,N.title=`${m.format||""}${m.codecName?" â€¢ "+m.codecName:""}${m.size?" â€¢ "+m.size:""}`.trim(),N.addEventListener("click",()=>Ov(m,y||null)),u.appendChild(N)})})}async function Ov(e,t=null){try{if(!window.electronAPI||!window.electronAPI.openMpvWithHeaders){showNotification("MPV (advanced) integration not available","error");return}const n=e.url,o=e.headers||{},i=o.userAgent||"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/141.0.0.0 Safari/537.36",r=o.referer||"https://fmoviesunblocked.net/",a=o.cookie||"",u=t?_v(t):0,m=await window.electronAPI.openMpvWithHeaders({url:n,userAgent:i,referer:r,cookie:a,hlsBitrate:u||void 0});m?.success?showNotification("Opened in MPV","success"):showNotification(`MPV Error: ${m?.message||"Unknown error"}`,"error")}catch(n){console.error("[MovieBox] MPV open error:",n),showNotification("Failed to open in MPV","error")}}async function Or(e=null,t=null){if(!ne){try{I("Select a movie/show first")}catch{}return}if(Ht=e,Bt=t,Pe==="nuvio")return console.log("[Provider] Routing to Nuvio"),xv(e,t);if(Pe==="comet")return console.log("[Provider] Routing to Comet"),Mv(e,t);if(Pe==="111477")return console.log("[Provider] Routing to 111477"),Rv(e,t);if(Pe==="moviebox")return console.log("[Provider] Routing to MovieBox"),hf(e,t);if((Pe==="torrentio"||Pe==="torrentless"||Pe==="jackett")&&(console.log("[Provider] Explicit override:",Pe),Pe!=="jackett")){if(Pe==="torrentio")try{const S=ne.id,P=Le,$=`https://api.themoviedb.org/3/${P}/${S}/external_ids?api_key=${Xe}`,C=await fetch($);if(!C.ok)throw new Error("Failed to get IMDB ID from TMDB");const F=(await C.json()).imdb_id;if(!F)throw new Error("No IMDB ID found for this content");let j;if(P==="movie")j=`http://localhost:6987/torrentio/api/${F}`;else if(e&&t)j=`http://localhost:6987/torrentio/api/${F}/${e}/${t}`;else throw new Error("Season and episode required for TV shows");Ct.innerHTML='<div class="loading"><i class="fas fa-spinner"></i> Searching Torrentio...</div>';const H=await fetch(j);if(!H.ok)throw new Error(`Torrentio error: ${H.statusText}`);const fe=((await H.json()).streams||[]).map(be=>{const re=be.magnetLink||(be.infoHash?`magnet:?xt=urn:btih:${be.infoHash}`:null);if(!re)return null;const ze=(be.title||"").match(/ðŸ‘¤\s*(\d+)/),Tt=(be.title||"").match(/ðŸ’¾\s*([\d.]+\s*[KMGT]B)/i),Qe=ze?parseInt(ze[1]):0,Kt=(Tt?Tt[1]:"0 B").match(/([\d.]+)\s*([KMGT]?B)/i);let K=0;if(Kt){const de=parseFloat(Kt[1]),ce=Kt[2].toUpperCase(),Me={B:1,KB:1024,MB:1024**2,GB:1024**3,TB:1024**4};K=Math.round(de*(Me[ce]||1))}return{title:(be.title||be.name||"").split(`
`)[0],magnet:re,seeders:Qe,size:K}}).filter(Boolean);r(fe,e,t);return}catch(S){console.error("[Torrentio] Error:",S),Ct.innerHTML=`<div class="error-message"><i class="fas fa-exclamation-triangle"></i> Torrentio Error: ${S.message}</div>`;return}else if(Pe==="torrentless")try{let S=ne.title||ne.name;if(Le==="movie"){const j=(ne.release_date||"").substring(0,4);j&&(S=`${S} ${j}`)}else if(Le==="tv"){if(e&&t){const j=String(e).padStart(2,"0"),H=String(t).padStart(2,"0");S=`${S} S${j}E${H}`}else if(e){const j=String(e).padStart(2,"0");S=`${S} S${j}`}}const P=`http://localhost:6987/torrentless/api/search?q=${encodeURIComponent(S)}&page=1`;Ct.innerHTML='<div class="loading"><i class="fas fa-spinner"></i> Searching Torrentless...</div>';const $=await fetch(P);if(!$.ok)throw new Error(`In-App Scraper error: ${$.statusText}`);const F=((await $.json()).items||[]).map(j=>{const H=parseInt((j.seeds||"0").replace(/,/g,""),10)||0;let te=0;if(j.size){const fe=j.size.match(/([\d.]+)\s*([KMGT]?B)/i);if(fe){const be=parseFloat(fe[1]),re=fe[2].toUpperCase(),ze={B:1,KB:1024,MB:1024**2,GB:1024**3,TB:1024**4};te=Math.round(be*(ze[re]||1))}}return{title:j.name,magnet:j.magnet,seeders:H,size:te}});r(F,e,t);return}catch(S){console.error("[Torrentless] Error:",S),Ct.innerHTML=`<div class="error-message"><i class="fas fa-exclamation-triangle"></i> In-App Scraper Error: ${S.message}</div>`;return}}console.log("[Provider] Using Playtorrio (default torrent search)");let n="torrentio",o=!1;try{const S=await fetch(`${se}/settings`);if(S.ok){const P=await S.json();o=!!P.useTorrentless,n=P.torrentSource||"torrentio",console.log("================================="),console.log("[Torrents] Settings loaded:"),console.log("  useTorrentless:",o),console.log("  torrentSource:",n),console.log("  Mode Decision:"),o?n==="torrentio"?console.log("  â†’ Will use TORRENTIO (useTorrentless=true, source=torrentio)"):n==="in-app-scraper"&&console.log("  â†’ Will use IN-APP SCRAPER (useTorrentless=true, source=in-app-scraper)"):console.log("  â†’ Will use JACKETT (useTorrentless is false)"),console.log("=================================")}}catch(S){console.error("[Torrents] Failed to load settings:",S)}if(Ct.innerHTML='<div class="loading"><i class="fas fa-spinner"></i> Searching...</div>',o){if(n==="torrentio"){console.log("[Torrentio] Using Torrentio API");try{const S=ne.id,P=Le;console.log("[Torrentio] Fetching IMDB ID for:",{tmdbId:S,mediaType:P});const $=`https://api.themoviedb.org/3/${P}/${S}/external_ids?api_key=${Xe}`;console.log("[Torrentio] External IDs URL:",$);const C=await fetch($);if(!C.ok)throw new Error("Failed to get IMDB ID from TMDB");const F=(await C.json()).imdb_id;if(console.log("[Torrentio] Got IMDB ID:",F),!F)throw new Error("No IMDB ID found for this content");let j;if(P==="movie")j=`http://localhost:6987/torrentio/api/${F}`,console.log("[Torrentio] Movie URL:",j);else if(e&&t)j=`http://localhost:6987/torrentio/api/${F}/${e}/${t}`,console.log("[Torrentio] TV Show URL:",j);else throw new Error("Season and episode required for TV shows");console.log("[Torrentio] Fetching from:",j);const H=await fetch(j);if(!H.ok)throw new Error(`Torrentio error: ${H.statusText}`);const te=await H.json();console.log("[Torrentio] Received data:",te);const Ee=te.streams||[];console.log("[Torrentio] Found",Ee.length,"streams");const fe=Ee.map(be=>{const re=be.magnetLink||(be.infoHash?`magnet:?xt=urn:btih:${be.infoHash}`:null);if(!re)return null;const ze=be.title.match(/ðŸ‘¤\s*(\d+)/),Tt=be.title.match(/ðŸ’¾\s*([\d.]+\s*[KMGT]B)/i),Qe=ze?parseInt(ze[1]):0,Kt=(Tt?Tt[1]:"0 B").match(/([\d.]+)\s*([KMGT]?B)/i);let K=0;if(Kt){const de=parseFloat(Kt[1]),ce=Kt[2].toUpperCase(),Me={B:1,KB:1024,MB:1024**2,GB:1024**3,TB:1024**4};K=Math.round(de*(Me[ce]||1))}return{title:be.title.split(`
`)[0]||be.name,magnet:re,seeders:Qe,size:K}}).filter(Boolean);console.log("[Torrentio] Converted",fe.length,"torrents"),r(fe,e,t);return}catch(S){console.error("[Torrentio] Error:",S),Ct.innerHTML=`<div class="error-message"><i class="fas fa-exclamation-triangle"></i> Torrentio Error: ${S.message}</div>`;return}}else if(n==="in-app-scraper"){console.log("[Torrentless] Using In-App Scraper API");try{let S=ne.title||ne.name;if(Le==="movie"){const j=(ne.release_date||"").substring(0,4);j&&(S=`${S} ${j}`)}else if(Le==="tv"){if(e&&t){const j=String(e).padStart(2,"0"),H=String(t).padStart(2,"0");S=`${S} S${j}E${H}`}else if(e){const j=String(e).padStart(2,"0");S=`${S} S${j}`}}const P=`http://localhost:6987/torrentless/api/search?q=${encodeURIComponent(S)}&page=1`;console.log("[Torrentless] Query:",S),console.log("[Torrentless] Fetching from:",P);const $=await fetch(P);if(!$.ok)throw new Error(`In-App Scraper error: ${$.statusText}`);const C=await $.json();console.log("[Torrentless] Raw response:",C);const M=C.items||[];console.log("[Torrentless] Found",M.length,"items");const F=M.map(j=>{const H=parseInt((j.seeds||"0").replace(/,/g,""),10)||0;let te=0;if(j.size){const fe=j.size.match(/([\d.]+)\s*([KMGT]?B)/i);if(fe){const be=parseFloat(fe[1]),re=fe[2].toUpperCase(),ze={B:1,KB:1024,MB:1024**2,GB:1024**3,TB:1024**4};te=Math.round(be*(ze[re]||1))}}return{title:j.name,magnet:j.magnet,seeders:H,size:te}});console.log("[Torrentless] Converted",F.length,"torrents"),r(F,e,t);return}catch(S){console.error("[Torrentless] Error:",S),Ct.innerHTML=`<div class="error-message"><i class="fas fa-exclamation-triangle"></i> Scraper Error: ${S.message}</div>`;return}}Ct.innerHTML='<div class="loading-spinner"><i class="fas fa-spinner fa-spin"></i> Loading torrents...</div>';try{let S=[];if(ne&&ne.external_ids&&ne.external_ids.imdb_id){const P=ne.external_ids.imdb_id;e&&t?S=await lr.getSeriesStreams(P,e,t):S=await lr.getMovieStreams(P)}else throw tmdbId?new Error("IMDb ID required for Torrentio. Please verify metadata."):new Error("Cannot fetch streams without IMDb ID");if(S.length===0){Ct.innerHTML='<div class="no-results">No streams found.</div>';return}r(S,e,t)}catch(S){console.error("[Torrentio] Error fetching streams:",S),Ct.innerHTML=`<div class="error-message"><i class="fas fa-exclamation-triangle"></i> ${S.message}</div>`}}function i(S,P,$){if(!P||!$||!S)return 0;const C=S.toLowerCase(),M=parseInt(P),F=parseInt($),j=[new RegExp(`s0*${M}[\\s._-]*e0*${F}(?!\\d)`,"i"),new RegExp(`s0*${M}\\.e0*${F}(?!\\d)`,"i"),new RegExp(`(?:^|\\D)${M}x0*${F}(?!\\d)`,"i"),new RegExp(`season[\\s._-]*0*${M}[\\s._-]*episode[\\s._-]*0*${F}(?!\\d)`,"i"),new RegExp(`e(?:p)?0*${F}s0*${M}(?!\\d)`,"i"),new RegExp(`s0*${M}ep0*${F}(?!\\d)`,"i"),new RegExp(`[\\[\\(]0*${M}[\\s._-]0*${F}[\\]\\)]`,"i")];for(let H=0;H<j.length;H++)if(j[H].test(C))return 1e3-H*10;return 0}function r(S,P=null,$=null){P&&$&&Le==="tv"?li=(S||[]).map(C=>({...C,episodeMatchScore:i(C.title,P,$)})):li=(S||[]).slice(),Mt=1,a()}function a(){Ct.innerHTML="",console.log("[RENDER] Starting renderTorrentsPage with sort mode:",Gt);const S=Le==="tv"&&Ht&&Bt,P=(li||[]).slice();console.log("[RENDER] Total torrents to sort:",P.length,"isTvEp:",S),P.sort((H,te)=>{if(S){const fe=Number(H.episodeMatchScore||0),be=Number(te.episodeMatchScore||0);if(be!==fe)return be-fe}const Ee=typeof Gt=="string"?Gt:"seeders";if(Ee==="size-asc"){const fe=Number(H.size||0),be=Number(te.size||0);return fe-be}else if(Ee==="size-desc"){const fe=Number(H.size||0);return Number(te.size||0)-fe}else{const fe=Number(H.seeders||0);return Number(te.seeders||0)-fe}}),console.log("[RENDER] After sort, first 3 torrents:"),P.slice(0,3).forEach((H,te)=>{console.log(`  ${te+1}. Size: ${((H.size||0)/1024/1024/1024).toFixed(2)}GB, Seeds: ${H.seeders}, Title: ${H.title?.substring(0,50)}`)});let $=P;const C=xo?xo.value.trim().toLowerCase():"";C&&($=P.filter(H=>(H.title||"").toLowerCase().includes(C)));try{typeof qt=="string"&&qt!=="all"&&($=$.filter(H=>Ur(H.size)))}catch{}if($.length===0){Ct.innerHTML=C?"<p>No torrents match your filter.</p>":"<p>No torrents found. Try enabling <strong>Streaming Servers</strong> in the app settings for more sources.</p>";return}const M=(Mt-1)*zs,F=M+zs;$.slice(M,F).forEach(H=>{const te=document.createElement("div");te.className="torrent-item",te.innerHTML=`
                    <div class="torrent-info">
                        <p class="torrent-name">
                            ${H.title}
                            <span class="cached-badge" style="display:none;">Cached</span>
                        </p>
                        <div class="torrent-details">
                            <span><i class="fas fa-arrow-up"></i> ${H.seeders}</span>
                            <span><i class="fas fa-database"></i> ${((H.size||0)/1024/1024/1024).toFixed(2)} GB</span>
                        </div>
                    </div>
                    <div class="torrent-actions">
                        <button class="btn-play torrent-btn"><i class="fas fa-play"></i> Play</button>
                        <button class="btn-copy torrent-btn"><i class="fas fa-copy"></i> Copy</button>
                    </div>
                `,te.querySelector(".btn-play").addEventListener("click",()=>m(H.magnet)),te.querySelector(".btn-copy").addEventListener("click",()=>N(H.magnet)),Ct.appendChild(te)}),u()}function u(){let S=li;const P=xo?xo.value.trim().toLowerCase():"";P&&(S=li.filter(H=>(H.title||"").toLowerCase().includes(P)));try{typeof qt=="string"&&qt!=="all"&&(S=S.filter(H=>Ur(H.size)))}catch{}const $=Math.ceil(S.length/zs);if($<=1)return;const C=document.createElement("div");C.className="torrent-pagination";const M=document.createElement("button");M.innerHTML='<i class="fas fa-arrow-left"></i>',M.disabled=Mt===1,M.addEventListener("click",()=>{Mt>1&&(Mt--,a())});const F=document.createElement("button");F.innerHTML='<i class="fas fa-arrow-right"></i>',F.disabled=Mt===$,F.addEventListener("click",()=>{Mt<$&&(Mt++,a())});const j=document.createElement("span");j.textContent=`Page ${Mt} of ${$}`,C.appendChild(M),C.appendChild(j),C.appendChild(F),Ct.appendChild(C)}async function m(S){nh(),await Ar();const P=sh(un);if(console.log("[UI][Stream] Starting with settings:",{useDebrid:fn,debridAuth:Vt,debridProvider:un}),fn&&!Vt){console.warn("[UI][Debrid] blocked: enabled but not logged in"),I(`${P} is enabled but you are not logged in. Please log in to continue.`),y();return}if(fn&&Vt&&S&&S.startsWith("magnet:")){console.log("[UI][Stream] Using Debrid path");try{let $=function(K,de,ce){return async Me=>{try{const We=Me?.currentTarget;if(!M(de))return;if(Un&&Un!==de)try{console.log("[UI][Debrid] Disconnecting from previous torrent before file switch:",Un),await fetch(`${se}/debrid/cleanup`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:Un})})}catch(Ne){console.warn("[UI][Debrid] Error cleaning up previous torrent:",Ne?.message)}try{const Ne=String(K.id||K.file||K.filename||K.path||"0");Ze=`debrid:${un}:${de}:${Ne}`,De=await Ln(Ze)}catch{}try{console.log("[UI][Debrid] select-files",{id:de,file:String(K.id||K.file)});const Ne=await fetch(`${se}/debrid/select-files`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:de,files:String(K.id||K.file)})});if(Ne.ok)try{const J=await Ne.json();if(J.reAddedForFileSwitch&&J.id){if(console.log("[UI][Debrid] Torrent re-added for file switch. Old ID:",de,"â†’ New ID:",J.id),de=J.id,Un=J.id,!M(de))return;if(I("Switched to episode "+(K.id||K.file)+" - Reloading file list..."),J.info&&J.info.files){console.log("[UI][Debrid] Reloading file selector with new torrent info");const tt=J.info.files,Yn=tt.filter(Ot=>/\.(mp4|mkv|avi|mov)$/i.test(Ot.path||Ot.filename||"")),Jo=tt.filter(Ot=>/\.(srt|vtt)$/i.test(Ot.path||Ot.filename||""));fe.length=0,fe.push(...Yn),ce.length=0,ce.push(...Jo),cn.innerHTML="",fe.forEach(Ot=>{const Jn=document.createElement("div");Jn.className="file-item",Jn.innerHTML=`<p class="file-name">${re(Ot)} ${Tt(Ot)}</p><p class="file-size">(${ze(Ot)})</p>`,Jn.addEventListener("click",$(Ot,de,Jo)),cn.appendChild(Jn)}),J.info.filename&&(on.textContent=J.info.filename)}}}catch(J){console.warn("[UI][Debrid] Could not parse select-files response:",J?.message)}else{const J=await Ne.text();console.warn("[UI][Debrid] select-files failed",J);try{if(JSON.parse(J).code==="DEBRID_UNAUTH"){I("Real-Debrid authentication expired. Please logout and login again in Settings."),Nt.style.display="none",Zi&&(Zi.textContent="Not logged in");return}}catch{}}}catch(Ne){console.warn("[UI][Debrid] select-files exception",Ne?.message)}let he=Array.isArray(K.links)&&K.links.length?K.links[0]:null;if(!he){I(`Not cached yet on ${P}. Waiting to cacheâ€¦`),Nt.style.display="flex";const Ne=await wo(de,K.id||K.file);if(!M(de))return;if(he=Ne,he&&We)try{const J=We.querySelector(".rd-cache-badge");J&&(J.textContent="Cached",J.style.background="#198754")}catch{}}if(!he){I("Still not cached. Try again later or disable Debrid in Settings to use WebTorrent."),Nt.style.display="none";return}const Lt=await fetch(`${se}/debrid/link`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({link:he})});if(!Lt.ok){console.error("[UI][Debrid] unrestrict/stream resolve failed",await Lt.text()),I(un==="torbox"?"Failed to get stream link":"Failed to unrestrict"),Nt.style.display="none";return}const tn=await Lt.json();if(!tn?.url){console.error("[UI][Debrid] unrestrict response missing url",tn),I("Invalid Debrid URL"),Nt.style.display="none";return}mn=tn.url,jt=eh(K.path||K.filename||"")||re(K),on.textContent=jt||re(K),Nn&&(Nn.textContent="Debrid",Nn.classList.remove("webtorrent"),Nn.classList.add("debrid")),Mn&&(Mn.textContent="Debrid",Mn.classList.remove("webtorrent"),Mn.classList.add("debrid")),Ms.style.display="flex",Nt.style.display="none",I(`Ready via ${P}`);const Yt=ce[0];if(Yt&&Array.isArray(Yt.links)&&Yt.links.length)try{const Ne=await fetch(`${se}/debrid/link`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({link:Yt.links[0]})});if(Ne.ok){const J=await Ne.json();if(J?.url){const tt=await fetch(`${se}/subtitles/download-direct`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({url:J.url,preferredName:re(Yt)})}),Yn=await tt.json();tt.ok&&Yn.url&&(sa=Yn.url)}}else console.warn("[UI][Debrid] sub unrestrict failed",await Ne.text())}catch(Ne){console.warn("[UI][Debrid] sub attach failed",Ne?.message)}}catch{console.error("[UI][Debrid] file play failed"),I("Failed to prepare Debrid file")}}};const C=++Ld,M=K=>ra.classList.contains("active")&&C===Ld&&(!K||Un===K);p(),Nt.style.display="flex",Ms.style.display="none",cn.innerHTML="",ci.innerHTML="",Ns.style.display="none",on.textContent=`Preparing ${P}â€¦`,console.log("[UI][Debrid] prepare addMagnet");const F=await fetch(`${se}/debrid/prepare`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({magnet:S})});if(!F.ok){let K="Debrid prepare failed";try{const de=await F.text();console.error("[UI][Debrid] prepare failed",de);try{const ce=JSON.parse(de);ce&&ce.code==="RD_PREMIUM_REQUIRED"?K=`${P} premium is required to add torrents. Disable Debrid in Settings to use WebTorrent instead.`:ce&&ce.code==="DEBRID_UNAUTH"?(K=`${P} authentication invalid. Please login again.`,Zi&&(Zi.textContent="Not logged in"),y()):ce&&ce.code==="TORBOX_UNIMPLEMENTED"?K="TorBox is not supported yet. Please switch provider in Settings or disable Debrid to use WebTorrent.":ce&&ce.error&&(K=ce.error)}catch{}}catch{}I(K),Nt.style.display="none";return}const j=await F.json(),H=j.id;Un=H;let te=j.info||null;if(!M(H))return;if(!te||!Array.isArray(te.files)||!te.files.length){if(await new Promise(de=>setTimeout(de,900)),!M(H))return;const K=await fetch(`${se}/debrid/files?id=${encodeURIComponent(H)}`);K.ok&&(te=await K.json())}let Ee=te&&te.files||[];if(!Ee.length)for(let K=0;K<8;K++){if(await new Promise(de=>setTimeout(de,1e3)),!M(H))return;try{const de=await fetch(`${se}/debrid/files?id=${encodeURIComponent(H)}`);if(de.ok){const ce=await de.json();if(Ee=ce&&ce.files||[],Ee.length)break}}catch{}}Nt.style.display="none",cn.innerHTML="",on.textContent=te?.filename||P;const fe=Ee.filter(K=>/\.(mp4|mkv|avi|mov)$/i.test(K.path||K.filename||"")),be=Ee.filter(K=>/\.(srt|vtt)$/i.test(K.path||K.filename||"")),re=K=>K.path||K.filename||"file",ze=K=>((K.bytes||K.size||0)/1024/1024).toFixed(2)+" MB",Tt=K=>{const de=K&&K.cached===!0||Array.isArray(K.links)&&K.links.length>0;return`<span class="source-badge rd-cache-badge" style="${de?"background:#198754;":"background:#6c757d;"} margin-left:6px;">${de?"Cached":"Not cached"}</span>`};async function Qe(K,{timeoutMs:de=6e4,intervalMs:ce=2e3}={}){const Me=Date.now();for(console.log("[UI][Debrid] Starting polling for file links...");Date.now()-Me<de;){if(!M(K))return null;try{const We=await fetch(`${se}/debrid/files?id=${encodeURIComponent(K)}`);if(!We.ok){try{const Ne=await We.text();if(/RD_RATE_LIMIT|RD_FEATURE_UNAVAILABLE|TB_NO_SEEDS/i.test(Ne))return/TB_NO_SEEDS/i.test(Ne)&&I("âŒ This torrent has no seeders and cannot be cached. Try a different release.","error"),null}catch{}await new Promise(Ne=>setTimeout(Ne,ce));continue}const he=await We.json(),Lt=Array.isArray(he?.files)?he.files:[];if(Lt.filter(Ne=>/\.(mp4|mkv|avi|mov)$/i.test(Ne.path||Ne.filename||"")).some(Ne=>Array.isArray(Ne.links)&&Ne.links.length>0))return console.log("[UI][Debrid] Files are ready! Links available."),Lt;const xt=he?.status||"",Yt=he?.progress||0;xt&&Yt>0&&(on.textContent=`${he?.filename||"Downloading"} - ${Yt}%`)}catch(We){console.warn("[UI][Debrid] Polling error:",We?.message)}await new Promise(We=>setTimeout(We,ce))}return console.warn("[UI][Debrid] Polling timed out after",de,"ms"),null}async function wo(K,de,{timeoutMs:ce=3e4,intervalMs:Me=1500}={}){const We=Date.now();for(;Date.now()-We<ce;){if(!M(K))return null;try{const he=await fetch(`${se}/debrid/files?id=${encodeURIComponent(K)}`);if(!he.ok){try{const xt=await he.text();if(/RD_RATE_LIMIT|RD_FEATURE_UNAVAILABLE|TB_NO_SEEDS/i.test(xt))return/TB_NO_SEEDS/i.test(xt)&&I("âŒ This torrent has no seeders. Try a different release.","error"),null}catch{}await new Promise(xt=>setTimeout(xt,Me));continue}const Lt=await he.json(),pn=(Array.isArray(Lt?.files)?Lt.files:[]).find(xt=>String(xt.id||xt.file)===String(de));if(pn&&Array.isArray(pn.links)&&pn.links.length)return pn.links[0]}catch{}await new Promise(he=>setTimeout(he,Me))}return null}fe.some(K=>!Array.isArray(K.links)||K.links.length===0)&&(on.textContent=`${te?.filename||"Torrent"} - Preparing files...`,I("Waiting for files to be ready on Real-Debrid..."),(async()=>{const K=await Qe(H);if(K){if(!M(H))return;const de=K.filter(Me=>/\.(mp4|mkv|avi|mov)$/i.test(Me.path||Me.filename||"")),ce=K.filter(Me=>/\.(srt|vtt)$/i.test(Me.path||Me.filename||""));fe.length=0,fe.push(...de),be.length=0,be.push(...ce),cn.innerHTML="",fe.forEach(Me=>{const We=document.createElement("div");We.className="file-item",We.innerHTML=`<p class="file-name">${re(Me)} ${Tt(Me)}</p><p class="file-size">(${ze(Me)})</p>`,We.addEventListener("click",$(Me,H,be)),cn.appendChild(We)}),on.textContent=te?.filename||P,I("âœ… Files are ready! Click to play.")}else I("Files are taking longer than expected. Try again later.")})()),fe.forEach(K=>{const de=document.createElement("div");de.className="file-item",de.innerHTML=`<p class="file-name">${re(K)} ${Tt(K)}</p><p class="file-size">(${ze(K)})</p>`,de.addEventListener("click",$(K,H,be)),cn.appendChild(de)}),be.length&&(Ns.style.display="flex",ci.innerHTML="",ci.classList.add("subtitle-list"),th=be.map(K=>({name:re(K),index:-1})),be.forEach(K=>{const de=document.createElement("div");de.className="subtitle-item";const ce=document.createElement("div");ce.className="subtitle-lang",ce.textContent=re(K),de.appendChild(ce),de.addEventListener("click",async()=>{try{const Me=Array.isArray(K.links)&&K.links.length?K.links[0]:null;if(!Me)return;const We=await fetch(`${se}/debrid/link`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({link:Me})});if(!We.ok){console.warn("[UI][Debrid] sub unrestrict failed",await We.text());return}const he=await We.json();if(!he?.url)return;const Lt=await fetch(`${se}/subtitles/download-direct`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({url:he.url,preferredName:re(K)})}),tn=await Lt.json();Lt.ok&&tn.url&&(sa=tn.url,I("Subtitle ready"))}catch(Me){console.warn("[UI][Debrid] sub attach failed",Me?.message)}}),ci.appendChild(de)}));return}catch($){console.error("[UI][Debrid] flow failed",$?.message),I("Debrid path failed. Falling back to WebTorrent."),Nt.style.display="none"}}console.log("[UI][Stream] Using WebTorrent client-side"),p(),Nt.style.display="flex",Ms.style.display="none",cn.innerHTML="",ci.innerHTML="",Ns.style.display="none",on.textContent="Initializing torrent engine...";try{const{file:$,torrent:C}=await TorrentService.getInstance().streamTorrent(S);console.log("[UI][Stream] Torrent ready:",$.name),$.getBlobURL((M,F)=>{if(M){console.error("[WebTorrent] Blob error:",M),on.textContent="Error creating stream URL",Nt.innerHTML=`<p class="error-msg">${M.message}</p>`;return}Nt.style.display="none",on.textContent=$.name,cn.innerHTML="";const j=document.createElement("div");j.className="file-item",j.innerHTML=`<p class="file-name">${$.name}</p><p class="file-size">(${displaySize({size:$.length})})</p>`,j.addEventListener("click",()=>{mn=F,Ve.src=F,Fn.style.display="flex",setTimeout(()=>Fn.classList.add("active"),10);try{Ve.play()}catch(H){console.error("Play error",H)}Mn&&(Mn.textContent="WebTorrent",Mn.classList.remove("debrid"),Mn.classList.add("webtorrent"))}),cn.appendChild(j)}),Nn&&(Nn.textContent="WebTorrent",Nn.classList.remove("debrid"),Nn.classList.add("webtorrent"))}catch($){console.error("Error initializing WebTorrent:",$),on.textContent="Error loading torrent",Nt.innerHTML=`<p class="error-msg">${$.message}</p>`}}function y(){try{Pr().then(()=>{setTimeout(()=>{try{const S=document.getElementById("debridSection");if(S&&typeof S.scrollIntoView=="function"&&S.scrollIntoView({behavior:"smooth",block:"start"}),un==="alldebrid")Xl&&(Xl.style.display=""),Sr&&Sr.focus();else{const P=document.getElementById("rdClientId");P&&P.focus()}}catch{}},50)})}catch{Pr()}}function p(){ra.classList.add("active")}function N(S){navigator.clipboard.writeText(S).then(()=>{I("Magnet link copied to clipboard")})}function I(S,P="info",$=5e3){ai.className="notification",P&&ai.classList.add(P),ai.textContent=S,ai.classList.add("show"),window.notificationTimeout&&clearTimeout(window.notificationTimeout),window.notificationTimeout=setTimeout(()=>{ai.classList.remove("show")},$),console.log(`[NOTIFICATION] ${P.toUpperCase()}: ${S}`)}let k=null,A=null;function U(){W(),k=document.createElement("div"),k.id="persistentUpdateNotification",k.innerHTML=`
                <div style="
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
                    color: white;
                    padding: 16px 20px;
                    border-radius: 12px;
                    box-shadow: 0 8px 32px rgba(34, 197, 94, 0.3);
                    z-index: 10000;
                    font-weight: 600;
                    font-size: 14px;
                    max-width: 320px;
                    backdrop-filter: blur(10px);
                    border: 1px solid rgba(255, 255, 255, 0.1);
                    animation: slideInRight 0.4s ease-out;
                ">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <i class="fas fa-rocket" style="font-size: 18px; color: #dcfce7;"></i>
                        <div>
                            <div style="font-size: 15px; margin-bottom: 4px;">ðŸŽ‰ Update Ready!</div>
                            <div style="font-size: 13px; opacity: 0.9;">Restart the app to complete the update</div>
                        </div>
                        <button onclick="restartForUpdate()" style="
                            background: rgba(255, 255, 255, 0.2);
                            border: 1px solid rgba(255, 255, 255, 0.3);
                            color: white;
                            padding: 8px 12px;
                            border-radius: 8px;
                            cursor: pointer;
                            font-size: 12px;
                            font-weight: 600;
                            transition: all 0.45s cubic-bezier(0.25, 0.46, 0.45, 0.94), transform 0.35s cubic-bezier(0.34, 1.56, 0.64, 1);
                        " onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">
                            Restart
                        </button>
                    </div>
                </div>
            `,document.body.appendChild(k),I("ðŸŽ‰ Update ready! Restart to complete installation.","success",6e3)}function W(){k&&(k.remove(),k=null),A&&(A.remove(),A=null)}function Y(S=0){if(A){try{A.remove()}catch{}A=null}A=document.createElement("div"),A.id="persistentDownloadNotification",A.innerHTML=`
                <div style="
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: linear-gradient(135deg, #a855f7 0%, #7c3aed 100%);
                    color: white;
                    padding: 16px 20px;
                    border-radius: 12px;
                    box-shadow: 0 8px 32px rgba(124, 58, 237, 0.35);
                    z-index: 10000;
                    font-weight: 600;
                    font-size: 14px;
                    max-width: 340px;
                    min-width: 280px;
                    backdrop-filter: blur(10px);
                    border: 1px solid rgba(255, 255, 255, 0.12);
                    animation: slideInRight 0.4s ease-out;
                ">
                    <div style="display:flex; align-items:center; gap:12px;">
                        <i class="fas fa-download" style="font-size:18px; color:#ede9fe;"></i>
                        <div style="flex:1;">
                            <div style="font-size:15px; margin-bottom:6px;">Downloading update...</div>
                            <div id="dlNotifText" style="font-size:13px; opacity:0.95;">${S}% complete</div>
                            <div style="margin-top:10px; height:6px; background:rgba(255,255,255,0.2); border-radius:6px; overflow:hidden;">
                                <div id="dlNotifBar" style="height:100%; width:${S}%; background:#c4b5fd; transition: width 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94);"></div>
                            </div>
                        </div>
                    </div>
                </div>
            `,document.body.appendChild(A)}function ae(S=0){if(!A)return;const P=A.querySelector("#dlNotifText"),$=A.querySelector("#dlNotifBar");P&&(P.textContent=`${S}% complete`),$&&($.style.width=`${S}%`)}let Ce=null;const G=1500,ve=document.getElementById("videoContainer");function Se(){ve.classList.add("show-controls"),Fn.classList.add("show-controls")}function oe(){En&&En.style.display==="block"||(ve.classList.remove("show-controls"),Fn.classList.remove("show-controls"))}function X(){Ce&&(clearTimeout(Ce),Ce=null)}function ye(){X(),Se(),Ce=setTimeout(oe,G)}ve.addEventListener("mousemove",ye),ve.addEventListener("mouseenter",ye),ve.addEventListener("mouseleave",oe),_s.addEventListener("mouseenter",()=>{X(),Se()}),_s.addEventListener("mousemove",()=>{X(),Se()}),_s.addEventListener("mouseleave",ye);const Z=Fn.querySelector(".player-header");Z&&(Z.addEventListener("mouseenter",()=>{X(),Se()}),Z.addEventListener("mousemove",()=>{X(),Se()}),Z.addEventListener("mouseleave",ye)),Lr&&Lr.addEventListener("click",()=>{setTimeout(()=>{En.style.display==="block"?(X(),Se()):ye()},0)}),Cr&&Cr.addEventListener("click",()=>{ye()});function Fe(S){if(!isFinite(S))return"0:00";const P=Math.floor(S/60),$=Math.floor(S%60);return`${P}:${String($).padStart(2,"0")}`}let Ae=1,Et=!1,It=!0,rt=!1,ft="browse",gt=null,$e=null,kt=!1;function ge(){$e&&(console.log("Closing active comics stream connection"),$e.close(),$e=null)}function Te(S){ft=S;const P=document.getElementById("comics-container"),$=document.getElementById("comics-issues-container"),C=document.getElementById("comics-reader-container"),M=document.getElementById("comics-loading"),F=document.getElementById("comics-back-btn"),j=document.getElementById("comics-load-more-container");P&&(P.style.display=S==="browse"?"grid":"none"),$&&($.style.display=S==="issues"?"block":"none"),C&&(C.style.display=S==="reader"?"block":"none"),M&&(M.style.display=S==="browse"?"block":"none"),F&&(F.style.display=S!=="browse"?"inline-block":"none"),j&&(j.style.display=S==="browse"?"block":"none")}async function _e(S){if(!S.trim())return;const P=document.getElementById("comics-container"),$=document.getElementById("comics-loading"),C=document.getElementById("comics-browse-btn");rt=!0,Et=!0,It=!1,P&&(P.innerHTML=""),$&&($.style.display="block",$.textContent="Searching..."),C&&(C.style.display="inline-block"),Te("browse");try{const F=await(await fetch(`http://localhost:6987/api/comics/search/${encodeURIComponent(S)}`)).json();F.success&&F.comics.length>0?(F.comics.forEach(j=>{qe(j)}),$.textContent=`Found ${F.count} results for "${S}"`):$.innerHTML=`<div style="color: #ff4444;">No comics found for "${S}"</div>`}catch(M){console.error("Error searching comics:",M),$.innerHTML='<div style="color: #ff4444;">Error searching comics. Please try again.</div>'}finally{Et=!1}}function qe(S){const P=document.createElement("div");P.className="movie-card",P.style.cssText="background: var(--card-bg); border-radius: 12px; overflow: hidden; transition: all 0.3s ease; cursor: pointer; border: 1px solid rgba(249, 115, 22, 0.2); box-shadow: 0 4px 12px rgba(0,0,0,0.3);",P.innerHTML=`
                <img src="${S.poster}" alt="${S.title}" style="width: 100%; height: 300px; object-fit: cover; display: block;" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22200%22 height=%22300%22%3E%3Crect width=%22200%22 height=%22300%22 fill=%22%23333%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 fill=%22%23666%22 text-anchor=%22middle%22 dy=%22.3em%22%3ENo Image%3C/text%3E%3C/svg%3E'">
                <div style="padding: 15px; font-size: 14px; font-weight: bold; text-align: center; min-height: 60px; display: flex; align-items: center; justify-content: center; color: var(--light);">${S.title}</div>
            `,P.onmouseover=()=>{P.style.transform="translateY(-8px)",P.style.borderColor="#f97316",P.style.boxShadow="0 8px 24px rgba(249, 115, 22, 0.4)"},P.onmouseout=()=>{P.style.transform="translateY(0)",P.style.borderColor="rgba(249, 115, 22, 0.2)",P.style.boxShadow="0 4px 12px rgba(0,0,0,0.3)"},P.onclick=()=>{if(S.link){const C=S.link.replace("https://readcomiconline.li/Comic/","");Ie(C,S.title)}};const $=document.getElementById("comics-container");$&&$.appendChild(P)}async function Ie(S,P){gt={slug:S,title:P};const $=document.getElementById("comics-issues-container");$&&($.innerHTML='<div style="text-align: center; padding: 20px; color: #888;">Loading issues...</div>'),Te("issues");try{const M=await(await fetch(`http://localhost:6987/api/comics/issues/${S}`)).json();if($.innerHTML="",M.success&&M.issues.length>0){const F=document.createElement("h2");F.textContent=P,F.style.cssText="margin-bottom: 20px; text-align: center; color: #fff;",$.appendChild(F),M.issues.forEach(j=>{const H=document.createElement("div");H.style.cssText="background: var(--card-bg); border-radius: 10px; padding: 15px 20px; margin-bottom: 10px; cursor: pointer; transition: all 0.3s ease; display: flex; justify-content: space-between; align-items: center; border: 1px solid rgba(249, 115, 22, 0.2);",H.innerHTML=`
                            <div style="font-weight: bold; flex: 1; color: var(--light);">${j.title}</div>
                            <div style="color: #9ca3af; font-size: 14px;">${j.date}</div>
                        `,H.onmouseover=()=>{H.style.background="rgba(249, 115, 22, 0.15)",H.style.borderColor="#f97316",H.style.transform="translateX(8px)"},H.onmouseout=()=>{H.style.background="var(--card-bg)",H.style.borderColor="rgba(249, 115, 22, 0.2)",H.style.transform="translateX(0)"},H.onclick=()=>we(j.link,j.title),$.appendChild(H)})}else $.innerHTML='<div style="color: #ff4444; text-align: center;">No issues found</div>'}catch(C){console.error("Error loading issues:",C),$.innerHTML='<div style="color: #ff4444; text-align: center;">Error loading issues. Please try again.</div>'}}async function we(S,P){ge();const $=document.getElementById("comics-reader-container");$&&($.innerHTML=`
                <h2 style="text-align:center;margin-bottom:20px;color:#fff;">${P}</h2>
                
                <!-- Keyboard Navigation Hint -->
                <div style="position: fixed; right: 2rem; top: 50%; transform: translateY(-50%); z-index: 900; background: rgba(0,0,0,0.85); padding: 1.5rem; border-radius: 12px; color: white; font-size: 0.95rem; text-align: center; backdrop-filter: blur(10px); box-shadow: 0 8px 24px rgba(0,0,0,0.5); border: 1px solid rgba(249, 115, 22, 0.3); max-width: 140px;">
                    <i class="fas fa-keyboard" style="font-size: 2rem; margin-bottom: 0.75rem; display: block; color: #f97316;"></i>
                    <p style="margin: 0; line-height: 1.5; font-weight: 600;">Use Arrow Keys<br>to Scroll</p>
                    <div style="margin-top: 1rem; font-size: 1.5rem; display: flex; flex-direction: column; gap: 0.5rem;">
                        <div style="color: #f97316;"><i class="fas fa-arrow-up"></i> Up</div>
                        <div style="color: #f97316;"><i class="fas fa-arrow-down"></i> Down</div>
                    </div>
                </div>
                
                <div id="comics-page-loader" style="text-align: center; padding: 20px; color: #888;">Connecting...</div>
            `),Te("reader");try{$e=new EventSource(`http://localhost:6987/api/comics/read-stream?link=${encodeURIComponent(S)}`);let C=0;const M=document.getElementById("comics-page-loader");$e.onmessage=F=>{const j=JSON.parse(F.data);if(j.type==="total")M&&(M.textContent=`Loading 0/${j.count} pages...`);else if(j.type==="page"){C++,M&&(M.textContent=`Loading ${C}...`);const H=document.createElement("img");H.style.cssText="width: 100%; margin-bottom: 10px; border-radius: 8px;",H.src=`http://localhost:6987/api/proxy-image?url=${encodeURIComponent(j.url)}`,H.alt=`Page ${j.pageNumber}`,H.loading="lazy",H.onerror=()=>{console.error(`Failed to load page ${j.pageNumber}: ${j.url}`),H.style.display="none"},$.appendChild(H)}else j.type==="done"?(M&&(M.textContent=`Loaded ${C} pages`,setTimeout(()=>{M&&M.parentNode&&M.remove()},2e3)),ge()):j.type==="error"&&(M&&M.remove(),$.innerHTML+=`<div style="color: #ff4444; text-align: center;">Error: ${j.message}</div>`,ge())},$e.onerror=F=>{console.error("EventSource error:",F),ge();const j=document.getElementById("comics-page-loader");j&&(j.remove(),$.innerHTML+='<div style="color: #ff4444; text-align: center;">Connection error. Please try again.</div>')}}catch(C){console.error("Error loading pages:",C);const M=document.getElementById("comics-page-loader");M&&M.remove(),$.innerHTML+='<div style="color: #ff4444; text-align: center;">Error loading pages. Please try again.</div>'}}async function st(S){if(Et||!It||rt){console.log("[COMICS] loadComicsAll blocked:",{comicsIsLoading:Et,comicsHasMore:It,comicsIsSearchMode:rt});return}const P=document.getElementById("comics-loading");if(!P){console.log("[COMICS] comics-loading div not found");return}console.log("[COMICS] Loading comics page:",S),Et=!0,P.style.display="block";try{const C=await(await fetch(`http://localhost:6987/api/comics/all?page=${S}`)).json();console.log("[COMICS] Comics response:",C.success,"comics count:",C.comics?.length),C.success&&C.comics.length>0?(C.comics.forEach(M=>{qe(M)}),Ae++,console.log("[COMICS] Comics loaded, next page will be:",Ae)):(It=!1,P.textContent="No more comics to load",console.log("[COMICS] No more comics available"))}catch($){console.error("[COMICS] Error loading comics:",$),P.innerHTML='<div style="color: #ff4444;">Error loading comics. Please try again.</div>'}finally{Et=!1,It&&(P.style.display="none");const $=document.getElementById("comics-load-more-container");document.getElementById("comics-load-more-btn"),$&&($.style.display=It&&!rt?"block":"none")}}function ht(){console.log("[COMICS SCROLL HANDLER] Called! Active:",kt,"View:",ft);{console.log("[COMICS SCROLL HANDLER] Blocked - page not active");return}}let Wt,Sn=0;window.addEventListener("scroll",()=>{const S=Date.now();S-Sn>1e3&&(console.log("[COMICS SCROLL EVENT] Fired. Active:",kt,"View:",ft),Sn=S),Wt&&clearTimeout(Wt),Wt=setTimeout(ht,100)});let Ut=null;const St=document.getElementById("comics-search-input");St&&(St.addEventListener("input",()=>{clearTimeout(Ut);const S=St.value.trim();if(!S){const P=document.getElementById("comics-container"),$=document.getElementById("comics-browse-btn");rt=!1,It=!0,Ae=1,P&&(P.innerHTML=""),$&&($.style.display="none"),Te("browse"),st(Ae);return}Ut=setTimeout(()=>{_e(S)},500)}),St.addEventListener("keypress",S=>{if(S.key==="Enter"){clearTimeout(Ut);const P=St.value.trim();P&&_e(P)}}));const ot=document.getElementById("comics-browse-btn");ot&&(ot.addEventListener("click",()=>{const S=document.getElementById("comics-container"),P=document.getElementById("comics-search-input");rt=!1,It=!0,Ae=1,S&&(S.innerHTML=""),ot.style.display="none",P&&(P.value=""),Te("browse"),st(Ae)}),ot.addEventListener("mouseenter",()=>{ot.style.background="linear-gradient(135deg, rgba(249, 115, 22, 0.4), rgba(234, 88, 12, 0.4))",ot.style.transform="translateY(-2px)"}),ot.addEventListener("mouseleave",()=>{ot.style.background="linear-gradient(135deg, rgba(249, 115, 22, 0.2), rgba(234, 88, 12, 0.2))",ot.style.transform="translateY(0)"}));const mt=document.getElementById("comics-back-btn");mt&&(mt.addEventListener("mouseenter",()=>{mt.style.background="linear-gradient(135deg, rgba(249, 115, 22, 0.4), rgba(234, 88, 12, 0.4))",mt.style.transform="translateY(-2px)"}),mt.addEventListener("mouseleave",()=>{mt.style.background="linear-gradient(135deg, rgba(249, 115, 22, 0.2), rgba(234, 88, 12, 0.2))",mt.style.transform="translateY(0)"}),mt.addEventListener("click",()=>{ge(),ft==="reader"?gt&&Ie(gt.slug,gt.title):ft==="issues"&&Te("browse")}));const At=document.getElementById("comics-load-more-btn");At&&(At.addEventListener("click",()=>{console.log("[COMICS] Load More button clicked, loading page:",Ae),st(Ae)}),At.addEventListener("mouseenter",()=>{At.style.transform="translateY(-4px)",At.style.boxShadow="0 8px 24px rgba(249, 115, 22, 0.6)"}),At.addEventListener("mouseleave",()=>{At.style.transform="translateY(0)",At.style.boxShadow="0 4px 12px rgba(249, 115, 22, 0.4)"})),window.addEventListener("beforeunload",()=>{ge()}),document.addEventListener("DOMContentLoaded",da);let Re=null,Ue=null,pt=null,He=null,vt=0;async function zn(S,P){try{console.log("[EPUB] Opening:",S);const $=document.getElementById("epubReaderOverlay"),C=document.getElementById("readerTitle"),M=document.getElementById("readerContainer"),F=document.getElementById("readerPrevBtn"),j=document.getElementById("readerNextBtn");if(C.textContent=P||"EPUB Reader",$.classList.add("theme-dark"),$.classList.remove("theme-light","theme-night"),$.style.display="flex",M.innerHTML="",Re=null,Ue=null,F.disabled=!0,j.disabled=!1,!window.ePub||!window.JSZip){if(console.log("[EPUB] Loading libraries..."),!window.JSZip){const re=document.createElement("script");re.src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js",await new Promise((ze,Tt)=>{re.onload=ze,re.onerror=Tt,document.head.appendChild(re)}),console.log("[EPUB] JSZip loaded")}if(!window.ePub){const re=document.createElement("script");re.src="https://cdn.jsdelivr.net/npm/epubjs@0.3.93/dist/epub.min.js",await new Promise((ze,Tt)=>{re.onload=ze,re.onerror=Tt,document.head.appendChild(re)}),console.log("[EPUB] epub.js loaded")}}console.log("[EPUB] Reading file...");const H=await window.electronAPI.readEpubFile(S);if(console.log("[EPUB] Read result:",H.success,H.base64?`${H.base64.length} bytes`:"no data"),!H.success||!H.base64){alert("Failed to open book: "+(H.message||"Unable to read file")),$.style.display="none";return}console.log("[EPUB] Converting to ArrayBuffer...");const te=atob(H.base64),Ee=new Uint8Array(te.length);for(let re=0;re<te.length;re++)Ee[re]=te.charCodeAt(re);console.log("[EPUB] ArrayBuffer size:",Ee.length),console.log("[EPUB] Creating book instance..."),Ue=window.ePub(Ee.buffer),console.log("[EPUB] Rendering to container..."),Re=Ue.renderTo(M,{width:"100%",height:"100%",spread:"none",flow:"paginated"});const fe="epub_position_"+encodeURIComponent(S);Re.on("relocated",re=>{if(console.log("[EPUB] Relocated:",re.atStart,re.atEnd),F.disabled=re.atStart,j.disabled=re.atEnd,re&&re.start&&re.start.cfi)try{localStorage.setItem(fe,re.start.cfi),console.log("[EPUB] Saved position:",re.start.cfi)}catch(ze){console.warn("[EPUB] Could not save position:",ze)}});let be=!1;try{const re=localStorage.getItem(fe);re&&(console.log("[EPUB] Restoring position:",re),await Re.display(re),be=!0,console.log("[EPUB] Position restored successfully"))}catch(re){console.warn("[EPUB] Could not restore position:",re)}be||(console.log("[EPUB] Displaying from beginning..."),await Re.display()),console.log("[EPUB] Book opened successfully"),Tn(),await ho()}catch($){console.error("[EPUB] Error:",$),alert("Could not open the EPUB: "+$.message);const C=document.getElementById("epubReaderOverlay");C.style.display="none"}}function Wn(){const S=document.getElementById("epubReaderOverlay"),P=document.getElementById("readerSettingsPanel");if(S.style.display="none",P.classList.add("hidden"),Re)try{Re.destroy()}catch{}Re=null,Ue=null,pt=null,He=null,vt=0;const $=document.getElementById("readerChapterControls");$&&($.style.display="none")}document.addEventListener("keydown",S=>{if(S.key==="Escape"){const P=document.getElementById("epubReaderOverlay");P&&P.style.display==="flex"&&Wn()}});function Tn(){const S=document.getElementById("epubReaderOverlay"),P=localStorage.getItem("reader.theme")||"dark",$=localStorage.getItem("reader.font")||"-apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif",C=parseInt(localStorage.getItem("reader.size")||"16",10);if(S.classList.remove("theme-light","theme-dark","theme-night"),S.classList.add(`theme-${P}`),Re){let M="#f2f2f2",F="#202225";P==="light"?(M="#111111",F="#ffffff"):P==="night"&&(M="#e5e7eb",F="#000000");try{Re.themes.register("custom",{body:{"font-family":`${$} !important`,color:M,background:F},"*":{"font-family":`${$} !important`}})}catch(j){console.log("[EPUB] Theme register error:",j)}try{Re.themes.select("custom")}catch(j){console.log("[EPUB] Theme select error:",j)}try{Re.themes.fontSize(`${C}px`)}catch(j){console.log("[EPUB] Font size error:",j)}try{Re.themes.default({body:{"font-family":`${$} !important`},p:{"font-family":`${$} !important`},div:{"font-family":`${$} !important`},span:{"font-family":`${$} !important`}})}catch{}}}document.addEventListener("click",S=>{if(S.target.closest("#readerPrevBtn")&&Re&&(console.log("[EPUB] Going to previous page"),Re.prev()),S.target.closest("#readerNextBtn")&&Re&&(console.log("[EPUB] Going to next page"),Re.next()),S.target.closest("#readerChapterGo")){const P=document.getElementById("readerChapterInput");if(!P)return;const $=parseInt(P.value,10);rn($)}if(S.target.closest("#readerSettingsBtn")){const P=document.getElementById("readerSettingsPanel"),$=P.classList.contains("hidden");if(P.classList.toggle("hidden"),$){const C=document.getElementById("readerFont"),M=document.getElementById("readerFontSize"),F=localStorage.getItem("reader.font")||"-apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif",j=localStorage.getItem("reader.size")||"16";C&&(C.value=F),M&&(M.value=j)}console.log("[EPUB] Settings panel toggled:",$?"now visible":"now hidden")}S.target.closest("#readerBackBtn")&&(console.log("[EPUB] Back button clicked"),Wn())}),document.addEventListener("keydown",S=>{if(S.key==="Enter"&&S.target&&S.target.id==="readerChapterInput"){const P=parseInt(S.target.value,10);rn(P)}}),document.addEventListener("click",S=>{const P=S.target.closest(".theme-btn");if(P){const $=P.getAttribute("data-theme");localStorage.setItem("reader.theme",$),Tn()}}),document.addEventListener("input",S=>{S.target.id==="readerFont"?(localStorage.setItem("reader.font",S.target.value),Tn()):S.target.id==="readerFontSize"&&(localStorage.setItem("reader.size",S.target.value),Tn())}),window.openEpubReader=zn;async function ho(){try{const S=document.getElementById("readerChapterControls"),P=document.getElementById("readerChapterCount"),$=document.getElementById("readerChapterInput");if(!S||!P||!$)return;if(!Ue){S.style.display="none";return}pt=null,He=null,vt=0;try{const C=await Ue.loaded?.navigation;C&&Array.isArray(C.toc)&&C.toc.length>0&&(pt=C.toc,vt=pt.length)}catch{}if(!vt)try{const C=await Ue.loaded?.spine;C&&Array.isArray(C.spineItems)&&C.spineItems.length>0?(He=C.spineItems,vt=He.length):Ue.spine&&Array.isArray(Ue.spine.spineItems)&&Ue.spine.spineItems.length>0&&(He=Ue.spine.spineItems,vt=He.length)}catch{}vt>0?(S.style.display="flex",P.textContent=String(vt),$.max=String(vt),$.placeholder=`1-${vt}`):S.style.display="none"}catch(S){console.warn("[EPUB] Could not initialize chapter controls:",S)}}async function rn(S){const P=document.getElementById("readerChapterInput");if(!Ue||!Re||!Number.isFinite(S)){P&&yt(P);return}const $=vt||0;if(!$){P&&yt(P);return}let C=Math.floor(S)-1;if(C<0||C>=$){P&&yt(P);return}try{let M=null;if(pt&&pt[C]&&pt[C].href?M=pt[C].href:He&&He[C]&&He[C].href&&(M=He[C].href),M)await Re.display(M);else{if(typeof Ue.spine?.get=="function"){const F=Ue.spine.get(C);if(F&&F.href){await Re.display(F.href);return}}throw new Error("No valid chapter target")}}catch(M){console.warn("[EPUB] Failed to jump to chapter",S,M),P&&yt(P)}}function yt(S){const P=S.style.borderColor;S.style.borderColor="rgba(244,63,94,0.85)",setTimeout(()=>{S.style.borderColor=P||"rgba(255,255,255,0.15)"},450)}async function Ln(S){if(!S)return null;try{const P=await fetch(`${se}/resume?key=${encodeURIComponent(S)}`);if(!P.ok)return null;const $=await P.json();if($&&typeof $.position=="number"&&$.position>0)return $}catch{}return null}try{Ve.addEventListener("ended",async()=>{if(Ze)try{await fetch(`${se}/resume?key=${encodeURIComponent(Ze)}`,{method:"DELETE"})}catch{}})}catch{}async function vo(){try{const S=await fetch(`${se}/resume/all`);if(!S.ok)return;const P=await S.json();if(!Array.isArray(P)||P.length===0){document.getElementById("continueWatchingSection").style.display="none";return}document.getElementById("continueWatchingSection").style.display="block";const $=document.getElementById("continueWatchingSlider");$.innerHTML="";for(const C of P){if(!C.title||!C.key)continue;const M=document.createElement("div");M.className="movie-card continue-watching-card",M.dataset.resumeKey=C.key;const F=C.duration>0?(C.position/C.duration*100).toFixed(1):0;let j="";if(C.media_type==="tv"&&C.season)j=`Season ${C.season}`;else{const te=C.duration>0?Fe(C.duration-C.position):"";j=te?`${te} left`:""}const H=C.poster_path?`<img loading="lazy" decoding="async" src="https://image.tmdb.org/t/p/w342${C.poster_path}" alt="${C.title.replace(/'/g,"\\'")}">`:`<div class="continue-watching-placeholder">
                            <i class="fas fa-play-circle"></i>
                           </div>`;M.innerHTML=`
                        <button class="remove-continue-btn" onclick="removeContinueWatching(event, '${C.key.replace(/'/g,"\\'")}')">
                            <i class="fas fa-times"></i>
                        </button>
                        <div class="movie-poster">
                            ${H}
                            <div class="continue-watching-progress" style="width: ${F}%"></div>
                        </div>
                        <div class="movie-info">
                            <h3 class="movie-title">${C.title}</h3>
                            <p class="movie-year">${j}</p>
                        </div>
                        <div class="movie-rating">
                            <i class="fas fa-clock"></i> ${F}%
                        </div>
                    `,M.addEventListener("click",te=>{if(!te.target.closest(".remove-continue-btn"))if(C.tmdb_id&&C.media_type){const Ee={id:C.tmdb_id,title:C.title,name:C.title,poster_path:C.poster_path,media_type:C.media_type};kn(Ee,C.media_type)}else I("Details not available for this item (missing metadata). Try watching it again to update.","info",4e3)}),$.appendChild(M)}}catch(S){console.error("[Continue Watching] Load error:",S),document.getElementById("continueWatchingSection").style.display="none"}}try{window.electronAPI?.onVersionNotice163&&window.electronAPI.onVersionNotice163(()=>{rh()})}catch{}try{let S=function(){$&&($.style.display="flex"),document.body&&(document.body.style.overflow="hidden")},P=function(){$&&($.style.display="none"),document.body&&(document.body.style.overflow="auto")};const $=document.getElementById("updateOverlay"),C=document.getElementById("updateStatusIcon"),M=document.getElementById("updateStatusText"),F=document.getElementById("updateProgressBar"),j=document.getElementById("updatePercent"),H=document.getElementById("updateRestartBtn");window.electronAPI&&(window.electronAPI.onUpdateChecking?.(te=>{console.log("[Update] Checking for updates..."),I("ðŸ” Checking for updates...","info",5e3)}),window.electronAPI.onUpdateNotAvailable?.(te=>{console.log("[Update] App is up to date"),I("âœ… App is up to date","success",4e3)}),window.electronAPI.onUpdateAvailable?.(te=>{if(console.log("[Update] Update available:",te),te?.manual||te?.platform==="darwin"){const fe=te?.downloadUrl||"https://github.com/ayman707-ux/PlayTorrio/releases/latest";I(`ðŸŽ‰ Update ${te?.version||""} available! Please download the new DMG from GitHub.`,"info",1e4),console.log("[Update] macOS: Manual download required. URL:",fe);return}console.log("[Update] Showing download progress overlay"),S(),C&&(C.className="fas fa-download",C.style.animation="pulse 1.5s ease-in-out infinite",C.style.color="#a855f7"),M&&(M.textContent="Update found! Download starting, please wait..."),F&&(F.style.width="0%"),j&&(j.textContent="0%"),H&&(H.style.display="none");const Ee=document.getElementById("updateWarningText");Ee&&(Ee.textContent="âš ï¸ Downloading update - please keep the app open"),Y(0)}),window.electronAPI.onUpdateProgress?.(te=>{console.log("[Update] Download progress:",te?.percent+"%");const Ee=Math.max(0,Math.min(100,Math.round(te?.percent||0)));F&&(F.style.width=Ee+"%"),j&&(j.textContent=Ee+"%"),M&&(M.textContent=`Downloading update... ${Ee}% complete`),C&&(C.className="fas fa-download",C.style.animation="pulse 1.5s ease-in-out infinite"),ae(Ee)}),window.electronAPI.onUpdateDownloaded?.(te=>{console.log("[Update] Download completed, ready to install"),W(),C&&(C.className="fas fa-check-circle",C.style.animation="none",C.style.color="#22c55e"),M&&(M.textContent='Update downloaded successfully! Click "Restart Now" to complete the update.'),F&&(F.style.width="100%"),j&&(j.textContent="100%"),H&&(H.style.display="inline-flex");const Ee=document.getElementById("updateWarningText");Ee&&(Ee.textContent="âœ… Update ready! You can restart the app anytime to apply the update");const fe=document.getElementById("updateCloseBtn");fe&&(fe.style.display="flex"),U()}),H?.addEventListener("click",async te=>{try{te.stopPropagation?.(),H.disabled=!0;const Ee=H.innerHTML;H.innerHTML='<i class="fas fa-sync fa-spin"></i> Restarting...',H.style.opacity="0.85";const fe=await window.electronAPI.installUpdateNow?.();setTimeout(()=>{try{W()}catch{}},200),(!fe||fe.success!==!0)&&(H.disabled=!1,H.innerHTML=Ee,H.style.opacity="1",I("Update install failed to start. Please try again.","error",4e3))}catch{try{H.disabled=!1,H.innerHTML='<i class="fas fa-sync-alt"></i> Restart Now to Complete Update',H.style.opacity="1"}catch{}I("Could not trigger restart. Please try again.","error",4e3)}}));try{const te=()=>I("You are offline. Offline Music Library is available.","warning",5e3),Ee=()=>I("Back online.","success",3e3);typeof navigator<"u"&&navigator&&navigator.onLine===!1&&te(),window.addEventListener("offline",te),window.addEventListener("online",Ee)}catch{}}catch{}async function Pt(){try{const S=await so.getObject("my-list")||[];if(S.success){const P=S.data||[],$=new Map,C=[];for(const M of P){const F=`${M.id}_${M.media_type}`;$.has(F)||($.set(F,!0),C.push(M))}return wn=C,C.length<P.length&&(console.log(`[MyList] Removed ${P.length-C.length} duplicate(s)`),await Kn()),wn}else return console.error("Failed to load my list:",S.message),[]}catch(S){return console.error("Error loading my list:",S),[]}}async function Kn(){try{const S=await so.setObject("my-list",wn);return S.success||console.error("Failed to save my list:",S.message),S.success}catch(S){return console.error("Error saving my list:",S),!1}}function g(S,P,$){const C=S.querySelector(".add-to-list-btn");if(!C)return;wn.some(F=>F.id===P&&F.media_type===$)?(C.classList.add("in-list"),C.innerHTML='<i class="fas fa-check"></i>',C.title="Remove from My List"):(C.classList.remove("in-list"),C.innerHTML='<i class="fas fa-plus"></i>',C.title="Add to My List")}function c(S,P,$){const C=S.querySelector(".done-watching-btn");if(!C)return;_t.some(F=>F.id===P&&F.media_type===$&&!F.season&&!F.episode)?(C.classList.add("is-done"),C.innerHTML='<i class="fas fa-check-circle"></i>',C.title="Remove from Done Watching"):(C.classList.remove("is-done"),C.innerHTML='<i class="fas fa-check"></i>',C.title="Mark as Done Watching")}async function d(){const S=document.getElementById("myListGrid"),P=document.getElementById("myListLoading"),$=document.getElementById("myListEmpty");if(S){if(P.style.display="block",$.style.display="none",S.innerHTML="",await Pt(),P.style.display="none",wn.length===0){$.style.display="block";return}wn.forEach(C=>{const M=document.createElement("div");M.className="movie-card",M.dataset.rating=C.vote_average||0,M.dataset.date=`${C.year}-01-01`,M.innerHTML=`
                    <button class="add-to-list-btn in-list" onclick="toggleMyList(event, ${C.id}, '${C.media_type}', '${C.title.replace(/'/g,"\\'")}', '${C.poster_path}', '${C.year}', ${C.vote_average})">
                        <i class="fas fa-check"></i>
                    </button>
                    <img loading="lazy" decoding="async" src="https://image.tmdb.org/t/p/w342${C.poster_path}" alt="${C.title}" class="movie-poster">
                    <div class="movie-info">
                        <h3 class="movie-title">${C.title}</h3>
                        <p class="movie-year">${C.year}</p>
                    </div>
                    <div class="movie-rating">
                        <i class="fas fa-star"></i> ${Number(C.vote_average).toFixed(1)}
                    </div>
                `,M.addEventListener("click",F=>{F.target.closest(".add-to-list-btn")||kn(C,C.media_type)}),S.appendChild(M)})}}async function b(){confirm("Are you sure you want to clear your entire list? This action cannot be undone.")&&(wn=[],await Kn(),document.querySelectorAll(".add-to-list-btn.in-list").forEach(S=>{S.classList.remove("in-list"),S.innerHTML='<i class="fas fa-plus"></i>',S.title="Add to My List"}),document.getElementById("myListPage").style.display!=="none"&&d())}async function B(){try{const S=await so.getObject("done-watching")||[];return S.success?(_t=S.data||[],_t):(console.error("Failed to load done watching:",S.message),[])}catch(S){return console.error("Error loading done watching:",S),[]}}async function R(){try{const S=await so.setObject("done-watching",_t);return S.success||console.error("Failed to save done watching:",S.message),S.success}catch(S){return console.error("Error saving done watching:",S),!1}}async function D(){const S=document.getElementById("doneWatchingGrid"),P=document.getElementById("doneWatchingLoading"),$=document.getElementById("doneWatchingEmpty");if(!S)return;if(P.style.display="block",$.style.display="none",S.innerHTML="",await B(),P.style.display="none",_t.length===0){$.style.display="block";return}const C=new Map;_t.forEach(M=>{if(M.media_type==="tv"&&M.season&&M.episode){const F=`${M.id}-${M.media_type}`;C.has(F)||C.set(F,{...M,episodes:[],isGrouped:!0}),C.get(F).episodes.push({season:M.season,episode:M.episode,episode_title:M.episode_title,completed_date:M.completed_date})}else{const F=`${M.id}-${M.media_type}-single`;C.set(F,{...M,isGrouped:!1})}}),Array.from(C.values()).sort((M,F)=>new Date(F.completed_date)-new Date(M.completed_date)).forEach(M=>{const F=document.createElement("div");F.className="movie-card",F.dataset.rating=M.vote_average||0,F.dataset.date=`${M.year}-01-01`;let j=M.title,H="",te="";if(M.isGrouped&&M.episodes&&M.episodes.length>0){const fe=M.episodes.sort((re,ze)=>re.season!==ze.season?ze.season-re.season:ze.episode-re.episode)[0],be=M.episodes.length;j=M.title,H=`<p class="episode-subtitle">${be} episode${be>1?"s":""} watched â€¢ Latest: S${fe.season}E${fe.episode}</p>`,te=`<div class="episode-badge"><i class="fas fa-tv"></i> ${be} Episodes</div>`}F.innerHTML=`
                        <button class="add-to-list-btn" onclick="toggleMyList(event, ${M.id}, '${M.media_type}', '${M.title.replace(/'/g,"\\'")}', '${M.poster_path}', '${M.year}', ${M.vote_average})">
                            <i class="fas fa-plus"></i>
                        </button>
                        ${M.media_type==="movie"?`
                        <button class="done-watching-btn is-done" onclick="toggleDoneWatching(event, ${M.id}, '${M.media_type}', '${M.title.replace(/'/g,"\\'")}', '${M.poster_path}', '${M.year}', ${M.vote_average})">
                            <i class="fas fa-check-circle"></i>
                        </button>`:""}
                        ${te}
                        <img loading="lazy" decoding="async" src="https://image.tmdb.org/t/p/w342${M.poster_path}" alt="${j}" class="movie-poster">
                        <div class="movie-info">
                            <h3 class="movie-title">${j}</h3>
                            ${H}
                            <p class="movie-year">${M.year}</p>
                        </div>
                        <div class="movie-rating">
                            <i class="fas fa-star"></i> ${Number(M.vote_average).toFixed(1)}
                        </div>
                        ${M.isGrouped?`
                        <button class="episode-details-btn" onclick="showEpisodeDetails(event, ${M.id}, '${M.title.replace(/'/g,"\\'")}')">
                            <i class="fas fa-list"></i> View ${M.episodes.length} Episode${M.episodes.length>1?"s":""}
                        </button>
                        `:""}
                    `,F.addEventListener("click",Ee=>{!Ee.target.closest(".add-to-list-btn")&&!Ee.target.closest(".done-watching-btn")&&kn(M,M.media_type)}),S.appendChild(F)})}async function ke(){confirm("Are you sure you want to clear your entire done watching list? This action cannot be undone.")&&(_t=[],await R(),document.querySelectorAll(".done-watching-btn.is-done").forEach(S=>{S.classList.remove("is-done"),S.innerHTML='<i class="fas fa-check"></i>',S.title="Mark as Done Watching"}),document.getElementById("doneWatchingPage").style.display!=="none"&&D())}document.addEventListener("DOMContentLoaded",async()=>{try{await reconcileDownloadedMusicWithDisk()}catch{}try{renderDownloadedMusic()}catch{}await Pt(),await B(),await vo();const S=Vo;Vo=function($,C=!0){const M=S.call(this,$,C);return setTimeout(()=>{$.forEach(F=>{document.querySelectorAll(`[data-rating="${F.vote_average||0}"]`).forEach(H=>{g(H,F.id,F.media_type||"movie"),c(H,F.id,F.media_type||"movie")})})},100),M};const P=wa;wa=function($,C){const M=P.call(this,$,C);return setTimeout(()=>{$.forEach(F=>{document.querySelectorAll(".movie-card").forEach(H=>{const te=H.querySelector("img");te&&te.src.includes(F.poster_path)&&(g(H,F.id,C),c(H,F.id,C))})})},100),M},document.getElementById("clearMyListBtn")?.addEventListener("click",b),document.getElementById("clearDoneWatchingBtn")?.addEventListener("click",ke)}),(function(){window.electronAPI&&window.electronAPI.platform&&document.body.classList.add("platform-"+window.electronAPI.platform)})(),window.showCustomMagnetModal=Oh,window.closeEpubDownloadModal=closeEpubDownloadModal,window.applyUIMode=Fa,window.applyTheme=Va}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>{console.log("[DEBUG] DOMContentLoaded fired - calling init()"),da()}):(console.log("[DEBUG] DOM already loaded - calling init() immediately"),da());export{dl as E,fu as W,Vv as a,im as b};
